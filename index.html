<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro v2.1</title>
    <style>
        :root {
            --primary: #8b5cf6; --primary-dark: #7c3aed; --primary-light: #a78bfa;
            --secondary: #06d6a0; --secondary-dark: #05c296;
            --accent: #f59e0b; --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --bg-primary: #0f0f23; --bg-secondary: #1a1b3a; --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f; --bg-hover: #252647;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #374151; --border-light: #4b5563;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --transition: 0.3s ease; --border-radius: 12px; --border-radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary); line-height: 1.6; min-height: 100vh; overflow-x: hidden;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 3rem 2rem; margin-bottom: 2rem;
            border-radius: var(--border-radius-lg); text-align: center;
            box-shadow: var(--shadow-xl); position: relative; overflow: hidden;
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 0.5rem; font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p { font-size: clamp(1rem, 2.5vw, 1.2rem); opacity: 0.95; }

        /* Navigazione migliorata */
        .nav-container {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg); margin-bottom: 2rem; border: 1px solid var(--border);
            position: sticky; top: 20px; z-index: 100;
        }

        .nav-tabs {
            display: flex; padding: 8px; gap: 4px; overflow-x: auto;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }

        .nav-tab {
            flex: 0 0 auto; min-width: 120px; padding: 16px 20px; border: none;
            background: transparent; color: var(--text-secondary); cursor: pointer;
            border-radius: var(--border-radius); transition: all var(--transition);
            font-weight: 600; font-size: 0.9rem; white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: var(--shadow); transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover); color: var(--text-primary); transform: translateY(-1px);
        }

        /* Menu burger per mobile */
        .mobile-nav-toggle {
            display: none; padding: 1rem; background: none; border: none;
            color: var(--text-primary); font-size: 1.5rem; cursor: pointer;
            border-radius: var(--border-radius);
        }

        .nav-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-card); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
            border-top: 1px solid var(--border); max-height: 60vh; overflow-y: auto;
        }

        .nav-dropdown.show { display: block; }

        .nav-dropdown .nav-tab {
            display: block; width: 100%; text-align: left; border-radius: 0;
            border-bottom: 1px solid var(--border-light);
        }

        @media (max-width: 768px) {
            .nav-tabs { display: none; }
            .mobile-nav-toggle { display: block; }
            .nav-container { position: relative; }
        }

        .section { display: none; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .section.active { display: block; opacity: 1; transform: translateY(0); }

        .card {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-lg);
            border: 1px solid var(--border); transition: all var(--transition);
            position: relative; overflow: hidden;
        }

        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .btn {
            padding: 16px 32px; border: none; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; font-size: 1rem; transition: all var(--transition);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 48px; position: relative; overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: var(--shadow);
        }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }

        .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .btn-small { padding: 0.75rem 1rem; font-size: 0.85rem; min-height: 40px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; position: relative; }

        label {
            display: block; margin-bottom: 0.75rem; font-weight: 600;
            color: var(--text-primary); font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%; padding: 16px 20px; border: 2px solid var(--border);
            border-radius: var(--border-radius); font-size: 1rem;
            background: var(--bg-tertiary); color: var(--text-primary);
            transition: all var(--transition); font-family: inherit; min-height: 48px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary); background: var(--bg-secondary);
            transform: translateY(-2px); box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-tertiary); border-radius: var(--border-radius);
            padding: 1.5rem; text-align: center; border: 1px solid var(--border);
            transition: all var(--transition);
        }

        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .stat-number { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; }

        .progress-bar {
            width: 100%; height: 12px; background: var(--bg-tertiary);
            border-radius: 6px; overflow: hidden; margin: 1rem 0;
        }

        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary));
            transition: width 0.8s ease; border-radius: 6px;
        }

        .timer-display {
            font-size: clamp(4rem, 10vw, 5rem); font-weight: 800;
            color: var(--primary-light); margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-align: center; transition: all var(--transition);
        }

        .timer-display.break-mode { color: var(--secondary); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; align-items: center;
            justify-content: center; z-index: 1000; padding: 20px;
        }

        .modal {
            background: var(--bg-card); border-radius: var(--border-radius-lg);
            padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh;
            overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border);
        }

        .modal-large {
            max-width: 800px; width: 95%;
        }

        .star-rating { display: flex; gap: 6px; margin-top: 0.5rem; }
        .star {
            font-size: 1.8rem; color: var(--text-muted); cursor: pointer;
            transition: all var(--transition);
        }
        .star:hover { transform: scale(1.2); }
        .star.active { color: #fbbf24; }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        .hidden { display: none !important; }
        .loading { opacity: 0.6; pointer-events: none; }

        .session-item {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem;
            display: flex; justify-content: space-between; align-items: center;
            transition: all var(--transition);
        }

        .session-item:hover { transform: translateX(4px); }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 2rem 1rem; }
            .timer-display { font-size: 4rem; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Componenti specifici */
        .subject-item {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem;
            transition: all var(--transition); border-left: 4px solid var(--primary);
        }

        .subject-item:hover { transform: translateX(8px); box-shadow: var(--shadow-lg); }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card);
        }

        .calendar-day {
            min-height: 120px; padding: 0.5rem; border: 1px solid var(--border);
            cursor: pointer; transition: all var(--transition);
            display: flex; flex-direction: column;
        }

        .calendar-day:hover { background: var(--bg-hover); transform: scale(1.02); }
        .calendar-day.today { border: 2px solid var(--accent); font-weight: 700; }
        .calendar-day.has-sessions { border-left: 4px solid var(--primary); }

        .heatmap-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px; margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: all var(--transition); min-height: 50px;
        }

        .heatmap-cell:hover { transform: scale(1.1); z-index: 10; }
        .heatmap-cell.empty { background: #374151; color: var(--text-muted); }
        .heatmap-cell.low { background: #ef4444; color: white; }
        .heatmap-cell.medium { background: #f59e0b; color: white; }
        .heatmap-cell.high { background: #10b981; color: white; }
        .heatmap-cell.very-high { background: #22c55e; color: white; }

        .tooltip {
            position: absolute; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 0.75rem; font-size: 0.9rem;
            color: var(--text-primary); box-shadow: var(--shadow-lg);
            pointer-events: none; z-index: 1000; opacity: 0; transition: all var(--transition);
        }

        .tooltip.show { opacity: 1; }

        /* NUOVE FUNZIONALIT√Ä */
        .semester-badges {
            display: flex; gap: 0.5rem; margin-top: 0.5rem;
        }

        .semester-badge {
            padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
            background: rgba(139, 92, 246, 0.2); color: var(--primary-light);
        }

        .score-explanation {
            background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px; padding: 1rem; margin: 1rem 0; cursor: pointer;
            transition: all var(--transition);
        }

        .score-explanation:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .search-filter {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem;
        }

        .filter-chips {
            display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;
        }

        .filter-chip {
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            background: var(--bg-card); border: 1px solid var(--border); cursor: pointer;
            transition: all var(--transition);
        }

        .filter-chip:hover { background: var(--primary); color: white; }
        .filter-chip.active { background: var(--primary); color: white; }

        .notification-banner {
            position: fixed; top: 80px; right: 20px; max-width: 400px;
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white; padding: 1rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl); z-index: 10000; transform: translateX(100%);
            transition: all var(--transition);
        }

        .notification-banner.show { transform: translateX(0); }

        .backup-indicator {
            position: fixed; bottom: 20px; right: 20px; padding: 0.5rem 1rem;
            background: var(--success); color: white; border-radius: 20px;
            font-size: 0.8rem; font-weight: 600; opacity: 0; transition: all var(--transition);
        }

        .backup-indicator.show { opacity: 1; }

        /* Utilit√† */
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 1rem; }
        .flex { display: flex; }
        .gap-2 { gap: 1rem; }
        .required { color: var(--danger); }

        /* Animazioni migliorate */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up { animation: fadeInUp 0.6s ease; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üöÄ Piano Studio Smart AI Pro v2.1</h1>
            <p>Il tuo assistente intelligente anti-procrastinazione con gestione esami completa - Universit√† di Napoli Vanvitelli</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-container">
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()">‚ò∞ Menu</button>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('oggi', this)">üåÖ Oggi</button>
                <button class="nav-tab" onclick="showSection('materie', this)">üìñ Materie</button>
                <button class="nav-tab" onclick="showSection('curriculum', this)">üéì Curriculum</button>
                <button class="nav-tab" onclick="showSection('esami', this)">üìä Esami</button>
                <button class="nav-tab" onclick="showSection('piano', this)">üìã Piano</button>
                <button class="nav-tab" onclick="showSection('pomodoro', this)">üçÖ Pomodoro</button>
                <button class="nav-tab" onclick="showSection('calendario', this)">üìÖ Calendario</button>
                <button class="nav-tab" onclick="showSection('statistiche', this)">üìà Statistiche</button>
                <button class="nav-tab" onclick="showSection('helper', this)">üéØ Helper</button>
                <button class="nav-tab" onclick="showSection('impostazioni', this)">‚öôÔ∏è Impostazioni</button>
            </div>
            <div class="nav-dropdown" id="navDropdown">
                <button class="nav-tab" onclick="showSection('oggi', this); closeMobileNav()">üåÖ Oggi</button>
                <button class="nav-tab" onclick="showSection('materie', this); closeMobileNav()">üìñ Materie</button>
                <button class="nav-tab" onclick="showSection('curriculum', this); closeMobileNav()">üéì Curriculum</button>
                <button class="nav-tab" onclick="showSection('esami', this); closeMobileNav()">üìä Esami</button>
                <button class="nav-tab" onclick="showSection('piano', this); closeMobileNav()">üìã Piano</button>
                <button class="nav-tab" onclick="showSection('pomodoro', this); closeMobileNav()">üçÖ Pomodoro</button>
                <button class="nav-tab" onclick="showSection('calendario', this); closeMobileNav()">üìÖ Calendario</button>
                <button class="nav-tab" onclick="showSection('statistiche', this); closeMobileNav()">üìà Statistiche</button>
                <button class="nav-tab" onclick="showSection('helper', this); closeMobileNav()">üéØ Helper</button>
                <button class="nav-tab" onclick="showSection('impostazioni', this); closeMobileNav()">‚öôÔ∏è Impostazioni</button>
            </div>
        </nav>

        <!-- Notification Banner -->
        <div class="notification-banner" id="notificationBanner">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 700;">üìÖ Promemoria Esame</div>
                    <div id="notificationText">Hai un esame tra 7 giorni!</div>
                </div>
                <button onclick="hideNotification()" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">√ó</button>
            </div>
        </div>

        <!-- Backup Indicator -->
        <div class="backup-indicator" id="backupIndicator">
            üíæ Backup automatico salvato
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sezione OGGI -->
            <section id="oggi" class="section active">
                <div class="card fade-in-up">
                    <h3>üåÖ Il Tuo Piano di Oggi</h3>
                    
                    <div id="smartPlanningAlert" class="card hidden" style="background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; margin-bottom: 2rem;">
                        <h4>ü§ñ Pianificazione Intelligente Attiva</h4>
                        <p id="smartPlanningMessage">Il sistema sta ottimizzando il tuo piano di studio.</p>
                    </div>

                    <div id="recoveryDashboard" class="card hidden" style="background: linear-gradient(135deg, var(--warning), #d97706); color: white; margin-bottom: 2rem;">
                        <h4>üìä Stato Recupero</h4>
                        <div>Tempo da recuperare: <span id="missedTime">0h 0min</span></div>
                        <button class="btn btn-warning mt-2" onclick="showRecoveryOptions()">üîß Modifica Piano</button>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: var(--border-radius); padding: 2rem; margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">üî• PROSSIMO TASK:</h4>
                        <div id="taskCorrente" style="background: var(--bg-secondary); border-radius: var(--border-radius); padding: 1.5rem;">
                            <div class="flex gap-2" style="margin-bottom: 1rem; align-items: flex-start; flex-wrap: wrap;">
                                <span id="currentTaskMateria" style="font-size: 1.3rem; font-weight: 700; flex: 1; min-width: 200px;">Nessun task programmato</span>
                                <span id="currentTaskTime" style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">‚è±Ô∏è -- min</span>
                            </div>
                            <div id="currentTaskDesc" style="font-size: 1.1rem; margin-bottom: 1rem;">
                                Aggiungi delle materie per iniziare a studiare in modo intelligente!
                            </div>
                            <div id="currentTaskMotivation" style="background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                üí° Il sistema pianificher√† automaticamente le tue sessioni di studio
                            </div>

                            <div id="taskOptions" class="hidden">
                                <h5>üéØ Cosa vuoi fare specificamente?</h5>
                                <div id="taskOptionsList"></div>
                            </div>

                            <button class="btn btn-primary" onclick="iniziaTask()" id="startTaskBtn" disabled>üöÄ Inizia Subito</button>
                        </div>
                    </div>

                    <div id="microTasks" class="hidden" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--secondary); margin-bottom: 1rem;">‚ö° Task Micro (Anti-Procrastinazione)</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Inizia con qualcosa di facile per creare momentum:</p>
                        <div id="microTasksList"></div>
                    </div>

                    <div>
                        <h4 style="color: var(--primary-light);">üìã Programma Completo di Oggi:</h4>
                        <div id="timelineOggi" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--border-radius); padding: 1.5rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÖ</div>
                                <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Materie -->
            <section id="materie" class="section">
                <div class="card" style="background: linear-gradient(135deg, var(--accent), #d97706); color: white; text-align: center;">
                    <h3 style="margin-bottom: 1rem;">üî• Studio Streak</h3>
                    <div id="streakNumber" style="font-size: clamp(3rem, 8vw, 4rem); font-weight: 800;">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <!-- Filtri e Ricerca -->
                <div class="search-filter fade-in-up">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="searchMateria">üîç Cerca Materia</label>
                            <input type="text" id="searchMateria" placeholder="Cerca per nome..." onkeyup="filterMaterie()">
                        </div>
                        <div class="form-group">
                            <label>üìä Filtra per Status</label>
                            <div class="filter-chips">
                                <div class="filter-chip active" onclick="toggleFilter('all', this)">Tutte</div>
                                <div class="filter-chip" onclick="toggleFilter('studio', this)">In Studio</div>
                                <div class="filter-chip" onclick="toggleFilter('completato', this)">Completate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>‚ûï Aggiungi Nuova Materia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anno">Anno <span class="required">*</span></label>
                            <select id="anno" required>
                                <option value="">Seleziona Anno</option>
                                <option value="1">1¬∞ Anno</option>
                                <option value="2">2¬∞ Anno</option>
                                <option value="3">3¬∞ Anno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="semestre">Semestre <span class="required">*</span></label>
                            <select id="semestre" required>
                                <option value="">Seleziona Semestre</option>
                                <option value="1">I Semestre</option>
                                <option value="2">II Semestre</option>
                                <option value="annuale">Annuale (Entrambi i Semestri)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagine">Pagine Totali <span class="required">*</span></label>
                            <input type="number" id="pagine" min="1" required placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="pagineStudiate">Pagine gi√† Studiate</label>
                            <input type="number" id="pagineStudiate" min="0" value="0" placeholder="Es. 120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineOra">Pagine per Ora</label>
                            <input type="number" id="pagineOra" min="1" max="50" value="8" placeholder="Es. 8">
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorit√†</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficolt√† Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1">‚òÖ</span>
                                <span class="star" data-rating="2">‚òÖ</span>
                                <span class="star" data-rating="3">‚òÖ</span>
                                <span class="star" data-rating="4">‚òÖ</span>
                                <span class="star" data-rating="5">‚òÖ</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‚è∞ Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Definisci gli slot orari in cui puoi studiare questa materia
                        </p>
                        <div id="weeklySlots" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;"></div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addMateria()">‚úÖ Aggiungi Materia</button>
                </div>

                <div class="card fade-in-up">
                    <h3>üìö Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìö</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Curriculum -->
            <section id="curriculum" class="section">
                <div class="flex gap-2 mb-2" style="align-items: center; flex-wrap: wrap;">
                    <div style="background: var(--bg-tertiary); border-radius: var(--border-radius); padding: 4px; border: 1px solid var(--border);">
                        <button class="nav-tab active" onclick="showCurriculumYear(1, this)">1¬∞ Anno</button>
                        <button class="nav-tab" onclick="showCurriculumYear(2, this)">2¬∞ Anno</button>
                        <button class="nav-tab" onclick="showCurriculumYear(3, this)">3¬∞ Anno</button>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="showAddSubjectModal()">‚ûï Aggiungi</button>
                    <button class="btn btn-secondary btn-small" onclick="exportCurriculumData()">üì§ Esporta</button>
                </div>

                <div id="curriculumContainer">
                    <div id="year-1" class="year-content active">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>üéì Primo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year1-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year1-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year1-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö I Semestre</h4>
                                    <div id="year1-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö II Semestre</h4>
                                    <div id="year1-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">üìÖ Annuali</h4>
                                    <div id="year1-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="year-2" class="year-content hidden">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>üéì Secondo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year2-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year2-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year2-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö I Semestre</h4>
                                    <div id="year2-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö II Semestre</h4>
                                    <div id="year2-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">üìÖ Annuali</h4>
                                    <div id="year2-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="year-3" class="year-content hidden">
                        <div class="card fade-in-up">
                            <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                                <h3>üéì Terzo Anno</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--secondary);" id="year3-subjects">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Materie</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--warning);" id="year3-cfu">0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">CFU</div>
                                    </div>
                                    <div class="stat-card" style="min-width: 80px; padding: 1rem;">
                                        <div class="stat-number" style="font-size: 1.5rem; color: var(--primary);" id="year3-average">0.0</div>
                                        <div class="stat-label" style="font-size: 0.7rem;">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö I Semestre</h4>
                                    <div id="year3-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìö II Semestre</h4>
                                    <div id="year3-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia aggiunta</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">üìÖ Annuali</h4>
                                    <div id="year3-annuale-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìñ</div>
                                            <p>Nessuna materia annuale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Esami -->
            <section id="esami" class="section">
                <div class="card fade-in-up">
                    <h3>üìä Statistiche Esami</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="totalExams">0</div>
                            <div class="stat-label">Esami Sostenuti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="totalCFU">0</div>
                            <div class="stat-label">CFU Acquisiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);" id="weightedAverage">0.00</div>
                            <div class="stat-label">Media Ponderata</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="projectedGrade">0</div>
                            <div class="stat-label">Voto Laurea Est.</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>üéì Esami Sostenuti</h3>
                    <div id="examsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üéì</div>
                            <p>Nessun esame sostenuto ancora.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Piano -->
            <section id="piano" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                    <h4>üéØ Piano di Studio Intelligente</h4>
                    <p id="planSummary">Caricamento piano personalizzato...</p>
                    
                    <!-- Spiegazione Score -->
                    <div class="score-explanation" onclick="toggleScoreExplanation()" style="margin: 1.5rem 0; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h5 style="margin: 0; color: white;">üßÆ Come Funziona lo Score Intelligente?</h5>
                            <span id="scoreToggleIcon" style="color: white; font-size: 1.2rem;">‚ñº</span>
                        </div>
                        <div id="scoreExplanationDetails" class="hidden" style="margin-top: 1rem; font-size: 0.9rem; line-height: 1.5;">
                            <p><strong>Lo Score rappresenta l'urgenza e importanza di una materia:</strong></p>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li><strong>Giorni all'esame:</strong> Pi√π √® vicino l'esame, pi√π sale lo score (max 40 punti)</li>
                                <li><strong>Priorit√†:</strong> Alta=25pt, Media=15pt, Bassa=5pt</li>
                                <li><strong>Difficolt√†:</strong> Ogni stella aggiunge 4 punti</li>
                                <li><strong>CFU:</strong> Pi√π CFU = pi√π importante (max 15 punti)</li>
                                <li><strong>Progresso:</strong> Materie poco avanzate hanno bonus priorit√†</li>
                            </ul>
                            <p><strong>Score pi√π alto = Studiare per primo! üéØ</strong></p>
                        </div>
                    </div>
                    
                    <div class="stats-grid mt-2">
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="totalWeeklyHours" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0h</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Ore Settimanali</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="avgDailyHours" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0h</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Media Giornaliera</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="totalPages" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Pagine Rimanenti</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
                            <div id="completionWeeks" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem;">0</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Settimane Stimate</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up" style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3);">
                    <h3 style="color: var(--secondary);">ü§ñ Suggerimenti AI</h3>
                    <div id="suggestionsList">
                        <div style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem;">
                            <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">üí° Analizzando i tuoi dati...</div>
                            <div style="color: var(--text-primary);">Il sistema sta elaborando raccomandazioni personalizzate.</div>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>üìã Dettagli Piano</h3>
                    <div id="pianDetails">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Aggiungi delle materie per generare il tuo piano personalizzato!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Pomodoro -->
            <section id="pomodoro" class="section">
                <div class="card fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border);">
                    <h4>üéØ Obiettivo Giornaliero</h4>
                    <div class="flex gap-2" style="align-items: center; margin-top: 1rem; flex-wrap: wrap;">
                        <label for="dailyGoal" style="margin: 0;">Pomodori da completare oggi:</label>
                        <input type="number" id="dailyGoal" style="width: 100px; text-align: center;" min="1" max="20" value="8" onchange="updateDailyGoal()">
                        <span style="color: var(--text-secondary);">sessioni</span>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <div style="text-align: center;">
                        <h3>üçÖ Timer Pomodoro</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin: 2rem 0;">
                            <button class="btn btn-secondary active" onclick="setPreset(25, 5, this)">25/5 min</button>
                            <button class="btn btn-secondary" onclick="setPreset(50, 10, this)">50/10 min</button>
                            <button class="btn btn-secondary" onclick="setPreset(90, 20, this)">90/20 min</button>
                            <button class="btn btn-secondary" onclick="showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="flex gap-2" style="justify-content: center; margin-bottom: 3rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="startBtn" onclick="startTimer()">‚ñ∂Ô∏è Inizia</button>
                            <button class="btn btn-warning hidden" id="pauseBtn" onclick="pauseTimer()">‚è∏Ô∏è Pausa</button>
                            <button class="btn btn-danger" onclick="resetTimer()">üîÑ Reset</button>
                        </div>

                        <div>
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small id="progressText" style="color: var(--text-secondary);">Inizia la tua prima sessione!</small>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <div class="flex gap-2 mb-2" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <h3 style="margin: 0;">üìä Tutte le Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="showDeleteAllTodaySessionsModal()">üóëÔ∏è Elimina tutte</button>
                    </div>
                    
                    <div id="allTodaySessionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üçÖ</div>
                            <p>Nessuna sessione completata oggi.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Calendario -->
            <section id="calendario" class="section">
                <div class="card fade-in-up">
                    <h3>üìÖ Navigazione Calendario</h3>
                    <div class="flex gap-2" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div class="flex gap-2" style="align-items: center;">
                            <button class="btn btn-secondary btn-small" onclick="changeMonth(-1)">‚óÄ Prec</button>
                            <h4 id="currentMonthYear" style="margin: 0; min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary btn-small" onclick="changeMonth(1)">Succ ‚ñ∂</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary btn-small" onclick="goToToday()">üìç Oggi</button>
                            <button class="btn btn-warning btn-small" onclick="addManualSession()">‚ûï Sessione</button>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <div style="background: var(--bg-card); border-radius: var(--border-radius-lg); overflow: hidden; box-shadow: var(--shadow-lg); border: 1px solid var(--border);">
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Lun</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Mar</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Mer</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Gio</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Ven</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Sab</div>
                            <div style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; color: var(--primary-light);">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>üìä Statistiche del Mese</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary-light);" id="monthSessions">0</div>
                            <div class="stat-label">Sessioni Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="monthHours">0h</div>
                            <div class="stat-label">Ore di Studio</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="monthDays">0</div>
                            <div class="stat-label">Giorni Attivi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent);" id="monthAverage">0</div>
                            <div class="stat-label">Media/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Statistiche -->
            <section id="statistiche" class="section">
                <div class="card fade-in-up">
                    <h3>üìä Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>üî• Heatmap Oraria della Produttivit√†</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Visualizza i tuoi momenti pi√π produttivi durante la giornata
                    </p>
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                    <div class="flex gap-2" style="justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #374151; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Nessun dato</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Bassa</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Media</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #10b981; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Alta</span>
                        </div>
                        <div class="flex gap-2" style="align-items: center;">
                            <div style="width: 16px; height: 16px; background: #22c55e; border-radius: 4px;"></div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">Eccellente</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <h4 style="margin-bottom: 1rem;">üèÜ Le Tue Top 3 Ore Migliori</h4>
                        <div id="topHoursGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                                <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                            </div>
                        </div>
                        
                        <div id="productivitySuggestion" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 1.5rem;">
                            <h4 style="color: var(--primary-light); margin-bottom: 0.75rem;">üí° Suggerimento Smart</h4>
                            <p style="color: var(--text-primary);">Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi√π produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Helper -->
            <section id="helper" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--accent), #d97706); color: white;">
                    <h3>üéØ Assistente Organizzazione Semestre</h3>
                    <p style="margin-bottom: 1.5rem; opacity: 0.9;">Non sai come organizzarti? Lascia che ti guidi nella pianificazione!</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                        <div onclick="prioritizeByDate()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">üìÖ Priorit√† per Scadenze</h4>
                            <p style="opacity: 0.9;">Ordina le materie in base alle date degli esami</p>
                        </div>
                        
                        <div onclick="prioritizeByDifficulty()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">‚≠ê Priorit√† per Difficolt√†</h4>
                            <p style="opacity: 0.9;">Inizia dalle materie pi√π difficili</p>
                        </div>
                        
                        <div onclick="balancedApproach()" style="background: rgba(255, 255, 255, 0.1); padding: 1.5rem; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition); border: 2px solid transparent;">
                            <h4 style="margin-bottom: 0.5rem;">‚öñÔ∏è Approccio Bilanciato</h4>
                            <p style="opacity: 0.9;">Mix intelligente tra scadenze e difficolt√†</p>
                        </div>
                    </div>
                </div>

                <div class="card hidden fade-in-up" id="helperResults">
                    <h3>üìã Piano Raccomandato</h3>
                    <div id="helperContent"></div>
                </div>
            </section>

            <!-- Sezione Impostazioni -->
            <section id="impostazioni" class="section">
                <div class="card fade-in-up" style="background: linear-gradient(135deg, var(--danger), #dc2626); color: white; text-align: center;">
                    <h3>‚öôÔ∏è Impostazioni App</h3>
                    <p style="margin-bottom: 1.5rem;">Gestisci i dati dell'applicazione e le configurazioni</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                        <button onclick="exportAllData()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            üì§ Esporta Dati
                        </button>
                        <button onclick="importAllData()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            üì• Importa Dati
                        </button>
                        <button onclick="showResetConfirmation()" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all var(--transition);">
                            üóëÔ∏è Reset Completo
                        </button>
                    </div>
                </div>

                <div class="card fade-in-up">
                    <h3>üîß Preferenze App</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="autoBackup">üíæ Backup Automatico</label>
                            <select id="autoBackup" onchange="updateAutoBackup()">
                                <option value="disabled">Disabilitato</option>
                                <option value="daily" selected>Giornaliero</option>
                                <option value="weekly">Settimanale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examNotifications">üîî Notifiche Esami</label>
                            <select id="examNotifications" onchange="updateExamNotifications()">
                                <option value="disabled">Disabilitate</option>
                                <option value="7days" selected>7 giorni prima</option>
                                <option value="3days">3 giorni prima</option>
                                <option value="1day">1 giorno prima</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="ratingModal">
        <div style="background: var(--bg-card); border-radius: 20px; padding: 3rem 2rem; max-width: 500px; width: 90%; box-shadow: var(--shadow-xl); text-align: center;">
            <h3 style="color: var(--primary-light); font-size: 1.8rem; margin-bottom: 1rem;">üéâ Sessione Completata!</h3>
            
            <!-- MIGLIORAMENTO: Tipo di sessione -->
            <div id="sessionTypeStep" style="margin-bottom: 2rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Che tipo di sessione hai fatto?</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button id="studySessionBtn" onclick="selectSessionType('study')" style="padding: 1.5rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all var(--transition); color: var(--text-primary);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</div>
                        <div style="font-weight: 600;">Studio</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Nuovi argomenti/esercizi</div>
                    </button>
                    <button id="reviewSessionBtn" onclick="selectSessionType('review')" style="padding: 1.5rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all var(--transition); color: var(--text-primary);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîÑ</div>
                        <div style="font-weight: 600;">Ripasso</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Revisione argomenti</div>
                    </button>
                </div>
            </div>

            <!-- MIGLIORAMENTO: Progress tracking per sessioni di studio -->
            <div id="progressStep" class="hidden" style="margin-bottom: 2rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Cosa hai fatto durante la sessione?</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <button id="pagesStudyBtn" onclick="selectProgressType('pages')" style="padding: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all var(--transition); color: var(--text-primary);">
                        <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üìñ</div>
                        <div style="font-weight: 600; font-size: 0.9rem;">Pagine Studiate</div>
                    </button>
                    <button id="exercisesBtn" onclick="selectProgressType('exercises')" style="padding: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all var(--transition); color: var(--text-primary);">
                        <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üí™</div>
                        <div style="font-weight: 600; font-size: 0.9rem;">Esercizi Fatti</div>
                    </button>
                </div>

                <div id="pagesInput" class="hidden form-group">
                    <label for="studiedPages">Quante pagine hai studiato?</label>
                    <input type="number" id="studiedPages" min="0" max="100" placeholder="es. 5" style="text-align: center;">
                </div>

                <div id="exercisesInput" class="hidden form-group">
                    <label for="exercisesDone">Quanti esercizi hai fatto?</label>
                    <input type="number" id="exercisesDone" min="0" max="50" placeholder="es. 3" style="text-align: center;">
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">Ogni esercizio vale circa 1 pagina di studio</small>
                </div>
            </div>

            <!-- Rating e note -->
            <div id="ratingStep" class="hidden">
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Come ti senti dopo questa sessione?</p>
                
                <div class="form-group">
                    <label for="sessionNote">üìù Note (opzionale):</label>
                    <input type="text" id="sessionNote" placeholder="Es. Ho studiato il capitolo 3..." style="margin-bottom: 1rem;">
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div onclick="submitRating(1)" style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1.5rem 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: var(--border-radius-lg); cursor: pointer; transition: all var(--transition);">
                        <div style="font-size: 2.5rem;">üò¥</div>
                        <div style="font-weight: 600; color: #9ca3af;">Stanco</div>
                    </div>
                    <div onclick="submitRating(2)" style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1.5rem 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: var(--border-radius-lg); cursor: pointer; transition: all var(--transition);">
                        <div style="font-size: 2.5rem;">üòê</div>
                        <div style="font-weight: 600; color: var(--warning);">Normale</div>
                    </div>
                    <div onclick="submitRating(3)" style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1.5rem 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: var(--border-radius-lg); cursor: pointer; transition: all var(--transition);">
                        <div style="font-size: 2.5rem;">üòä</div>
                        <div style="font-weight: 600; color: var(--secondary);">Bene</div>
                    </div>
                    <div onclick="submitRating(4)" style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem; padding: 1.5rem 1rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: var(--border-radius-lg); cursor: pointer; transition: all var(--transition);">
                        <div style="font-size: 2.5rem;">üî•</div>
                        <div style="font-weight: 600; color: var(--success);">Eccellente</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Timer Personalizzato -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3>‚öôÔ∏è Timer Personalizzato</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="customWorkTime">Minuti di Studio:</label>
                    <input type="number" id="customWorkTime" min="1" max="180" value="25" placeholder="25">
                </div>
                <div class="form-group">
                    <label for="customBreakTime">Minuti di Pausa:</label>
                    <input type="number" id="customBreakTime" min="0" max="60" value="5" placeholder="5">
                </div>
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-primary" onclick="applyCustomTimer()">‚úÖ Applica</button>
                <button class="btn btn-secondary" onclick="closeCustomTimerModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Dettagli Giorno -->
    <div class="modal-overlay" id="dayDetailModal">
        <div class="modal modal-large">
            <h3 id="dayDetailTitle">üìÖ Dettagli del Giorno</h3>
            
            <div class="mb-2">
                <button class="btn btn-primary btn-small" onclick="addSessionToDay()">‚ûï Aggiungi Sessione</button>
            </div>
            
            <div id="daySessionsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <p>Nessuna sessione per questo giorno.</p>
                </div>
            </div>
            
            <div class="mt-2">
                <button class="btn btn-secondary" onclick="closeDayDetailModal()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <h3>‚ûï Aggiungi Materia al Curriculum</h3>
            <div class="form-group">
                <label for="currSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="currSubjectName" required placeholder="Es. Analisi Matematica I">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectYear">Anno <span class="required">*</span></label>
                    <select id="currSubjectYear" required>
                        <option value="1">1¬∞ Anno</option>
                        <option value="2">2¬∞ Anno</option>
                        <option value="3">3¬∞ Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="currSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                        <option value="annuale">Annuale (Entrambi)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="currSubjectCFU">CFU <span class="required">*</span></label>
                <input type="number" id="currSubjectCFU" min="1" max="30" required placeholder="Es. 9">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-primary" onclick="saveCurriculumSubject()">‚úÖ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSubjectModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="examModal">
        <div class="modal">
            <h3>üéì Registra Esame Sostenuto</h3>
            <div class="form-group">
                <label for="examSubject">Materia:</label>
                <input type="text" id="examSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="examGrade">Voto (18-30):</label>
                    <input type="number" id="examGrade" min="18" max="30" placeholder="30">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="examLode"> Lode
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="examDate">Data Esame:</label>
                <input type="date" id="examDate">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-success" onclick="saveExamGrade()">‚úÖ Salva</button>
                <button class="btn btn-secondary" onclick="closeExamModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addSessionModal">
        <div class="modal">
            <h3>‚ûï Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sessionMateria">Materia:</label>
                    <select id="sessionMateria">
                        <option value="">Sessione generica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionDuration">Durata (minuti):</label>
                    <input type="number" id="sessionDuration" min="5" max="300" value="25">
                </div>
            </div>
            <div class="form-group">
                <label for="sessionNote">Note (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Capitolo 3 - Derivate">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-primary" onclick="saveManualSession()">‚úÖ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSessionModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetConfirmationModal">
        <div class="modal">
            <h3>‚ö†Ô∏è Conferma Reset Completo</h3>
            <div style="text-align: center; margin: 2rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
                <p style="margin-bottom: 1rem;"><strong>ATTENZIONE:</strong> Eliminerai TUTTI i dati dell'app!</p>
                <p style="color: var(--danger); font-weight: 600;">Questa azione NON pu√≤ essere annullata!</p>
            </div>
            <div class="form-group">
                <label for="resetConfirmText">Scrivi "RESET" per confermare:</label>
                <input type="text" id="resetConfirmText" placeholder="RESET" style="text-align: center; text-transform: uppercase;">
            </div>
            <div class="flex gap-2 mt-2">
                <button class="btn btn-danger" onclick="performCompleteReset()">üóëÔ∏è Reset</button>
                <button class="btn btn-secondary" onclick="closeResetConfirmationModal()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <div class="tooltip" id="heatmapTooltip"></div>

    <script>
        // === STATO GLOBALE ===
        const APP = {
            materie: JSON.parse(localStorage.getItem('materie')) || [],
            esami: JSON.parse(localStorage.getItem('esami')) || [],
            curriculum: JSON.parse(localStorage.getItem('curriculum')) || [],
            currentCalendarDate: new Date(),
            calendarSessions: JSON.parse(localStorage.getItem('calendarSessions')) || {},
            sessionRatings: JSON.parse(localStorage.getItem('sessionRatings')) || {},
            difficoltaSelezionata: 3,
            timerInterval: null,
            selectedTaskOption: null,
            currentSessionStartTime: null,
            currentSessionData: null,
            currentEditingExamId: null,
            currentCurriculumYear: 1,
            currentDayDetailDate: null,
            mobileNavOpen: false,
            currentFilter: 'all',
            autoBackupEnabled: localStorage.getItem('autoBackup') !== 'disabled',
            
            // MIGLIORAMENTO: Nuove variabili per tracking progresso
            sessionType: null, // 'study' o 'review'
            progressType: null, // 'pages' o 'exercises'
            
            universalMicroTasks: [
                { text: "üìñ Leggi il sommario del primo capitolo", durata: 5 },
                { text: "‚úèÔ∏è Scrivi 3 concetti che gi√† conosci", durata: 3 },
                { text: "üìù Prepara il materiale di studio", durata: 2 },
                { text: "üéØ Definisci 1 obiettivo per oggi", durata: 2 },
                { text: "üìä Controlla il tuo progresso", durata: 3 },
                { text: "üîç Cerca 1 video introduttivo", durata: 5 },
                { text: "üìã Crea una lista di 3 domande", durata: 4 },
                { text: "‚ö° Fai 10 respiri profondi", durata: 1 }
            ],

            timerState: {
                minutes: 25, seconds: 0, isRunning: false, isBreak: false,
                workTime: 25, breakTime: 5,
                sessionsToday: parseInt(localStorage.getItem('sessionsToday')) || 0,
                lastSessionDate: localStorage.getItem('lastSessionDate') || '',
                dailyGoal: parseInt(localStorage.getItem('dailyGoal')) || 8
            },

            studyData: {
                streak: parseInt(localStorage.getItem('studyStreak')) || 0,
                lastStudyDate: localStorage.getItem('lastStudyDate') || '',
                totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
                missedTime: parseInt(localStorage.getItem('missedTime')) || 0
            },

            todayDetailedSessions: JSON.parse(localStorage.getItem('todayDetailedSessions')) || []
        };

        // === UTILITIES ===
        const Utils = {
            showSuccessMessage(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
                    color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow-xl);
                    z-index: 10000; font-weight: 600; max-width: 400px; animation: slideIn 0.4s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.4s ease';
                    setTimeout(() => document.body.removeChild(toast), 400);
                }, 4000);
                
                if (!document.getElementById('toast-styles')) {
                    const style = document.createElement('style');
                    style.id = 'toast-styles';
                    style.textContent = `
                        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
                    `;
                    document.head.appendChild(style);
                }
            },

            calculateTaskDuration(inizio, fine) {
                const start = new Date(`1970-01-01T${inizio}:00`);
                const end = new Date(`1970-01-01T${fine}:00`);
                return Math.round((end - start) / (1000 * 60));
            },

            getDaysToExam(dataEsame) {
                if (!dataEsame) return null;
                const today = new Date();
                const examDate = new Date(dataEsame);
                const diffTime = examDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            formatTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}h ${mins}min` : `${mins}min`;
            },

            // ALGORITMO DI PRIORIT√Ä MIGLIORATO
            calculateSmartPriority(materia) {
                let score = 0;
                let explanations = [];
                
                // 1. URGENZA ESAME (peso maggiore)
                const daysToExam = this.getDaysToExam(materia.dataEsame);
                if (daysToExam !== null) {
                    if (daysToExam <= 3) {
                        score += 50;
                        explanations.push("üö® URGENTISSIMO: Esame tra 3 giorni!");
                    } else if (daysToExam <= 7) {
                        score += 45;
                        explanations.push("üî• URGENTE: Esame entro una settimana");
                    } else if (daysToExam <= 14) {
                        score += 35;
                        explanations.push("‚ö° Esame tra 2 settimane");
                    } else if (daysToExam <= 30) {
                        score += 25;
                        explanations.push("üìÖ Esame entro un mese");
                    } else if (daysToExam <= 60) {
                        score += 15;
                        explanations.push("üìÜ Esame tra 1-2 mesi");
                    } else {
                        score += 5;
                        explanations.push("üóìÔ∏è Esame ancora lontano");
                    }
                }
                
                // 2. PRIORIT√Ä MANUALE
                const priorityMap = { 'alta': 25, 'media': 15, 'bassa': 5 };
                const priorityScore = priorityMap[materia.priorita] || 15;
                score += priorityScore;
                explanations.push(`üéØ Priorit√† ${materia.priorita}: +${priorityScore}pt`);
                
                // 3. DIFFICOLT√Ä PERCEPITA
                const difficultyScore = (materia.difficolta || 3) * 4;
                score += difficultyScore;
                explanations.push(`‚≠ê Difficolt√† ${materia.difficolta}/5: +${difficultyScore}pt`);
                
                // 4. IMPORTANZA CFU
                const cfuScore = Math.min(materia.cfu * 1.5, 15);
                score += cfuScore;
                explanations.push(`üìö ${materia.cfu} CFU: +${Math.round(cfuScore)}pt`);
                
                // 5. PROGRESSO MATERIA
                const progress = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                let progressScore = 0;
                if (progress < 10) {
                    progressScore = 12;
                    explanations.push("üöÄ Materia da iniziare: +12pt");
                } else if (progress > 80) {
                    progressScore = 10;
                    explanations.push("üèÅ Quasi completata: +10pt");
                } else if (progress < 30) {
                    progressScore = 8;
                    explanations.push("üìà Inizio promettente: +8pt");
                } else {
                    progressScore = 5;
                    explanations.push("‚öñÔ∏è Progresso normale: +5pt");
                }
                score += progressScore;
                
                // 6. DISPONIBILIT√Ä SLOT TEMPORALI
                let slotsCount = 0;
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slotsCount += slots.length;
                    });
                }
                if (slotsCount > 0) {
                    const slotScore = Math.min(slotsCount * 2, 8);
                    score += slotScore;
                    explanations.push(`‚è∞ ${slotsCount} slot disponibili: +${slotScore}pt`);
                }
                
                const result = {
                    score: Math.round(score),
                    explanations: explanations,
                    category: this.getScoreCategory(score)
                };
                
                return result.score; // Manteniamo compatibilit√†
            },
            
            getScoreCategory(score) {
                if (score >= 80) return { name: "MASSIMA", color: "#ef4444", icon: "üö®" };
                if (score >= 60) return { name: "ALTA", color: "#f59e0b", icon: "üî•" };
                if (score >= 40) return { name: "MEDIA", color: "#8b5cf6", icon: "üìà" };
                if (score >= 20) return { name: "BASSA", color: "#06d6a0", icon: "üìö" };
                return { name: "MINIMA", color: "#64748b", icon: "üí§" };
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // MIGLIORAMENTO: Correzione bug data calendario
            formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            parseDateFromInput(dateString) {
                // Assicurati che la data sia interpretata come locale, non UTC
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
        };

        // === NOTIFICAZIONI E BACKUP ===
        const NotificationManager = {
            checkUpcomingExams() {
                const examSettings = localStorage.getItem('examNotifications') || '7days';
                if (examSettings === 'disabled') return;
                
                // CORREZIONE: Controlla se la notifica √® gi√† stata mostrata oggi
                const today = new Date().toDateString();
                const lastNotificationDate = localStorage.getItem('lastNotificationDate');
                if (lastNotificationDate === today) return;
                
                const daysThreshold = {
                    '1day': 1,
                    '3days': 3,
                    '7days': 7
                }[examSettings] || 7;
                
                const upcomingExams = APP.materie.filter(materia => {
                    if (materia.status === 'completato' || !materia.dataEsame) return false;
                    const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                    return daysToExam > 0 && daysToExam <= daysThreshold;
                });
                
                if (upcomingExams.length > 0) {
                    const closestExam = upcomingExams.sort((a, b) => 
                        Utils.getDaysToExam(a.dataEsame) - Utils.getDaysToExam(b.dataEsame)
                    )[0];
                    
                    const daysLeft = Utils.getDaysToExam(closestExam.dataEsame);
                    this.showExamNotification(closestExam.nome, daysLeft);
                    
                    // Salva che abbiamo mostrato la notifica oggi
                    localStorage.setItem('lastNotificationDate', today);
                }
            },
            
            showExamNotification(subjectName, daysLeft) {
                const banner = document.getElementById('notificationBanner');
                const text = document.getElementById('notificationText');
                
                if (banner && text) {
                    text.textContent = `${subjectName} - ${daysLeft} ${daysLeft === 1 ? 'giorno' : 'giorni'} rimanenti!`;
                    banner.classList.add('show');
                    
                    // MIGLIORAMENTO: Auto-hide dopo 15 secondi invece di 10
                    setTimeout(() => {
                        banner.classList.remove('show');
                    }, 15000);
                }
            }
        };

        const BackupManager = {
            performAutoBackup() {
                if (!APP.autoBackupEnabled) return;
                
                try {
                    const backupData = {
                        materie: APP.materie,
                        esami: APP.esami,
                        curriculum: APP.curriculum,
                        calendarSessions: APP.calendarSessions,
                        sessionRatings: APP.sessionRatings,
                        backupDate: new Date().toISOString(),
                        version: '2.1'
                    };
                    
                    localStorage.setItem('autoBackup', JSON.stringify(backupData));
                    this.showBackupIndicator();
                } catch (error) {
                    console.error('Errore backup automatico:', error);
                }
            },
            
            showBackupIndicator() {
                const indicator = document.getElementById('backupIndicator');
                if (indicator) {
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
            }
        };

        // === FILTRI E RICERCA ===
        function filterMaterie() {
            const searchTerm = document.getElementById('searchMateria').value.toLowerCase();
            const materieItems = document.querySelectorAll('.subject-item');
            
            materieItems.forEach(item => {
                const materiaName = item.querySelector('div[style*="font-size: 1.3rem"]')?.textContent.toLowerCase() || '';
                const matchesSearch = materiaName.includes(searchTerm);
                const matchesFilter = APP.currentFilter === 'all' || 
                    (APP.currentFilter === 'studio' && !item.classList.contains('exam-completed')) ||
                    (APP.currentFilter === 'completato' && item.classList.contains('exam-completed'));
                
                item.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
            });
        }

        function toggleFilter(filter, element) {
            APP.currentFilter = filter;
            
            // Aggiorna visual filtri
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            element.classList.add('active');
            
            filterMaterie();
        }

        // === NAVIGAZIONE ===
        function toggleMobileNav() {
            const dropdown = document.getElementById('navDropdown');
            APP.mobileNavOpen = !APP.mobileNavOpen;
            
            if (APP.mobileNavOpen) {
                dropdown.classList.add('show');
            } else {
                dropdown.classList.remove('show');
            }
        }

        function closeMobileNav() {
            const dropdown = document.getElementById('navDropdown');
            dropdown.classList.remove('show');
            APP.mobileNavOpen = false;
        }

        function showSection(sectionName, targetElement) {
            try {
                closeMobileNav();
                
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

                const targetSection = document.getElementById(sectionName);
                if (targetSection) targetSection.classList.add('active');
                if (targetElement) targetElement.classList.add('active');

                const updateContent = Utils.debounce(() => {
                    switch(sectionName) {
                        case 'oggi': SmartPlanner.generateTodaySchedule(); break;
                        case 'piano': PianoStudio.generatePianoStudio(); break;
                        case 'statistiche': 
                            Statistics.updateStatistiche();
                            Heatmap.updateHeatmap();
                            ProductivityAnalyzer.updateProductivitySection();
                            break;
                        case 'calendario': Calendar.renderCalendar(); break;
                        case 'materie':
                            setTimeout(() => {
                                WeeklySlots.initializeWeeklySlots();
                                StarRating.setupStarRating();
                                filterMaterie();
                            }, 100);
                            break;
                        case 'pomodoro': Sessions.updateAllTodaySessionsList(); break;
                        case 'esami': ExamManager.updateExamsSection(); break;
                        case 'curriculum': CurriculumManager.loadCurriculumData(); break;
                    }
                }, 150);

                updateContent();
            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // === SMART PLANNER ===
        const SmartPlanner = {
            generateTodaySchedule() {
                if (APP.materie.length === 0) {
                    this.updateTodayDisplay(null, []);
                    return;
                }

                const oggi = new Date();
                const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
                
                const scheduleOggi = this.generateIntelligentSchedule(giornoSettimana);
                
                this.updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
                this.updateMicroTasks(scheduleOggi.nextTask);
                this.showSmartPlanningAlert(scheduleOggi.conflicts);
            },

            generateIntelligentSchedule(giornoSettimana) {
                const materieFiltrate = APP.materie.filter(materia => {
                    if (materia.status === 'completato') return false;
                    const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                    return slots && slots.length > 0;
                });

                if (materieFiltrate.length === 0) {
                    return { nextTask: null, timeline: [], conflicts: [] };
                }

                const materieConPriorita = materieFiltrate.map(materia => ({
                    ...materia,
                    smartPriority: Utils.calculateSmartPriority(materia)
                })).sort((a, b) => b.smartPriority - a.smartPriority);

                const { resolvedSchedule, conflicts } = this.resolveTimeConflicts(materieConPriorita, giornoSettimana);
                const timeline = this.buildTimeline(resolvedSchedule);
                const nextTask = this.findNextTask(timeline);

                return { nextTask, timeline, conflicts };
            },

            resolveTimeConflicts(materie, giornoSettimana) {
                const allSlots = [];
                const conflicts = [];

                materie.forEach(materia => {
                    const slots = materia.slotSettimanali[giornoSettimana] || [];
                    slots.forEach(slot => {
                        allSlots.push({
                            materia: materia,
                            slot: slot,
                            priority: materia.smartPriority,
                            start: this.timeToMinutes(slot.inizio),
                            end: this.timeToMinutes(slot.fine)
                        });
                    });
                });

                allSlots.sort((a, b) => b.priority - a.priority);

                const resolvedSchedule = [];
                const usedTimes = [];

                allSlots.forEach(item => {
                    const hasConflict = usedTimes.some(used => 
                        this.timesOverlap(item.start, item.end, used.start, used.end)
                    );

                    if (!hasConflict) {
                        resolvedSchedule.push(item);
                        usedTimes.push({ start: item.start, end: item.end });
                    } else {
                        conflicts.push({
                            materia: item.materia.nome,
                            originalSlot: `${item.slot.inizio}-${item.slot.fine}`
                        });
                    }
                });

                return { resolvedSchedule, conflicts };
            },

            buildTimeline(resolvedSchedule) {
                return resolvedSchedule.map(item => ({
                    materia: item.materia.nome,
                    durata: Utils.calculateTaskDuration(item.slot.inizio, item.slot.fine),
                    orarioInizio: item.slot.inizio,
                    orarioFine: item.slot.fine,
                    difficolta: item.materia.difficolta,
                    priority: item.priority,
                    pagineRimanenti: Math.max(0, item.materia.pagine - (item.materia.pagineStudiate || 0)),
                    percentualeCompletamento: ((item.materia.pagineStudiate || 0) / item.materia.pagine) * 100,
                    opzioni: this.generateTaskOptions(item.materia),
                    smartReason: this.getSmartReason(item.materia)
                })).sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio));
            },

            findNextTask(timeline) {
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                let nextTask = timeline.find(task => task.orarioInizio > currentTime);
                if (!nextTask && timeline.length > 0) {
                    nextTask = timeline[0];
                }
                
                return nextTask;
            },

            getSmartReason(materia) {
                const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                const progress = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                
                if (daysToExam !== null && daysToExam <= 7) {
                    return `Esame tra ${daysToExam} giorni - Priorit√† MASSIMA`;
                } else if (materia.priorita === 'alta') {
                    return 'Materia ad alta priorit√†';
                } else if (materia.difficolta >= 4) {
                    return 'Materia difficile - Meglio quando sei fresco';
                } else if (progress < 10) {
                    return 'Importante iniziare subito';
                } else if (progress > 80) {
                    return 'Vicino al completamento';
                }
                return 'Programmato nel piano di studio';
            },

            generateTaskOptions(materia) {
                const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                const pagineStudiate = materia.pagineStudiate || 0;
                const pagineRimanenti = materia.pagine - pagineStudiate;
                const options = [];

                // MIGLIORAMENTO: Logica pi√π intelligente basata sul progresso reale
                
                // Fase iniziale: 0-15%
                if (percentualeCompletamento < 15) {
                    if (pagineStudiate === 0) {
                        options.push({
                            id: 'primo-approccio',
                            titulo: 'üöÄ Primo Approccio',
                            descrizione: 'Inizia con una panoramica generale e l\'indice del libro',
                            motivazione: 'Il primo contatto √® fondamentale per orientarsi nella materia'
                        });
                    }
                    
                    options.push({
                        id: 'concetti-base',
                        titulo: 'üìö Concetti Fondamentali',
                        descrizione: 'Studio delle definizioni e teoremi principali',
                        motivazione: 'Costruire basi solide √® essenziale per il successo'
                    });
                    
                    if (pagineStudiate > 10) {
                        options.push({
                            id: 'consolidamento-base',
                            titulo: 'üîß Consolidamento Base',
                            descrizione: 'Ripassa e consolida i primi concetti appresi',
                            motivazione: 'Prima di andare avanti, assicurati di aver capito bene'
                        });
                    }
                }
                
                // Fase intermedia: 15-70%
                else if (percentualeCompletamento < 70) {
                    options.push({
                        id: 'approfondimento',
                        titulo: 'üîç Approfondimento Teorico',
                        descrizione: 'Continua con gli argomenti pi√π complessi e le dimostrazioni',
                        motivazione: 'Sviluppa una comprensione pi√π profonda della materia'
                    });
                    
                    options.push({
                        id: 'esercizi-guidati',
                        titulo: 'üí™ Esercizi Guidati',
                        descrizione: 'Risolvi problemi ed esercizi con soluzioni disponibili',
                        motivazione: 'La pratica guidata consolida la teoria appresa'
                    });
                    
                    if (percentualeCompletamento > 30) {
                        options.push({
                            id: 'collegamenti',
                            titulo: 'üîó Collegamenti Concettuali',
                            descrizione: 'Trova connessioni tra argomenti diversi',
                            motivazione: 'Capire i collegamenti rende tutto pi√π semplice'
                        });
                    }
                    
                    if (percentualeCompletamento > 50) {
                        options.push({
                            id: 'ripasso-mirato',
                            titulo: 'üéØ Ripasso Mirato',
                            descrizione: 'Rivedi gli argomenti pi√π difficili o dimenticati',
                            motivazione: 'Il ripasso mirato rafforza i punti deboli'
                        });
                    }
                }
                
                // Fase avanzata: 70-90%
                else if (percentualeCompletamento < 90) {
                    options.push({
                        id: 'esercizi-avanzati',
                        titulo: 'üèÜ Esercizi Avanzati',
                        descrizione: 'Affronta problemi complessi e casi particolari',
                        motivazione: 'Gli esercizi difficili ti preparano per qualsiasi domanda'
                    });
                    
                    options.push({
                        id: 'ripasso-generale',
                        titulo: 'üîÑ Ripasso Generale',
                        descrizione: 'Rivedi tutti gli argomenti principali della materia',
                        motivazione: 'Un ripasso completo consolida tutta la preparazione'
                    });
                    
                    options.push({
                        id: 'simulazione-esame',
                        titulo: 'üéì Simulazione Esame',
                        descrizione: 'Prova a rispondere a domande tipo esame',
                        motivazione: 'La simulazione ti prepara psicologicamente all\'esame'
                    });
                }
                
                // Fase finale: 90%+
                else {
                    options.push({
                        id: 'ripasso-finale',
                        titulo: '‚ú® Ripasso Finale',
                        descrizione: 'Ultimo ripasso prima dell\'esame',
                        motivazione: 'Rinfresca la memoria su tutto il programma'
                    });
                    
                    options.push({
                        id: 'esami-passati',
                        titulo: 'üìù Esami degli Anni Passati',
                        descrizione: 'Risolvi prove d\'esame precedenti',
                        motivazione: 'Le prove passate mostrano cosa aspettarsi'
                    });
                    
                    options.push({
                        id: 'punti-critici',
                        titulo: '‚ö†Ô∏è Punti Critici',
                        descrizione: 'Concentrati sugli argomenti pi√π ostici',
                        motivazione: 'Elimina gli ultimi dubbi prima dell\'esame'
                    });
                }

                // Sempre disponibile
                options.push({
                    id: 'personalizzato',
                    titulo: '‚öôÔ∏è Studio Personalizzato',
                    descrizione: 'Scegli tu cosa studiare in questa sessione',
                    motivazione: 'Tu conosci meglio le tue necessit√† del momento'
                });

                return options;
            },

            updateTodayDisplay(nextTask, timeline) {
                const elements = {
                    currentTaskMateria: document.getElementById('currentTaskMateria'),
                    currentTaskTime: document.getElementById('currentTaskTime'),
                    currentTaskDesc: document.getElementById('currentTaskDesc'),
                    currentTaskMotivation: document.getElementById('currentTaskMotivation'),
                    taskOptions: document.getElementById('taskOptions'),
                    taskOptionsList: document.getElementById('taskOptionsList'),
                    startTaskBtn: document.getElementById('startTaskBtn'),
                    timelineContainer: document.getElementById('timelineOggi')
                };

                if (!nextTask) {
                    elements.currentTaskMateria.textContent = 'Nessun task programmato';
                    elements.currentTaskTime.textContent = '‚è±Ô∏è -- min';
                    elements.currentTaskDesc.textContent = 'Aggiungi slot temporali alle tue materie per vedere il piano giornaliero!';
                    elements.currentTaskMotivation.textContent = 'üí° Definisci quando puoi studiare per ottimizzare la tua giornata';
                    elements.taskOptions.classList.add('hidden');
                    elements.startTaskBtn.disabled = true;
                    
                    elements.timelineContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                        </div>
                    `;
                    return;
                }

                elements.currentTaskMateria.textContent = nextTask.materia;
                elements.currentTaskTime.textContent = `‚è±Ô∏è ${nextTask.durata} min`;
                
                if (nextTask.opzioni && nextTask.opzioni.length > 0) {
                    elements.taskOptions.classList.remove('hidden');
                    elements.taskOptionsList.innerHTML = nextTask.opzioni.map(opzione => `
                        <button class="task-option-btn" onclick="SmartPlanner.selectTaskOption('${opzione.id}', '${nextTask.materia}', this)" style="width: 100%; margin-bottom: 0.75rem; padding: 1rem; background: var(--bg-card); border: 2px solid var(--border); color: var(--text-primary); border-radius: 8px; cursor: pointer; transition: all var(--transition); text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${opzione.titulo}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${opzione.descrizione}</div>
                            <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 0.5rem;">üí° ${opzione.motivazione}</div>
                        </button>
                    `).join('');
                    
                    if (!APP.selectedTaskOption) {
                        this.selectTaskOption(nextTask.opzioni[0].id, nextTask.materia);
                    }
                } else {
                    elements.taskOptions.classList.add('hidden');
                }

                elements.startTaskBtn.disabled = false;

                if (timeline.length === 0) {
                    elements.timelineContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p>Nessun task programmato per oggi</p>
                        </div>
                    `;
                } else {
                    elements.timelineContainer.innerHTML = timeline.map(task => `
                        <div style="display: flex; align-items: flex-start; padding: 1rem; margin-bottom: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; border-left: 4px solid var(--accent); gap: 1rem;">
                            <div style="font-weight: 700; min-width: 80px; color: var(--accent); font-size: 1rem;">${task.orarioInizio}</div>
                            <div style="flex: 1;">
                                <strong>${task.materia}</strong><br>
                                <span style="opacity: 0.8;">${task.smartReason}</span><br>
                                <small style="color: var(--secondary);">
                                    ${task.durata} min ‚Ä¢ ${Math.round(task.percentualeCompletamento)}% completato
                                    ${task.priority ? ` ‚Ä¢ Score: ${task.priority}` : ''}
                                </small>
                            </div>
                        </div>
                    `).join('');
                }
            },

            selectTaskOption(optionId, materia, clickedElement) {
                APP.selectedTaskOption = optionId;
                APP.currentSessionData = { materia: materia, option: optionId };
                
                document.querySelectorAll('.task-option-btn').forEach(btn => {
                    btn.style.borderColor = 'var(--border)';
                    btn.style.background = 'var(--bg-card)';
                });
                
                if (clickedElement) {
                    clickedElement.style.borderColor = 'var(--primary)';
                    clickedElement.style.background = 'rgba(139, 92, 246, 0.1)';
                }
                
                const currentTask = this.getCurrentNextTask();
                if (currentTask && currentTask.opzioni) {
                    const selectedOption = currentTask.opzioni.find(opt => opt.id === optionId);
                    if (selectedOption) {
                        document.getElementById('currentTaskDesc').textContent = selectedOption.descrizione;
                        document.getElementById('currentTaskMotivation').textContent = `üí° ${selectedOption.motivazione}`;
                    }
                }
            },

            updateMicroTasks(nextTask) {
                const microTasksContainer = document.getElementById('microTasks');
                const microTasksList = document.getElementById('microTasksList');

                if (!nextTask) {
                    microTasksContainer.classList.add('hidden');
                    return;
                }

                // MIGLIORAMENTO: Genera micro-tasks intelligenti basati sul progresso
                const materia = APP.materie.find(m => m.nome === nextTask.materia);
                const tasks = this.generateSmartMicroTasks(materia);
                
                microTasksContainer.classList.remove('hidden');
                
                microTasksList.innerHTML = tasks.map(task => `
                    <div onclick="SmartPlanner.startMicroTask('${task.text}', ${task.durata}, this)" style="background: rgba(16, 185, 129, 0.05); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all var(--transition); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div>${task.text}</div>
                        <div style="font-size: 0.8rem; color: var(--secondary); font-weight: 600;">${task.durata} min</div>
                    </div>
                `).join('');
            },

            generateSmartMicroTasks(materia) {
                if (!materia) {
                    return APP.universalMicroTasks.slice(0, 4);
                }

                const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                const pagineStudiate = materia.pagineStudiate || 0;
                let smartTasks = [];

                // Task basati sul progresso della materia
                if (percentualeCompletamento === 0) {
                    smartTasks = [
                        { text: `üìñ Sfoglia l'indice di ${materia.nome}`, durata: 3 },
                        { text: "üéØ Leggi l'introduzione del primo capitolo", durata: 5 },
                        { text: "üìù Scrivi 3 obiettivi per questa materia", durata: 4 },
                        { text: "üîç Cerca info generali sulla materia online", durata: 5 }
                    ];
                } else if (percentualeCompletamento < 25) {
                    smartTasks = [
                        { text: `üìö Rileggi le ultime 2 pagine studiate di ${materia.nome}`, durata: 4 },
                        { text: "‚úèÔ∏è Riassumi in 3 punti l'ultimo argomento", durata: 3 },
                        { text: "ü§î Pensa a 2 domande sull'argomento corrente", durata: 2 },
                        { text: "üìã Controlla se hai capito le definizioni base", durata: 4 }
                    ];
                } else if (percentualeCompletamento < 50) {
                    smartTasks = [
                        { text: `üîó Collega l'ultimo argomento ai precedenti di ${materia.nome}`, durata: 4 },
                        { text: "üí° Trova un esempio pratico dell'ultimo concetto", durata: 5 },
                        { text: "üìä Fai un mini-schema dell'argomento corrente", durata: 6 },
                        { text: "üéØ Identifica i punti pi√π difficili finora", durata: 3 }
                    ];
                } else if (percentualeCompletamento < 75) {
                    smartTasks = [
                        { text: `üîÑ Ripassa velocemente un capitolo di ${materia.nome}`, durata: 5 },
                        { text: "üí™ Prova a spiegare un concetto a voce alta", durata: 3 },
                        { text: "üìù Scrivi le formule principali a memoria", durata: 4 },
                        { text: "ü§Ø Identifica i collegamenti tra capitoli", durata: 5 }
                    ];
                } else {
                    smartTasks = [
                        { text: `üéì Ripassa i concetti chiave di ${materia.nome}`, durata: 5 },
                        { text: "‚ö° Fai un ripasso lampo degli argomenti principali", durata: 4 },
                        { text: "üß† Pensa alle possibili domande d'esame", durata: 4 },
                        { text: "‚ú® Rivedi i punti che ti sembrano meno chiari", durata: 5 }
                    ];
                }

                return smartTasks;
            },

            startMicroTask(taskText, durata, clickedElement) {
                APP.currentSessionData = { materia: 'Micro-task', option: taskText };
                setPreset(durata, Math.max(2, Math.floor(durata / 5)), null);
                Utils.showSuccessMessage(`üöÄ Micro-task avviato: ${taskText}`);
                
                if (clickedElement) {
                    document.querySelectorAll('.micro-task-item').forEach(item => {
                        item.style.transform = 'translateX(0)';
                        item.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                    });
                    clickedElement.style.transform = 'translateX(8px)';
                    clickedElement.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
                }
                
                startTimer();
            },

            getCurrentNextTask() {
                const oggi = new Date();
                const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
                const schedule = this.generateIntelligentSchedule(giornoSettimana);
                return schedule.nextTask;
            },

            showSmartPlanningAlert(conflicts) {
                const alertEl = document.getElementById('smartPlanningAlert');
                const messageEl = document.getElementById('smartPlanningMessage');
                
                if (conflicts.length > 0) {
                    let message = `‚ö†Ô∏è Risolti ${conflicts.length} conflitti di orario. `;
                    message += `Materie riprogrammate: ${conflicts.map(c => c.materia).join(', ')}`;
                    messageEl.textContent = message;
                    alertEl.classList.remove('hidden');
                } else if (APP.materie.length > 0) {
                    messageEl.textContent = '‚úÖ Piano ottimizzato con algoritmo intelligente - Nessun conflitto rilevato';
                    alertEl.classList.remove('hidden');
                } else {
                    alertEl.classList.add('hidden');
                }
            },

            timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            },

            minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            },

            timesOverlap(start1, end1, start2, end2) {
                return start1 < end2 && end1 > start2;
            }
        };

        // === MATERIE MANAGER ===
        const MaterieManager = {
            saveMaterie() {
                try {
                    localStorage.setItem('materie', JSON.stringify(APP.materie));
                    BackupManager.performAutoBackup();
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                }
            },

            loadMaterie() {
                const container = document.getElementById('materieList');
                
                if (APP.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìö</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = APP.materie.map(materia => {
                    const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                    const isExamCompleted = materia.status === 'completato';
                    const examData = APP.esami.find(e => e.materiaId === materia.id);
                    const smartPriority = Utils.calculateSmartPriority(materia);
                    
                    let oreTotaliSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreTotaliSettimanali += durata;
                            });
                        });
                        oreTotaliSettimanali = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                    }
                    
                    // MIGLIORAMENTO: Supporto semestri annuali
                    const getSemesterBadges = (semestre) => {
                        if (semestre === 'annuale') {
                            return `
                                <div class="semester-badges">
                                    <span class="semester-badge">I Sem</span>
                                    <span class="semester-badge">II Sem</span>
                                </div>
                            `;
                        }
                        return `<span class="semester-badge">${semestre}¬∞ Semestre</span>`;
                    };
                    
                    return `
                    <div class="subject-item ${isExamCompleted ? 'exam-completed' : ''} fade-in-up">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-light); flex: 1; min-width: 200px;">${materia.nome}</div>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <span style="padding: 8px 16px; border-radius: 25px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; ${isExamCompleted ? 'background: rgba(16, 185, 129, 0.2); color: var(--success);' : 'background: rgba(139, 92, 246, 0.2); color: var(--primary-light);'}">
                                    ${isExamCompleted ? 'üéì Completato' : 'üìö In Studio'}
                                </span>
                                <span style="padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: rgba(245, 158, 11, 0.2); color: #fcd34d;">${materia.priorita}</span>
                                ${!isExamCompleted ? `
                                    <span style="background: rgba(139, 92, 246, 0.2); color: var(--primary-light); padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;" title="Score Intelligente: ${smartPriority} punti">
                                        Score: ${smartPriority}
                                    </span>
                                    <button class="btn btn-success btn-small" onclick="MaterieManager.markAsExamCompleted(${materia.id})" title="Segna esame come completato">üéì</button>
                                    <button class="btn btn-warning btn-small" onclick="MaterieManager.editMateria(${materia.id})" title="Modifica materia">‚úèÔ∏è</button>
                                ` : `
                                    <button class="btn btn-warning btn-small" onclick="ExamManager.editExam(${materia.id})" title="Modifica esame">‚úèÔ∏è</button>
                                `}
                                <button class="btn btn-danger btn-small" onclick="MaterieManager.deleteMateria(${materia.id})" title="Elimina materia">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        ${!isExamCompleted ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong style="color: var(--primary-light);">Progresso Studio:</strong>
                                <span style="color: var(--secondary); font-weight: 600;">${percentualeCompletamento}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentualeCompletamento}%"></div>
                            </div>
                            <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine completate</small>
                        </div>
                        ` : examData ? `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${examData.voto}${examData.lode ? 'L' : ''}</div>
                            <div>
                                <div style="color: var(--success); font-weight: 600;">Esame sostenuto</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    ${examData.dataEsame ? new Date(examData.dataEsame).toLocaleDateString('it-IT') : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.95rem; color: var(--text-secondary);">
                            <div><strong>Anno:</strong> ${materia.anno}¬∞ Anno</div>
                            <div>
                                <strong>Semestre:</strong> 
                                ${getSemesterBadges(materia.semestre)}
                            </div>
                            <div><strong>CFU:</strong> ${materia.cfu}</div>
                            <div><strong>Pagine:</strong> ${materia.pagine}</div>
                            <div><strong>Ore settimanali:</strong> ${oreTotaliSettimanali}h</div>
                            <div><strong>Esame:</strong> ${materia.dataEsame ? new Date(materia.dataEsame).toLocaleDateString('it-IT') : 'Non impostato'}</div>
                            <div><strong>Difficolt√†:</strong> ${'‚òÖ'.repeat(materia.difficolta || 3)}${'‚òÜ'.repeat(5-(materia.difficolta || 3))}</div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Applica filtri dopo il caricamento
                setTimeout(filterMaterie, 100);
            },

            markAsExamCompleted(materiaId) {
                const materia = APP.materie.find(m => m.id === materiaId);
                if (!materia) {
                    Utils.showSuccessMessage('‚ùå Materia non trovata');
                    return;
                }

                document.getElementById('examSubject').value = materia.nome;
                document.getElementById('examModal').style.display = 'flex';
                document.getElementById('examModal').dataset.materiaId = materiaId;
            },

            editMateria(id) {
                try {
                    const materia = APP.materie.find(m => m.id === id);
                    if (!materia) {
                        Utils.showSuccessMessage('‚ùå Materia non trovata');
                        return;
                    }

                    const fields = {
                        nomeMateria: materia.nome || '',
                        cfu: materia.cfu || '',
                        anno: materia.anno || '',
                        semestre: materia.semestre || '',
                        pagine: materia.pagine || '',
                        pagineStudiate: materia.pagineStudiate || 0,
                        pagineOra: materia.pagineOra || 8,
                        dataEsame: materia.dataEsame || '',
                        priorita: materia.priorita || 'media'
                    };

                    Object.entries(fields).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.value = value;
                    });
                    
                    APP.difficoltaSelezionata = materia.difficolta || 3;
                    StarRating.updateStarDisplay();

                    setTimeout(() => {
                        WeeklySlots.initializeWeeklySlots();
                        
                        if (materia.slotSettimanali) {
                            setTimeout(() => {
                                Object.keys(materia.slotSettimanali).forEach(giorno => {
                                    const slots = materia.slotSettimanali[giorno];
                                    slots.forEach(slot => {
                                        WeeklySlots.addTimeSlot(giorno);
                                        const container = document.getElementById(`slots-${giorno}`);
                                        if (container) {
                                            const lastSlot = container.querySelector('.slot-item:last-of-type');
                                            if (lastSlot) {
                                                const inputs = lastSlot.querySelectorAll('input[type="time"]');
                                                if (inputs.length >= 2) {
                                                    inputs[0].value = slot.inizio;
                                                    inputs[1].value = slot.fine;
                                                }
                                            }
                                        }
                                    });
                                });
                            }, 200);
                        }
                    }, 100);

                    APP.materie = APP.materie.filter(m => m.id !== id);
                    this.saveMaterie();
                    this.loadMaterie();

                    showSection('materie', document.querySelector('.nav-tab[onclick*="materie"]'));
                    Utils.showSuccessMessage('üìù Materia caricata per modifica');
                    
                } catch (error) {
                    console.error('‚ùå Errore nella modifica:', error);
                    Utils.showSuccessMessage('‚ùå Errore nel caricamento della materia');
                }
            },

            deleteMateria(id) {
                try {
                    const materia = APP.materie.find(m => m.id === id);
                    if (!materia) {
                        Utils.showSuccessMessage('‚ùå Materia non trovata');
                        return;
                    }

                    const conferma = confirm(`Sei sicuro di voler eliminare "${materia.nome}"?\n\nQuesta azione eliminer√† anche l'eventuale esame associato.`);
                    
                    if (conferma) {
                        APP.esami = APP.esami.filter(e => e.materiaId !== id);
                        ExamManager.saveEsami();
                        
                        APP.materie = APP.materie.filter(m => m.id !== id);
                        this.saveMaterie();
                        this.loadMaterie();
                        
                        const currSubjectIndex = APP.curriculum.findIndex(c => c.nome === materia.nome && c.anno === materia.anno && (c.semestre === materia.semestre || materia.semestre === 'annuale'));
                        if (currSubjectIndex !== -1) {
                            APP.curriculum.splice(currSubjectIndex, 1);
                            CurriculumManager.saveCurriculum();
                        }
                        
                        SmartPlanner.generateTodaySchedule();
                        PianoStudio.generatePianoStudio();
                        Statistics.updateStatistiche();
                        ExamManager.updateExamsSection();
                        CurriculumManager.loadCurriculumData();
                        
                        Utils.showSuccessMessage('üóëÔ∏è Materia ed esame eliminati con successo');
                    }
                } catch (error) {
                    console.error('‚ùå Errore nell\'eliminazione:', error);
                    Utils.showSuccessMessage('‚ùå Errore nell\'eliminazione della materia');
                }
            }
        };

        // === EXAM MANAGER ===
        const ExamManager = {
            saveEsami() {
                try {
                    localStorage.setItem('esami', JSON.stringify(APP.esami));
                    BackupManager.performAutoBackup();
                } catch (error) {
                    console.error('Errore nel salvataggio esami:', error);
                }
            },

            updateExamsSection() {
                this.updateExamStats();
                this.updateExamsList();
            },

            updateExamStats() {
                const elements = {
                    totalExams: document.getElementById('totalExams'),
                    totalCFU: document.getElementById('totalCFU'),
                    weightedAverage: document.getElementById('weightedAverage'),
                    projectedGrade: document.getElementById('projectedGrade')
                };

                if (APP.esami.length === 0) {
                    Object.values(elements).forEach(el => el && (el.textContent = '0'));
                    return;
                }

                let totalCFU = 0;
                let weightedSum = 0;

                APP.esami.forEach(esame => {
                    const materia = APP.materie.find(m => m.id === esame.materiaId);
                    if (materia) {
                        const cfu = materia.cfu;
                        totalCFU += cfu;
                        weightedSum += esame.voto * cfu;
                    }
                });

                const weightedAverage = totalCFU > 0 ? (weightedSum / totalCFU).toFixed(2) : 0;
                const projectedGrade = totalCFU > 0 ? Math.round((weightedSum / totalCFU) * 110 / 30) : 0;

                if (elements.totalExams) elements.totalExams.textContent = APP.esami.length;
                if (elements.totalCFU) elements.totalCFU.textContent = totalCFU;
                if (elements.weightedAverage) elements.weightedAverage.textContent = weightedAverage;
                if (elements.projectedGrade) elements.projectedGrade.textContent = projectedGrade;
            },

            updateExamsList() {
                const container = document.getElementById('examsList');
                if (!container) return;

                if (APP.esami.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéì</div>
                            <p>Nessun esame sostenuto ancora.</p>
                        </div>
                    `;
                    return;
                }

                const sortedExams = APP.esami.sort((a, b) => {
                    const dateA = new Date(a.dataEsame || '1970-01-01');
                    const dateB = new Date(b.dataEsame || '1970-01-01');
                    return dateB - dateA;
                });

                container.innerHTML = sortedExams.map(esame => {
                    const materia = APP.materie.find(m => m.id === esame.materiaId);
                    if (!materia) return '';

                    return `
                        <div class="subject-item fade-in-up" style="border-color: var(--success); background: rgba(16, 185, 129, 0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary);">${materia.nome}</div>
                                <div style="display: flex; gap: 0.75rem; align-items: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${esame.voto}${esame.lode ? 'L' : ''}</div>
                                    <button class="btn btn-warning btn-small" onclick="ExamManager.editExam(${materia.id})" title="Modifica esame">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-small" onclick="ExamManager.deleteExam(${esame.id})" title="Elimina esame">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.95rem; color: var(--text-secondary);">
                                <div><strong>CFU:</strong> ${materia.cfu}</div>
                                <div><strong>Data:</strong> ${esame.dataEsame ? new Date(esame.dataEsame).toLocaleDateString('it-IT') : 'Non specificata'}</div>
                                ${esame.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${esame.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            editExam(materiaId) {
                const materia = APP.materie.find(m => m.id === materiaId);
                const esame = APP.esami.find(e => e.materiaId === materiaId);
                
                if (!materia || !esame) {
                    Utils.showSuccessMessage('‚ùå Esame non trovato');
                    return;
                }

                APP.currentEditingExamId = esame.id;
                Utils.showSuccessMessage('Funzione di modifica esame in sviluppo');
            },

            deleteExam(esameId) {
                const esame = APP.esami.find(e => e.id === esameId);
                if (!esame) return;

                const materia = APP.materie.find(m => m.id === esame.materiaId);
                if (!materia) return;

                const conferma = confirm(`Sei sicuro di voler eliminare l'esame di "${materia.nome}"?\n\nLa materia torner√† allo stato "In Studio".`);
                
                if (conferma) {
                    APP.esami = APP.esami.filter(e => e.id !== esameId);
                    materia.status = 'studio';
                    
                    this.saveEsami();
                    MaterieManager.saveMaterie();
                    MaterieManager.loadMaterie();
                    this.updateExamsSection();
                    
                    Utils.showSuccessMessage('üóëÔ∏è Esame eliminato con successo');
                }
            }
        };

        // === CURRICULUM MANAGER ===
        const CurriculumManager = {
            saveCurriculum() {
                try {
                    localStorage.setItem('curriculum', JSON.stringify(APP.curriculum));
                    BackupManager.performAutoBackup();
                } catch (error) {
                    console.error('Errore nel salvataggio curriculum:', error);
                }
            },

            loadCurriculumData() {
                this.updateYearStats();
                this.loadYearSubjects();
            },

            updateYearStats() {
                for (let year = 1; year <= 3; year++) {
                    const yearSubjects = APP.curriculum.filter(s => s.anno === year);
                    const completedSubjects = yearSubjects.filter(s => s.completato);
                    
                    const totalCFU = yearSubjects.reduce((sum, s) => sum + (s.cfu || 0), 0);
                    const avgGrade = completedSubjects.length > 0 ? 
                        (completedSubjects.reduce((sum, s) => sum + (s.voto || 0), 0) / completedSubjects.length).toFixed(1) : 0;

                    const elements = {
                        subjects: document.getElementById(`year${year}-subjects`),
                        cfu: document.getElementById(`year${year}-cfu`),
                        average: document.getElementById(`year${year}-average`)
                    };

                    if (elements.subjects) elements.subjects.textContent = yearSubjects.length;
                    if (elements.cfu) elements.cfu.textContent = totalCFU;
                    if (elements.average) elements.average.textContent = avgGrade;
                }
            },

            loadYearSubjects() {
                for (let year = 1; year <= 3; year++) {
                    // MIGLIORAMENTO: Supporto per materie annuali
                    const semesters = [
                        { id: 1, name: 'I Semestre' },
                        { id: 2, name: 'II Semestre' },
                        { id: 'annuale', name: 'Annuali' }
                    ];
                    
                    semesters.forEach(semester => {
                        const containerId = semester.id === 'annuale' ? 
                            `year${year}-annuale-subjects` : 
                            `year${year}-semester${semester.id}-subjects`;
                        const container = document.getElementById(containerId);
                        if (!container) return;

                        const subjects = APP.curriculum.filter(s => 
                            s.anno === year && s.semestre === semester.id
                        );
                        
                        if (subjects.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon">üìñ</div>
                                    <p>Nessuna materia ${semester.id === 'annuale' ? 'annuale' : 'aggiunta'}</p>
                                </div>
                            `;
                            return;
                        }

                        container.innerHTML = subjects.map(subject => `
                            <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; ${subject.completato ? 'border-color: var(--success); background: rgba(16, 185, 129, 0.05);' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; gap: 1rem; flex-wrap: wrap;">
                                    <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem; flex: 1; min-width: 150px;">${subject.nome}</div>
                                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                        ${subject.completato && subject.voto ? 
                                            `<span style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${subject.voto}${subject.lode ? 'L' : ''}</span>` : ''
                                        }
                                        <input type="checkbox" ${subject.completato ? 'checked' : ''} 
                                               onchange="CurriculumManager.toggleSubjectCompletion(${subject.id})" style="width: 20px; height: 20px; cursor: pointer;" title="Segna come completato">
                                        <button class="btn btn-danger btn-small" onclick="CurriculumManager.deleteCurriculumSubject(${subject.id})" title="Elimina materia">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                                    <div><strong>CFU:</strong> ${subject.cfu}</div>
                                    ${subject.professore ? `<div><strong>Prof:</strong> ${subject.professore}</div>` : ''}
                                    ${subject.semestre === 'annuale' ? `<div><strong>Tipo:</strong> <span style="color: var(--accent); font-weight: 600;">Annuale</span></div>` : ''}
                                </div>
                            </div>
                        `).join('');
                    });
                }
            },

            toggleSubjectCompletion(subjectId) {
                const subject = APP.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                if (!subject.completato) {
                    const voto = prompt(`Inserisci il voto per "${subject.nome}" (18-30):`);
                    if (voto === null) return;
                    
                    const votoNum = parseInt(voto);
                    if (isNaN(votoNum) || votoNum < 18 || votoNum > 30) {
                        alert('Voto non valido. Inserisci un numero tra 18 e 30.');
                        return;
                    }

                    const lode = votoNum === 30 ? confirm('Lode?') : false;
                    
                    subject.completato = true;
                    subject.voto = votoNum;
                    subject.lode = lode;
                    subject.dataCompletamento = new Date().toISOString().split('T')[0];
                } else {
                    subject.completato = false;
                    delete subject.voto;
                    delete subject.lode;
                    delete subject.dataCompletamento;
                }

                this.saveCurriculum();
                this.loadCurriculumData();
            },

            deleteCurriculumSubject(subjectId) {
                const subject = APP.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                const conferma = confirm(`Sei sicuro di voler eliminare "${subject.nome}" dal curriculum?\n\nQuesta azione eliminer√† anche la materia corrispondente dalla sezione Materie e tutti i dati associati.`);
                
                if (conferma) {
                    // MIGLIORAMENTO: Elimina anche dalla pagina Materie
                    const materiaCorrispondente = APP.materie.find(m => 
                        m.nome === subject.nome && 
                        m.anno === subject.anno && 
                        (m.semestre === subject.semestre || subject.semestre === 'annuale')
                    );
                    
                    if (materiaCorrispondente) {
                        // Elimina anche eventuali esami associati
                        APP.esami = APP.esami.filter(e => e.materiaId !== materiaCorrispondente.id);
                        ExamManager.saveEsami();
                        
                        // Elimina la materia
                        APP.materie = APP.materie.filter(m => m.id !== materiaCorrispondente.id);
                        MaterieManager.saveMaterie();
                        MaterieManager.loadMaterie();
                    }
                    
                    // Elimina dal curriculum
                    APP.curriculum = APP.curriculum.filter(s => s.id !== subjectId);
                    this.saveCurriculum();
                    this.loadCurriculumData();
                    
                    // Aggiorna tutte le sezioni correlate
                    SmartPlanner.generateTodaySchedule();
                    PianoStudio.generatePianoStudio();
                    Statistics.updateStatistiche();
                    ExamManager.updateExamsSection();
                    
                    Utils.showSuccessMessage('üóëÔ∏è Materia eliminata completamente da curriculum e materie');
                }
            }
        };

        // === TIMER ===
        const Timer = {
            updateTimerDisplay() {
                const display = `${APP.timerState.minutes.toString().padStart(2, '0')}:${APP.timerState.seconds.toString().padStart(2, '0')}`;
                const timerDisplayEl = document.getElementById('timerDisplay');
                
                if (timerDisplayEl) {
                    timerDisplayEl.textContent = display;
                    timerDisplayEl.classList.toggle('break-mode', APP.timerState.isBreak);
                }
            },

            updateSessionDisplay() {
                const elements = {
                    sessionCount: document.getElementById('sessionCount'),
                    sessionGoal: document.getElementById('sessionGoal'),
                    sessionProgress: document.getElementById('sessionProgress'),
                    progressText: document.getElementById('progressText')
                };

                this.updateDailyGoalDisplay();
                
                if (elements.sessionCount) elements.sessionCount.textContent = APP.timerState.sessionsToday;
                if (elements.sessionGoal) elements.sessionGoal.textContent = APP.timerState.dailyGoal;
                
                if (elements.sessionProgress) {
                    const progress = Math.min(100, (APP.timerState.sessionsToday / APP.timerState.dailyGoal) * 100);
                    elements.sessionProgress.style.width = progress + '%';
                }
                
                if (elements.progressText) {
                    if (APP.timerState.sessionsToday === 0) {
                        elements.progressText.textContent = 'Inizia la tua prima sessione!';
                    } else if (APP.timerState.sessionsToday >= APP.timerState.dailyGoal) {
                        elements.progressText.textContent = 'üéâ Obiettivo raggiunto! Ottimo lavoro!';
                    } else {
                        const remaining = APP.timerState.dailyGoal - APP.timerState.sessionsToday;
                        elements.progressText.textContent = `Ancora ${remaining} sessioni per raggiungere l'obiettivo`;
                    }
                }
            },

            updateDailyGoalDisplay() {
                const goalInput = document.getElementById('dailyGoal');
                const sessionGoalEl = document.getElementById('sessionGoal');
                
                if (goalInput) goalInput.value = APP.timerState.dailyGoal;
                if (sessionGoalEl) sessionGoalEl.textContent = APP.timerState.dailyGoal;
            }
        };

        // === STAR RATING ===
        const StarRating = {
            setupStarRating() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.replaceWith(star.cloneNode(true));
                });
                
                const freshStars = document.querySelectorAll('.star');
                freshStars.forEach((star, index) => {
                    star.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP.difficoltaSelezionata = parseInt(star.dataset.rating);
                        this.updateStarDisplay();
                    });

                    star.addEventListener('mouseover', () => {
                        const rating = parseInt(star.dataset.rating);
                        this.highlightStars(rating);
                    });
                    
                    star.addEventListener('mouseout', () => {
                        this.updateStarDisplay();
                    });
                });

                this.updateStarDisplay();
            },

            highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            },

            updateStarDisplay() {
                this.highlightStars(APP.difficoltaSelezionata);
            }
        };

        // === WEEKLY SLOTS ===
        const WeeklySlots = {
            initializeWeeklySlots() {
                const container = document.getElementById('weeklySlots');
                if (!container) return;
                
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const giorniLabel = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];

                container.innerHTML = giorni.map((giorno, index) => `
                    <div class="fade-in-up" style="background: var(--bg-tertiary); border-radius: var(--border-radius); padding: 1.5rem; border: 1px solid var(--border);">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem; text-align: center;">${giorniLabel[index]}</h4>
                        <div id="slots-${giorno}">
                            <button type="button" onclick="WeeklySlots.addTimeSlot('${giorno}')" style="width: 100%; padding: 0.75rem; border: 2px dashed var(--border); background: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all var(--transition); font-weight: 600;">+ Aggiungi Slot</button>
                        </div>
                    </div>
                `).join('');
            },

            addTimeSlot(giorno) {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) return;
                
                const slotId = `${giorno}-${Date.now()}`;
                
                const slotHTML = `
                    <div id="${slotId}" class="slot-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); flex-wrap: wrap;">
                        <input type="time" value="09:00" style="padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: auto; min-width: 120px;">
                        <span style="color: var(--text-secondary);">-</span>
                        <input type="time" value="11:00" style="padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: auto; min-width: 120px;">
                        <button type="button" onclick="WeeklySlots.removeTimeSlot('${slotId}')" style="background: var(--danger); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;" title="Rimuovi slot">√ó</button>
                    </div>
                `;
                
                const addButton = container.querySelector('button');
                if (addButton) {
                    addButton.insertAdjacentHTML('beforebegin', slotHTML);
                }
            },

            removeTimeSlot(slotId) {
                const slot = document.getElementById(slotId);
                if (slot) {
                    slot.remove();
                }
            },

            getWeeklySlots() {
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const slotSettimanali = {};

                giorni.forEach(giorno => {
                    const container = document.getElementById(`slots-${giorno}`);
                    if (!container) {
                        slotSettimanali[giorno] = [];
                        return;
                    }
                    
                    const slots = container.querySelectorAll('div[id^="' + giorno + '-"]');
                    slotSettimanali[giorno] = [];

                    slots.forEach(slot => {
                        const inputs = slot.querySelectorAll('input[type="time"]');
                        const start = inputs[0].value;
                        const end = inputs[1].value;
                        
                        if (start && end && start < end) {
                            slotSettimanali[giorno].push({
                                inizio: start,
                                fine: end,
                                disponibile: true
                            });
                        }
                    });
                });

                return slotSettimanali;
            }
        };

        // === SESSIONS ===
        const Sessions = {
            updateAllTodaySessionsList() {
                const container = document.getElementById('allTodaySessionsList');
                if (!container) return;
                
                const today = new Date().toDateString();
                if (APP.timerState.lastSessionDate !== today) {
                    APP.timerState.sessionsToday = 0;
                    APP.todayDetailedSessions = [];
                    localStorage.setItem('sessionsToday', 0);
                    localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                }
                
                const allSessions = [...APP.todayDetailedSessions];
                
                if (APP.calendarSessions[today]) {
                    APP.calendarSessions[today].forEach(session => {
                        allSessions.push({
                            ...session,
                            rating: session.rating || 3,
                            timestamp: session.timestamp,
                            type: 'manual'
                        });
                    });
                }
                
                if (allSessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üçÖ</div>
                            <p>Nessuna sessione completata oggi.</p>
                        </div>
                    `;
                    return;
                }
                
                const sortedSessions = allSessions.sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                container.innerHTML = sortedSessions.map((session, index) => {
                    const time = new Date(session.timestamp).toLocaleTimeString('it-IT', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const ratingEmojis = ['üò¥', 'üòê', 'üòä', 'üî•'];
                    const ratingStars = '‚òÖ'.repeat(session.rating) + '‚òÜ'.repeat(4 - session.rating);
                    
                    return `
                        <div class="session-item fade-in-up">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 200px;">
                                <div style="font-weight: 700; min-width: 80px; color: var(--primary-light);">${time}</div>
                                <div>
                                    <div style="color: var(--secondary); font-weight: 600;">${session.materia}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${session.note || session.option || ''}</div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;">${session.duration || 25}min ${session.type === 'manual' ? '(Manuale)' : ''}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${ratingEmojis[session.rating - 1]}</span>
                                    <small style="color: var(--text-secondary);">${ratingStars}</small>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="Sessions.deleteSession(${index}, '${session.type || 'timer'}')" title="Elimina sessione">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            deleteSession(index, type) {
                if (confirm('Sei sicuro di voler eliminare questa sessione?')) {
                    const today = new Date().toDateString();
                    
                    if (type === 'manual' && APP.calendarSessions[today]) {
                        const manualIndex = index - APP.todayDetailedSessions.length;
                        if (manualIndex >= 0 && manualIndex < APP.calendarSessions[today].length) {
                            APP.calendarSessions[today].splice(manualIndex, 1);
                            if (APP.calendarSessions[today].length === 0) {
                                delete APP.calendarSessions[today];
                            }
                            localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
                        }
                    } else {
                        if (index < APP.todayDetailedSessions.length) {
                            APP.todayDetailedSessions.splice(index, 1);
                            APP.timerState.sessionsToday = Math.max(0, APP.timerState.sessionsToday - 1);
                            localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
                            localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
                        }
                    }
                    
                    this.updateAllTodaySessionsList();
                    Timer.updateSessionDisplay();
                    Calendar.renderCalendar();
                    Utils.showSuccessMessage('üóëÔ∏è Sessione eliminata');
                }
            }
        };

        // === CALENDAR ===
        const Calendar = {
            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                
                if (!grid || !monthYearEl) return;
                
                const year = APP.currentCalendarDate.getFullYear();
                const month = APP.currentCalendarDate.getMonth();
                
                monthYearEl.textContent = new Date(year, month).toLocaleDateString('it-IT', {
                    month: 'long',
                    year: 'numeric'
                });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);
                
                grid.innerHTML = '';
                
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayEl = this.createDayElement(date, month);
                    grid.appendChild(dayEl);
                }
                
                this.updateMonthStats();
            },
            
            createDayElement(date, currentMonth) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                const dateStr = date.toDateString();
                const today = new Date().toDateString();
                
                if (date.getMonth() !== currentMonth) {
                    dayEl.style.opacity = '0.5';
                }
                
                if (dateStr === today) {
                    dayEl.classList.add('today');
                }
                
                const sessions = this.getSessionsForDate(dateStr);
                if (sessions.length > 0) {
                    dayEl.classList.add('has-sessions');
                }
                
                dayEl.innerHTML = `
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">${date.getDate()}</div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                        ${sessions.slice(0, 3).map(session => 
                            `<div style="width: 100%; height: 4px; border-radius: 2px; background: ${session.type === 'completed' ? 'var(--primary)' : 'var(--secondary)'};"></div>`
                        ).join('')}
                    </div>
                    ${sessions.length > 0 ? 
                        `<div style="font-size: 0.7rem; color: var(--text-secondary); text-align: center; margin-top: auto;">${sessions.length} sessioni</div>` : ''
                    }
                `;
                
                dayEl.addEventListener('click', () => this.showDayDetail(dateStr, sessions));
                
                return dayEl;
            },
            
            getSessionsForDate(dateStr) {
                const sessions = [];
                
                if (APP.sessionRatings[dateStr]) {
                    Object.keys(APP.sessionRatings[dateStr]).forEach(hour => {
                        APP.sessionRatings[dateStr][hour].forEach(session => {
                            sessions.push({
                                ...session,
                                type: 'completed',
                                hour: parseInt(hour)
                            });
                        });
                    });
                }
                
                if (APP.calendarSessions[dateStr]) {
                    APP.calendarSessions[dateStr].forEach(session => {
                        sessions.push({
                            ...session,
                            type: 'manual'
                        });
                    });
                }
                
                if (dateStr === new Date().toDateString()) {
                    APP.todayDetailedSessions.forEach(session => {
                        const sessionDate = new Date(session.timestamp).toDateString();
                        if (sessionDate === dateStr) {
                            const exists = sessions.some(s => 
                                Math.abs(new Date(s.timestamp) - new Date(session.timestamp)) < 60000
                            );
                            if (!exists) {
                                sessions.push({
                                    ...session,
                                    type: 'today'
                                });
                            }
                        }
                    });
                }
                
                return sessions.sort((a, b) => (a.hour || 0) - (b.hour || 0));
            },
            
            showDayDetail(dateStr, sessions) {
                APP.currentDayDetailDate = dateStr;
                const modal = document.getElementById('dayDetailModal');
                const title = document.getElementById('dayDetailTitle');
                const sessionsList = document.getElementById('daySessionsList');
                
                const date = new Date(dateStr);
                title.textContent = `üìÖ ${date.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}`;
                
                if (sessions.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <p>Nessuna sessione per questo giorno.</p>
                        </div>
                    `;
                } else {
                    sessionsList.innerHTML = sessions.map((session, index) => {
                        const time = session.timestamp ? 
                            new Date(session.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 
                            session.hour ? `${session.hour}:00` : '--:--';
                        
                        const ratingEmojis = ['üò¥', 'üòê', 'üòä', 'üî•'];
                        const rating = session.rating || 3;
                        
                        return `
                            <div class="session-item fade-in-up">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <div style="font-weight: 700; color: var(--primary-light);">${time}</div>
                                        <div style="color: var(--secondary); font-weight: 600;">${session.materia || 'Sessione generica'}</div>
                                        <div style="font-size: 1.2rem;">${ratingEmojis[rating - 1]}</div>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                        ${session.note || session.option || 'Nessuna nota'}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.8rem;">
                                        ${session.duration || 25} minuti ‚Ä¢ ${session.type === 'manual' ? 'Aggiunta manualmente' : 'Completata con timer'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="btn btn-warning btn-small" onclick="Calendar.editDaySession(${index})" title="Modifica sessione">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-small" onclick="Calendar.deleteDaySession(${index})" title="Elimina sessione">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                modal.style.display = 'flex';
            },
            
            editDaySession(index) {
                Utils.showSuccessMessage('‚öôÔ∏è Funzione modifica sessione in sviluppo');
            },
            
            deleteDaySession(index) {
                if (!APP.currentDayDetailDate) return;
                
                if (confirm('Sei sicuro di voler eliminare questa sessione?')) {
                    const dateStr = APP.currentDayDetailDate;
                    const sessions = this.getSessionsForDate(dateStr);
                    
                    if (index >= 0 && index < sessions.length) {
                        const session = sessions[index];
                        
                        if (session.type === 'manual' && APP.calendarSessions[dateStr]) {
                            const manualIndex = APP.calendarSessions[dateStr].findIndex(s => 
                                s.timestamp === session.timestamp
                            );
                            if (manualIndex !== -1) {
                                APP.calendarSessions[dateStr].splice(manualIndex, 1);
                                if (APP.calendarSessions[dateStr].length === 0) {
                                    delete APP.calendarSessions[dateStr];
                                }
                                localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
                            }
                        } else if (session.type === 'today') {
                            const todayIndex = APP.todayDetailedSessions.findIndex(s => 
                                s.timestamp === session.timestamp
                            );
                            if (todayIndex !== -1) {
                                APP.todayDetailedSessions.splice(todayIndex, 1);
                                APP.timerState.sessionsToday = Math.max(0, APP.timerState.sessionsToday - 1);
                                localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
                                localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
                            }
                        }
                        
                        const updatedSessions = this.getSessionsForDate(dateStr);
                        this.showDayDetail(dateStr, updatedSessions);
                        this.renderCalendar();
                        Sessions.updateAllTodaySessionsList();
                        Timer.updateSessionDisplay();
                        
                        Utils.showSuccessMessage('üóëÔ∏è Sessione eliminata');
                    }
                }
            },
            
            updateMonthStats() {
                const year = APP.currentCalendarDate.getFullYear();
                const month = APP.currentCalendarDate.getMonth();
                
                let totalSessions = 0;
                let totalMinutes = 0;
                let activeDays = new Set();
                
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toDateString();
                    const sessions = this.getSessionsForDate(dateStr);
                    
                    if (sessions.length > 0) {
                        totalSessions += sessions.length;
                        totalMinutes += sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                        activeDays.add(day);
                    }
                }
                
                const avgSessionsPerDay = activeDays.size > 0 ? Math.round(totalSessions / activeDays.size * 10) / 10 : 0;
                
                const elements = {
                    monthSessions: document.getElementById('monthSessions'),
                    monthHours: document.getElementById('monthHours'),
                    monthDays: document.getElementById('monthDays'),
                    monthAverage: document.getElementById('monthAverage')
                };
                
                if (elements.monthSessions) elements.monthSessions.textContent = totalSessions;
                if (elements.monthHours) elements.monthHours.textContent = `${Math.round(totalMinutes / 60 * 10) / 10}h`;
                if (elements.monthDays) elements.monthDays.textContent = activeDays.size;
                if (elements.monthAverage) elements.monthAverage.textContent = avgSessionsPerDay;
            }
        };

        // === STATISTICS ===
        const Statistics = {
            updateStatistiche() {
                const container = document.getElementById('statisticheContent');
                if (!container) return;
                
                if (APP.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    `;
                    return;
                }
                
                const stats = this.calculateStats();
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);">${stats.totalSubjects}</div>
                            <div class="stat-label">Materie Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);">${stats.completedSubjects}</div>
                            <div class="stat-label">Materie Completate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);">${stats.totalPages}</div>
                            <div class="stat-label">Pagine Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);">${stats.studiedPages}</div>
                            <div class="stat-label">Pagine Studiate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent);">${stats.weeklyHours}h</div>
                            <div class="stat-label">Ore Settimanali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary-light);">${stats.avgProgress}%</div>
                            <div class="stat-label">Progresso Medio</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üìà Progresso per Materia</h4>
                        ${APP.materie.filter(m => m.status !== 'completato').map(materia => {
                            const progress = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                            return `
                                <div class="fade-in-up" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem;">
                                        <span style="font-weight: 600; flex: 1; min-width: 150px;">${materia.nome}</span>
                                        <span style="color: var(--secondary); font-weight: 600;">${progress}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            calculateStats() {
                const totalSubjects = APP.materie.length;
                const completedSubjects = APP.materie.filter(m => m.status === 'completato').length;
                const totalPages = APP.materie.reduce((sum, m) => sum + m.pagine, 0);
                const studiedPages = APP.materie.reduce((sum, m) => sum + (m.pagineStudiate || 0), 0);
                
                let weeklyHours = 0;
                APP.materie.forEach(materia => {
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                weeklyHours += Utils.calculateTaskDuration(slot.inizio, slot.fine);
                            });
                        });
                    }
                });
                weeklyHours = Math.round(weeklyHours / 60 * 10) / 10;
                
                const avgProgress = totalPages > 0 ? Math.round((studiedPages / totalPages) * 100) : 0;
                
                return {
                    totalSubjects,
                    completedSubjects,
                    totalPages,
                    studiedPages,
                    weeklyHours,
                    avgProgress
                };
            }
        };

        // === HEATMAP ===
        const Heatmap = {
            updateHeatmap() {
                const heatmapGrid = document.getElementById('heatmapGrid');
                if (!heatmapGrid) return;
                
                heatmapGrid.innerHTML = '';
                
                for (let hour = 0; hour < 24; hour++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.textContent = hour.toString().padStart(2, '0');
                    cell.dataset.hour = hour;
                    
                    const avgRating = this.calculateHourlyAverageRating(hour);
                    
                    if (avgRating === 0) {
                        cell.classList.add('empty');
                    } else if (avgRating <= 1.5) {
                        cell.classList.add('low');
                    } else if (avgRating <= 2.5) {
                        cell.classList.add('medium');
                    } else if (avgRating <= 3.5) {
                        cell.classList.add('high');
                    } else {
                        cell.classList.add('very-high');
                    }
                    
                    cell.addEventListener('mouseenter', (e) => this.showHeatmapTooltip(e, hour));
                    cell.addEventListener('mouseleave', this.hideHeatmapTooltip);
                    
                    heatmapGrid.appendChild(cell);
                }
            },

            calculateHourlyAverageRating(hour) {
                let totalRating = 0;
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                Object.keys(APP.sessionRatings).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date >= thirtyDaysAgo && APP.sessionRatings[dateKey][hour]) {
                        APP.sessionRatings[dateKey][hour].forEach(session => {
                            totalRating += session.rating;
                            sessionCount++;
                        });
                    }
                });
                
                return sessionCount > 0 ? totalRating / sessionCount : 0;
            },

            getHourlySessionCount(hour) {
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                Object.keys(APP.sessionRatings).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date >= thirtyDaysAgo && APP.sessionRatings[dateKey][hour]) {
                        sessionCount += APP.sessionRatings[dateKey][hour].length;
                    }
                });
                
                return sessionCount;
            },

            showHeatmapTooltip(event, hour) {
                const tooltip = document.getElementById('heatmapTooltip');
                if (!tooltip) return;
                
                const avgRating = this.calculateHourlyAverageRating(hour);
                const sessionCount = this.getHourlySessionCount(hour);
                
                let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
                
                if (sessionCount === 0) {
                    content += 'Nessuna sessione registrata';
                } else {
                    const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                     avgRating <= 2.5 ? 'Media' : 
                                     avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    content += `Produttivit√†: ${ratingText}<br>`;
                    content += `${sessionCount} sessioni<br>`;
                    content += `Rating medio: ${avgRating.toFixed(1)}/4`;
                }
                
                tooltip.innerHTML = content;
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY - 10 + 'px';
                tooltip.classList.add('show');
            },

            hideHeatmapTooltip() {
                const tooltip = document.getElementById('heatmapTooltip');
                if (tooltip) {
                    tooltip.classList.remove('show');
                }
            }
        };

        // === PRODUCTIVITY ANALYZER ===
        const ProductivityAnalyzer = {
            updateProductivitySection() {
                this.updateTopHours();
                this.updateProductivitySuggestion();
            },

            updateTopHours() {
                const topHoursGrid = document.getElementById('topHoursGrid');
                if (!topHoursGrid) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = Heatmap.calculateHourlyAverageRating(hour);
                    const sessionCount = Heatmap.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const top3 = hourlyRatings.slice(0, 3);
                
                if (top3.length === 0) {
                    topHoursGrid.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                            <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                        </div>
                    `;
                    return;
                }
                
                topHoursGrid.innerHTML = top3.map((hour, index) => {
                    const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                      hour.avgRating <= 2.5 ? 'Media' : 
                                      hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    
                    const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
                    
                    return `
                        <div class="fade-in-up" style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; text-align: center; border: 2px solid var(--border); transition: all 0.3s ease;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success); margin-bottom: 0.5rem;">${rankEmojis[index]}</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-light); margin-bottom: 0.5rem;">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                                <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateProductivitySuggestion() {
                const suggestionEl = document.getElementById('productivitySuggestion');
                if (!suggestionEl) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = Heatmap.calculateHourlyAverageRating(hour);
                    const sessionCount = Heatmap.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                if (hourlyRatings.length === 0) {
                    suggestionEl.innerHTML = `
                        <h4 style="color: var(--primary-light); margin-bottom: 0.75rem;">üí° Suggerimento Smart</h4>
                        <p style="color: var(--text-primary);">Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi√π produttivi!</p>
                    `;
                    return;
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const bestHour = hourlyRatings[0];
                const worstHour = hourlyRatings[hourlyRatings.length - 1];
                
                let suggestion = '';
                
                if (bestHour.avgRating >= 3.5) {
                    suggestion = `üåü Ottimo! Il tuo momento migliore √® alle ${bestHour.hour}:00 con un rating di ${bestHour.avgRating.toFixed(1)}/4. Cerca di programmare le materie pi√π difficili in questo orario.`;
                } else if (bestHour.avgRating >= 2.5) {
                    suggestion = `üìà Il tuo orario pi√π produttivo √® alle ${bestHour.hour}:00. Prova a ottimizzare questo slot con pause regolari.`;
                } else {
                    suggestion = `‚ö° Il tuo orario migliore √® alle ${bestHour.hour}:00, ma puoi migliorare. Sperimenta con diverse tecniche di studio.`;
                }
                
                if (worstHour.avgRating < 2 && hourlyRatings.length > 3) {
                    suggestion += ` Evita di studiare alle ${worstHour.hour}:00 quando possibile.`;
                }
                
                suggestionEl.innerHTML = `
                    <h4 style="color: var(--primary-light); margin-bottom: 0.75rem;">üí° Suggerimento Smart</h4>
                    <p style="color: var(--text-primary);">${suggestion}</p>
                `;
            }
        };

        // === PIANO STUDIO ===
        const PianoStudio = {
            generatePianoStudio() {
                try {
                    const materieInStudio = APP.materie.filter(m => m.status !== 'completato');
                    
                    if (materieInStudio.length === 0) {
                        this.showEmptyPlanState();
                        return;
                    }

                    const planMetrics = this.calculatePlanMetrics(materieInStudio);
                    this.updatePlanOverview(planMetrics);
                    this.generateAISuggestions(materieInStudio, planMetrics);
                    this.generatePlanDetails(materieInStudio);
                    
                } catch (error) {
                    console.error('Errore nella generazione del piano:', error);
                }
            },

            calculatePlanMetrics(materieInStudio) {
                let totalWeeklyHours = 0;
                let totalPages = 0;
                let totalRemainingPages = 0;
                let estimatedCompletionWeeks = 0;

                materieInStudio.forEach(materia => {
                    let oreSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreSettimanali += durata;
                            });
                        });
                    }
                    totalWeeklyHours += oreSettimanali / 60;
                    
                    totalPages += materia.pagine;
                    const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                    totalRemainingPages += pagineRimanenti;
                    
                    if (oreSettimanali > 0 && pagineRimanenti > 0) {
                        const paginePerSettimana = (oreSettimanali / 60) * (materia.pagineOra || 8);
                        const settimaneRimanenti = Math.ceil(pagineRimanenti / paginePerSettimana);
                        estimatedCompletionWeeks = Math.max(estimatedCompletionWeeks, settimaneRimanenti);
                    }
                });

                return {
                    totalWeeklyHours: Math.round(totalWeeklyHours * 10) / 10,
                    avgDailyHours: Math.round((totalWeeklyHours / 7) * 10) / 10,
                    totalPages,
                    totalRemainingPages,
                    estimatedCompletionWeeks,
                    subjectsCount: materieInStudio.length
                };
            },

            updatePlanOverview(metrics) {
                const elements = {
                    planSummary: document.getElementById('planSummary'),
                    totalWeeklyHours: document.getElementById('totalWeeklyHours'),
                    avgDailyHours: document.getElementById('avgDailyHours'),
                    totalPages: document.getElementById('totalPages'),
                    completionWeeks: document.getElementById('completionWeeks')
                };

                if (elements.planSummary) {
                    const summaryText = `Piano ottimizzato per ${metrics.subjectsCount} materie con un carico di studio di ${metrics.totalWeeklyHours}h settimanali. Completamento stimato in ${metrics.estimatedCompletionWeeks || 'N/A'} settimane.`;
                    elements.planSummary.textContent = summaryText;
                }

                if (elements.totalWeeklyHours) elements.totalWeeklyHours.textContent = `${metrics.totalWeeklyHours}h`;
                if (elements.avgDailyHours) elements.avgDailyHours.textContent = `${metrics.avgDailyHours}h`;
                if (elements.totalPages) elements.totalPages.textContent = metrics.totalRemainingPages;
                if (elements.completionWeeks) elements.completionWeeks.textContent = metrics.estimatedCompletionWeeks || 'N/A';
            },

            generateAISuggestions(materieInStudio, metrics) {
                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestionsList) return;

                const suggestions = [];
                
                if (metrics.avgDailyHours > 6) {
                    suggestions.push({
                        title: "‚ö†Ô∏è Carico di Studio Intenso",
                        description: `Con ${metrics.avgDailyHours}h al giorno, considera di distribuire meglio il carico per evitare il burnout.`
                    });
                } else if (metrics.avgDailyHours < 2) {
                    suggestions.push({
                        title: "‚ö° Opportunit√† di Ottimizzazione",
                        description: `Con solo ${metrics.avgDailyHours}h al giorno, potresti aumentare le ore di studio per raggiungere prima i tuoi obiettivi.`
                    });
                }

                const materieConScadenza = materieInStudio.filter(m => m.dataEsame);
                if (materieConScadenza.length > 0) {
                    const prossimeScadenze = materieConScadenza
                        .map(m => ({ ...m, daysToExam: Utils.getDaysToExam(m.dataEsame) }))
                        .filter(m => m.daysToExam <= 30 && m.daysToExam > 0)
                        .sort((a, b) => a.daysToExam - b.daysToExam);

                    if (prossimeScadenze.length > 0) {
                        suggestions.push({
                            title: "üéØ Focus su Priorit√†",
                            description: `${prossimeScadenze[0].nome} ha l'esame tra ${prossimeScadenze[0].daysToExam} giorni. Concentra i tuoi sforzi!`
                        });
                    }
                }

                // MIGLIORAMENTO: Analisi bilanciamento materie
                const materieConSlots = materieInStudio.filter(m => m.slotSettimanali && Object.values(m.slotSettimanali).some(slots => slots.length > 0));
                if (materieConSlots.length < materieInStudio.length) {
                    suggestions.push({
                        title: "üìÖ Ottimizza Programmazione",
                        description: `${materieInStudio.length - materieConSlots.length} materie non hanno slot temporali definiti. Aggiungi degli orari per ottimizzare il piano.`
                    });
                }

                if (suggestions.length === 0) {
                    suggestions.push({
                        title: "‚úÖ Piano Ottimale",
                        description: "Il tuo piano di studio √® ben bilanciato! Continua cos√¨ e mantieni la costanza."
                    });
                }

                suggestionsList.innerHTML = suggestions.map(s => `
                    <div class="fade-in-up" style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">${s.title}</div>
                        <div style="color: var(--text-primary);">${s.description}</div>
                    </div>
                `).join('');
            },

            generatePlanDetails(materieInStudio) {
                const detailsContainer = document.getElementById('pianDetails');
                if (!detailsContainer) return;

                if (materieInStudio.length === 0) {
                    detailsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Aggiungi delle materie per generare il tuo piano personalizzato!</p>
                        </div>
                    `;
                    return;
                }

                const materieOrdinate = materieInStudio
                    .map(m => ({ ...m, smartPriority: Utils.calculateSmartPriority(m) }))
                    .sort((a, b) => b.smartPriority - a.smartPriority);

                detailsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-top: 2rem;">
                        ${materieOrdinate.map((materia, index) => {
                            const progress = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                            const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                            const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                            
                            let oreTotaliSettimanali = 0;
                            let slotsInfo = 'Nessun slot definito';
                            
                            if (materia.slotSettimanali) {
                                const slots = [];
                                Object.entries(materia.slotSettimanali).forEach(([giorno, slotArray]) => {
                                    slotArray.forEach(slot => {
                                        const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                        oreTotaliSettimanali += durata;
                                        slots.push(`${giorno.charAt(0).toUpperCase() + giorno.slice(1)}: ${slot.inizio}-${slot.fine}`);
                                    });
                                });
                                
                                if (slots.length > 0) {
                                    slotsInfo = slots.slice(0, 3).join('<br>') + (slots.length > 3 ? '<br>...' : '');
                                }
                            }
                            
                            const oreSettimanaliFormatted = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                            const settimaneRimanenti = oreSettimanaliFormatted > 0 ? 
                                Math.ceil(pagineRimanenti / ((oreSettimanaliFormatted) * (materia.pagineOra || 8))) : 'N/A';
                            
                            let borderColor = 'var(--border)';
                            let priorityIcon = 'üìö';
                            if (index === 0) { borderColor = 'var(--danger)'; priorityIcon = 'üö®'; }
                            else if (index === 1) { borderColor = 'var(--warning)'; priorityIcon = 'üî•'; }
                            else if (index === 2) { borderColor = 'var(--primary)'; priorityIcon = '‚≠ê'; }
                            
                            return `
                                <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--border-radius); padding: 1.5rem; border-left: 4px solid ${borderColor}; transition: all var(--transition);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-light); flex: 1; min-width: 150px;">${materia.nome}</div>
                                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                            <div style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; background: rgba(245, 158, 11, 0.2); color: #fcd34d;">${materia.priorita}</div>
                                            <div style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.7rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;" title="Posizione nella priorit√†">
                                                ${priorityIcon} #${index + 1}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${progress}%</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Completato</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${pagineRimanenti}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Pagine Rim.</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">${oreSettimanaliFormatted}h</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Ore/Sett.</div>
                                        </div>
                                        <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${settimaneRimanenti}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Sett. Stim.</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                                        <div style="font-weight: 600; color: var(--primary-light); margin-bottom: 0.5rem;">üéØ Score Intelligente</div>
                                        <div style="font-size: 0.9rem; color: var(--text-primary);">
                                            <strong>${materia.smartPriority} punti</strong> ‚Ä¢ Posizione: <strong>#${index + 1}</strong>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">üìÖ Programma:</div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${slotsInfo}</div>
                                    </div>
                                    
                                    ${materia.dataEsame ? `
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: ${daysToExam <= 14 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px;">
                                            <strong>üìÖ Esame:</strong> ${new Date(materia.dataEsame).toLocaleDateString('it-IT')}<br>
                                            <small style="color: ${daysToExam <= 14 ? 'var(--danger)' : 'var(--warning)'};">
                                                ${daysToExam <= 7 ? 'üö® URGENTE: ' : '‚ö†Ô∏è '}Giorni rimanenti: ${daysToExam || 'N/A'}
                                            </small>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            showEmptyPlanState() {
                const detailsContainer = document.getElementById('pianDetails');
                const suggestionsList = document.getElementById('suggestionsList');
                
                if (detailsContainer) {
                    detailsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Aggiungi delle materie per generare il tuo piano personalizzato!</p>
                            <p style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="showSection('materie', document.querySelector('.nav-tab[onclick*=materie]'))">
                                    ‚ûï Aggiungi Prima Materia
                                </button>
                            </p>
                        </div>
                    `;
                }
                
                if (suggestionsList) {
                    suggestionsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>Aggiungi delle materie per ricevere suggerimenti personalizzati!</p>
                        </div>
                    `;
                }
            }
        };

        // === FUNZIONI GLOBALI ===
        function addMateria() {
            try {
                const nome = document.getElementById('nomeMateria').value.trim();
                const cfu = parseInt(document.getElementById('cfu').value);
                const anno = parseInt(document.getElementById('anno').value);
                const semestre = document.getElementById('semestre').value; // MIGLIORAMENTO: Pu√≤ essere 'annuale'
                const pagine = parseInt(document.getElementById('pagine').value);
                const pagineStudiate = parseInt(document.getElementById('pagineStudiate').value) || 0;
                const pagineOra = parseInt(document.getElementById('pagineOra').value) || 8;
                const dataEsame = document.getElementById('dataEsame').value;
                const priorita = document.getElementById('priorita').value;

                if (!nome || !cfu || !anno || !semestre || !pagine) {
                    Utils.showSuccessMessage('‚ùå Compila tutti i campi obbligatori');
                    return;
                }

                if (pagineStudiate > pagine) {
                    Utils.showSuccessMessage('‚ùå Le pagine studiate non possono essere superiori al totale');
                    return;
                }

                const slotSettimanali = WeeklySlots.getWeeklySlots();
                let hasSlots = false;
                Object.values(slotSettimanali).forEach(slots => {
                    if (slots.length > 0) hasSlots = true;
                });

                if (!hasSlots && semestre !== 'annuale') {
                    const conferma = confirm('Non hai definito slot temporali per questa materia. Vuoi continuare comunque?');
                    if (!conferma) return;
                }

                const nuovaMateria = {
                    id: Date.now(),
                    nome, cfu, anno, semestre, pagine, pagineStudiate, pagineOra, dataEsame, priorita,
                    difficolta: APP.difficoltaSelezionata,
                    slotSettimanali,
                    status: 'studio',
                    dataCreazione: new Date().toISOString()
                };

                APP.materie.push(nuovaMateria);
                MaterieManager.saveMaterie();
                
                // MIGLIORAMENTO: Gestione materie annuali nel curriculum
                const existingCurrSubject = APP.curriculum.find(c => 
                    c.nome === nome && c.anno === anno && 
                    (c.semestre === semestre || semestre === 'annuale')
                );
                
                if (!existingCurrSubject) {
                    const curriculumSubject = {
                        id: Date.now() + 1,
                        nome: nome, anno: anno, semestre: semestre, cfu: cfu,
                        professore: '', note: 'Aggiunta automaticamente dalla sezione Materie',
                        completato: false, dataCreazione: new Date().toISOString()
                    };
                    
                    APP.curriculum.push(curriculumSubject);
                    CurriculumManager.saveCurriculum();
                }
                
                MaterieManager.loadMaterie();
                
                // Reset form
                ['nomeMateria', 'cfu', 'anno', 'semestre', 'pagine', 'dataEsame'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                document.getElementById('pagineStudiate').value = '0';
                document.getElementById('pagineOra').value = '8';
                document.getElementById('priorita').value = 'media';
                APP.difficoltaSelezionata = 3;
                
                WeeklySlots.initializeWeeklySlots();
                StarRating.setupStarRating();
                
                SmartPlanner.generateTodaySchedule();
                PianoStudio.generatePianoStudio();
                CurriculumManager.loadCurriculumData();
                
                Utils.showSuccessMessage('‚úÖ Materia aggiunta con successo!');
                
            } catch (error) {
                console.error('Errore nell\'aggiunta materia:', error);
                Utils.showSuccessMessage('‚ùå Errore nell\'aggiunta della materia');
            }
        }

        function setPreset(work, breakTime, targetElement) {
            try {
                if (APP.timerState.isRunning) return;
                
                APP.timerState.workTime = work;
                APP.timerState.breakTime = breakTime;
                APP.timerState.minutes = work;
                APP.timerState.seconds = 0;
                APP.timerState.isBreak = false;
                
                Timer.updateTimerDisplay();
                
                document.querySelectorAll('.btn-secondary.active').forEach(btn => btn.classList.remove('active'));
                if (targetElement) {
                    targetElement.classList.add('active');
                }
            } catch (error) {
                console.error('Errore nel preset timer:', error);
            }
        }

        function startTimer() {
            if (APP.timerState.isRunning) return;
            
            APP.timerState.isRunning = true;
            APP.currentSessionStartTime = new Date();
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.add('hidden');
            if (pauseBtn) pauseBtn.classList.remove('hidden');
            
            APP.timerInterval = setInterval(() => {
                if (APP.timerState.seconds === 0) {
                    if (APP.timerState.minutes === 0) {
                        clearInterval(APP.timerInterval);
                        completeSession();
                        return;
                    } else {
                        APP.timerState.minutes--;
                        APP.timerState.seconds = 59;
                    }
                } else {
                    APP.timerState.seconds--;
                }
                
                Timer.updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            if (!APP.timerState.isRunning) return;
            
            APP.timerState.isRunning = false;
            clearInterval(APP.timerInterval);
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
        }

        function resetTimer() {
            APP.timerState.isRunning = false;
            clearInterval(APP.timerInterval);
            
            APP.timerState.minutes = APP.timerState.workTime;
            APP.timerState.seconds = 0;
            APP.timerState.isBreak = false;
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            Timer.updateTimerDisplay();
        }

        function completeSession() {
            APP.timerState.isRunning = false;
            
            if (!APP.timerState.isBreak) {
                APP.timerState.sessionsToday++;
                APP.studyData.totalSessions++;
                
                const today = new Date().toDateString();
                if (APP.studyData.lastStudyDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (APP.studyData.lastStudyDate === yesterday.toDateString()) {
                        APP.studyData.streak++;
                    } else {
                        APP.studyData.streak = 1;
                    }
                    APP.studyData.lastStudyDate = today;
                }
                
                localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
                localStorage.setItem('lastSessionDate', today);
                localStorage.setItem('studyStreak', APP.studyData.streak);
                localStorage.setItem('lastStudyDate', APP.studyData.lastStudyDate);
                localStorage.setItem('totalSessions', APP.studyData.totalSessions);
                
                Timer.updateSessionDisplay();
                updateStreakDisplay();
                
                showRatingModal();
                
                if (APP.timerState.breakTime > 0) {
                    setTimeout(() => {
                        APP.timerState.isBreak = true;
                        APP.timerState.minutes = APP.timerState.breakTime;
                        APP.timerState.seconds = 0;
                        Timer.updateTimerDisplay();
                        Utils.showSuccessMessage('‚è∏Ô∏è Inizia la tua pausa!');
                    }, 2000);
                }
            } else {
                APP.timerState.isBreak = false;
                APP.timerState.minutes = APP.timerState.workTime;
                APP.timerState.seconds = 0;
                Timer.updateTimerDisplay();
                Utils.showSuccessMessage('üöÄ Pausa finita! Torna al lavoro!');
            }
            
            resetTimer();
        }

        function showRatingModal() {
            // Reset del modal
            document.getElementById('sessionTypeStep').style.display = 'block';
            document.getElementById('progressStep').classList.add('hidden');
            document.getElementById('ratingStep').classList.add('hidden');
            
            // Reset selections
            APP.sessionType = null;
            APP.progressType = null;
            document.getElementById('sessionNote').value = '';
            document.getElementById('studiedPages').value = '';
            document.getElementById('exercisesDone').value = '';
            
            // Reset button styles
            resetButtonStyles();
            
            document.getElementById('ratingModal').style.display = 'flex';
        }

        // NUOVE FUNZIONI per il tracking del progresso
        function selectSessionType(type) {
            APP.sessionType = type;
            
            // Reset button styles
            document.getElementById('studySessionBtn').style.borderColor = 'var(--border)';
            document.getElementById('reviewSessionBtn').style.borderColor = 'var(--border)';
            document.getElementById('studySessionBtn').style.background = 'var(--bg-tertiary)';
            document.getElementById('reviewSessionBtn').style.background = 'var(--bg-tertiary)';
            
            // Highlight selected
            const selectedBtn = type === 'study' ? 'studySessionBtn' : 'reviewSessionBtn';
            document.getElementById(selectedBtn).style.borderColor = 'var(--primary)';
            document.getElementById(selectedBtn).style.background = 'rgba(139, 92, 246, 0.1)';
            
            // Procedi al prossimo step
            setTimeout(() => {
                document.getElementById('sessionTypeStep').style.display = 'none';
                
                if (type === 'study') {
                    // Mostra step progresso solo per sessioni di studio
                    document.getElementById('progressStep').classList.remove('hidden');
                } else {
                    // Vai direttamente al rating per sessioni di ripasso
                    document.getElementById('ratingStep').classList.remove('hidden');
                }
            }, 300);
        }

        function selectProgressType(type) {
            APP.progressType = type;
            
            // Reset button styles
            document.getElementById('pagesStudyBtn').style.borderColor = 'var(--border)';
            document.getElementById('exercisesBtn').style.borderColor = 'var(--border)';
            document.getElementById('pagesStudyBtn').style.background = 'var(--bg-tertiary)';
            document.getElementById('exercisesBtn').style.background = 'var(--bg-tertiary)';
            
            // Hide all inputs
            document.getElementById('pagesInput').classList.add('hidden');
            document.getElementById('exercisesInput').classList.add('hidden');
            
            // Show selected input and highlight button
            if (type === 'pages') {
                document.getElementById('pagesStudyBtn').style.borderColor = 'var(--primary)';
                document.getElementById('pagesStudyBtn').style.background = 'rgba(139, 92, 246, 0.1)';
                document.getElementById('pagesInput').classList.remove('hidden');
                document.getElementById('studiedPages').focus();
            } else {
                document.getElementById('exercisesBtn').style.borderColor = 'var(--primary)';
                document.getElementById('exercisesBtn').style.background = 'rgba(139, 92, 246, 0.1)';
                document.getElementById('exercisesInput').classList.remove('hidden');
                document.getElementById('exercisesDone').focus();
            }
            
            // MIGLIORAMENTO: Auto-proceed al rating step solo dopo che l'utente ha inserito qualcosa
            const targetInput = type === 'pages' ? 'studiedPages' : 'exercisesDone';
            const inputElement = document.getElementById(targetInput);
            
            // Listener per procedere automaticamente quando l'utente inserisce un valore
            const proceedToRating = () => {
                if (inputElement.value && parseInt(inputElement.value) > 0) {
                    setTimeout(() => {
                        document.getElementById('progressStep').classList.add('hidden');
                        document.getElementById('ratingStep').classList.remove('hidden');
                    }, 500);
                    inputElement.removeEventListener('input', proceedToRating);
                }
            };
            
            inputElement.addEventListener('input', proceedToRating);
            
            // Fallback: procedi comunque dopo 10 secondi se l'utente non inserisce nulla
            setTimeout(() => {
                if (!document.getElementById('ratingStep').classList.contains('hidden')) return;
                document.getElementById('progressStep').classList.add('hidden');
                document.getElementById('ratingStep').classList.remove('hidden');
                inputElement.removeEventListener('input', proceedToRating);
            }, 10000);
        }

        function resetButtonStyles() {
            // Reset tutti gli stili dei bottoni
            const buttons = ['studySessionBtn', 'reviewSessionBtn', 'pagesStudyBtn', 'exercisesBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.borderColor = 'var(--border)';
                    btn.style.background = 'var(--bg-tertiary)';
                }
            });
        }

        function submitRating(rating) {
            const sessionNote = document.getElementById('sessionNote').value || '';
            const today = new Date().toDateString();
            const hour = new Date().getHours();
            
            if (!APP.sessionRatings[today]) {
                APP.sessionRatings[today] = {};
            }
            if (!APP.sessionRatings[today][hour]) {
                APP.sessionRatings[today][hour] = [];
            }
            
            // MIGLIORAMENTO: Raccogli dati progresso
            let progressData = {
                sessionType: APP.sessionType || 'review',
                progressType: APP.progressType,
                studiedPages: 0,
                exercisesDone: 0
            };
            
            if (APP.sessionType === 'study' && APP.progressType) {
                if (APP.progressType === 'pages') {
                    progressData.studiedPages = parseInt(document.getElementById('studiedPages').value) || 0;
                } else if (APP.progressType === 'exercises') {
                    progressData.exercisesDone = parseInt(document.getElementById('exercisesDone').value) || 0;
                    // Converte esercizi in pagine equivalenti (1 esercizio = 1 pagina)
                    progressData.studiedPages = progressData.exercisesDone;
                }
            }
            
            const sessionData = {
                rating: rating,
                note: sessionNote,
                materia: APP.currentSessionData?.materia || 'Sessione generica',
                option: APP.currentSessionData?.option || '',
                timestamp: new Date().toISOString(),
                duration: APP.timerState.workTime,
                ...progressData
            };
            
            APP.sessionRatings[today][hour].push(sessionData);
            localStorage.setItem('sessionRatings', JSON.stringify(APP.sessionRatings));
            
            APP.todayDetailedSessions.push(sessionData);
            localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
            
            // MIGLIORAMENTO: Aggiorna progresso materia se √® una sessione di studio
            if (APP.sessionType === 'study' && progressData.studiedPages > 0 && APP.currentSessionData?.materia) {
                updateMateriaProgress(APP.currentSessionData.materia, progressData.studiedPages);
            }
            
            document.getElementById('ratingModal').style.display = 'none';
            
            Sessions.updateAllTodaySessionsList();
            Calendar.renderCalendar();
            
            const messages = [
                'üò¥ Riposa un po\' e riprova pi√π tardi!',
                'üòê Buon lavoro! La prossima andr√† meglio!',
                'üòä Ottimo lavoro! Continua cos√¨!',
                'üî• Fantastico! Sei in zona di massima produttivit√†!'
            ];
            
            let finalMessage = messages[rating - 1];
            if (APP.sessionType === 'study' && progressData.studiedPages > 0) {
                finalMessage += ` +${progressData.studiedPages} pagine completate! üìö`;
            }
            
            Utils.showSuccessMessage(finalMessage);
        }

        // NUOVA FUNZIONE: Aggiorna progresso materia
        function updateMateriaProgress(materiaName, pagineStudiate) {
            const materia = APP.materie.find(m => m.nome === materiaName && m.status !== 'completato');
            
            if (materia && pagineStudiate > 0) {
                const oldProgress = materia.pagineStudiate || 0;
                const newProgress = Math.min(oldProgress + pagineStudiate, materia.pagine);
                
                materia.pagineStudiate = newProgress;
                MaterieManager.saveMaterie();
                
                // Aggiorna visualizzazioni
                MaterieManager.loadMaterie();
                SmartPlanner.generateTodaySchedule();
                PianoStudio.generatePianoStudio();
                Statistics.updateStatistiche();
                
                // Notifica se materia completata
                if (newProgress === materia.pagine) {
                    setTimeout(() => {
                        Utils.showSuccessMessage(`üéâ Complimenti! Hai completato lo studio di ${materiaName}! Ora puoi sostenere l'esame.`);
                    }, 1000);
                }
            }
        }

        function updateStreakDisplay() {
            const streakEl = document.getElementById('streakNumber');
            if (streakEl) {
                streakEl.textContent = APP.studyData.streak;
            }
        }

        function updateDailyGoal() {
            const goalValue = parseInt(document.getElementById('dailyGoal').value);
            if (goalValue && goalValue > 0 && goalValue <= 20) {
                APP.timerState.dailyGoal = goalValue;
                localStorage.setItem('dailyGoal', goalValue);
                Timer.updateSessionDisplay();
            }
        }

        function iniziaTask() {
            if (!APP.selectedTaskOption) {
                Utils.showSuccessMessage('‚ö†Ô∏è Seleziona prima cosa vuoi studiare');
                return;
            }
            
            startTimer();
            Utils.showSuccessMessage('üöÄ Sessione di studio iniziata!');
        }

        // === SPIEGAZIONE SCORE ===
        function toggleScoreExplanation() {
            const details = document.getElementById('scoreExplanationDetails');
            const icon = document.getElementById('scoreToggleIcon');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
            } else {
                details.classList.add('hidden');
                icon.textContent = '‚ñº';
            }
        }

        // Timer personalizzato
        function showCustomTimerDialog() {
            document.getElementById('customTimerModal').style.display = 'flex';
        }

        function closeCustomTimerModal() {
            document.getElementById('customTimerModal').style.display = 'none';
        }

        function applyCustomTimer() {
            const workTime = parseInt(document.getElementById('customWorkTime').value);
            const breakTime = parseInt(document.getElementById('customBreakTime').value);
            
            if (!workTime || workTime < 1 || workTime > 180) {
                Utils.showSuccessMessage('‚ùå Inserisci un tempo di studio valido (1-180 minuti)');
                return;
            }
            
            if (breakTime < 0 || breakTime > 60) {
                Utils.showSuccessMessage('‚ùå Inserisci un tempo di pausa valido (0-60 minuti)');
                return;
            }
            
            document.querySelectorAll('.btn-secondary.active').forEach(btn => btn.classList.remove('active'));
            
            setPreset(workTime, breakTime, null);
            closeCustomTimerModal();
            
            Utils.showSuccessMessage(`‚úÖ Timer personalizzato: ${workTime}/${breakTime} minuti`);
        }

        function showDeleteAllTodaySessionsModal() {
            const allSessions = [...APP.todayDetailedSessions];
            const today = new Date().toDateString();
            if (APP.calendarSessions[today]) {
                allSessions.push(...APP.calendarSessions[today]);
            }
            
            if (allSessions.length === 0) {
                Utils.showSuccessMessage('üìù Non ci sono sessioni da eliminare');
                return;
            }
            
            const conferma = confirm(`Sei sicuro di voler eliminare tutte le ${allSessions.length} sessioni di oggi?\n\nQuesta azione non pu√≤ essere annullata.`);
            
            if (conferma) {
                APP.todayDetailedSessions = [];
                APP.timerState.sessionsToday = 0;
                
                if (APP.calendarSessions[today]) {
                    delete APP.calendarSessions[today];
                    localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
                }
                
                localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                localStorage.setItem('sessionsToday', 0);
                
                Sessions.updateAllTodaySessionsList();
                Timer.updateSessionDisplay();
                Calendar.renderCalendar();
                Utils.showSuccessMessage('üóëÔ∏è Tutte le sessioni di oggi sono state eliminate');
            }
        }

        function changeMonth(direction) {
            APP.currentCalendarDate.setMonth(APP.currentCalendarDate.getMonth() + direction);
            Calendar.renderCalendar();
        }

        function goToToday() {
            APP.currentCalendarDate = new Date();
            Calendar.renderCalendar();
        }

        function addManualSession() {
            // MIGLIORAMENTO: Correzione bug data
            document.getElementById('sessionDate').value = Utils.formatDateForInput(new Date());
            
            const select = document.getElementById('sessionMateria');
            select.innerHTML = '<option value="">Sessione generica</option>';
            APP.materie.forEach(materia => {
                if (materia.status !== 'completato') {
                    select.innerHTML += `<option value="${materia.nome}">${materia.nome}</option>`;
                }
            });
            
            document.getElementById('addSessionModal').style.display = 'flex';
        }

        function addSessionToDay() {
            if (!APP.currentDayDetailDate) return;
            
            const dayDate = Utils.parseDateFromInput(APP.currentDayDetailDate);
            document.getElementById('sessionDate').value = Utils.formatDateForInput(dayDate);
            
            const select = document.getElementById('sessionMateria');
            select.innerHTML = '<option value="">Sessione generica</option>';
            APP.materie.forEach(materia => {
                if (materia.status !== 'completato') {
                    select.innerHTML += `<option value="${materia.nome}">${materia.nome}</option>`;
                }
            });
            
            document.getElementById('addSessionModal').style.display = 'flex';
        }

        function closeAddSessionModal() {
            document.getElementById('addSessionModal').style.display = 'none';
        }

        function saveManualSession() {
            const dateInput = document.getElementById('sessionDate').value;
            const materia = document.getElementById('sessionMateria').value || 'Sessione generica';
            const duration = parseInt(document.getElementById('sessionDuration').value) || 25;
            const note = document.getElementById('sessionNote').value || '';
            
            if (!dateInput) {
                Utils.showSuccessMessage('‚ùå Seleziona una data');
                return;
            }
            
            // MIGLIORAMENTO: Correzione bug data - usa la data locale corretta
            const selectedDate = Utils.parseDateFromInput(dateInput);
            const dateStr = selectedDate.toDateString();
            
            if (!APP.calendarSessions[dateStr]) {
                APP.calendarSessions[dateStr] = [];
            }
            
            const sessionData = {
                id: Date.now(),
                materia,
                duration,
                note,
                timestamp: selectedDate.toISOString(),
                type: 'manual',
                rating: 3
            };
            
            APP.calendarSessions[dateStr].push(sessionData);
            localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
            
            const today = new Date().toDateString();
            if (dateStr === today) {
                Sessions.updateAllTodaySessionsList();
            }
            
            Calendar.renderCalendar();
            closeAddSessionModal();
            
            if (APP.currentDayDetailDate === dateStr) {
                const sessions = Calendar.getSessionsForDate(dateStr);
                Calendar.showDayDetail(dateStr, sessions);
            }
            
            document.getElementById('sessionNote').value = '';
            
            Utils.showSuccessMessage('‚úÖ Sessione aggiunta al calendario!');
        }

        function closeDayDetailModal() {
            document.getElementById('dayDetailModal').style.display = 'none';
            APP.currentDayDetailDate = null;
        }

        function saveExamGrade() {
            const materiaId = parseInt(document.getElementById('examModal').dataset.materiaId);
            const voto = parseInt(document.getElementById('examGrade').value);
            const lode = document.getElementById('examLode').checked;
            const dataEsame = document.getElementById('examDate').value;
            
            if (!voto || voto < 18 || voto > 30) {
                Utils.showSuccessMessage('‚ùå Inserisci un voto valido (18-30)');
                return;
            }
            
            const materia = APP.materie.find(m => m.id === materiaId);
            if (!materia) return;
            
            materia.status = 'completato';
            
            const nuovoEsame = {
                id: Date.now(),
                materiaId: materiaId,
                voto: voto,
                lode: lode && voto === 30,
                dataEsame: dataEsame || new Date().toISOString().split('T')[0],
                dataCreazione: new Date().toISOString()
            };
            
            APP.esami.push(nuovoEsame);
            
            // MIGLIORAMENTO: Gestione materie annuali nel curriculum
            const currSubjects = APP.curriculum.filter(c => 
                c.nome === materia.nome && c.anno === materia.anno && 
                (c.semestre === materia.semestre || materia.semestre === 'annuale')
            );
            
            currSubjects.forEach(currSubject => {
                currSubject.completato = true;
                currSubject.voto = voto;
                currSubject.lode = lode && voto === 30;
                currSubject.dataCompletamento = dataEsame || new Date().toISOString().split('T')[0];
            });
            
            MaterieManager.saveMaterie();
            ExamManager.saveEsami();
            CurriculumManager.saveCurriculum();
            
            MaterieManager.loadMaterie();
            ExamManager.updateExamsSection();
            CurriculumManager.loadCurriculumData();
            SmartPlanner.generateTodaySchedule();
            PianoStudio.generatePianoStudio();
            
            closeExamModal();
            
            Utils.showSuccessMessage(`üéì Esame di ${materia.nome} registrato con voto ${voto}${lode ? 'L' : ''}!`);
        }

        function closeExamModal() {
            document.getElementById('examModal').style.display = 'none';
            document.getElementById('examGrade').value = '';
            document.getElementById('examLode').checked = false;
            document.getElementById('examDate').value = '';
        }

        function showAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'flex';
        }

        function closeAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'none';
        }

        function saveCurriculumSubject() {
            const nome = document.getElementById('currSubjectName').value.trim();
            const anno = parseInt(document.getElementById('currSubjectYear').value);
            const semestre = document.getElementById('currSubjectSemester').value; // MIGLIORAMENTO: Pu√≤ essere 'annuale'
            const cfu = parseInt(document.getElementById('currSubjectCFU').value);
            
            if (!nome || !anno || !semestre || !cfu) {
                Utils.showSuccessMessage('‚ùå Compila tutti i campi obbligatori');
                return;
            }
            
            const nuovaMateria = {
                id: Date.now(),
                nome, anno, semestre, cfu,
                professore: '', note: '',
                completato: false,
                dataCreazione: new Date().toISOString()
            };
            
            APP.curriculum.push(nuovaMateria);
            CurriculumManager.saveCurriculum();
            CurriculumManager.loadCurriculumData();
            
            closeAddSubjectModal();
            
            document.getElementById('currSubjectName').value = '';
            document.getElementById('currSubjectYear').value = '1';
            document.getElementById('currSubjectSemester').value = '1';
            document.getElementById('currSubjectCFU').value = '';
            
            Utils.showSuccessMessage('‚úÖ Materia aggiunta al curriculum!');
        }

        function showCurriculumYear(year, tabElement) {
            APP.currentCurriculumYear = year;
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.textContent.includes('Anno')) {
                    tab.classList.remove('active');
                }
            });
            if (tabElement) tabElement.classList.add('active');
            
            document.querySelectorAll('.year-content').forEach(content => content.classList.add('hidden'));
            const targetContent = document.getElementById(`year-${year}`);
            if (targetContent) targetContent.classList.remove('hidden');
        }

        function exportCurriculumData() {
            const data = JSON.stringify(APP.curriculum, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `curriculum_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            Utils.showSuccessMessage('üì§ Curriculum esportato!');
        }

        function showRecoveryOptions() {
            Utils.showSuccessMessage('üîß Funzione opzioni recupero in sviluppo');
        }

        // === HELPER FUNCTIONS ===
        function prioritizeByDate() {
            if (APP.materie.length === 0) {
                Utils.showSuccessMessage('‚ùå Aggiungi prima delle materie');
                return;
            }

            const materieConDate = APP.materie
                .filter(m => m.status !== 'completato' && m.dataEsame)
                .sort((a, b) => new Date(a.dataEsame) - new Date(b.dataEsame));

            const materieSenzaDate = APP.materie
                .filter(m => m.status !== 'completato' && !m.dataEsame)
                .sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));

            const strategia = [...materieConDate, ...materieSenzaDate];
            
            showHelperResults('üìÖ Strategia: Priorit√† per Scadenze', strategia, 
                'Ordinate per data di esame. Concentrati sulle scadenze pi√π vicine prima di passare alle altre materie.');
        }

        function prioritizeByDifficulty() {
            if (APP.materie.length === 0) {
                Utils.showSuccessMessage('‚ùå Aggiungi prima delle materie');
                return;
            }

            const strategia = APP.materie
                .filter(m => m.status !== 'completato')
                .sort((a, b) => (b.difficolta || 3) - (a.difficolta || 3));
            
            showHelperResults('‚≠ê Strategia: Priorit√† per Difficolt√†', strategia,
                'Inizia dalle materie pi√π difficili quando la tua mente √® fresca. Affronta le sfide maggiori per prime.');
        }

        function balancedApproach() {
            if (APP.materie.length === 0) {
                Utils.showSuccessMessage('‚ùå Aggiungi prima delle materie');
                return;
            }

            const strategia = APP.materie
                .filter(m => m.status !== 'completato')
                .sort((a, b) => Utils.calculateSmartPriority(b) - Utils.calculateSmartPriority(a));
            
            showHelperResults('‚öñÔ∏è Strategia: Approccio Bilanciato', strategia,
                'Algoritmo intelligente che bilancia scadenze, difficolt√†, CFU e progresso per il piano ottimale.');
        }

        function showHelperResults(title, strategia, explanation) {
            const resultsContainer = document.getElementById('helperResults');
            const contentContainer = document.getElementById('helperContent');

            contentContainer.innerHTML = `
                <div style="background: rgba(6, 214, 160, 0.1); border: 1px solid rgba(6, 214, 160, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">üìã ${title}</h4>
                    <p style="color: var(--text-primary); line-height: 1.6; margin-bottom: 1.5rem;">${explanation}</p>
                    <button class="btn btn-primary" onclick="applyStrategy()">‚úÖ Applica Questa Strategia</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    ${strategia.map((materia, index) => {
                        const priority = Utils.calculateSmartPriority(materia);
                        const progress = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                        const daysToExam = Utils.getDaysToExam(materia.dataEsame);
                        
                        return `
                            <div class="fade-in-up" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; border-left: 4px solid ${getPriorityColor(index)};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="color: var(--text-primary); margin: 0;">${index + 1}. ${materia.nome}</h4>
                                    <span style="background: ${getPriorityColor(index)}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                        Pos. ${index + 1}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">${priority}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Score</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-card); border-radius: 8px;">
                                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--secondary);">${progress}%</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Progresso</div>
                                    </div>
                                </div>
                                
                                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4;">
                                    <div><strong>CFU:</strong> ${materia.cfu}</div>
                                    <div><strong>Difficolt√†:</strong> ${'‚òÖ'.repeat(materia.difficolta || 3)}${'‚òÜ'.repeat(5-(materia.difficolta || 3))}</div>
                                    <div><strong>Priorit√†:</strong> ${materia.priorita}</div>
                                    ${daysToExam ? `<div><strong>Esame tra:</strong> ${daysToExam} giorni</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            resultsContainer.classList.remove('hidden');
            APP.helperCurrentStrategy = strategia;
        }

        function getPriorityColor(index) {
            if (index === 0) return 'var(--danger)';
            if (index === 1) return 'var(--warning)';
            if (index === 2) return 'var(--primary)';
            return 'var(--secondary)';
        }

        function applyStrategy() {
            if (!APP.helperCurrentStrategy) return;

            APP.helperCurrentStrategy.forEach((materia, index) => {
                const original = APP.materie.find(m => m.id === materia.id);
                if (original) {
                    if (index < 2) original.priorita = 'alta';
                    else if (index < 4) original.priorita = 'media';
                    else original.priorita = 'bassa';
                }
            });

            MaterieManager.saveMaterie();
            MaterieManager.loadMaterie();
            SmartPlanner.generateTodaySchedule();
            PianoStudio.generatePianoStudio();

            Utils.showSuccessMessage('‚úÖ Strategia applicata! Le priorit√† delle materie sono state aggiornate.');
            
            document.getElementById('helperResults').classList.add('hidden');
        }

        // === NOTIFICHE ===
        function hideNotification() {
            document.getElementById('notificationBanner').classList.remove('show');
            // CORREZIONE: Salva che l'utente ha chiuso manualmente la notifica
            localStorage.setItem('lastNotificationDate', new Date().toDateString());
        }

        function updateAutoBackup() {
            const setting = document.getElementById('autoBackup').value;
            localStorage.setItem('autoBackup', setting);
            APP.autoBackupEnabled = setting !== 'disabled';
            
            if (APP.autoBackupEnabled) {
                BackupManager.performAutoBackup();
                Utils.showSuccessMessage('‚úÖ Backup automatico attivato');
            } else {
                Utils.showSuccessMessage('‚öôÔ∏è Backup automatico disattivato');
            }
        }

        function updateExamNotifications() {
            const setting = document.getElementById('examNotifications').value;
            localStorage.setItem('examNotifications', setting);
            Utils.showSuccessMessage('üîî Impostazioni notifiche aggiornate');
        }

        // === DATA MANAGEMENT ===
        function exportAllData() {
            try {
                const allData = {
                    materie: APP.materie,
                    esami: APP.esami,
                    curriculum: APP.curriculum,
                    calendarSessions: APP.calendarSessions,
                    sessionRatings: APP.sessionRatings,
                    timerSettings: {
                        dailyGoal: APP.timerState.dailyGoal,
                        sessionsToday: APP.timerState.sessionsToday,
                        lastSessionDate: APP.timerState.lastSessionDate
                    },
                    studyData: APP.studyData,
                    todayDetailedSessions: APP.todayDetailedSessions,
                    exportDate: new Date().toISOString(),
                    version: '2.1'
                };

                const dataString = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `piano_studio_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                Utils.showSuccessMessage('üì§ Backup completo esportato con successo!');
            } catch (error) {
                console.error('Errore nell\'esportazione:', error);
                Utils.showSuccessMessage('‚ùå Errore nell\'esportazione dei dati');
            }
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!validateImportData(data)) {
                            Utils.showSuccessMessage('‚ùå File di backup non valido o corrotto');
                            return;
                        }

                        const confirmMsg = `Importare il backup del ${new Date(data.exportDate).toLocaleDateString('it-IT')}?\n\nQuesta azione sostituir√† TUTTI i dati correnti.`;
                        if (!confirm(confirmMsg)) return;

                        performImport(data);
                        
                    } catch (error) {
                        console.error('Errore nell\'importazione:', error);
                        Utils.showSuccessMessage('‚ùå Errore nella lettura del file di backup');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function validateImportData(data) {
            const requiredFields = ['materie', 'esami', 'curriculum', 'exportDate'];
            return requiredFields.every(field => data.hasOwnProperty(field));
        }

        function performImport(data) {
            try {
                APP.materie = data.materie || [];
                APP.esami = data.esami || [];
                APP.curriculum = data.curriculum || [];
                APP.calendarSessions = data.calendarSessions || {};
                APP.sessionRatings = data.sessionRatings || {};
                APP.todayDetailedSessions = data.todayDetailedSessions || [];

                if (data.timerSettings) {
                    APP.timerState.dailyGoal = data.timerSettings.dailyGoal || 8;
                    APP.timerState.sessionsToday = data.timerSettings.sessionsToday || 0;
                    APP.timerState.lastSessionDate = data.timerSettings.lastSessionDate || '';
                }

                if (data.studyData) {
                    APP.studyData = { ...APP.studyData, ...data.studyData };
                }

                saveAllToStorage();
                reloadAllSections();

                Utils.showSuccessMessage('‚úÖ Dati importati con successo! App ricaricata.');
            } catch (error) {
                console.error('Errore nell\'importazione:', error);
                Utils.showSuccessMessage('‚ùå Errore nell\'importazione dei dati');
            }
        }

        function saveAllToStorage() {
            localStorage.setItem('materie', JSON.stringify(APP.materie));
            localStorage.setItem('esami', JSON.stringify(APP.esami));
            localStorage.setItem('curriculum', JSON.stringify(APP.curriculum));
            localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
            localStorage.setItem('sessionRatings', JSON.stringify(APP.sessionRatings));
            localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
            localStorage.setItem('dailyGoal', APP.timerState.dailyGoal);
            localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
            localStorage.setItem('lastSessionDate', APP.timerState.lastSessionDate);
            localStorage.setItem('studyStreak', APP.studyData.streak);
            localStorage.setItem('lastStudyDate', APP.studyData.lastStudyDate);
            localStorage.setItem('totalSessions', APP.studyData.totalSessions);
            localStorage.setItem('missedTime', APP.studyData.missedTime);
        }

        function reloadAllSections() {
            MaterieManager.loadMaterie();
            ExamManager.updateExamsSection();
            CurriculumManager.loadCurriculumData();
            SmartPlanner.generateTodaySchedule();
            PianoStudio.generatePianoStudio();
            Sessions.updateAllTodaySessionsList();
            Calendar.renderCalendar();
            Statistics.updateStatistiche();
            Heatmap.updateHeatmap();
            ProductivityAnalyzer.updateProductivitySection();
            Timer.updateSessionDisplay();
            updateStreakDisplay();
        }

        function showResetConfirmation() {
            document.getElementById('resetConfirmationModal').style.display = 'flex';
        }

        function closeResetConfirmationModal() {
            document.getElementById('resetConfirmationModal').style.display = 'none';
        }

        function performCompleteReset() {
            const confirmText = document.getElementById('resetConfirmText').value.toUpperCase();
            
            if (confirmText !== 'RESET') {
                Utils.showSuccessMessage('‚ùå Scrivi esattamente "RESET" per confermare');
                return;
            }

            try {
                const keysToRemove = [
                    'materie', 'esami', 'curriculum', 'calendarSessions', 
                    'sessionRatings', 'todayDetailedSessions', 'dailyGoal', 
                    'sessionsToday', 'lastSessionDate', 'studyStreak', 
                    'lastStudyDate', 'totalSessions', 'missedTime',
                    'autoBackup', 'examNotifications'
                ];

                keysToRemove.forEach(key => localStorage.removeItem(key));

                APP.materie = [];
                APP.esami = [];
                APP.curriculum = [];
                APP.calendarSessions = {};
                APP.sessionRatings = {};
                APP.todayDetailedSessions = [];
                APP.timerState = {
                    minutes: 25, seconds: 0, isRunning: false, isBreak: false,
                    workTime: 25, breakTime: 5, sessionsToday: 0,
                    lastSessionDate: '', dailyGoal: 8
                };
                APP.studyData = {
                    streak: 0, lastStudyDate: '', totalSessions: 0, missedTime: 0
                };

                reloadAllSections();
                showSection('oggi', document.querySelector('.nav-tab[onclick*="oggi"]'));
                closeResetConfirmationModal();

                Utils.showSuccessMessage('üóëÔ∏è Reset completo eseguito! App pulita e pronta all\'uso.');
            } catch (error) {
                console.error('Errore nel reset:', error);
                Utils.showSuccessMessage('‚ùå Errore durante il reset');
            }
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Caricamento iniziale
                MaterieManager.loadMaterie();
                Timer.updateSessionDisplay();
                Timer.updateDailyGoalDisplay();
                updateStreakDisplay();
                
                const today = new Date().toDateString();
                if (APP.timerState.lastSessionDate !== today) {
                    APP.timerState.sessionsToday = 0;
                    APP.todayDetailedSessions = [];
                    localStorage.setItem('sessionsToday', 0);
                    localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                }
                
                // Inizializzazione componenti
                SmartPlanner.generateTodaySchedule();
                WeeklySlots.initializeWeeklySlots();
                StarRating.setupStarRating();
                Sessions.updateAllTodaySessionsList();
                Calendar.renderCalendar();
                Heatmap.updateHeatmap();
                Statistics.updateStatistiche();
                ExamManager.updateExamsSection();
                CurriculumManager.loadCurriculumData();
                PianoStudio.generatePianoStudio();
                ProductivityAnalyzer.updateProductivitySection();
                
                // MIGLIORAMENTO: Controllo notifiche e backup automatico
                NotificationManager.checkUpcomingExams();
                if (APP.autoBackupEnabled) {
                    BackupManager.performAutoBackup();
                }
                
                // Impostazioni iniziali
                document.getElementById('autoBackup').value = localStorage.getItem('autoBackup') || 'daily';
                document.getElementById('examNotifications').value = localStorage.getItem('examNotifications') || '7days';
                
                console.log('üìö Piano Studio Smart v2.1 MIGLIORATO inizializzato con successo!');
                console.log('üéØ Nuove funzionalit√†: Materie annuali, Score spiegato, Notifiche, Backup automatico, Filtri avanzati');
                
            } catch (error) {
                console.error('‚ùå Errore nell\'inizializzazione:', error);
            }
        });

        // Chiudi modali cliccando fuori
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
                if (e.target.id === 'dayDetailModal') {
                    APP.currentDayDetailDate = null;
                }
            }
        });

        // Previeni chiusura modal su click interno
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Chiudi menu mobile quando si clicca fuori
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-container') && APP.mobileNavOpen) {
                closeMobileNav();
            }
        });

        // Controllo notifiche periodico (ogni ora)
        setInterval(() => {
            NotificationManager.checkUpcomingExams();
        }, 3600000);

        // Backup automatico periodico (ogni 6 ore)
        setInterval(() => {
            if (APP.autoBackupEnabled) {
                BackupManager.performAutoBackup();
            }
        }, 21600000);
    </script>
</body>
</html>
