<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro</title>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary-color: #06d6a0;
            --secondary-dark: #05c296;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            
            /* Dark theme colors */
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3a;
            --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f;
            --bg-hover: #252647;
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-accent: #f1f5f9;
            
            --border-color: #374151;
            --border-light: #4b5563;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            --glow-secondary: 0 0 20px rgba(6, 214, 160, 0.3);
            --glow-accent: 0 0 20px rgba(245, 158, 11, 0.3);

            /* Colori per heatmap */
            --heatmap-empty: #374151;
            --heatmap-low: #ef4444;
            --heatmap-medium: #f59e0b;
            --heatmap-high: #10b981;
            --heatmap-very-high: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animazioni */
        .section {
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: sectionSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes sectionSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95);
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Container Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            background-size: 200% 200%;
            animation: gradientShift 6s ease infinite;
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 8s infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary), var(--shadow);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .card h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s;
            transform: translate(-50%, -50%);
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-primary), var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-secondary), var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-small {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        /* TODAY SECTION STYLES */
        .oggi-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--primary-color);
        }

        .oggi-card::before {
            background: var(--primary-color);
        }

        .oggi-card h3 {
            color: var(--primary-light) !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .prossimo-task {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .task-corrente {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .materia-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tempo-stimato {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .task-descrizione {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .task-motivazione {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .task-options {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-options h5 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .task-option-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .task-option-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateX(8px);
        }

        .task-option-btn.selected {
            border-color: var(--primary-color);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: var(--glow-primary);
        }

        .timeline-oggi {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .timeline-time {
            font-weight: 700;
            min-width: 80px;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .timeline-content {
            flex: 1;
            margin-left: 1rem;
            color: var(--text-primary);
        }

        /* RECOVERY DASHBOARD */
        .recovery-dashboard {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .missed-time {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .highlight {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .recovery-plan {
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        /* MICRO TASKS */
        .micro-tasks {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .micro-task-item {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .micro-task-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(8px);
        }

        .micro-task-duration {
            font-size: 0.8rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* SLOT TEMPORALI STYLES */
        .weekly-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .day-slots {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .day-slots h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            text-align: center;
        }

        .time-slots {
            space-y: 1rem;
        }

        .slot-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .slot-item input[type="time"] {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            width: auto;
            min-width: 100px;
        }

        .add-slot {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .add-slot:hover {
            border-color: var(--primary-color);
            color: var(--primary-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .remove-slot {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .remove-slot:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 6px;
            margin-top: 0.5rem;
        }

        .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.active {
            color: #fbbf24;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }

        /* Subject Items */
        .subject-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .subject-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        }

        .subject-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .subject-item.exam-completed {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .subject-item.exam-completed::before {
            background: var(--success-color);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .subject-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .subject-actions {
            display: flex;
            gap: 0.75rem;
        }

        .subject-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Priority Badges */
        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-alta { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .priority-media { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .priority-bassa { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Status Badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-studio {
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary-light);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .status-completato {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Exam Cards */
        .exam-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .exam-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--success-color);
        }

        .exam-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .exam-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .exam-grade {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success-color);
        }

        .exam-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* Grade Input Styles */
        .grade-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .grade-input {
            width: 80px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .grade-input:focus {
            color: var(--success-color);
        }

        /* Timer */
        .timer-container {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: var(--primary-light);
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
        }

        .timer-display.break-mode {
            color: var(--secondary-color);
            text-shadow: 0 0 30px rgba(6, 214, 160, 0.5);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .preset-btn {
            padding: 1rem;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }

        .preset-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary);
        }

        /* Daily Goal Settings */
        .daily-goal-settings {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .daily-goal-settings h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
        }

        .goal-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-input {
            width: 100px;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }

        .goal-input:focus {
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Streak */
        .streak-card {
            background: linear-gradient(135deg, var(--accent-color), #d97706);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from { box-shadow: var(--shadow-lg); }
            to { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4), var(--shadow-lg); }
        }

        .streak-number {
            font-size: 4rem;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Grade Distribution Chart */
        .grade-distribution {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .grade-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .grade-label {
            min-width: 60px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grade-bar-fill {
            height: 20px;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .grade-count {
            min-width: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Session List Styles */
        .session-list {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .session-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .session-time {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.1rem;
        }

        .session-materia {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .session-note {
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 0.5rem;
        }

        .session-rating {
            display: flex;
            gap: 2px;
        }

        .session-rating .star {
            font-size: 1rem;
            color: #fbbf24;
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Heatmap 24 ore */
        .hourly-heatmap {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 50px;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .heatmap-cell.empty {
            background: var(--heatmap-empty);
            color: var(--text-muted);
        }

        .heatmap-cell.low {
            background: var(--heatmap-low);
            color: white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .heatmap-cell.medium {
            background: var(--heatmap-medium);
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .heatmap-cell.high {
            background: var(--heatmap-high);
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .heatmap-cell.very-high {
            background: var(--heatmap-very-high);
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            animation: pulseHeat 2s ease-in-out infinite alternate;
        }

        @keyframes pulseHeat {
            from { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
            to { box-shadow: 0 0 25px rgba(34, 197, 94, 0.6); }
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Top Hours Section */
        .top-hours-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .top-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .top-hour-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .top-hour-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
        }

        .top-hour-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--success-color);
        }

        .top-hour-rank {
            font-size: 2rem;
            font-weight: 800;
            color: var(--success-color);
            margin-bottom: 0.5rem;
        }

        .top-hour-time {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }

        .top-hour-rating {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .productivity-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 4px solid var(--primary-color);
        }

        .productivity-suggestion h4 {
            color: var(--primary-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .productivity-suggestion p {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Calendario Styles */
        .calendar-container {
            width: 100%;
            max-width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day-header {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-light);
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card);
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--bg-hover);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .calendar-day.other-month {
            background: var(--bg-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--bg-card);
            border: 2px solid var(--accent-color);
            font-weight: 700;
        }

        .calendar-day.has-sessions {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .calendar-day.has-scheduled {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .calendar-sessions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-session-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }

        .session-completed {
            background: var(--primary-color);
        }

        .session-scheduled {
            background: var(--secondary-color);
        }

        .session-manual {
            background: var(--warning-color);
        }

        .calendar-session-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
        }

        /* CURRICULUM STYLES */
        .curriculum-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .year-selector {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }

        .year-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .year-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .year-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .year-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .year-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .year-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .year-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .year-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            min-width: 100px;
        }

        .year-stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .year-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .semesters-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .semester-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .semester-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .semester-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .semester-progress {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .curriculum-subject {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .curriculum-subject:hover {
            transform: translateX(8px);
            border-color: var(--border-light);
        }

        .curriculum-subject.completed {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .curriculum-subject.completed::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--success-color);
        }

        .subject-header-curr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .subject-name-curr {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .subject-actions-curr {
            display: flex;
            gap: 0.5rem;
        }

        .subject-info-curr {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .exam-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .subject-grade {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success-color);
        }

        /* Add Subject Form */
        .add-subject-form {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .curriculum-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            animation: modalEnter 0.3s ease;
        }

        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Rating Modal Post-Sessione */
        .rating-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 3rem 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: ratingModalEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ratingModalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.5) translateY(100px) rotate(-10deg);
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        .rating-modal h3 {
            color: var(--primary-light);
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .rating-modal p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 2rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .rating-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .rating-btn.sleepy:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
            box-shadow: 0 0 20px rgba(107, 114, 128, 0.3);
        }

        .rating-btn.neutral:hover {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .rating-btn.good:hover {
            border-color: var(--secondary-color);
            background: rgba(6, 214, 160, 0.1);
            box-shadow: 0 0 20px rgba(6, 214, 160, 0.3);
        }

        .rating-btn.excellent:hover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .rating-emoji {
            font-size: 3.5rem;
            transition: all 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .rating-btn:hover .rating-emoji {
            transform: scale(1.2) rotate(5deg);
        }

        .rating-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .rating-btn.sleepy .rating-label { color: #9ca3af; }
        .rating-btn.neutral .rating-label { color: var(--warning-color); }
        .rating-btn.good .rating-label { color: var(--secondary-color); }
        .rating-btn.excellent .rating-label { color: var(--success-color); }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-content {
            text-align: center;
            animation: focusEnter 0.5s ease;
        }

        .focus-timer {
            font-size: 8rem;
            font-weight: 800;
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 50px rgba(139, 92, 246, 0.8);
        }

        .close-focus {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .close-focus:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        @keyframes focusEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Tooltip per heatmap */
        .tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* PIANO DI STUDIO INTELLIGENTE STYLES */
        .smart-plan-container {
            display: grid;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .plan-overview {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
        }

        .plan-overview h4 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .plan-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .plan-metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .plan-metric-number {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .plan-metric-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .weekly-plan {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .weekly-plan h4 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .day-plan {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            min-height: 200px;
            transition: all 0.3s ease;
            position: relative;
        }

        .day-plan:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .day-plan.today {
            border-color: var(--accent-color);
            background: rgba(245, 158, 11, 0.05);
        }

        .day-plan.weekend {
            background: var(--bg-secondary);
            opacity: 0.7;
        }

        .day-header {
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .day-sessions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .session-block {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.85rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .session-block:hover {
            transform: translateX(4px);
            border-color: var(--secondary-color);
        }

        .session-block.priority-alta {
            border-left: 4px solid var(--danger-color);
        }

        .session-block.priority-media {
            border-left: 4px solid var(--warning-color);
        }

        .session-block.priority-bassa {
            border-left: 4px solid var(--success-color);
        }

        .session-time {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .session-subject {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .session-details {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .progress-overview {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progress-overview h4 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
        }

        .subject-progress-list {
            display: grid;
            gap: 1rem;
        }

        .subject-progress-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .subject-progress-item:hover {
            transform: translateX(8px);
            border-color: var(--border-light);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-subject-name {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.1rem;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .ai-suggestions {
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), rgba(6, 214, 160, 0.05));
            border: 1px solid rgba(6, 214, 160, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--secondary-color);
        }

        .ai-suggestions h4 {
            color: var(--secondary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .suggestion-item {
            background: rgba(6, 214, 160, 0.05);
            border: 1px solid rgba(6, 214, 160, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            background: rgba(6, 214, 160, 0.1);
            transform: translateY(-2px);
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .suggestion-description {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .deadline-alerts {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--danger-color);
        }

        .deadline-alerts h4 {
            color: var(--danger-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .deadline-item {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deadline-subject {
            font-weight: 600;
            color: var(--text-primary);
        }

        .deadline-date {
            color: var(--danger-color);
            font-weight: 600;
        }

        .deadline-days {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Study Efficiency Chart */
        .efficiency-chart {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .efficiency-chart h4 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
        }

        .chart-container {
            height: 200px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .timer-display {
                font-size: 4rem;
            }

            .focus-timer {
                font-size: 6rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .subject-info {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                padding: 6px;
            }

            .nav-tab {
                padding: 12px 16px;
                min-width: 100px;
                font-size: 0.9rem;
            }

            .card {
                padding: 1.5rem;
            }

            .timer-controls {
                flex-direction: column;
                align-items: center;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .streak-number {
                font-size: 3rem;
            }

            .weekly-slots {
                grid-template-columns: 1fr;
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .heatmap-grid {
                grid-template-columns: repeat(6, 1fr);
            }

            .rating-buttons {
                grid-template-columns: 1fr;
            }

            .rating-btn {
                padding: 1.5rem 1rem;
            }

            .rating-emoji {
                font-size: 2.5rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .calendar-day-number {
                font-size: 0.9rem;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .calendar-session-count {
                font-size: 0.6rem;
            }

            .session-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .grade-input-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .semesters-container {
                grid-template-columns: 1fr;
            }

            .year-stats {
                justify-content: center;
            }

            .curriculum-navigation {
                justify-content: center;
            }

            .year-selector {
                flex-wrap: wrap;
            }

            .week-grid {
                grid-template-columns: 1fr;
            }

            .plan-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>🚀 Piano Studio Smart AI Pro</h1>
            <p>Il tuo assistente intelligente anti-procrastinazione con gestione esami completa</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('oggi', this)">🌅 Oggi</button>
            <button class="nav-tab" onclick="showSection('materie', this)">📖 Materie</button>
            <button class="nav-tab" onclick="showSection('curriculum', this)">🎓 Curriculum</button>
            <button class="nav-tab" onclick="showSection('esami', this)">📊 Esami</button>
            <button class="nav-tab" onclick="showSection('piano', this)">📋 Piano</button>
            <button class="nav-tab" onclick="showSection('pomodoro', this)">🍅 Pomodoro</button>
            <button class="nav-tab" onclick="showSection('calendario', this)">📅 Calendario</button>
            <button class="nav-tab" onclick="showSection('statistiche', this)">📈 Statistiche</button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sezione OGGI -->
            <section id="oggi" class="section active">
                <!-- Recovery Dashboard -->
                <div class="recovery-dashboard" id="recoveryDashboard" style="display: none;">
                    <h4>📊 Stato Recupero</h4>
                    <div class="missed-time">Tempo da recuperare: <span class="highlight" id="missedTime">0h 0min</span></div>
                    <div class="recovery-plan" id="recoveryPlan">Piano: Distribuzione automatica attiva</div>
                    <button class="btn btn-warning" onclick="showRecoveryOptions()">🔧 Modifica Piano</button>
                </div>

                <div class="card oggi-card">
                    <h3>🌅 Il Tuo Piano di Oggi</h3>
                    
                    <div class="prossimo-task">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">🔥 PROSSIMO TASK:</h4>
                        <div class="task-corrente" id="taskCorrente">
                            <div class="task-header">
                                <span class="materia-nome" id="currentTaskMateria">Nessun task programmato</span>
                                <span class="tempo-stimato" id="currentTaskTime">⏱️ -- min</span>
                            </div>
                            <div class="task-descrizione" id="currentTaskDesc">
                                Aggiungi delle materie per iniziare a studiare in modo intelligente!
                            </div>
                            <div class="task-motivazione" id="currentTaskMotivation">
                                💡 Il sistema pianificherà automaticamente le tue sessioni di studio
                            </div>

                            <div class="task-options" id="taskOptions" style="display: none;">
                                <h5>🎯 Cosa vuoi fare specificamente?</h5>
                                <div id="taskOptionsList"></div>
                            </div>

                            <button class="btn btn-primary" onclick="iniziaTask()" id="startTaskBtn" disabled>🚀 Inizia Subito</button>
                        </div>
                    </div>

                    <!-- Micro Tasks per Anti-Procrastinazione -->
                    <div class="micro-tasks" id="microTasks" style="display: none;">
                        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">⚡ Task Micro (Anti-Procrastinazione)</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Inizia con qualcosa di facile per creare momentum:</p>
                        <div id="microTasksList"></div>
                    </div>

                    <div class="programma-giornata">
                        <h4 style="color: var(--primary-light);">📋 Programma Completo di Oggi:</h4>
                        <div class="timeline-oggi" id="timelineOggi">
                            <div class="empty-state">
                                <div class="empty-state-icon">📅</div>
                                <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Materie -->
            <section id="materie" class="section">
                <!-- Study Streak Card -->
                <div class="streak-card">
                    <h3 style="margin-bottom: 1rem; color: white;">🔥 Studio Streak</h3>
                    <div class="streak-number" id="streakNumber">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <div class="card">
                    <h3>➕ Aggiungi Nuova Materia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagine">Pagine Totali <span class="required">*</span></label>
                            <input type="number" id="pagine" min="1" required placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="pagineStudiate">Pagine già Studiate</label>
                            <input type="number" id="pagineStudiate" min="0" value="0" placeholder="Es. 120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineOra">Pagine per Ora</label>
                            <input type="number" id="pagineOra" min="1" max="50" value="8" placeholder="Es. 8">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Quante pagine riesci a studiare in 1 ora per questa materia</small>
                        </div>
                        <div class="form-group">
                            <label for="eserciziTotali">Esercizi Totali</label>
                            <input type="number" id="eserciziTotali" min="0" value="0" placeholder="Es. 150">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Numero totale di esercizi da completare (opzionale)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eserciziCompletati">Esercizi Completati</label>
                            <input type="number" id="eserciziCompletati" min="0" value="0" placeholder="Es. 45">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Esercizi già completati</small>
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorità</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficoltà Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Slot Temporali -->
                    <div class="form-group">
                        <label>⏰ Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Definisci gli slot orari specifici in cui puoi studiare questa materia durante la settimana
                        </p>
                        <div class="weekly-slots" id="weeklySlots">
                            <!-- Slot per ogni giorno generati dinamicamente -->
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addMateria()">✅ Aggiungi Materia</button>
                </div>

                <div class="card">
                    <h3>📚 Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon">📚</div>
                            <p>Nessuna materia aggiunta ancora.</p>
                            <p>Inizia aggiungendo la tua prima materia!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione CURRICULUM -->
            <section id="curriculum" class="section">
                <!-- Navigation per anni -->
                <div class="curriculum-navigation">
                    <div class="year-selector">
                        <button class="year-tab active" onclick="showCurriculumYear(1, this)">1° Anno</button>
                        <button class="year-tab" onclick="showCurriculumYear(2, this)">2° Anno</button>
                        <button class="year-tab" onclick="showCurriculumYear(3, this)">3° Anno</button>
                    </div>
                    <div class="curriculum-actions">
                        <button class="btn btn-primary btn-small" onclick="showAddSubjectModal()">➕ Aggiungi Materia</button>
                        <button class="btn btn-secondary btn-small" onclick="importCurriculumData()">📥 Importa Dati</button>
                        <button class="btn btn-warning btn-small" onclick="exportCurriculumData()">📤 Esporta Dati</button>
                    </div>
                </div>

                <!-- Container per gli anni -->
                <div id="curriculumContainer">
                    <!-- Anno 1 -->
                    <div id="year-1" class="year-content active">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span>🎓</span>
                                    <span>Primo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary-color);" id="year1-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning-color);" id="year1-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success-color);" id="year1-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary-color);" id="year1-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 I Semestre</div>
                                        <div class="semester-progress" id="year1-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year1-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 II Semestre</div>
                                        <div class="semester-progress" id="year1-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year1-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anno 2 -->
                    <div id="year-2" class="year-content">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span>🎓</span>
                                    <span>Secondo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary-color);" id="year2-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning-color);" id="year2-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success-color);" id="year2-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary-color);" id="year2-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 I Semestre</div>
                                        <div class="semester-progress" id="year2-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year2-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 II Semestre</div>
                                        <div class="semester-progress" id="year2-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year2-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anno 3 -->
                    <div id="year-3" class="year-content">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span>🎓</span>
                                    <span>Terzo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary-color);" id="year3-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning-color);" id="year3-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success-color);" id="year3-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary-color);" id="year3-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 I Semestre</div>
                                        <div class="semester-progress" id="year3-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year3-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title">📚 II Semestre</div>
                                        <div class="semester-progress" id="year3-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year3-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📖</div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Esami -->
            <section id="esami" class="section">
                <!-- Statistiche Esami -->
                <div class="card">
                    <h3>📊 Statistiche Esami</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success-color);" id="totalExams">0</div>
                            <div class="stat-label">Esami Sostenuti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning-color);" id="totalCFU">0</div>
                            <div class="stat-label">CFU Acquisiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary-color);" id="weightedAverage">0.00</div>
                            <div class="stat-label">Media Ponderata</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary-color);" id="projectedGrade">0</div>
                            <div class="stat-label">Voto Laurea Est.</div>
                        </div>
                    </div>
                </div>

                <!-- Distribuzione Voti -->
                <div class="card">
                    <h3>📈 Distribuzione Voti</h3>
                    <div class="grade-distribution" id="gradeDistribution">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Completa alcuni esami per vedere la distribuzione!</p>
                        </div>
                    </div>
                </div>

                <!-- Lista Esami Sostenuti -->
                <div class="card">
                    <h3>🎓 Esami Sostenuti</h3>
                    <div id="examsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">🎓</div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Marca una materia come "Esame Sostenuto" per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Piano Studio -->
            <section id="piano" class="section">
                <!-- Piano Overview -->
                <div class="plan-overview">
                    <h4>🎯 Piano di Studio Intelligente</h4>
                    <p id="planSummary">Caricamento piano personalizzato...</p>
                    <div class="plan-metrics">
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="totalWeeklyHours">0h</div>
                            <div class="plan-metric-label">Ore Settimanali</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="avgDailyHours">0h</div>
                            <div class="plan-metric-label">Media Giornaliera</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="totalPages">0</div>
                            <div class="plan-metric-label">Pagine Totali</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="completionWeeks">0</div>
                            <div class="plan-metric-label">Settimane Stimate</div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div class="ai-suggestions" id="aiSuggestions">
                    <h4>🤖 Suggerimenti AI</h4>
                    <div id="suggestionsList">
                        <div class="suggestion-item">
                            <div class="suggestion-title">💡 Analizzando i tuoi dati...</div>
                            <div class="suggestion-description">Il sistema sta elaborando raccomandazioni personalizzate basate sui tuoi orari di studio e produttività.</div>
                        </div>
                    </div>
                </div>

                <!-- Deadline Alerts -->
                <div class="deadline-alerts" id="deadlineAlerts" style="display: none;">
                    <h4>⚠️ Alert Scadenze</h4>
                    <div id="deadlinesList"></div>
                </div>

                <!-- Weekly Schedule -->
                <div class="weekly-plan">
                    <h4>📅 Pianificazione Settimanale</h4>
                    <div class="week-grid" id="weekGrid">
                        <!-- Giorni generati dinamicamente -->
                    </div>
                </div>

                <!-- Progress Overview -->
                <div class="progress-overview">
                    <h4>📈 Panoramica Progressi</h4>
                    <div class="subject-progress-list" id="subjectProgressList">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Aggiungi delle materie per vedere i progressi dettagliati!</p>
                        </div>
                    </div>
                </div>

                <!-- Study Efficiency Chart -->
                <div class="efficiency-chart">
                    <h4>⚡ Efficienza Studio</h4>
                    <div class="chart-container">
                        📊 Grafico efficienza disponibile dopo alcune sessioni di studio
                    </div>
                </div>
            </section>

            <!-- Sezione Pomodoro -->
            <section id="pomodoro" class="section">
                <!-- Impostazioni Obiettivo Giornaliero -->
                <div class="daily-goal-settings">
                    <h4>🎯 Obiettivo Giornaliero Personalizzato</h4>
                    <div class="goal-input-group">
                        <label for="dailyGoal" style="margin: 0; color: var(--text-primary);">Pomodori da completare oggi:</label>
                        <input type="number" id="dailyGoal" class="goal-input" min="1" max="20" value="8" onchange="updateDailyGoal()">
                        <span style="color: var(--text-secondary);">sessioni</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Personalizza il tuo obiettivo giornaliero in base al tempo che hai disponibile
                    </p>
                </div>

                <div class="card">
                    <div class="timer-container">
                        <h3>🍅 Timer Pomodoro</h3>
                        
                        <div class="timer-presets">
                            <button class="preset-btn active" onclick="setPreset(25, 5, this)">25/5 min</button>
                            <button class="preset-btn" onclick="setPreset(50, 10, this)">50/10 min</button>
                            <button class="preset-btn" onclick="setPreset(90, 20, this)">90/20 min</button>
                            <button class="preset-btn" onclick="showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startBtn" onclick="startTimer()">▶️ Inizia</button>
                            <button class="btn btn-warning" id="pauseBtn" onclick="pauseTimer()" style="display: none;">⏸️ Pausa</button>
                            <button class="btn btn-danger" onclick="resetTimer()">🔄 Reset</button>
                            <button class="btn btn-secondary" onclick="toggleFocusMode()">🎯 Focus</button>
                        </div>

                        <div class="form-group">
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="progressText">Inizia la tua prima sessione!</small>
                        </div>
                    </div>
                </div>

                <!-- Lista Sessioni di Oggi -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">📊 Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="showDeleteAllTodaySessionsModal()">🗑️ Elimina tutte</button>
                    </div>
                    
                    <div id="todaySessionsList" class="session-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">🍅</div>
                            <p>Nessuna sessione completata oggi.</p>
                            <p>Avvia una sessione per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Calendario -->
            <section id="calendario" class="section">
                <!-- Controlli Calendario -->
                <div class="card">
                    <h3>📅 Navigazione Calendario</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="changeMonth(-1)" style="padding: 0.75rem 1rem;">◀ Precedente</button>
                            <h4 id="currentMonthYear" style="margin: 0; color: var(--primary-light); min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary" onclick="changeMonth(1)" style="padding: 0.75rem 1rem;">Successivo ▶</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="goToToday()" style="padding: 0.75rem 1rem;">📍 Oggi</button>
                            <button class="btn btn-warning" onclick="addManualSession()" style="padding: 0.75rem 1rem;">➕ Aggiungi Sessione</button>
                        </div>
                    </div>
                </div>

                <!-- Calendario Principale -->
                <div class="card">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header">Sab</div>
                            <div class="calendar-day-header">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Giorni generati dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Statistiche Mensili -->
                <div class="card">
                    <h3>📊 Statistiche del Mese</h3>
                    <div class="form-row">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-light);" id="monthSessions">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni Totali</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary-color);" id="monthHours">0h</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ore di Studio</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="monthDays">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Giorni Attivi</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-color);" id="monthAverage">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Media Sessioni/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Statistiche -->
            <section id="statistiche" class="section">
                <div class="card">
                    <h3>📊 Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Nessuna statistica disponibile.</p>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <!-- Sezione Produttività -->
                <div class="card">
                    <h3>📊 La Tua Produttività</h3>
                    
                    <!-- Heatmap 24 ore -->
                    <div class="hourly-heatmap">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">🔥 Heatmap Oraria della Produttività</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Visualizza i tuoi momenti più produttivi durante la giornata
                        </p>
                        <div class="heatmap-grid" id="heatmapGrid">
                            <!-- Celle generate dinamicamente per ogni ora (0-23) -->
                        </div>
                        <div class="heatmap-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-empty);"></div>
                                <span>Nessun dato</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-low);"></div>
                                <span>Bassa</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                                <span>Media</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-high);"></div>
                                <span>Alta</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-very-high);"></div>
                                <span>Eccellente</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Ore Migliori -->
                    <div class="top-hours-section">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;">🏆 Le Tue Top 3 Ore Migliori</h4>
                        <div class="top-hours-grid" id="topHoursGrid">
                            <!-- Top ore generate dinamicamente -->
                        </div>
                        
                        <!-- Suggerimento AI -->
                        <div class="productivity-suggestion" id="productivitySuggestion">
                            <h4>💡 Suggerimento Smart</h4>
                            <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti più produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode" id="focusMode">
        <button class="close-focus" onclick="toggleFocusMode()">✕</button>
        <div class="focus-content">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">🎯 Modalità Focus</h2>
            <div class="focus-timer" id="focusTimer">25:00</div>
            <p style="font-size: 1.2rem; opacity: 0.8;">Resta concentrato! Stai facendo un ottimo lavoro.</p>
        </div>
    </div>

    <!-- Modal per Aggiungere Materia al Curriculum -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <h3>➕ Aggiungi Materia al Curriculum</h3>
            <div class="form-group">
                <label for="currSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="currSubjectName" required placeholder="Es. Analisi Matematica I">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectYear">Anno <span class="required">*</span></label>
                    <select id="currSubjectYear" required>
                        <option value="1">1° Anno</option>
                        <option value="2">2° Anno</option>
                        <option value="3">3° Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="currSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectCFU">CFU <span class="required">*</span></label>
                    <input type="number" id="currSubjectCFU" min="1" max="30" required placeholder="Es. 9">
                </div>
                <div class="form-group">
                    <label for="currSubjectProfessor">Professore</label>
                    <input type="text" id="currSubjectProfessor" placeholder="Es. Prof. Mario Rossi">
                </div>
            </div>
            <div class="form-group">
                <label for="currSubjectNotes">Note (opzionale)</label>
                <textarea id="currSubjectNotes" rows="2" placeholder="Note aggiuntive sulla materia..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveCurriculumSubject()">✅ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSubjectModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Rating Post-Sessione con Note -->
    <div class="modal-overlay" id="ratingModal">
        <div class="rating-modal">
            <h3>🎉 Sessione Completata!</h3>
            <p>Come ti senti dopo questa sessione di studio?<br>La tua valutazione ci aiuta a ottimizzare i tuoi orari migliori.</p>
            
            <div class="form-group">
                <label for="sessionNote">📝 Note sulla sessione (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Ho studiato il capitolo 3..." style="margin-bottom: 1rem;">
            </div>
            
            <div class="rating-buttons">
                <div class="rating-btn sleepy" onclick="submitRating(1)">
                    <div class="rating-emoji">😴</div>
                    <div class="rating-label">Stanco</div>
                </div>
                <div class="rating-btn neutral" onclick="submitRating(2)">
                    <div class="rating-emoji">😐</div>
                    <div class="rating-label">Normale</div>
                </div>
                <div class="rating-btn good" onclick="submitRating(3)">
                    <div class="rating-emoji">😊</div>
                    <div class="rating-label">Bene</div>
                </div>
                <div class="rating-btn excellent" onclick="submitRating(4)">
                    <div class="rating-emoji">🔥</div>
                    <div class="rating-label">Eccellente</div>
                </div>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                Clicca per salvare automaticamente
            </p>
        </div>
    </div>

    <!-- Modal per Timer Personalizzato -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3>⚙️ Personalizza Timer</h3>
            <div class="form-group">
                <label for="customWorkTime">Minuti di Lavoro (1-180):</label>
                <input type="number" id="customWorkTime" min="1" max="180" value="25">
            </div>
            <div class="form-group">
                <label for="customBreakTime">Minuti di Pausa (1-60):</label>
                <input type="number" id="customBreakTime" min="1" max="60" value="5">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyCustomTimer()">✅ Applica</button>
                <button class="btn btn-secondary" onclick="closeCustomTimerModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Sessione Manuale -->
    <div class="modal-overlay" id="addSessionModal">
        <div class="modal">
            <h3>➕ Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label for="sessionMateria">Materia (opzionale):</label>
                <select id="sessionMateria">
                    <option value="">Sessione generica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sessionDuration">Durata (minuti):</label>
                <input type="number" id="sessionDuration" min="5" max="300" value="25">
            </div>
            <div class="form-group">
                <label for="manualSessionNote">Note (opzionale):</label>
                <input type="text" id="manualSessionNote" placeholder="Es. Ripasso capitolo 3">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveManualSession()">✅ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSessionModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Giorno Specifico -->
    <div class="modal-overlay" id="dayDetailModal">
        <div class="modal" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto;">
            <h3 id="dayDetailTitle">📅 Dettagli Giorno</h3>
            <div id="dayDetailContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDayDetailModal()">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Voto Esame -->
    <div class="modal-overlay" id="examModal">
        <div class="modal">
            <h3>🎓 Registra Esame Sostenuto</h3>
            <div class="form-group">
                <label for="examSubject">Materia:</label>
                <input type="text" id="examSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="examGrade">Voto (18-30):</label>
                    <div class="grade-input-group">
                        <input type="number" id="examGrade" class="grade-input" min="18" max="30" placeholder="30">
                        <label>
                            <input type="checkbox" id="examLode"> Lode
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="examDate">Data Esame:</label>
                    <input type="date" id="examDate">
                </div>
            </div>
            <div class="form-group">
                <label for="examNotes">Note (opzionale):</label>
                <textarea id="examNotes" rows="3" placeholder="Es. Esame andato molto bene, argomenti principali..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveExamGrade()">✅ Salva Esame</button>
                <button class="btn btn-secondary" onclick="closeExamModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Modificare Esame -->
    <div class="modal-overlay" id="editExamModal">
        <div class="modal">
            <h3>✏️ Modifica Esame</h3>
            <div class="form-group">
                <label for="editExamSubject">Materia:</label>
                <input type="text" id="editExamSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editExamGrade">Voto (18-30):</label>
                    <div class="grade-input-group">
                        <input type="number" id="editExamGrade" class="grade-input" min="18" max="30">
                        <label>
                            <input type="checkbox" id="editExamLode"> Lode
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editExamDate">Data Esame:</label>
                    <input type="date" id="editExamDate">
                </div>
            </div>
            <div class="form-group">
                <label for="editExamNotes">Note (opzionale):</label>
                <textarea id="editExamNotes" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="updateExamGrade()">✅ Aggiorna</button>
                <button class="btn btn-secondary" onclick="closeEditExamModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Modificare Materia Curriculum -->
    <div class="modal-overlay" id="editCurriculumModal">
        <div class="modal">
            <h3>✏️ Modifica Materia Curriculum</h3>
            <div class="form-group">
                <label for="editCurrSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="editCurrSubjectName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editCurrSubjectYear">Anno <span class="required">*</span></label>
                    <select id="editCurrSubjectYear" required>
                        <option value="1">1° Anno</option>
                        <option value="2">2° Anno</option>
                        <option value="3">3° Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCurrSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="editCurrSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editCurrSubjectCFU">CFU <span class="required">*</span></label>
                    <input type="number" id="editCurrSubjectCFU" min="1" max="30" required>
                </div>
                <div class="form-group">
                    <label for="editCurrSubjectProfessor">Professore</label>
                    <input type="text" id="editCurrSubjectProfessor">
                </div>
            </div>
            <div class="form-group">
                <label for="editCurrSubjectNotes">Note (opzionale)</label>
                <textarea id="editCurrSubjectNotes" rows="2"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="updateCurriculumSubject()">✅ Aggiorna</button>
                <button class="btn btn-secondary" onclick="closeEditCurriculumModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Opzioni Recupero -->
    <div class="modal-overlay" id="recoveryModal">
        <div class="modal">
            <h3>🔧 Opzioni Recupero</h3>
            <div class="form-group">
                <label>Strategia di Recupero:</label>
                <select id="recoveryStrategy">
                    <option value="graduale">Graduale (distribuisci su 7 giorni)</option>
                    <option value="intensivo">Intensivo (recupera in 2-3 giorni)</option>
                    <option value="weekend">Weekend (solo sabato e domenica)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyRecoveryStrategy()">✅ Applica</button>
                <button class="btn btn-secondary" onclick="closeRecoveryModal()">❌ Annulla</button>
            </div>
        </div>
    </div>

    <!-- Tooltip per heatmap -->
    <div class="tooltip" id="heatmapTooltip"></div>

    <script>
        // === STATO GLOBALE APPLICAZIONE ===
        let materie = JSON.parse(localStorage.getItem('materie')) || [];
        let esami = JSON.parse(localStorage.getItem('esami')) || [];
        let curriculum = JSON.parse(localStorage.getItem('curriculum')) || [];
        let currentCalendarDate = new Date();
        let calendarSessions = JSON.parse(localStorage.getItem('calendarSessions')) || {};
        let sessionRatings = JSON.parse(localStorage.getItem('sessionRatings')) || {};
        let difficoltaSelezionata = 3;
        let timerInterval = null;
        let selectedTaskOption = null;
        let currentSessionStartTime = null;
        let currentSessionData = null;
        let currentEditingExamId = null;
        let currentEditingCurriculumId = null;
        let currentCurriculumYear = 1;

        // Task micro universali anti-procrastinazione
        const universalMicroTasks = [
            { text: "📖 Leggi il sommario del primo capitolo", durata: 5 },
            { text: "✏️ Scrivi 3 concetti che già conosci dell'argomento", durata: 3 },
            { text: "📝 Prepara il materiale di studio sulla scrivania", durata: 2 },
            { text: "🎯 Definisci 1 obiettivo specifico per oggi", durata: 2 },
            { text: "📊 Controlla il tuo progresso attuale", durata: 3 },
            { text: "🔍 Cerca 1 video introduttivo sull'argomento", durata: 5 },
            { text: "📋 Crea una lista di 3 domande da fare", durata: 4 },
            { text: "⚡ Fai 10 respiri profondi per concentrarti", durata: 1 }
        ];
        
        let timerState = {
            minutes: 25,
            seconds: 0,
            isRunning: false,
            isBreak: false,
            workTime: 25,
            breakTime: 5,
            sessionsToday: parseInt(localStorage.getItem('sessionsToday')) || 0,
            lastSessionDate: localStorage.getItem('lastSessionDate') || '',
            dailyGoal: parseInt(localStorage.getItem('dailyGoal')) || 8
        };

        let studyData = {
            streak: parseInt(localStorage.getItem('studyStreak')) || 0,
            lastStudyDate: localStorage.getItem('lastStudyDate') || '',
            totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
            missedTime: parseInt(localStorage.getItem('missedTime')) || 0
        };

        // Array per salvare le sessioni dettagliate di oggi
        let todayDetailedSessions = JSON.parse(localStorage.getItem('todayDetailedSessions')) || [];

        // === PIANO DI STUDIO INTELLIGENTE ===
        function generatePianoStudio() {
            try {
                const container = document.getElementById('pianoStudio');
                if (!container) return;
                
                const materieInStudio = materie.filter(m => m.status !== 'completato');
                
                if (materieInStudio.length === 0) {
                    showEmptyPlanState();
                    return;
                }

                // Calcola metriche generali
                const planMetrics = calculatePlanMetrics(materieInStudio);
                updatePlanOverview(planMetrics);
                
                // Genera suggerimenti AI
                generateAISuggestions(materieInStudio, planMetrics);
                
                // Controlla scadenze
                checkDeadlines(materieInStudio);
                
                // Genera pianificazione settimanale intelligente
                generateWeeklyPlan(materieInStudio);
                
                // Aggiorna panoramica progressi
                updateProgressOverview(materieInStudio);
                
            } catch (error) {
                console.error('Errore nella generazione del piano:', error);
                showErrorPlanState();
            }
        }

        function calculatePlanMetrics(materieInStudio) {
            let totalWeeklyHours = 0;
            let totalPages = 0;
            let totalRemainingPages = 0;
            let estimatedCompletionWeeks = 0;

            materieInStudio.forEach(materia => {
                // Calcola ore settimanali per materia
                let oreSettimanali = 0;
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slots.forEach(slot => {
                            const durata = calculateTaskDuration(slot.inizio, slot.fine);
                            oreSettimanali += durata;
                        });
                    });
                }
                totalWeeklyHours += oreSettimanali / 60;
                
                totalPages += materia.pagine;
                const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                totalRemainingPages += pagineRimanenti;
                
                // Stima settimane per completamento (considerando pagine/ora)
                if (oreSettimanali > 0 && pagineRimanenti > 0) {
                    const paginePerSettimana = (oreSettimanali / 60) * (materia.pagineOra || 8);
                    const settimaneRimanenti = Math.ceil(pagineRimanenti / paginePerSettimana);
                    estimatedCompletionWeeks = Math.max(estimatedCompletionWeeks, settimaneRimanenti);
                }
            });

            return {
                totalWeeklyHours: Math.round(totalWeeklyHours * 10) / 10,
                avgDailyHours: Math.round((totalWeeklyHours / 7) * 10) / 10,
                totalPages,
                totalRemainingPages,
                estimatedCompletionWeeks,
                subjectsCount: materieInStudio.length
            };
        }

        function updatePlanOverview(metrics) {
            const planSummary = document.getElementById('planSummary');
            const totalWeeklyHours = document.getElementById('totalWeeklyHours');
            const avgDailyHours = document.getElementById('avgDailyHours');
            const totalPages = document.getElementById('totalPages');
            const completionWeeks = document.getElementById('completionWeeks');

            if (planSummary) {
                planSummary.textContent = `Piano ottimizzato per ${metrics.subjectsCount} materie con un carico di studio di ${metrics.totalWeeklyHours}h settimanali. Completamento stimato in ${metrics.estimatedCompletionWeeks} settimane.`;
            }

            if (totalWeeklyHours) totalWeeklyHours.textContent = `${metrics.totalWeeklyHours}h`;
            if (avgDailyHours) avgDailyHours.textContent = `${metrics.avgDailyHours}h`;
            if (totalPages) totalPages.textContent = metrics.totalRemainingPages;
            if (completionWeeks) completionWeeks.textContent = metrics.estimatedCompletionWeeks;
        }

        function generateAISuggestions(materieInStudio, metrics) {
            const suggestionsList = document.getElementById('suggestionsList');
            if (!suggestionsList) return;

            const suggestions = [];
            
            // Analisi carico di studio
            if (metrics.avgDailyHours > 6) {
                suggestions.push({
                    title: "⚠️ Carico di Studio Intenso",
                    description: `Con ${metrics.avgDailyHours}h al giorno, considera di distribuire meglio il carico o estendere le tempistiche per evitare burnout.`
                });
            } else if (metrics.avgDailyHours < 2) {
                suggestions.push({
                    title: "⚡ Opportunità di Ottimizzazione",
                    description: `Con solo ${metrics.avgDailyHours}h al giorno, potresti aumentare le ore di studio per completare prima o aggiungere materie.`
                });
            }

            // Analisi priorità e scadenze
            const materieConScadenza = materieInStudio.filter(m => m.dataEsame);
            if (materieConScadenza.length > 0) {
                const prossimeScadenze = materieConScadenza
                    .map(m => ({ ...m, daysToExam: getDaysToExam(m.dataEsame) }))
                    .filter(m => m.daysToExam <= 30 && m.daysToExam > 0)
                    .sort((a, b) => a.daysToExam - b.daysToExam);

                if (prossimeScadenze.length > 0) {
                    suggestions.push({
                        title: "🎯 Focus su Priorità",
                        description: `${prossimeScadenze[0].nome} ha l'esame tra ${prossimeScadenze[0].daysToExam} giorni. Considera di aumentare le ore dedicate a questa materia.`
                    });
                }
            }

            // Suggerimenti basati su produttività
            const bestHours = getBestStudyHours();
            if (bestHours.length > 0) {
                suggestions.push({
                    title: "🔥 Ottimizza i Tempi",
                    description: `Le tue ore più produttive sono ${bestHours.slice(0, 2).map(h => h + ':00').join(' e ')}. Programma le materie più difficili in questi orari.`
                });
            }

            // Bilanciamento difficoltà
            const difficoltaMedia = materieInStudio.reduce((sum, m) => sum + (m.difficolta || 3), 0) / materieInStudio.length;
            if (difficoltaMedia > 4) {
                suggestions.push({
                    title: "🎲 Strategia Difficoltà",
                    description: "Hai molte materie complesse. Alterna studio di materie difficili con sessioni di ripasso per mantenere la motivazione."
                });
            }

            // Progresso generale
            const progressoMedio = materieInStudio.reduce((sum, m) => sum + (((m.pagineStudiate || 0) / m.pagine) * 100), 0) / materieInStudio.length;
            if (progressoMedio < 20) {
                suggestions.push({
                    title: "🚀 Kickstart Consigliato",
                    description: "Il progresso generale è ancora basso. Inizia con sessioni brevi per ogni materia per creare momentum."
                });
            }

            if (suggestions.length === 0) {
                suggestions.push({
                    title: "✅ Piano Ottimale",
                    description: "Il tuo piano di studio è ben bilanciato! Continua così e monitora i progressi regolarmente."
                });
            }

            suggestionsList.innerHTML = suggestions.map(s => `
                <div class="suggestion-item">
                    <div class="suggestion-title">${s.title}</div>
                    <div class="suggestion-description">${s.description}</div>
                </div>
            `).join('');
        }

        function checkDeadlines(materieInStudio) {
            const deadlineAlerts = document.getElementById('deadlineAlerts');
            const deadlinesList = document.getElementById('deadlinesList');
            
            if (!deadlineAlerts || !deadlinesList) return;

            const materieConScadenza = materieInStudio
                .filter(m => m.dataEsame)
                .map(m => ({ ...m, daysToExam: getDaysToExam(m.dataEsame) }))
                .filter(m => m.daysToExam <= 30 && m.daysToExam > 0)
                .sort((a, b) => a.daysToExam - b.daysToExam);

            if (materieConScadenza.length === 0) {
                deadlineAlerts.style.display = 'none';
                return;
            }

            deadlineAlerts.style.display = 'block';
            deadlinesList.innerHTML = materieConScadenza.map(materia => `
                <div class="deadline-item">
                    <div>
                        <div class="deadline-subject">${materia.nome}</div>
                        <div class="deadline-days">${getProgressDescription(materia)}</div>
                    </div>
                    <div class="deadline-date">
                        ${materia.daysToExam} giorni
                    </div>
                </div>
            `).join('');
        }

        function generateWeeklyPlan(materieInStudio) {
            const weekGrid = document.getElementById('weekGrid');
            if (!weekGrid) return;

            const giorni = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
            const giorniKey = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const oggi = new Date().getDay();
            
            weekGrid.innerHTML = giorni.map((giorno, index) => {
                const isToday = (index + 1) % 7 === oggi % 7;
                const isWeekend = index >= 5;
                const giornoKey = giorniKey[index];
                
                const sessioniGiorno = generateDaySchedule(materieInStudio, giornoKey);
                
                return `
                    <div class="day-plan ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}">
                        <div class="day-header">
                            ${giorno}
                            ${isToday ? '(Oggi)' : ''}
                        </div>
                        <div class="day-sessions">
                            ${sessioniGiorno.length === 0 ? 
                                '<div style="color: var(--text-secondary); font-style: italic; text-align: center; padding: 1rem;">Nessuna sessione</div>' :
                                sessioniGiorno.map(session => `
                                    <div class="session-block priority-${session.priorita}">
                                        <div class="session-time">${session.orario}</div>
                                        <div class="session-subject">${session.materia}</div>
                                        <div class="session-details">${session.tipo} • ${session.durata}min</div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateDaySchedule(materieInStudio, giornoKey) {
            const sessions = [];
            
            materieInStudio.forEach(materia => {
                if (!materia.slotSettimanali || !materia.slotSettimanali[giornoKey]) return;
                
                const slots = materia.slotSettimanali[giornoKey] || [];
                slots.forEach(slot => {
                    const durata = calculateTaskDuration(slot.inizio, slot.fine);
                    const tipoSessione = determinaSessionType(materia);
                    
                    sessions.push({
                        orario: `${slot.inizio}-${slot.fine}`,
                        materia: materia.nome,
                        durata: durata,
                        priorita: materia.priorita,
                        tipo: tipoSessione,
                        difficolta: materia.difficolta
                    });
                });
            });
            
            return sessions.sort((a, b) => a.orario.localeCompare(b.orario));
        }

        function determinaSessionType(materia) {
            const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
            
            if (percentualeCompletamento < 20) return "Studio base";
            if (percentualeCompletamento < 50) return "Approfondimento";
            if (percentualeCompletamento < 80) return "Consolidamento";
            return "Ripasso finale";
        }

        function updateProgressOverview(materieInStudio) {
            const subjectProgressList = document.getElementById('subjectProgressList');
            if (!subjectProgressList) return;

            if (materieInStudio.length === 0) {
                subjectProgressList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>Aggiungi delle materie per vedere i progressi dettagliati!</p>
                    </div>
                `;
                return;
            }

            // Ordina per priorità e scadenza
            const materieSorted = [...materieInStudio].sort((a, b) => {
                const priorityOrder = { 'alta': 3, 'media': 2, 'bassa': 1 };
                const aPriority = priorityOrder[a.priorita] || 0;
                const bPriority = priorityOrder[b.priorita] || 0;
                
                if (aPriority !== bPriority) return bPriority - aPriority;
                
                // Se stessa priorità, ordina per scadenza
                const aDays = a.dataEsame ? getDaysToExam(a.dataEsame) : 999;
                const bDays = b.dataEsame ? getDaysToExam(b.dataEsame) : 999;
                return aDays - bDays;
            });

            subjectProgressList.innerHTML = materieSorted.map(materia => {
                const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                const daysToExam = materia.dataEsame ? getDaysToExam(materia.dataEsame) : null;
                
                let oreSettimanali = 0;
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slots.forEach(slot => {
                            oreSettimanali += calculateTaskDuration(slot.inizio, slot.fine);
                        });
                    });
                }
                oreSettimanali = Math.round(oreSettimanali / 60 * 10) / 10;

                const settimaneStimate = oreSettimanali > 0 ? 
                    Math.ceil(pagineRimanenti / ((oreSettimanali / 7) * (materia.pagineOra || 8) * 7)) : 0;

                return `
                    <div class="subject-progress-item">
                        <div class="progress-header">
                            <div class="progress-subject-name">${materia.nome}</div>
                            <div class="progress-percentage">${percentualeCompletamento}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentualeCompletamento}%"></div>
                        </div>
                        <div class="progress-details">
                            <div><strong>Pagine:</strong> ${materia.pagineStudiate || 0}/${materia.pagine}</div>
                            <div><strong>Rimanenti:</strong> ${pagineRimanenti}</div>
                            <div><strong>Ore/sett:</strong> ${oreSettimanali}h</div>
                            <div><strong>Priorità:</strong> ${materia.priorita}</div>
                            <div><strong>Difficoltà:</strong> ${'★'.repeat(materia.difficolta || 3)}</div>
                            ${daysToExam !== null && daysToExam > 0 ? 
                                `<div><strong>Scadenza:</strong> ${daysToExam} giorni</div>` : 
                                ''
                            }
                            ${settimaneStimate > 0 ? 
                                `<div><strong>Stima:</strong> ${settimaneStimate} settimane</div>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showEmptyPlanState() {
            const container = document.getElementById('pianoStudio');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                        <p style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="showSection('materie', document.querySelector('.nav-tab[onclick*=materie]'))">
                                ➕ Aggiungi Prima Materia
                            </button>
                        </p>
                    </div>
                `;
            }
        }

        function showErrorPlanState() {
            const container = document.getElementById('pianoStudio');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <p>Errore nella generazione del piano di studio.</p>
                        <p style="margin-top: 1rem;">
                            <button class="btn btn-warning" onclick="generatePianoStudio()">
                                🔄 Riprova
                            </button>
                        </p>
                    </div>
                `;
            }
        }

        // Helper functions
        function getDaysToExam(dataEsame) {
            if (!dataEsame) return null;
            const today = new Date();
            const examDate = new Date(dataEsame);
            const diffTime = examDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getBestStudyHours() {
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({ hour, avgRating });
                }
            }
            
            return hourlyRatings
                .sort((a, b) => b.avgRating - a.avgRating)
                .slice(0, 3)
                .map(h => h.hour);
        }

        function getProgressDescription(materia) {
            const percentuale = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
            if (percentuale < 20) return "Studio iniziale necessario";
            if (percentuale < 50) return "Progresso in corso";
            if (percentuale < 80) return "Fase avanzata";
            return "Quasi completato";
        }

        // === CURRICULUM MANAGEMENT ===
        function showCurriculumYear(year, tabElement) {
            currentCurriculumYear = year;
            
            // Aggiorna tab attivi
            document.querySelectorAll('.year-tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) tabElement.classList.add('active');
            
            // Nascondi tutti i contenuti anni
            document.querySelectorAll('.year-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Mostra l'anno selezionato
            const yearContent = document.getElementById(`year-${year}`);
            if (yearContent) {
                yearContent.style.display = 'block';
                yearContent.classList.add('active');
            }
            
            // Aggiorna il contenuto
            loadCurriculumData();
        }

        function showAddSubjectModal() {
            const modal = document.getElementById('addSubjectModal');
            if (!modal) return;
            
            // Pre-seleziona l'anno corrente
            document.getElementById('currSubjectYear').value = currentCurriculumYear;
            
            modal.style.display = 'flex';
        }

        function closeAddSubjectModal() {
            const modal = document.getElementById('addSubjectModal');
            if (modal) modal.style.display = 'none';
            
            // Reset form
            document.getElementById('currSubjectName').value = '';
            document.getElementById('currSubjectCFU').value = '';
            document.getElementById('currSubjectProfessor').value = '';
            document.getElementById('currSubjectNotes').value = '';
        }

        function saveCurriculumSubject() {
            try {
                const name = document.getElementById('currSubjectName').value.trim();
                const year = parseInt(document.getElementById('currSubjectYear').value);
                const semester = parseInt(document.getElementById('currSubjectSemester').value);
                const cfu = parseInt(document.getElementById('currSubjectCFU').value);
                const professor = document.getElementById('currSubjectProfessor').value.trim();
                const notes = document.getElementById('currSubjectNotes').value.trim();

                if (!name || !year || !semester || !cfu) {
                    showSuccessMessage('❌ Compila tutti i campi obbligatori');
                    return;
                }

                const subject = {
                    id: Date.now(),
                    name: name,
                    year: year,
                    semester: semester,
                    cfu: cfu,
                    professor: professor,
                    notes: notes,
                    completed: false,
                    grade: null,
                    lode: false,
                    examDate: null,
                    examNotes: '',
                    dateAdded: new Date().toISOString()
                };

                curriculum.push(subject);
                saveCurriculumData();
                loadCurriculumData();
                updateExamsSection(); // Aggiorna anche la sezione esami
                closeAddSubjectModal();

                showSuccessMessage(`✅ Materia "${name}" aggiunta al ${year}° anno`);

            } catch (error) {
                console.error('Errore nel salvataggio materia curriculum:', error);
                showSuccessMessage('❌ Errore nel salvataggio della materia');
            }
        }

        function loadCurriculumData() {
            try {
                // Carica dati per tutti e 3 gli anni
                for (let year = 1; year <= 3; year++) {
                    loadYearData(year);
                }
            } catch (error) {
                console.error('Errore nel caricamento curriculum:', error);
            }
        }

        function loadYearData(year) {
            const yearSubjects = curriculum.filter(s => s.year === year);
            const semester1Subjects = yearSubjects.filter(s => s.semester === 1);
            const semester2Subjects = yearSubjects.filter(s => s.semester === 2);

            // Calcola statistiche anno
            const totalSubjects = yearSubjects.length;
            const totalCFU = yearSubjects.reduce((sum, s) => sum + s.cfu, 0);
            const completedSubjects = yearSubjects.filter(s => s.completed).length;
            const completedGrades = yearSubjects.filter(s => s.completed && s.grade);
            const averageGrade = completedGrades.length > 0 ? 
                (completedGrades.reduce((sum, s) => sum + (s.lode ? 31 : s.grade), 0) / completedGrades.length).toFixed(1) : 0;

            // Aggiorna statistiche header
            const subjectsEl = document.getElementById(`year${year}-subjects`);
            const cfuEl = document.getElementById(`year${year}-cfu`);
            const completedEl = document.getElementById(`year${year}-completed`);
            const averageEl = document.getElementById(`year${year}-average`);

            if (subjectsEl) subjectsEl.textContent = totalSubjects;
            if (cfuEl) cfuEl.textContent = totalCFU;
            if (completedEl) completedEl.textContent = completedSubjects;
            if (averageEl) averageEl.textContent = averageGrade;

            // Aggiorna progress semestri
            const sem1ProgressEl = document.getElementById(`year${year}-sem1-progress`);
            const sem2ProgressEl = document.getElementById(`year${year}-sem2-progress`);
            
            if (sem1ProgressEl) {
                const sem1Completed = semester1Subjects.filter(s => s.completed).length;
                sem1ProgressEl.textContent = `${sem1Completed}/${semester1Subjects.length} esami`;
            }
            
            if (sem2ProgressEl) {
                const sem2Completed = semester2Subjects.filter(s => s.completed).length;
                sem2ProgressEl.textContent = `${sem2Completed}/${semester2Subjects.length} esami`;
            }

            // Carica materie per semestre
            loadSemesterSubjects(year, 1, semester1Subjects);
            loadSemesterSubjects(year, 2, semester2Subjects);
        }

        function loadSemesterSubjects(year, semester, subjects) {
            const container = document.getElementById(`year${year}-semester${semester}-subjects`);
            if (!container) return;

            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📖</div>
                        <p>Nessuna materia aggiunta ancora</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = subjects.map(subject => {
                const isCompleted = subject.completed;
                const gradeDisplay = isCompleted && subject.grade ? 
                    `<div class="subject-grade">${subject.grade}${subject.lode ? 'L' : ''}</div>` : '';

                return `
                    <div class="curriculum-subject ${isCompleted ? 'completed' : ''}">
                        <div class="subject-header-curr">
                            <div class="subject-name-curr">${subject.name}</div>
                            <div class="subject-actions-curr">
                                <input type="checkbox" class="exam-checkbox" ${isCompleted ? 'checked' : ''} 
                                       onchange="toggleCurriculumExam(${subject.id}, this.checked)" 
                                       title="${isCompleted ? 'Esame completato' : 'Marca come completato'}">
                                ${gradeDisplay}
                                <button class="btn btn-warning btn-small" onclick="editCurriculumSubject(${subject.id})" title="Modifica">✏️</button>
                                <button class="btn btn-danger btn-small" onclick="deleteCurriculumSubject(${subject.id})" title="Elimina">🗑️</button>
                            </div>
                        </div>
                        
                        <div class="subject-info-curr">
                            <div><strong>CFU:</strong> ${subject.cfu}</div>
                            ${subject.professor ? `<div><strong>Professore:</strong> ${subject.professor}</div>` : ''}
                            ${subject.examDate ? `<div><strong>Data Esame:</strong> ${new Date(subject.examDate).toLocaleDateString('it-IT')}</div>` : ''}
                            ${subject.notes ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${subject.notes}</div>` : ''}
                            ${subject.examNotes ? `<div style="grid-column: 1 / -1;"><strong>Note Esame:</strong> ${subject.examNotes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCurriculumExam(subjectId, isCompleted) {
            const subject = curriculum.find(s => s.id === subjectId);
            if (!subject) return;

            if (isCompleted && !subject.grade) {
                // Mostra modal per inserire voto
                showCurriculumExamModal(subject);
            } else if (!isCompleted) {
                // Rimuovi esame e voto
                subject.completed = false;
                subject.grade = null;
                subject.lode = false;
                subject.examDate = null;
                subject.examNotes = '';
                
                // Rimuovi anche dall'array esami se esiste
                esami = esami.filter(e => e.curriculumSubjectId !== subjectId);
                saveEsami();
                
                saveCurriculumData();
                loadCurriculumData();
                updateExamsSection();
                
                showSuccessMessage(`✅ Esame di "${subject.name}" rimosso`);
            }
        }

        function showCurriculumExamModal(subject) {
            // Usa il modal esistente degli esami
            document.getElementById('examSubject').value = subject.name;
            document.getElementById('examModal').style.display = 'flex';
            
            // Salva l'ID del curriculum subject
            document.getElementById('examModal').dataset.curriculumSubjectId = subject.id;
            // Assicurati che non sia marcato come materia studio
            delete document.getElementById('examModal').dataset.materiaId;
        }

        function editCurriculumSubject(subjectId) {
            const subject = curriculum.find(s => s.id === subjectId);
            if (!subject) {
                showSuccessMessage('❌ Materia non trovata');
                return;
            }

            // Popola form di modifica
            document.getElementById('editCurrSubjectName').value = subject.name;
            document.getElementById('editCurrSubjectYear').value = subject.year;
            document.getElementById('editCurrSubjectSemester').value = subject.semester;
            document.getElementById('editCurrSubjectCFU').value = subject.cfu;
            document.getElementById('editCurrSubjectProfessor').value = subject.professor || '';
            document.getElementById('editCurrSubjectNotes').value = subject.notes || '';
            
            currentEditingCurriculumId = subjectId;
            document.getElementById('editCurriculumModal').style.display = 'flex';
        }

        function closeEditCurriculumModal() {
            document.getElementById('editCurriculumModal').style.display = 'none';
            currentEditingCurriculumId = null;
        }

        function updateCurriculumSubject() {
            try {
                const subjectIndex = curriculum.findIndex(s => s.id === currentEditingCurriculumId);
                if (subjectIndex === -1) {
                    showSuccessMessage('❌ Materia non trovata');
                    return;
                }

                const name = document.getElementById('editCurrSubjectName').value.trim();
                const year = parseInt(document.getElementById('editCurrSubjectYear').value);
                const semester = parseInt(document.getElementById('editCurrSubjectSemester').value);
                const cfu = parseInt(document.getElementById('editCurrSubjectCFU').value);
                const professor = document.getElementById('editCurrSubjectProfessor').value.trim();
                const notes = document.getElementById('editCurrSubjectNotes').value.trim();

                if (!name || !year || !semester || !cfu) {
                    showSuccessMessage('❌ Compila tutti i campi obbligatori');
                    return;
                }

                // Aggiorna dati
                curriculum[subjectIndex].name = name;
                curriculum[subjectIndex].year = year;
                curriculum[subjectIndex].semester = semester;
                curriculum[subjectIndex].cfu = cfu;
                curriculum[subjectIndex].professor = professor;
                curriculum[subjectIndex].notes = notes;

                // Aggiorna anche nell'array esami se esiste
                const examIndex = esami.findIndex(e => e.curriculumSubjectId === currentEditingCurriculumId);
                if (examIndex !== -1) {
                    esami[examIndex].nomeMateria = name;
                    esami[examIndex].cfu = cfu;
                    saveEsami();
                }

                saveCurriculumData();
                loadCurriculumData();
                updateExamsSection();
                closeEditCurriculumModal();

                showSuccessMessage(`✅ Materia "${name}" aggiornata`);

            } catch (error) {
                console.error('Errore nell\'aggiornamento materia curriculum:', error);
                showSuccessMessage('❌ Errore nell\'aggiornamento della materia');
            }
        }

        function deleteCurriculumSubject(subjectId) {
            const subject = curriculum.find(s => s.id === subjectId);
            if (!subject) {
                showSuccessMessage('❌ Materia non trovata');
                return;
            }

            const conferma = confirm(`Sei sicuro di voler eliminare "${subject.name}"?\n\nQuesta azione eliminerà anche l'eventuale esame associato e non può essere annullata.`);
            
            if (conferma) {
                // Elimina anche l'esame associato se esiste
                esami = esami.filter(e => e.curriculumSubjectId !== subjectId);
                saveEsami();
                
                curriculum = curriculum.filter(s => s.id !== subjectId);
                saveCurriculumData();
                loadCurriculumData();
                updateExamsSection();
                
                showSuccessMessage(`🗑️ Materia "${subject.name}" eliminata`);
            }
        }

        function saveCurriculumData() {
            try {
                localStorage.setItem('curriculum', JSON.stringify(curriculum));
            } catch (error) {
                console.error('Errore nel salvataggio curriculum:', error);
            }
        }

        function importCurriculumData() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Valida struttura dati
                            if (!Array.isArray(data) || !data.every(item => 
                                item.name && item.year && item.semester && item.cfu)) {
                                throw new Error('Formato file non valido');
                            }
                            
                            const conferma = confirm(`Importare ${data.length} materie?\n\nQuesta azione sostituirà il curriculum esistente.`);
                            if (conferma) {
                                curriculum = data.map(item => ({
                                    ...item,
                                    id: item.id || Date.now() + Math.random()
                                }));
                                saveCurriculumData();
                                loadCurriculumData();
                                showSuccessMessage(`✅ ${data.length} materie importate con successo`);
                            }
                        } catch (error) {
                            showSuccessMessage('❌ Errore nell\'importazione: file non valido');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            } catch (error) {
                console.error('Errore nell\'importazione:', error);
                showSuccessMessage('❌ Errore nell\'importazione dati');
            }
        }

        function exportCurriculumData() {
            try {
                if (curriculum.length === 0) {
                    showSuccessMessage('❌ Nessun dato da esportare');
                    return;
                }
                
                const dataStr = JSON.stringify(curriculum, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `curriculum_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccessMessage(`✅ Curriculum esportato (${curriculum.length} materie)`);
            } catch (error) {
                console.error('Errore nell\'esportazione:', error);
                showSuccessMessage('❌ Errore nell\'esportazione dati');
            }
        }

        // === NAVIGAZIONE ===
        function showSection(sectionName, targetElement) {
            try {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });

                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                if (targetElement) {
                    targetElement.classList.add('active');
                }

                // Aggiorna contenuto dinamico
                if (sectionName === 'oggi') {
                    generateTodaySchedule();
                } else if (sectionName === 'piano') {
                    generatePianoStudio();
                } else if (sectionName === 'statistiche') {
                    updateStatistiche();
                    updateHeatmap();
                    updateProductivitySection();
                } else if (sectionName === 'calendario') {
                    renderCalendar();
                } else if (sectionName === 'materie') {
                    setTimeout(() => {
                        initializeWeeklySlots();
                        setupStarRating();
                    }, 100);
                } else if (sectionName === 'pomodoro') {
                    updateTodaySessionsList();
                } else if (sectionName === 'esami') {
                    updateExamsSection();
                } else if (sectionName === 'curriculum') {
                    loadCurriculumData();
                }

            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // Modifica la funzione saveExamGrade per gestire sia materie studio che curriculum
        function saveExamGrade() {
            try {
                const materiaId = document.getElementById('examModal').dataset.materiaId;
                const curriculumSubjectId = document.getElementById('examModal').dataset.curriculumSubjectId;
                const voto = parseInt(document.getElementById('examGrade').value);
                const lode = document.getElementById('examLode').checked;
                const dataEsame = document.getElementById('examDate').value;
                const note = document.getElementById('examNotes').value.trim();

                if (!voto || voto < 18 || voto > 30) {
                    showSuccessMessage('❌ Inserisci un voto valido tra 18 e 30');
                    return;
                }

                if (voto < 30 && lode) {
                    showSuccessMessage('❌ La lode può essere assegnata solo con voto 30');
                    return;
                }

                let sourceObject = null;
                let sourceName = '';

                if (materiaId) {
                    // Materia da studio
                    sourceObject = materie.find(m => m.id === parseInt(materiaId));
                    if (sourceObject) {
                        sourceObject.status = 'completato';
                        sourceObject.pagineStudiate = sourceObject.pagine;
                        sourceName = sourceObject.nome;
                    }
                } else if (curriculumSubjectId) {
                    // Materia da curriculum
                    sourceObject = curriculum.find(s => s.id === parseInt(curriculumSubjectId));
                    if (sourceObject) {
                        sourceObject.completed = true;
                        sourceObject.grade = voto;
                        sourceObject.lode = lode;
                        sourceObject.examDate = dataEsame;
                        sourceObject.examNotes = note;
                        sourceName = sourceObject.name;
                    }
                }

                if (!sourceObject) {
                    showSuccessMessage('❌ Materia non trovata');
                    return;
                }

                // Crea record esame
                const esame = {
                    id: Date.now(),
                    materiaId: materiaId ? parseInt(materiaId) : null,
                    curriculumSubjectId: curriculumSubjectId ? parseInt(curriculumSubjectId) : null,
                    nomeMateria: sourceName,
                    cfu: sourceObject.cfu || sourceObject.cfu,
                    voto: voto,
                    lode: lode,
                    dataEsame: dataEsame,
                    note: note,
                    dataRegistrazione: new Date().toISOString()
                };

                esami.push(esame);
                
                saveMaterie();
                saveCurriculumData();
                saveEsami();
                loadMaterie();
                loadCurriculumData();
                updateExamsSection();
                closeExamModal();

                showSuccessMessage(`🎓 Esame "${sourceName}" registrato con voto ${voto}${lode ? ' e lode' : ''}!`);

            } catch (error) {
                console.error('Errore nel salvataggio esame:', error);
                showSuccessMessage('❌ Errore nel salvataggio dell\'esame');
            }
        }

        // === TIMER POMODORO ===
        function setPreset(work, breakTime, targetElement) {
            try {
                if (timerState.isRunning) return;
                
                timerState.workTime = work;
                timerState.breakTime = breakTime;
                timerState.minutes = work;
                timerState.seconds = 0;
                timerState.isBreak = false;
                
                updateTimerDisplay();
                
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                if (targetElement) {
                    targetElement.classList.add('active');
                }
            } catch (error) {
                console.error('Errore nel preset timer:', error);
            }
        }

        function showCustomTimerDialog() {
            if (timerState.isRunning) {
                showSuccessMessage('❌ Ferma il timer prima di personalizzare!');
                return;
            }
            
            const modal = document.getElementById('customTimerModal');
            modal.style.display = 'flex';
            
            document.getElementById('customWorkTime').value = timerState.workTime;
            document.getElementById('customBreakTime').value = timerState.breakTime;
        }

        function closeCustomTimerModal() {
            const modal = document.getElementById('customTimerModal');
            modal.style.display = 'none';
        }

        function applyCustomTimer() {
            const workMinutes = parseInt(document.getElementById('customWorkTime').value);
            const breakMinutes = parseInt(document.getElementById('customBreakTime').value);
            
            if (isNaN(workMinutes) || workMinutes < 1 || workMinutes > 180) {
                showSuccessMessage('❌ Inserisci minuti di lavoro validi (1-180)');
                return;
            }
            
            if (isNaN(breakMinutes) || breakMinutes < 1 || breakMinutes > 60) {
                showSuccessMessage('❌ Inserisci minuti di pausa validi (1-60)');
                return;
            }
            
            timerState.workTime = workMinutes;
            timerState.breakTime = breakMinutes;
            timerState.minutes = workMinutes;
            timerState.seconds = 0;
            timerState.isBreak = false;
            
            updateTimerDisplay();
            
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            const customBtn = document.querySelector('.preset-btn:last-child');
            customBtn.classList.add('active');
            customBtn.textContent = `${workMinutes}/${breakMinutes} min`;
            
            closeCustomTimerModal();
            showSuccessMessage(`✅ Timer personalizzato: ${workMinutes} min lavoro, ${breakMinutes} min pausa`);
        }

        function startTimer() {
            if (timerState.isRunning) return;
            
            // Salva orario inizio sessione per il rating
            currentSessionStartTime = new Date();
            
            timerState.isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-flex';
            
            timerInterval = setInterval(() => {
                if (timerState.seconds === 0) {
                    if (timerState.minutes === 0) {
                        completeSession();
                        return;
                    }
                    timerState.minutes--;
                    timerState.seconds = 59;
                } else {
                    timerState.seconds--;
                }
                
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            timerState.isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('pauseBtn').style.display = 'none';
        }

        function resetTimer() {
            pauseTimer();
            timerState.minutes = timerState.isBreak ? timerState.breakTime : timerState.workTime;
            timerState.seconds = 0;
            currentSessionStartTime = null;
            updateTimerDisplay();
        }

        function completeSession() {
            pauseTimer();
            
            if (!timerState.isBreak) {
                timerState.sessionsToday++;
                studyData.totalSessions++;
                localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                updateSessionDisplay();
                updateStudyStreak();
                recordCompletedSession();
                
                // Mostra modal rating solo per sessioni di lavoro
                setTimeout(() => {
                    showRatingModal();
                }, 500);
                
                timerState.isBreak = true;
                timerState.minutes = timerState.breakTime;
                timerState.seconds = 0;
            } else {
                timerState.isBreak = false;
                timerState.minutes = timerState.workTime;
                timerState.seconds = 0;
                
                showNotification('⏰ Pausa finita!', 'Torna al lavoro!');
            }
            
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const display = `${timerState.minutes.toString().padStart(2, '0')}:${timerState.seconds.toString().padStart(2, '0')}`;
            const timerDisplayEl = document.getElementById('timerDisplay');
            const focusTimerEl = document.getElementById('focusTimer');
            
            if (timerDisplayEl) timerDisplayEl.textContent = display;
            if (focusTimerEl) focusTimerEl.textContent = display;
            
            if (timerDisplayEl) {
                if (timerState.isBreak) {
                    timerDisplayEl.classList.add('break-mode');
                } else {
                    timerDisplayEl.classList.remove('break-mode');
                }
            }
        }

        function updateSessionDisplay() {
            const sessionCountEl = document.getElementById('sessionCount');
            const sessionGoalEl = document.getElementById('sessionGoal');
            const sessionProgressEl = document.getElementById('sessionProgress');
            const progressTextEl = document.getElementById('progressText');
            
            updateDailyGoalDisplay();
            
            if (sessionCountEl) sessionCountEl.textContent = timerState.sessionsToday;
            if (sessionGoalEl) sessionGoalEl.textContent = timerState.dailyGoal;
            
            if (sessionProgressEl) {
                const progress = Math.min(100, (timerState.sessionsToday / timerState.dailyGoal) * 100);
                sessionProgressEl.style.width = progress + '%';
            }
            
            if (progressTextEl) {
                if (timerState.sessionsToday === 0) {
                    progressTextEl.textContent = 'Inizia la tua prima sessione!';
                } else if (timerState.sessionsToday >= timerState.dailyGoal) {
                    progressTextEl.textContent = '🎉 Obiettivo raggiunto! Ottimo lavoro!';
                } else {
                    const remaining = timerState.dailyGoal - timerState.sessionsToday;
                    progressTextEl.textContent = `Ancora ${remaining} sessioni per raggiungere l'obiettivo`;
                }
            }
        }

        function toggleFocusMode() {
            const focusMode = document.getElementById('focusMode');
            const isVisible = focusMode.style.display === 'flex';
            
            if (isVisible) {
                focusMode.style.display = 'none';
            } else {
                focusMode.style.display = 'flex';
                updateTimerDisplay();
                if (!timerState.isRunning && timerState.minutes > 0) {
                    startTimer();
                }
            }
        }

        // Sistema Rating Sessioni
        function showRatingModal() {
            try {
                const modal = document.getElementById('ratingModal');
                if (!modal) {
                    console.error('Rating modal not found');
                    return;
                }
                
                // Resetta la nota
                const noteInput = document.getElementById('sessionNote');
                if (noteInput) noteInput.value = '';
                
                modal.style.display = 'flex';
                
                // Suono di notifica
                playNotificationSound();
                
                // Notifica browser se supportata
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('🎉 Sessione completata!', { 
                        body: 'Come ti senti? Valuta la tua produttività.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><text y="32" font-size="32">🍅</text></svg>'
                    });
                }
            } catch (error) {
                console.error('Errore nella visualizzazione del modal rating:', error);
                showSuccessMessage('🎉 Sessione completata! Ottimo lavoro!');
            }
        }

        function submitRating(rating) {
            try {
                const now = new Date();
                const hour = now.getHours();
                
                const dateKey = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
                const timestamp = now.getTime();
                
                // Ottieni la nota dalla sessione
                const noteInput = document.getElementById('sessionNote');
                const sessionNote = noteInput ? noteInput.value.trim() : '';
                
                // Salva rating con timestamp e ora
                if (!sessionRatings[dateKey]) {
                    sessionRatings[dateKey] = {};
                }
                
                if (!sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour] = [];
                }
                
                sessionRatings[dateKey][hour].push({
                    rating: rating,
                    timestamp: timestamp,
                    duration: timerState.workTime,
                    note: sessionNote
                });
                
                localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                
                // Salva sessione dettagliata per la lista di oggi
                const sessionDetails = {
                    id: timestamp,
                    startTime: currentSessionStartTime ? currentSessionStartTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    endTime: now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    duration: timerState.workTime,
                    rating: rating,
                    note: sessionNote,
                    materia: currentSessionData?.materia || 'Studio generale',
                    date: dateKey
                };
                
                todayDetailedSessions.push(sessionDetails);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna lista sessioni
                updateTodaySessionsList();
                
                // Chiudi modal con animazione
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Aggiorna heatmap e statistiche
                updateHeatmap();
                updateProductivitySection();
                
                // Feedback visivo
                const ratingTexts = ['😴 Riposa un po\'', '😐 Va bene così', '😊 Ottimo lavoro!', '🔥 Sei in fiammata!'];
                showSuccessMessage(`${ratingTexts[rating-1]} Rating salvato per le ${hour}:00`);
                
            } catch (error) {
                console.error('Errore nel salvataggio rating:', error);
                showSuccessMessage('⚠️ Errore nel salvataggio del rating, ma sessione completata!');
                
                // Chiudi comunque il modal
                const modal = document.getElementById('ratingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // === LISTA SESSIONI DI OGGI ===
        function updateTodaySessionsList() {
            const container = document.getElementById('todaySessionsList');
            if (!container) return;
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
            const lastSessionDate = localStorage.getItem('lastDetailedSessionDate') || '';
            
            if (lastSessionDate !== today) {
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                localStorage.setItem('lastDetailedSessionDate', today);
            }
            
            if (todayDetailedSessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🍅</div>
                        <p>Nessuna sessione completata oggi.</p>
                        <p>Avvia una sessione per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            // Ordina le sessioni per ora di inizio (più recenti prima)
            const sortedSessions = [...todayDetailedSessions].sort((a, b) => b.id - a.id);
            
            container.innerHTML = sortedSessions.map(session => {
                const ratingStars = '★'.repeat(session.rating) + '☆'.repeat(4 - session.rating);
                
                return `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-time">${session.startTime} - ${session.endTime}</div>
                            <div>
                                <span class="session-materia">${session.materia}</span>
                                <span style="color: var(--text-secondary); margin-left: 1rem;">${session.duration} min</span>
                            </div>
                            ${session.note ? `<div class="session-note">"${session.note}"</div>` : ''}
                            <div class="session-rating">
                                <span style="color: #fbbf24; font-size: 0.9rem;">${ratingStars}</span>
                            </div>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteSpecificSession(${session.id})" title="Elimina questa sessione">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteSpecificSession(sessionId) {
            try {
                const sessionIndex = todayDetailedSessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    showSuccessMessage('❌ Sessione non trovata');
                    return;
                }
                
                const session = todayDetailedSessions[sessionIndex];
                
                const conferma = confirm(`Sei sicuro di voler eliminare questa sessione?\n\n` +
                    `Materia: ${session.materia}\n` +
                    `Durata: ${session.duration} min\n` +
                    `Orario: ${session.startTime} - ${session.endTime}\n` +
                    `Rating: ${'★'.repeat(session.rating)}${'☆'.repeat(4 - session.rating)}\n` +
                    `${session.note ? `Nota: ${session.note}` : ''}`);
                
                if (!conferma) return;
                
                // Rimuovi dalla lista dettagliata
                todayDetailedSessions.splice(sessionIndex, 1);
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                // Aggiorna contatori generali
                if (timerState.sessionsToday > 0) {
                    timerState.sessionsToday--;
                    localStorage.setItem('sessionsToday', timerState.sessionsToday.toString());
                }
                
                if (studyData.totalSessions > 0) {
                    studyData.totalSessions--;
                    localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                }
                
                // Rimuovi dal rating se esiste
                const sessionHour = parseInt(session.startTime.split(':')[0]);
                const dateKey = session.date;
                
                if (sessionRatings[dateKey] && sessionRatings[dateKey][sessionHour]) {
                    const ratingIndex = sessionRatings[dateKey][sessionHour].findIndex(r => r.timestamp === session.id);
                    if (ratingIndex !== -1) {
                        sessionRatings[dateKey][sessionHour].splice(ratingIndex, 1);
                        if (sessionRatings[dateKey][sessionHour].length === 0) {
                            delete sessionRatings[dateKey][sessionHour];
                        }
                        localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                    }
                }
                
                // Aggiorna anche il calendario
                const today = new Date().toISOString().split('T')[0];
                if (calendarSessions[today] && calendarSessions[today].completed > 0) {
                    calendarSessions[today].completed--;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(`✅ Sessione di ${session.duration} min eliminata`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione della sessione:', error);
                showSuccessMessage('❌ Errore nell\'eliminazione della sessione');
            }
        }

        function showDeleteAllTodaySessionsModal() {
            if (todayDetailedSessions.length === 0) {
                showSuccessMessage('❌ Nessuna sessione da eliminare oggi');
                return;
            }
            
            const totalMinutes = todayDetailedSessions.reduce((sum, session) => sum + session.duration, 0);
            
            const conferma = confirm(`Sei sicuro di voler eliminare tutte le ${todayDetailedSessions.length} sessioni di oggi?\n\n` +
                `Tempo totale: ${totalMinutes} minuti\n` +
                `Questa azione non può essere annullata.`);
            
            if (!conferma) return;
            
            try {
                const sessionsDeleted = todayDetailedSessions.length;
                
                todayDetailedSessions = [];
                localStorage.setItem('todayDetailedSessions', JSON.stringify(todayDetailedSessions));
                
                timerState.sessionsToday = 0;
                localStorage.setItem('sessionsToday', '0');
                
                studyData.totalSessions = Math.max(0, studyData.totalSessions - sessionsDeleted);
                localStorage.setItem('totalSessions', studyData.totalSessions.toString());
                
                // Pulisci anche i rating di oggi
                const today = new Date().toISOString().split('T')[0];
                if (sessionRatings[today]) {
                    delete sessionRatings[today];
                    localStorage.setItem('sessionRatings', JSON.stringify(sessionRatings));
                }
                
                // Pulisci calendario di oggi
                if (calendarSessions[today]) {
                    calendarSessions[today].completed = 0;
                    localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
                }
                
                // Aggiorna UI
                updateTodaySessionsList();
                updateSessionDisplay();
                renderCalendar();
                updateHeatmap();
                updateProductivitySection();
                
                showSuccessMessage(`✅ Tutte le ${sessionsDeleted} sessioni di oggi sono state eliminate`);
                
            } catch (error) {
                console.error('Errore nell\'eliminazione di tutte le sessioni:', error);
                showSuccessMessage('❌ Errore nell\'eliminazione delle sessioni');
            }
        }

        // === OBIETTIVO GIORNALIERO PERSONALIZZABILE ===
        function updateDailyGoal() {
            const goalInput = document.getElementById('dailyGoal');
            const newGoal = parseInt(goalInput.value);
            
            if (newGoal && newGoal > 0 && newGoal <= 20) {
                timerState.dailyGoal = newGoal;
                localStorage.setItem('dailyGoal', newGoal.toString());
                updateSessionDisplay();
                updateDailyGoalDisplay();
                showSuccessMessage(`🎯 Obiettivo aggiornato: ${newGoal} pomodori al giorno`);
            } else {
                goalInput.value = timerState.dailyGoal;
                showSuccessMessage('❌ Inserisci un obiettivo valido (1-20 sessioni)');
            }
        }

        function updateDailyGoalDisplay() {
            const goalInput = document.getElementById('dailyGoal');
            const sessionGoalEl = document.getElementById('sessionGoal');
            
            if (goalInput) goalInput.value = timerState.dailyGoal;
            if (sessionGoalEl) sessionGoalEl.textContent = timerState.dailyGoal;
        }

        // Registra sessioni completate dal timer
        function recordCompletedSession() {
            try {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
                
                if (!calendarSessions[today]) {
                    calendarSessions[today] = { completed: 0, manual: 0 };
                }
                
                calendarSessions[today].completed = (calendarSessions[today].completed || 0) + 1;
                localStorage.setItem('calendarSessions', JSON.stringify(calendarSessions));
            } catch (error) {
                console.error('Errore nel recording sessione:', error);
            }
        }

        // === STUDIO STREAK ===
        function updateStudyStreak() {
            const today = new Date().toDateString();
            const lastStudy = studyData.lastStudyDate;
            
            if (lastStudy === today) {
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastStudy === yesterday.toDateString()) {
                studyData.streak++;
            } else if (lastStudy !== today) {
                studyData.streak = timerState.sessionsToday > 0 ? 1 : 0;
            }
            
            if (timerState.sessionsToday > 0) {
                studyData.lastStudyDate = today;
            }
            
            saveStudyData();
            updateStreakDisplay();
        }

        function updateStreakDisplay() {
            const streakNumber = document.getElementById('streakNumber');
            if (streakNumber) {
                streakNumber.textContent = studyData.streak;
            }
        }

        function saveStudyData() {
            localStorage.setItem('studyStreak', studyData.streak.toString());
            localStorage.setItem('lastStudyDate', studyData.lastStudyDate);
            localStorage.setItem('totalSessions', studyData.totalSessions.toString());
            localStorage.setItem('missedTime', studyData.missedTime.toString());
            localStorage.setItem('dailyGoal', timerState.dailyGoal.toString());
        }

        // === HEATMAP 24 ORE ===
        function initializeHeatmap() {
            const heatmapGrid = document.getElementById('heatmapGrid');
            if (!heatmapGrid) return;
            
            heatmapGrid.innerHTML = '';
            
            // Genera 24 celle (0-23 ore)
            for (let hour = 0; hour < 24; hour++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell empty';
                cell.textContent = hour.toString().padStart(2, '0');
                cell.dataset.hour = hour;
                
                // Event listeners per tooltip
                cell.addEventListener('mouseenter', (e) => showHeatmapTooltip(e, hour));
                cell.addEventListener('mouseleave', hideHeatmapTooltip);
                
                heatmapGrid.appendChild(cell);
            }
            
            updateHeatmap();
        }

        function updateHeatmap() {
            const cells = document.querySelectorAll('.heatmap-cell');
            
            cells.forEach((cell, hour) => {
                const avgRating = calculateHourlyAverageRating(hour);
                
                // Reset classi
                cell.className = 'heatmap-cell';
                
                if (avgRating === 0) {
                    cell.classList.add('empty');
                } else if (avgRating <= 1.5) {
                    cell.classList.add('low');
                } else if (avgRating <= 2.5) {
                    cell.classList.add('medium');
                } else if (avgRating <= 3.5) {
                    cell.classList.add('high');
                } else {
                    cell.classList.add('very-high');
                }
            });
        }

        function calculateHourlyAverageRating(hour) {
            let totalRating = 0;
            let sessionCount = 0;
            
            // Analizza gli ultimi 30 giorni
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionRatings[dateKey][hour].forEach(session => {
                        totalRating += session.rating;
                        sessionCount++;
                    });
                }
            });
            
            return sessionCount > 0 ? totalRating / sessionCount : 0;
        }

        function showHeatmapTooltip(event, hour) {
            const tooltip = document.getElementById('heatmapTooltip');
            if (!tooltip) return;
            
            const avgRating = calculateHourlyAverageRating(hour);
            const sessionCount = getHourlySessionCount(hour);
            
            let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
            
            if (sessionCount === 0) {
                content += 'Nessuna sessione registrata';
            } else {
                const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                 avgRating <= 2.5 ? 'Media' : 
                                 avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                content += `Produttività: ${ratingText}<br>`;
                content += `${sessionCount} sessioni<br>`;
                content += `Rating medio: ${avgRating.toFixed(1)}/4`;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.add('show');
        }

        function hideHeatmapTooltip() {
            const tooltip = document.getElementById('heatmapTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        function getHourlySessionCount(hour) {
            let sessionCount = 0;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            Object.keys(sessionRatings).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date >= thirtyDaysAgo && sessionRatings[dateKey][hour]) {
                    sessionCount += sessionRatings[dateKey][hour].length;
                }
            });
            
            return sessionCount;
        }

        // === SEZIONE PRODUTTIVITÀ ===
        function updateProductivitySection() {
            updateTopHours();
            updateProductivitySuggestion();
        }

        function updateTopHours() {
            const topHoursGrid = document.getElementById('topHoursGrid');
            if (!topHoursGrid) return;
            
            // Calcola rating medio per ogni ora
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            // Ordina per rating e prendi i top 3
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const top3 = hourlyRatings.slice(0, 3);
            
            if (top3.length === 0) {
                topHoursGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
                        <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                    </div>
                `;
                return;
            }
            
            topHoursGrid.innerHTML = top3.map((hour, index) => {
                const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                  hour.avgRating <= 2.5 ? 'Media' : 
                                  hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                
                const rankEmojis = ['🥇', '🥈', '🥉'];
                
                return `
                    <div class="top-hour-item">
                        <div class="top-hour-rank">${rankEmojis[index]}</div>
                        <div class="top-hour-time">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                        <div class="top-hour-rating">
                            ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                            <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProductivitySuggestion() {
            const suggestionEl = document.getElementById('productivitySuggestion');
            if (!suggestionEl) return;
            
            // Calcola statistics per il suggerimento
            const hourlyRatings = [];
            for (let hour = 0; hour < 24; hour++) {
                const avgRating = calculateHourlyAverageRating(hour);
                const sessionCount = getHourlySessionCount(hour);
                
                if (sessionCount > 0) {
                    hourlyRatings.push({
                        hour: hour,
                        avgRating: avgRating,
                        sessionCount: sessionCount
                    });
                }
            }
            
            if (hourlyRatings.length === 0) {
                suggestionEl.innerHTML = `
                    <h4>💡 Suggerimento Smart</h4>
                    <p>Aggiungi delle sessioni di studio per scoprire i tuoi momenti più produttivi!</p>
                `;
                return;
            }
            
            // Trova le ore migliori
            hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
            const bestHours = hourlyRatings.slice(0, 3);
            
            // Genera suggerimento personalizzato
            let suggestion = '';
            if (bestHours.length >= 2) {
                const topHour = bestHours[0];
                const secondHour = bestHours[1];
                
                const materieComplesse = materie.filter(m => m.difficolta >= 4 && m.status !== 'completato');
                
                if (materieComplesse.length > 0) {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Perfette per ${materieComplesse[0].nome} che richiede maggiore concentrazione!`;
                } else {
                    suggestion = `Le tue ore migliori sono ${topHour.hour}:00-${topHour.hour + 1}:00 e ${secondHour.hour}:00-${secondHour.hour + 1}:00. 
                        Programma le sessioni più impegnative in questi orari.`;
                }
            } else {
                const topHour = bestHours[0];
                suggestion = `La tua ora migliore è ${topHour.hour}:00-${topHour.hour + 1}:00 con un rating medio di ${topHour.avgRating.toFixed(1)}/4. 
                    Concentra qui le attività più difficili!`;
            }
            
            suggestionEl.innerHTML = `
                <h4>💡 Suggerimento Smart</h4>
                <p>${suggestion}</p>
            `;
        }

        // === UTILITÀ ===
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                backdrop-filter: blur(10px);
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%) scale(0.8); opacity: 0; }
                    to { transform: translateX(0) scale(1); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0) scale(1); opacity: 1; }
                    to { transform: translateX(100%) scale(0.8); opacity: 0; }
                }
            `;
            
            document.head.appendChild(style);
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                    if (document.head.contains(style)) {
                        document.head.removeChild(style);
                    }
                }, 400);
            }, 4000);
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        function showNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: message });
            }
            showSuccessMessage(`${title} ${message}`);
        }

        // === GESTIONE MATERIE ===
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.replaceWith(star.cloneNode(true));
            });
            
            const freshStars = document.querySelectorAll('.star');
            freshStars.forEach((star, index) => {
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    difficoltaSelezionata = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
                
                star.addEventListener('mouseout', function() {
                    updateStarDisplay();
                });
            });

            updateStarDisplay();
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateStarDisplay() {
            highlightStars(difficoltaSelezionata);
        }

        // === SISTEMA SLOT TEMPORALI ===
        function initializeWeeklySlots() {
            const container = document.getElementById('weeklySlots');
            if (!container) {
                console.error('Container weeklySlots non trovato!');
                return;
            }
            
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const giorniLabel = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];

            const slotsHTML = giorni.map((giorno, index) => `
                <div class="day-slots">
                    <h4>${giorniLabel[index]}</h4>
                    <div class="time-slots" id="slots-${giorno}">
                        <button type="button" class="add-slot" onclick="addTimeSlot('${giorno}')">+ Aggiungi Slot</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = slotsHTML;
        }

        function addTimeSlot(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) {
                console.error(`Container slots-${giorno} non trovato!`);
                return;
            }
            
            const slotId = `${giorno}-${Date.now()}`;
            
            const slotHTML = `
                <div class="slot-item" id="${slotId}">
                    <input type="time" value="09:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <span style="color: var(--text-secondary); margin: 0 0.5rem;">-</span>
                    <input type="time" value="11:00" onchange="validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                    <button type="button" class="remove-slot" onclick="removeTimeSlot('${slotId}', '${giorno}')" title="Rimuovi slot">×</button>
                </div>
            `;
            
            const addButton = container.querySelector('.add-slot');
            if (addButton) {
                addButton.insertAdjacentHTML('beforebegin', slotHTML);
            }
        }

        function removeTimeSlot(slotId, giorno) {
            const slot = document.getElementById(slotId);
            if (slot) {
                slot.remove();
                validateSlots(giorno);
            }
        }

        function validateSlots(giorno) {
            const container = document.getElementById(`slots-${giorno}`);
            if (!container) return true;
            
            const slots = container.querySelectorAll('.slot-item');
            
            const timeRanges = [];
            let hasOverlap = false;

            slots.forEach(slot => {
                const inputs = slot.querySelectorAll('input[type="time"]');
                const start = inputs[0].value;
                const end = inputs[1].value;
                
                inputs.forEach(input => {
                    input.style.borderColor = 'var(--border-color)';
                });

                if (start && end) {
                    if (start >= end) {
                        inputs.forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    } else {
                        timeRanges.push({ start, end, element: slot });
                    }
                }
            });

            for (let i = 0; i < timeRanges.length; i++) {
                for (let j = i + 1; j < timeRanges.length; j++) {
                    const range1 = timeRanges[i];
                    const range2 = timeRanges[j];
                    
                    if (timeOverlap(range1.start, range1.end, range2.start, range2.end)) {
                        range1.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        range2.element.querySelectorAll('input').forEach(input => {
                            input.style.borderColor = 'var(--danger-color)';
                        });
                        hasOverlap = true;
                    }
                }
            }

            return !hasOverlap;
        }

        function timeOverlap(start1, end1, start2, end2) {
            return (start1 < end2) && (end1 > start2);
        }

        function getWeeklySlots() {
            const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
            const slotSettimanali = {};

            giorni.forEach(giorno => {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) {
                    slotSettimanali[giorno] = [];
                    return;
                }
                
                const slots = container.querySelectorAll('.slot-item');
                slotSettimanali[giorno] = [];

                slots.forEach(slot => {
                    const inputs = slot.querySelectorAll('input[type="time"]');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    if (start && end && start < end) {
                        slotSettimanali[giorno].push({
                            inizio: start,
                            fine: end,
                            disponibile: true
                        });
                    }
                });
            });

            return slotSettimanali;
        }

        function addMateria() {
            try {
                const nome = document.getElementById('nomeMateria').value.trim();
                const cfu = document.getElementById('cfu').value;
                const pagine = document.getElementById('pagine').value;

                if (!nome || !cfu || !pagine) {
                    showSuccessMessage('❌ Compila tutti i campi obbligatori: Nome Materia, CFU e Pagine Totali');
                    return;
                }

                const slotSettimanali = getWeeklySlots();
                const hasSlots = Object.values(slotSettimanali).some(slots => slots.length > 0);

                if (!hasSlots) {
                    showSuccessMessage('❌ Aggiungi almeno uno slot temporale per programmare lo studio!');
                    return;
                }

                const materia = {
                    id: Date.now(),
                    nome: nome,
                    cfu: parseInt(cfu),
                    pagine: parseInt(pagine),
                    pagineStudiate: parseInt(document.getElementById('pagineStudiate').value) || 0,
                    pagineOra: parseInt(document.getElementById('pagineOra').value) || 8,
                    eserciziTotali: parseInt(document.getElementById('eserciziTotali').value) || 0,
                    eserciziCompletati: parseInt(document.getElementById('eserciziCompletati').value) || 0,
                    dataEsame: document.getElementById('dataEsame').value,
                    priorita: document.getElementById('priorita').value,
                    difficolta: difficoltaSelezionata,
                    slotSettimanali: slotSettimanali,
                    status: 'studio'
                };

                materie.push(materia);
                saveMaterie();
                loadMaterie();
                generateTodaySchedule();
                generatePianoStudio();
                updateStatistiche();
                updateExamsSection();

                resetForm();
                showSuccessMessage('✅ Materia aggiunta con successo!');
                
            } catch (error) {
                console.log('Errore nell\'aggiunta materia:', error);
                showSuccessMessage('❌ Errore nell\'aggiunta della materia. Riprova.');
            }
        }

        function resetForm() {
            document.getElementById('nomeMateria').value = '';
            document.getElementById('cfu').value = '';
            document.getElementById('pagine').value = '';
            document.getElementById('pagineStudiate').value = '0';
            document.getElementById('pagineOra').value = '8';
            document.getElementById('eserciziTotali').value = '0';
            document.getElementById('eserciziCompletati').value = '0';
            document.getElementById('dataEsame').value = '';
            document.getElementById('priorita').value = 'media';
            
            difficoltaSelezionata = 3;
            updateStarDisplay();

            setTimeout(() => {
                initializeWeeklySlots();
            }, 100);
        }

        function loadMaterie() {
            const container = document.getElementById('materieList');
            
            if (materie.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📚</div>
                        <p>Nessuna materia aggiunta ancora.</p>
                        <p>Inizia aggiungendo la tua prima materia!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = materie.map(materia => {
                const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                const percentualeEsercizi = materia.eserciziTotali > 0 ? 
                    Math.round(((materia.eserciziCompletati || 0) / materia.eserciziTotali) * 100) : 0;
                
                const isExamCompleted = materia.status === 'completato';
                const examData = esami.find(e => e.materiaId === materia.id);
                
                let oreTotaliSettimanali = 0;
                if (materia.slotSettimanali) {
                    Object.values(materia.slotSettimanali).forEach(slots => {
                        slots.forEach(slot => {
                            const durata = calculateTaskDuration(slot.inizio, slot.fine);
                            oreTotaliSettimanali += durata;
                        });
                    });
                    oreTotaliSettimanali = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                }
                
                return `
                <div class="subject-item ${isExamCompleted ? 'exam-completed' : ''}">
                    <div class="subject-header">
                        <div class="subject-name">${materia.nome}</div>
                        <div class="subject-actions">
                            <span class="status-badge ${isExamCompleted ? 'status-completato' : 'status-studio'}">
                                ${isExamCompleted ? '🎓 Completato' : '📚 In Studio'}
                            </span>
                            <span class="priority-badge priority-${materia.priorita}">${materia.priorita}</span>
                            ${!isExamCompleted ? `
                                <button class="btn btn-success btn-small" onclick="markAsExamCompleted(${materia.id})" title="Marca come esame sostenuto">🎓</button>
                                <button class="btn btn-warning btn-small" onclick="editMateria(${materia.id})" title="Modifica materia">✏️</button>
                            ` : `
                                <button class="btn btn-warning btn-small" onclick="editExam(${materia.id})" title="Modifica esame">✏️</button>
                            `}
                            <button class="btn btn-danger btn-small" onclick="deleteMateria(${materia.id})" title="Elimina">🗑️</button>
                        </div>
                    </div>
                    
                    ${!isExamCompleted ? `
                    <div class="subject-progress" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--primary-light);">Progresso Studio:</strong>
                            <span style="color: var(--secondary-color); font-weight: 600;">${percentualeCompletamento}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentualeCompletamento}%"></div>
                        </div>
                        <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine completate</small>
                    </div>
                    ` : examData ? `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div class="exam-grade">${examData.voto}${examData.lode ? 'L' : ''}</div>
                        <div>
                            <div style="color: var(--success-color); font-weight: 600;">Esame sostenuto</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                ${examData.dataEsame ? new Date(examData.dataEsame).toLocaleDateString('it-IT') : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${materia.eserciziTotali > 0 && !isExamCompleted ? `
                    <div class="subject-progress" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong style="color: var(--accent-color);">Progresso Esercizi:</strong>
                            <span style="color: var(--warning-color); font-weight: 600;">${percentualeEsercizi}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentualeEsercizi}%; background: linear-gradient(90deg, var(--warning-color), var(--accent-color));"></div>
                        </div>
                        <small style="color: var(--text-secondary);">${materia.eserciziCompletati || 0}/${materia.eserciziTotali} esercizi completati</small>
                    </div>
                    ` : ''}
                    
                    <div class="subject-info">
                        <div><strong>CFU:</strong> ${materia.cfu}</div>
                        <div><strong>Pagine:</strong> ${materia.pagine}</div>
                        <div><strong>Pagine/ora:</strong> ${materia.pagineOra || 8}</div>
                        <div><strong>Ore settimanali:</strong> ${oreTotaliSettimanali}h</div>
                        ${materia.eserciziTotali > 0 ? `<div><strong>Esercizi:</strong> ${materia.eserciziCompletati || 0}/${materia.eserciziTotali}</div>` : ''}
                        <div><strong>Esame:</strong> ${materia.dataEsame ? new Date(materia.dataEsame).toLocaleDateString('it-IT') : 'Non impostato'}</div>
                        <div><strong>Difficoltà:</strong> ${'★'.repeat(materia.difficolta || 3)}${'☆'.repeat(5-(materia.difficolta || 3))}</div>
                        ${examData && examData.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${examData.note}</div>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function editMateria(id) {
            try {
                const materia = materie.find(m => m.id === id);
                if (!materia) {
                    showSuccessMessage('❌ Materia non trovata');
                    return;
                }

                document.getElementById('nomeMateria').value = materia.nome || '';
                document.getElementById('cfu').value = materia.cfu || '';
                document.getElementById('pagine').value = materia.pagine || '';
                document.getElementById('pagineStudiate').value = materia.pagineStudiate || 0;
                document.getElementById('pagineOra').value = materia.pagineOra || 8;
                document.getElementById('eserciziTotali').value = materia.eserciziTotali || 0;
                document.getElementById('eserciziCompletati').value = materia.eserciziCompletati || 0;
                document.getElementById('dataEsame').value = materia.dataEsame || '';
                document.getElementById('priorita').value = materia.priorita || 'media';
                
                difficoltaSelezionata = materia.difficolta || 3;
                updateStarDisplay();

                setTimeout(() => {
                    initializeWeeklySlots();
                    
                    if (materia.slotSettimanali) {
                        setTimeout(() => {
                            Object.keys(materia.slotSettimanali).forEach(giorno => {
                                const slots = materia.slotSettimanali[giorno];
                                slots.forEach(slot => {
                                    addTimeSlot(giorno);
                                    const container = document.getElementById(`slots-${giorno}`);
                                    if (container) {
                                        const lastSlot = container.querySelector('.slot-item:last-of-type');
                                        if (lastSlot) {
                                            const inputs = lastSlot.querySelectorAll('input[type="time"]');
                                            if (inputs.length >= 2) {
                                                inputs[0].value = slot.inizio;
                                                inputs[1].value = slot.fine;
                                            }
                                        }
                                    }
                                });
                            });
                        }, 200);
                    }
                }, 100);

                materie = materie.filter(m => m.id !== id);
                saveMaterie();
                loadMaterie();

                showSection('materie', document.querySelector('.nav-tab[onclick*="materie"]'));
                showSuccessMessage('📝 Materia caricata per modifica');
                
            } catch (error) {
                console.error('❌ Errore nella modifica:', error);
                showSuccessMessage('❌ Errore nel caricamento della materia');
            }
        }

        function markAsExamCompleted(materiaId) {
            const materia = materie.find(m => m.id === materiaId);
            if (!materia) {
                showSuccessMessage('❌ Materia non trovata');
                return;
            }

            document.getElementById('examSubject').value = materia.nome;
            document.getElementById('examModal').style.display = 'flex';
            document.getElementById('examModal').dataset.materiaId = materiaId;
        }

        function editExam(materiaId) {
            const examData = esami.find(e => e.materiaId === materiaId);
            const materia = materie.find(m => m.id === materiaId);
            
            if (!examData || !materia) {
                showSuccessMessage('❌ Esame non trovato');
                return;
            }

            document.getElementById('editExamSubject').value = materia.nome;
            document.getElementById('editExamGrade').value = examData.voto;
            document.getElementById('editExamLode').checked = examData.lode;
            document.getElementById('editExamDate').value = examData.dataEsame || '';
            document.getElementById('editExamNotes').value = examData.note || '';
            
            currentEditingExamId = examData.id;
            document.getElementById('editExamModal').style.display = 'flex';
        }

        function updateExamGrade() {
            try {
                const voto = parseInt(document.getElementById('editExamGrade').value);
                const lode = document.getElementById('editExamLode').checked;
                const dataEsame = document.getElementById('editExamDate').value;
                const note = document.getElementById('editExamNotes').value.trim();

                if (!voto || voto < 18 || voto > 30) {
                    showSuccessMessage('❌ Inserisci un voto valido tra 18 e 30');
                    return;
                }

                if (voto < 30 && lode) {
                    showSuccessMessage('❌ La lode può essere assegnata solo con voto 30');
                    return;
                }

                const examIndex = esami.findIndex(e => e.id === currentEditingExamId);
                if (examIndex === -1) {
                    showSuccessMessage('❌ Esame non trovato');
                    return;
                }

                esami[examIndex].voto = voto;
                esami[examIndex].lode = lode;
                esami[examIndex].dataEsame = dataEsame;
                esami[examIndex].note = note;

                saveEsami();
                loadMaterie();
                updateExamsSection();
                closeEditExamModal();

                showSuccessMessage(`✅ Esame "${esami[examIndex].nomeMateria}" aggiornato!`);

            } catch (error) {
                console.error('Errore nell\'aggiornamento esame:', error);
                showSuccessMessage('❌ Errore nell\'aggiornamento dell\'esame');
            }
        }

        function deleteMateria(id) {
            try {
                const materia = materie.find(m => m.id === id);
                if (!materia) {
                    showSuccessMessage('❌ Materia non trovata');
                    return;
                }

                const conferma = confirm(`Sei sicuro di voler eliminare "${materia.nome}"?\n\nQuesta azione eliminerà anche l'eventuale esame associato e non può essere annullata.`);
                
                if (conferma) {
                    esami = esami.filter(e => e.materiaId !== id);
                    saveEsami();
                    
                    materie = materie.filter(m => m.id !== id);
                    saveMaterie();
                    loadMaterie();
                    generateTodaySchedule();
                    generatePianoStudio();
                    updateStatistiche();
                    updateExamsSection();
                    
                    showSuccessMessage('🗑️ Materia ed esame eliminati con successo');
                }
            } catch (error) {
                console.error('❌ Errore nell\'eliminazione:', error);
                showSuccessMessage('❌ Errore nell\'eliminazione della materia');
            }
        }

        function saveMaterie() {
            try {
                localStorage.setItem('materie', JSON.stringify(materie));
            } catch (error) {
                console.error('Errore nel salvataggio:', error);
            }
        }

        function saveEsami() {
            try {
                localStorage.setItem('esami', JSON.stringify(esami));
            } catch (error) {
                console.error('Errore nel salvataggio esami:', error);
            }
        }

        // === GESTIONE ESAMI ===
        function calculateExamStats() {
            if (esami.length === 0) {
                return {
                    totalExams: 0,
                    totalCFU: 0,
                    weightedAverage: 0,
                    simpleAverage: 0,
                    projectedGrade: 0,
                    gradeDistribution: {}
                };
            }

            const totalExams = esami.length;
            const totalCFU = esami.reduce((sum, e) => sum + e.cfu, 0);
            
            const weightedSum = esami.reduce((sum, e) => {
                const grade = e.lode ? 31 : e.voto;
                return sum + (grade * e.cfu);
            }, 0);
            const weightedAverage = totalCFU > 0 ? weightedSum / totalCFU : 0;

            const simpleSum = esami.reduce((sum, e) => {
                const grade = e.lode ? 31 : e.voto;
                return sum + grade;
            }, 0);
            const simpleAverage = simpleSum / totalExams;

            const projectedGrade = Math.round((weightedAverage * 110) / 30);

            const gradeDistribution = {};
            esami.forEach(e => {
                const gradeKey = e.lode ? '30L' : e.voto.toString();
                gradeDistribution[gradeKey] = (gradeDistribution[gradeKey] || 0) + 1;
            });

            return {
                totalExams,
                totalCFU,
                weightedAverage,
                simpleAverage,
                projectedGrade,
                gradeDistribution
            };
        }

        function updateExamsSection() {
            const stats = calculateExamStats();
            
            document.getElementById('totalExams').textContent = stats.totalExams;
            document.getElementById('totalCFU').textContent = stats.totalCFU;
            document.getElementById('weightedAverage').textContent = stats.weightedAverage.toFixed(2);
            document.getElementById('projectedGrade').textContent = stats.projectedGrade;

            updateGradeDistribution(stats.gradeDistribution);
            updateExamsList();
        }

        function updateGradeDistribution(distribution) {
            const container = document.getElementById('gradeDistribution');
            
            if (Object.keys(distribution).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>Nessun esame sostenuto ancora.</p>
                        <p>Completa alcuni esami per vedere la distribuzione!</p>
                    </div>
                `;
                return;
            }

            const maxCount = Math.max(...Object.values(distribution));
            const gradeOrder = ['18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '30L'];
            
            let distributionHTML = '';
            gradeOrder.forEach(grade => {
                const count = distribution[grade] || 0;
                if (count > 0) {
                    const percentage = (count / maxCount) * 100;
                    distributionHTML += `
                        <div class="grade-bar">
                            <div class="grade-label">${grade}</div>
                            <div style="flex: 1; background: var(--bg-secondary); border-radius: 10px; overflow: hidden;">
                                <div class="grade-bar-fill" style="width: ${percentage}%;"></div>
                            </div>
                            <div class="grade-count">${count}</div>
                        </div>
                    `;
                }
            });

            container.innerHTML = distributionHTML;
        }

        function updateExamsList() {
            const container = document.getElementById('examsList');
            
            if (esami.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎓</div>
                        <p>Nessun esame sostenuto ancora.</p>
                        <p>Marca una materia come "Esame Sostenuto" per iniziare!</p>
                    </div>
                `;
                return;
            }

            const sortedExams = [...esami].sort((a, b) => {
                const dateA = new Date(a.dataRegistrazione);
                const dateB = new Date(b.dataRegistrazione);
                return dateB - dateA;
            });

            container.innerHTML = sortedExams.map(exam => `
                <div class="exam-item">
                    <div class="exam-header">
                        <div class="exam-name">${exam.nomeMateria}</div>
                        <div class="exam-grade">${exam.voto}${exam.lode ? 'L' : ''}</div>
                    </div>
                    
                    <div class="exam-info">
                        <div><strong>CFU:</strong> ${exam.cfu}</div>
                        <div><strong>Data Esame:</strong> ${exam.dataEsame ? new Date(exam.dataEsame).toLocaleDateString('it-IT') : 'Non specificata'}</div>
                        <div><strong>Registrato:</strong> ${new Date(exam.dataRegistrazione).toLocaleDateString('it-IT')}</div>
                        <div><strong>Fonte:</strong> ${exam.materiaId ? 'Materia Studio' : 'Curriculum'}</div>
                        ${exam.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${exam.note}</div>` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                        <button class="btn btn-warning btn-small" onclick="editExam(${exam.materiaId || exam.curriculumSubjectId})" title="Modifica esame">✏️ Modifica</button>
                        <button class="btn btn-danger btn-small" onclick="deleteExam(${exam.id})" title="Elimina esame">🗑️ Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteExam(examId) {
            try {
                const examIndex = esami.findIndex(e => e.id === examId);
                if (examIndex === -1) {
                    showSuccessMessage('❌ Esame non trovato');
                    return;
                }

                const exam = esami[examIndex];
                const conferma = confirm(`Sei sicuro di voler eliminare l'esame di "${exam.nomeMateria}"?\n\nLa materia tornerà in stato "In Studio".`);
                
                if (conferma) {
                    if (exam.materiaId) {
                        const materia = materie.find(m => m.id === exam.materiaId);
                        if (materia) {
                            materia.status = 'studio';
                        }
                    }

                    if (exam.curriculumSubjectId) {
                        const currSubject = curriculum.find(s => s.id === exam.curriculumSubjectId);
                        if (currSubject) {
                            currSubject.completed = false;
                            currSubject.grade = null;
                            currSubject.lode = false;
                            currSubject.examDate = null;
                            currSubject.examNotes = '';
                        }
                    }

                    esami.splice(examIndex, 1);
                    
                    saveMaterie();
                    saveCurriculumData();
                    saveEsami();
                    loadMaterie();
                    loadCurriculumData();
                    updateExamsSection();
                    
                    showSuccessMessage(`🗑️ Esame "${exam.nomeMateria}" eliminato`);
                }
            } catch (error) {
                console.error('Errore nell\'eliminazione esame:', error);
                showSuccessMessage('❌ Errore nell\'eliminazione dell\'esame');
            }
        }

        function calculateTaskDuration(inizio, fine) {
            const start = new Date(`1970-01-01T${inizio}:00`);
            const end = new Date(`1970-01-01T${fine}:00`);
            return Math.round((end - start) / (1000 * 60));
        }

        // === SMART SCHEDULER CON OPZIONI PERSONALIZZABILI ===
        function generateTodaySchedule() {
            if (materie.length === 0) {
                updateTodayDisplay(null, []);
                return;
            }

            const oggi = new Date();
            const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
            
            const scheduleOggi = generateSmartSchedule(giornoSettimana);
            
            updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
            updateMicroTasks(scheduleOggi.nextTask);
        }

        function generateSmartSchedule(giornoSettimana) {
            const materieFiltrate = materie.filter(materia => {
                if (materia.status === 'completato') return false;
                const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                return slots && slots.length > 0;
            });

            if (materieFiltrate.length === 0) {
                return { nextTask: null, timeline: [] };
            }

            const timeline = [];
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            const materiePrioritarie = materieFiltrate.sort((a, b) => {
                const priorityOrder = { 'alta': 3, 'media': 2, 'bassa': 1 };
                return (priorityOrder[b.priorita] || 0) - (priorityOrder[a.priorita] || 0);
            });

            let nextTask = null;

            materiePrioritarie.forEach(materia => {
                const slots = materia.slotSettimanali[giornoSettimana] || [];
                
                slots.forEach(slot => {
                    if (slot.disponibile) {
                        const durata = calculateTaskDuration(slot.inizio, slot.fine);
                        
                        const task = {
                            materia: materia.nome,
                            durata: durata,
                            orarioInizio: slot.inizio,
                            orarioFine: slot.fine,
                            difficolta: materia.difficolta,
                            pagineRimanenti: Math.max(0, materia.pagine - (materia.pagineStudiate || 0)),
                            percentualeCompletamento: ((materia.pagineStudiate || 0) / materia.pagine) * 100,
                            opzioni: generateTaskOptions(materia)
                        };

                        timeline.push(task);

                        if (!nextTask && slot.inizio > currentTime) {
                            nextTask = task;
                        }
                    }
                });
            });

            if (!nextTask && timeline.length > 0) {
                nextTask = timeline[0];
            }

            return { nextTask, timeline: timeline.sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio)) };
        }

        function generateTaskOptions(materia) {
            const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
            const options = [];

            if (percentualeCompletamento < 30) {
                options.push({
                    id: 'concetti-base',
                    titulo: '📚 Concetti Base',
                    descrizione: 'Inizia con i fondamenti e le definizioni principali',
                    motivazione: 'Costruire basi solide è essenziale per il successo'
                });
                options.push({
                    id: 'primi-capitoli',
                    titulo: '📖 Primi Capitoli',
                    descrizione: 'Studio sequenziale dall\'inizio del programma',
                    motivazione: 'Approccio sistematico per una comprensione completa'
                });
            }

            if (percentualeCompletamento >= 20) {
                options.push({
                    id: 'approfondimento',
                    titulo: '🔍 Approfondimento',
                    descrizione: 'Continua con gli argomenti più complessi',
                    motivazione: 'Sviluppa una comprensione più profonda della materia'
                });
                options.push({
                    id: 'esercizi',
                    titulo: '💪 Esercizi Pratici',
                    descrizione: 'Risolvi problemi ed esercizi applicativi',
                    motivazione: 'La pratica consolida la teoria appresa'
                });
            }

            if (percentualeCompletamento >= 50) {
                options.push({
                    id: 'ripasso',
                    titulo: '🔄 Ripasso Generale',
                    descrizione: 'Rivedi e consolida gli argomenti già studiati',
                    motivazione: 'Il ripasso rafforza la memoria a lungo termine'
                });
            }

            options.push({
                id: 'personalizzato',
                titulo: '⚙️ Studio Personalizzato',
                descrizione: 'Scegli tu cosa studiare in questa sessione',
                motivazione: 'Tu conosci meglio le tue necessità del momento'
            });

            return options;
        }

        function updateTodayDisplay(nextTask, timeline) {
            const currentTaskMateria = document.getElementById('currentTaskMateria');
            const currentTaskTime = document.getElementById('currentTaskTime');
            const currentTaskDesc = document.getElementById('currentTaskDesc');
            const currentTaskMotivation = document.getElementById('currentTaskMotivation');
            const taskOptions = document.getElementById('taskOptions');
            const taskOptionsList = document.getElementById('taskOptionsList');
            const startTaskBtn = document.getElementById('startTaskBtn');
            const timelineContainer = document.getElementById('timelineOggi');

            if (!nextTask) {
                currentTaskMateria.textContent = 'Nessun task programmato';
                currentTaskTime.textContent = '⏱️ -- min';
                currentTaskDesc.textContent = 'Aggiungi slot temporali alle tue materie per vedere il piano giornaliero!';
                currentTaskMotivation.textContent = '💡 Definisci quando puoi studiare per ottimizzare la tua giornata';
                taskOptions.style.display = 'none';
                startTaskBtn.disabled = true;
                
                timelineContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                    </div>
                `;
                return;
            }

            currentTaskMateria.textContent = nextTask.materia;
            currentTaskTime.textContent = `⏱️ ${nextTask.durata} min`;
            
            if (nextTask.opzioni && nextTask.opzioni.length > 0) {
                taskOptions.style.display = 'block';
                taskOptionsList.innerHTML = nextTask.opzioni.map(opzione => `
                    <button class="task-option-btn" onclick="selectTaskOption('${opzione.id}', '${nextTask.materia}', this)">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${opzione.titulo}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${opzione.descrizione}</div>
                        <div style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.5rem;">💡 ${opzione.motivazione}</div>
                    </button>
                `).join('');
                
                if (!selectedTaskOption) {
                    selectTaskOption(nextTask.opzioni[0].id, nextTask.materia);
                }
            } else {
                taskOptions.style.display = 'none';
            }

            startTaskBtn.disabled = false;

            if (timeline.length === 0) {
                timelineContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>Nessun task programmato per oggi</p>
                    </div>
                `;
            } else {
                timelineContainer.innerHTML = timeline.map(task => `
                    <div class="timeline-item">
                        <div class="timeline-time">${task.orarioInizio}</div>
                        <div class="timeline-content">
                            <strong>${task.materia}</strong><br>
                            <span style="opacity: 0.8;">Slot di studio programmato</span><br>
                            <small style="color: var(--secondary-color);">${task.durata} min • ${Math.round(task.percentualeCompletamento)}% completato</small>
                        </div>
                    </div>
                `).join('');
            }
        }

        function selectTaskOption(optionId, materia, clickedElement) {
            selectedTaskOption = optionId;
            currentSessionData = { materia: materia, option: optionId };
            
            document.querySelectorAll('.task-option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (clickedElement) {
                clickedElement.classList.add('selected');
            } else {
                const buttons = document.querySelectorAll('.task-option-btn');
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(optionId)) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            const currentTask = getCurrentNextTask();
            if (currentTask && currentTask.opzioni) {
                const selectedOption = currentTask.opzioni.find(opt => opt.id === optionId);
                if (selectedOption) {
                    document.getElementById('currentTaskDesc').textContent = selectedOption.descrizione;
                    document.getElementById('currentTaskMotivation').textContent = `💡 ${selectedOption.motivazione}`;
                }
            }
        }

        function updateMicroTasks(nextTask) {
            const microTasksContainer = document.getElementById('microTasks');
            const microTasksList = document.getElementById('microTasksList');

            if (!nextTask) {
                microTasksContainer.style.display = 'none';
                return;
            }

            const tasks = universalMicroTasks.slice(0, 4);
            microTasksContainer.style.display = 'block';
            
            microTasksList.innerHTML = tasks.map(task => `
                <div class="micro-task-item" onclick="startMicroTask('${task.text}', ${task.durata}, this)">
                    <div>${task.text}</div>
                    <div class="micro-task-duration">${task.durata} min</div>
                </div>
            `).join('');
        }

        function startMicroTask(taskText, durata, clickedElement) {
            currentSessionData = { materia: 'Micro-task', option: taskText };
            setPreset(durata, Math.max(2, Math.floor(durata / 5)), null);
            showSuccessMessage(`🚀 Micro-task avviato: ${taskText}`);
            
            if (clickedElement) {
                document.querySelectorAll('.micro-task-item').forEach(item => {
                    item.style.transform = 'translateX(0)';
                    item.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                });
                clickedElement.style.transform = 'translateX(8px)';
                clickedElement.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
            }
            
            startTimer();
        }

        function iniziaTask() {
            const nextTask = getCurrentNextTask();
            if (nextTask) {
                const taskDuration = Math.min(50, nextTask.durata);
                const breakDuration = Math.max(5, Math.floor(taskDuration / 10));
                
                setPreset(taskDuration, breakDuration, null);
                
                const selectedOptionText = selectedTaskOption ? 
                    ` (${document.querySelector('.task-option-btn.selected')?.textContent.split('\n')[0] || 'Studio'})` : '';
                
                showSuccessMessage(`🚀 Task avviato: ${nextTask.materia}${selectedOptionText} per ${taskDuration} minuti`);
                startTimer();
            }
        }

        function getCurrentNextTask() {
            const oggi = new Date();
            const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
            const schedule = generateSmartSchedule(giornoSettimana);
            return schedule.nextTask;
        }

        // === STATISTICHE AVANZATE ===
        function updateStatistiche() {
            const container = document.getElementById('statisticheContent');
            
            const materieInStudio = materie.filter(m => m.status !== 'completato');
            
            if (materieInStudio.length === 0 && esami.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>Nessuna statistica disponibile.</p>
                        <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                    </div>
                `;
                return;
            }
            
            const totaleCFU = materie.reduce((sum, m) => sum + m.cfu, 0);
            const cfuCompletati = esami.reduce((sum, e) => sum + e.cfu, 0);
            const totalePagine = materieInStudio.reduce((sum, m) => sum + m.pagine, 0);
            const pagineStudiate = materieInStudio.reduce((sum, m) => sum + (m.pagineStudiate || 0), 0);
            const progressoGenerale = totalePagine > 0 ? Math.round((pagineStudiate / totalePagine) * 100) : 0;
            
            const examStats = calculateExamStats();

            let statisticheHTML = `
                <div class="form-row">
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">📚 CFU Totali</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${totaleCFU}</div>
                        <small style="opacity: 0.8;">${cfuCompletati} completati</small>
                    </div>
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--warning-color), #d97706); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">📖 Progresso</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${progressoGenerale}%</div>
                        <small style="opacity: 0.8;">materie in studio</small>
                    </div>
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, var(--success-color), #059669); color: white;">
                        <h4 style="color: white; margin-bottom: 1rem;">🏆 Sessioni</h4>
                        <div style="font-size: 3rem; font-weight: 800;">${timerState.sessionsToday}</div>
                        <small style="opacity: 0.8;">completate oggi</small>
                    </div>
                </div>

                <div class="card">
                    <h4 style="color: var(--primary-light);">📊 Analisi Dettagliata</h4>
                    <div class="form-row">
                        <div><strong>Materie studio:</strong> ${materie.length}</div>
                        <div><strong>Esami sostenuti:</strong> ${esami.length}</div>
                        <div><strong>CFU acquisiti:</strong> ${cfuCompletati}</div>
                        <div><strong>Pagine studiate:</strong> ${pagineStudiate}</div>
                        <div><strong>Streak attuale:</strong> ${studyData.streak} giorni</div>
                        <div><strong>Sessioni totali:</strong> ${studyData.totalSessions}</div>
                        <div><strong>Media ponderata:</strong> ${examStats.weightedAverage.toFixed(2)}</div>
                    </div>
                </div>
            `;

            container.innerHTML = statisticheHTML;
        }

        // === CALENDARIO ===
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthYear = document.getElementById('currentMonthYear');
            
            if (!calendarGrid || !currentMonthYear) return;
            
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                           'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            currentMonthYear.textContent = `${months[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
            
            let calendarHTML = '';
            const today = new Date();
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const isToday = currentDay.toDateString() === today.toDateString();
                const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
                const dayKey = currentDay.toISOString().split('T')[0];
                
                const sessions = calendarSessions[dayKey];
                const hasCompletedSessions = sessions && sessions.completed > 0;
                const hasScheduledSessions = sessions && sessions.manual > 0;
                
                let sessionDots = '';
                if (hasCompletedSessions) {
                    for (let j = 0; j < Math.min(sessions.completed, 5); j++) {
                        sessionDots += '<div class="calendar-session-dot session-completed"></div>';
                    }
                }
                if (hasScheduledSessions) {
                    for (let j = 0; j < Math.min(sessions.manual, 3); j++) {
                        sessionDots += '<div class="calendar-session-dot session-manual"></div>';
                    }
                }
                
                const sessionCount = sessions ? (sessions.completed || 0) + (sessions.manual || 0) : 0;
                
                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${!isCurrentMonth ? 'other-month' : ''} 
                         ${hasCompletedSessions ? 'has-sessions' : ''} ${hasScheduledSessions ? 'has-scheduled' : ''}"
                         onclick="showDayDetail('${dayKey}')">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        <div class="calendar-sessions">
                            ${sessionDots}
                        </div>
                        ${sessionCount > 0 ? `<div class="calendar-session-count">${sessionCount}</div>` : ''}
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = calendarHTML;
            updateMonthStats();
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function updateMonthStats() {
            const monthSessions = document.getElementById('monthSessions');
            const monthHours = document.getElementById('monthHours');
            const monthDays = document.getElementById('monthDays');
            const monthAverage = document.getElementById('monthAverage');
            
            if (!monthSessions || !monthHours || !monthDays || !monthAverage) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            let totalSessions = 0;
            let totalHours = 0;
            let activeDays = 0;
            
            Object.keys(calendarSessions).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date.getFullYear() === year && date.getMonth() === month) {
                    const sessions = calendarSessions[dateKey];
                    const daySessions = (sessions.completed || 0) + (sessions.manual || 0);
                    if (daySessions > 0) {
                        totalSessions += daySessions;
                        activeDays++;
                        // Stima ore (25 min per sessione media)
                        totalHours += Math.round((daySessions * 25) / 60 * 10) / 10;
                    }
                }
            });
            
            const avgSessions = activeDays > 0 ? Math.round(totalSessions / activeDays) : 0;
            
            monthSessions.textContent = totalSessions;
            monthHours.textContent = `${totalHours}h`;
            monthDays.textContent = activeDays;
            monthAverage.textContent = avgSessions;
        }

        function showDayDetail(dateKey) {
            // Implementazione placeholder per ora
            console.log('Show day detail for:', dateKey);
        }

        function addManualSession() {
            const modal = document.getElementById('addSessionModal');
            if (modal) {
                document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
                
                // Popola dropdown materie
                const materieSelect = document.getElementById('sessionMateria');
                if (materieSelect) {
                    materieSelect.innerHTML = '<option value="">Sessione generica</option>' +
                        materie.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                }
                
                modal.style.display = 'flex';
            }
        }

        function saveManualSession() {
            // Implementazione placeholder per ora
            const modal = document.getElementById('addSessionModal');
            if (modal) modal.style.display = 'none';
            showSuccessMessage('✅ Sessione aggiunta al calendario');
        }

        // === MODAL FUNCTIONS ===
        function closeExamModal() {
            const modal = document.getElementById('examModal');
            if (modal) modal.style.display = 'none';
        }

        function closeEditExamModal() {
            const modal = document.getElementById('editExamModal');
            if (modal) modal.style.display = 'none';
        }

        function closeAddSessionModal() {
            const modal = document.getElementById('addSessionModal');
            if (modal) modal.style.display = 'none';
        }

        function closeDayDetailModal() {
            const modal = document.getElementById('dayDetailModal');
            if (modal) modal.style.display = 'none';
        }

        function showRecoveryOptions() {
            const modal = document.getElementById('recoveryModal');
            if (modal) modal.style.display = 'flex';
        }

        function closeRecoveryModal() {
            const modal = document.getElementById('recoveryModal');
            if (modal) modal.style.display = 'none';
        }

        function applyRecoveryStrategy() {
            // TODO: Implementare strategia di recupero
            closeRecoveryModal();
            showSuccessMessage('✅ Strategia di recupero applicata');
        }

        // === KEYBOARD SHORTCUTS ===
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') {
                return;
            }

            if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                e.preventDefault();
                if (timerState.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                resetTimer();
            }
            
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                toggleFocusMode();
            }
            
            if (e.key === 'Escape') {
                const focusMode = document.getElementById('focusMode');
                const customModal = document.getElementById('customTimerModal');
                const recoveryModal = document.getElementById('recoveryModal');
                const ratingModal = document.getElementById('ratingModal');
                const addSessionModal = document.getElementById('addSessionModal');
                const dayDetailModal = document.getElementById('dayDetailModal');
                const examModal = document.getElementById('examModal');
                const editExamModal = document.getElementById('editExamModal');
                const addSubjectModal = document.getElementById('addSubjectModal');
                const editCurriculumModal = document.getElementById('editCurriculumModal');
                
                if (focusMode && focusMode.style.display === 'flex') {
                    toggleFocusMode();
                } else if (customModal && customModal.style.display === 'flex') {
                    closeCustomTimerModal();
                } else if (recoveryModal && recoveryModal.style.display === 'flex') {
                    closeRecoveryModal();
                } else if (addSessionModal && addSessionModal.style.display === 'flex') {
                    closeAddSessionModal();
                } else if (dayDetailModal && dayDetailModal.style.display === 'flex') {
                    closeDayDetailModal();
                } else if (examModal && examModal.style.display === 'flex') {
                    closeExamModal();
                } else if (editExamModal && editExamModal.style.display === 'flex') {
                    closeEditExamModal();
                } else if (addSubjectModal && addSubjectModal.style.display === 'flex') {
                    closeAddSubjectModal();
                } else if (editCurriculumModal && editCurriculumModal.style.display === 'flex') {
                    closeEditCurriculumModal();
                }
            }

            // Shortcuts per rating rapido (1-4)
            if (document.getElementById('ratingModal').style.display === 'flex') {
                if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    submitRating(parseInt(e.key));
                }
            }

            if (e.key >= '1' && e.key <= '8' && document.getElementById('ratingModal').style.display !== 'flex') {
                e.preventDefault();
                const sections = ['oggi', 'materie', 'curriculum', 'esami', 'piano', 'pomodoro', 'calendario', 'statistiche'];
                const sectionIndex = parseInt(e.key) - 1;
                if (sections[sectionIndex]) {
                    const tabs = document.querySelectorAll('.nav-tab');
                    if (tabs[sectionIndex]) {
                        showSection(sections[sectionIndex], tabs[sectionIndex]);
                    }
                }
            }
        });

        // Event listeners per modal
        document.addEventListener('click', (e) => {
            const customModal = document.getElementById('customTimerModal');
            const recoveryModal = document.getElementById('recoveryModal');
            const addSessionModal = document.getElementById('addSessionModal');
            const dayDetailModal = document.getElementById('dayDetailModal');
            const examModal = document.getElementById('examModal');
            const editExamModal = document.getElementById('editExamModal');
            const addSubjectModal = document.getElementById('addSubjectModal');
            const editCurriculumModal = document.getElementById('editCurriculumModal');
            
            if (e.target === customModal) {
                closeCustomTimerModal();
            }
            if (e.target === recoveryModal) {
                closeRecoveryModal();
            }
            if (e.target === addSessionModal) {
                closeAddSessionModal();
            }
            if (e.target === dayDetailModal) {
                closeDayDetailModal();
            }
            if (e.target === examModal) {
                closeExamModal();
            }
            if (e.target === editExamModal) {
                closeEditExamModal();
            }
            if (e.target === addSubjectModal) {
                closeAddSubjectModal();
            }
            if (e.target === editCurriculumModal) {
                closeEditCurriculumModal();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Controllo se le date delle sessioni sono di oggi, altrimenti reset
                const today = new Date().toDateString();
                const lastSessionDate = localStorage.getItem('lastSessionDate');
                
                if (lastSessionDate !== today) {
                    timerState.sessionsToday = 0;
                    localStorage.setItem('sessionsToday', '0');
                    localStorage.setItem('lastSessionDate', today);
                }
                
                // Inizializza displays
                updateSessionDisplay();
                updateStreakDisplay();
                updateTodaySessionsList();
                initializeHeatmap();
                updateProductivitySection();
                loadCurriculumData();
                loadMaterie();
                renderCalendar();
                generateTodaySchedule();
                generatePianoStudio();
                updateExamsSection();
                updateStatistiche();
                
                console.log('🚀 Piano Studio Smart AI Pro inizializzato!');
                console.log('🆕 NUOVE FUNZIONALITÀ:');
                console.log('  • 🎓 Curriculum completo con gestione materie per anno/semestre');
                console.log('  • ✅ Checkbox per marcare esami completati');
                console.log('  • ✏️ Modifica e eliminazione materie curriculum');
                console.log('  • 📊 Integrazione automatica con sezione esami');
                console.log('  • 📥📤 Import/Export dati curriculum');
                console.log('  • 🍅 Timer Pomodoro con rating intelligente');
                console.log('  • 🔥 Heatmap produttività 24 ore');
                console.log('  • 🤖 Piano di studio intelligente AI-powered');
                console.log('  • 📈 Analisi e suggerimenti personalizzati');
                console.log('⌨️ Shortcuts: 1-8 (sezioni), Ctrl+Space (timer), F (focus), Esc (chiudi), 1-4 (rating veloce)');
                
            } catch (error) {
                console.error('Errore nell\'inizializzazione:', error);
                showSuccessMessage('⚠️ Errore nell\'inizializzazione. Ricarica la pagina.');
            }
        });

    </script>
</body>
</html>
