<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Studio Smart - AI Enhanced Pro</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary: #06d6a0;
            --secondary-dark: #05c296;
            --accent: #f59e0b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3a;
            --bg-tertiary: #2d2f4f;
            --bg-card: #1e1f3f;
            --bg-hover: #252647;
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --border: #374151;
            --border-light: #4b5563;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            --glow-secondary: 0 0 20px rgba(6, 214, 160, 0.3);
            --glow-accent: 0 0 20px rgba(245, 158, 11, 0.3);

            --heatmap-empty: #374151;
            --heatmap-low: #ef4444;
            --heatmap-medium: #f59e0b;
            --heatmap-high: #10b981;
            --heatmap-very-high: #22c55e;

            --transition: 0.3s ease;
            --border-radius: 12px;
            --border-radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            background-size: 200% 200%;
            animation: gradientShift 6s ease infinite;
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 8s infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 0.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 8px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
            z-index: 100;
            gap: 4px;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary), var(--shadow);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger);
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all var(--transition);
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all var(--transition);
            transform: translate(-50%, -50%);
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-primary), var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: var(--glow-secondary), var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-small {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        /* Sezione OGGI */
        .oggi-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--primary);
        }

        .oggi-card::before {
            background: var(--primary);
        }

        .prossimo-task {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .task-corrente {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .materia-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tempo-stimato {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .task-descrizione {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .task-motivazione {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
        }

        .task-options {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .task-option-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition);
            text-align: left;
        }

        .task-option-btn:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
            transform: translateX(8px);
        }

        .task-option-btn.selected {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: var(--glow-primary);
        }

        .recovery-dashboard {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .missed-time {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .highlight {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .micro-tasks {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .micro-task-item {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .micro-task-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(8px);
        }

        .micro-task-duration {
            font-size: 0.8rem;
            color: var(--secondary);
            font-weight: 600;
        }

        .timeline-oggi {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .timeline-time {
            font-weight: 700;
            min-width: 80px;
            color: var(--accent);
            font-size: 1rem;
        }

        .timeline-content {
            flex: 1;
            margin-left: 1rem;
            color: var(--text-primary);
        }

        /* Streak */
        .streak-card {
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }

        @keyframes pulseGlow {
            from { box-shadow: var(--shadow-lg); }
            to { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4), var(--shadow-lg); }
        }

        .streak-number {
            font-size: clamp(3rem, 8vw, 4rem);
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Subject Items */
        .subject-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all var(--transition);
            overflow: hidden;
        }

        .subject-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
        }

        .subject-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-light);
        }

        .subject-item.exam-completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .subject-item.exam-completed::before {
            background: var(--success);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .subject-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .subject-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .subject-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-alta { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .priority-media { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .priority-bassa { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-studio {
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary-light);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .status-completato {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 6px;
            margin-top: 0.5rem;
        }

        .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.active {
            color: #fbbf24;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5));
        }

        /* Weekly Slots */
        .weekly-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .day-slots {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .day-slots h4 {
            color: var(--primary-light);
            margin-bottom: 1rem;
            text-align: center;
        }

        .slot-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .slot-item input[type="time"] {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            width: auto;
            min-width: 100px;
        }

        .add-slot {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition);
            font-weight: 600;
        }

        .add-slot:hover {
            border-color: var(--primary);
            color: var(--primary-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .remove-slot {
            background: var(--danger);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all var(--transition);
        }

        .remove-slot:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Timer */
        .timer-container {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .timer-display {
            font-size: clamp(4rem, 10vw, 5rem);
            font-weight: 800;
            color: var(--primary-light);
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            transition: all var(--transition);
        }

        .timer-display.break-mode {
            color: var(--secondary);
            text-shadow: 0 0 30px rgba(6, 214, 160, 0.5);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .preset-btn {
            padding: 1rem;
            border: 2px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition);
            font-weight: 600;
        }

        .preset-btn:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .preset-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--glow-primary);
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CURRICULUM STYLES */
        .curriculum-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .year-selector {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 4px;
            border: 1px solid var(--border);
        }

        .year-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all var(--transition);
            font-weight: 600;
        }

        .year-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .year-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .year-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .year-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .year-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .year-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .year-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            min-width: 100px;
        }

        .year-stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .year-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .semesters-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .semester-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        .semester-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .semester-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .semester-progress {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* HEATMAP 24 ORE */
        .hourly-heatmap {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 1.5rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            min-height: 50px;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .heatmap-cell.empty {
            background: var(--heatmap-empty);
            color: var(--text-muted);
        }

        .heatmap-cell.low {
            background: var(--heatmap-low);
            color: white;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .heatmap-cell.medium {
            background: var(--heatmap-medium);
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .heatmap-cell.high {
            background: var(--heatmap-high);
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .heatmap-cell.very-high {
            background: var(--heatmap-very-high);
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
            animation: pulseHeat 2s ease-in-out infinite alternate;
        }

        @keyframes pulseHeat {
            from { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
            to { box-shadow: 0 0 25px rgba(34, 197, 94, 0.6); }
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* CALENDARIO */
        .calendar-container {
            width: 100%;
            max-width: 100%;
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .calendar-day-header {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-light);
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border);
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-card);
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background: var(--bg-hover);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }

        .calendar-day.other-month {
            background: var(--bg-secondary);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            font-weight: 700;
        }

        .calendar-day.has-sessions {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--primary);
        }

        .calendar-day.has-scheduled {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--secondary);
        }

        .calendar-day-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .calendar-sessions {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .calendar-session-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }

        .session-completed {
            background: var(--primary);
        }

        .session-scheduled {
            background: var(--secondary);
        }

        .session-manual {
            background: var(--warning);
        }

        .calendar-session-count {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
        }

        /* Session List */
        .session-list {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .session-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all var(--transition);
        }

        .session-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .session-time {
            font-weight: 700;
            color: var(--primary-light);
            font-size: 1.1rem;
        }

        .session-materia {
            color: var(--secondary);
            font-weight: 600;
        }

        .session-note {
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 0.5rem;
        }

        .session-rating {
            display: flex;
            gap: 2px;
        }

        .session-rating .star {
            font-size: 1rem;
            color: #fbbf24;
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
            animation: modalEnter var(--transition);
        }

        @keyframes modalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .modal h3 {
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Rating Modal */
        .rating-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 3rem 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
            text-align: center;
            animation: ratingModalEnter 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes ratingModalEnter {
            from { 
                opacity: 0; 
                transform: scale(0.5) translateY(100px) rotate(-10deg);
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        .rating-modal h3 {
            color: var(--primary-light);
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .rating-modal p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 2rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .rating-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .rating-btn.sleepy:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
            box-shadow: 0 0 20px rgba(107, 114, 128, 0.3);
        }

        .rating-btn.neutral:hover {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        .rating-btn.good:hover {
            border-color: var(--secondary);
            background: rgba(6, 214, 160, 0.1);
            box-shadow: 0 0 20px rgba(6, 214, 160, 0.3);
        }

        .rating-btn.excellent:hover {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .rating-emoji {
            font-size: 3.5rem;
            transition: all var(--transition);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .rating-btn:hover .rating-emoji {
            transform: scale(1.2) rotate(5deg);
        }

        .rating-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .rating-btn.sleepy .rating-label { color: #9ca3af; }
        .rating-btn.neutral .rating-label { color: var(--warning); }
        .rating-btn.good .rating-label { color: var(--secondary); }
        .rating-btn.excellent .rating-label { color: var(--success); }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .focus-content {
            text-align: center;
            animation: focusEnter 0.5s ease;
        }

        .focus-timer {
            font-size: clamp(6rem, 15vw, 8rem);
            font-weight: 800;
            margin: 3rem 0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            text-shadow: 0 0 50px rgba(139, 92, 246, 0.8);
        }

        .close-focus {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all var(--transition);
            backdrop-filter: blur(10px);
        }

        .close-focus:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        @keyframes focusEnter {
            from { 
                opacity: 0; 
                transform: scale(0.8) translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all var(--transition);
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Goal Settings */
        .daily-goal-settings {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .goal-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-input {
            width: 100px;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }

        .goal-input:focus {
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
        }

        /* Grade Input */
        .grade-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .grade-input {
            width: 80px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .grade-input:focus {
            color: var(--success);
        }

        /* Curriculum Subject */
        .curriculum-subject {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all var(--transition);
        }

        .curriculum-subject:hover {
            transform: translateX(8px);
            border-color: var(--border-light);
        }

        .curriculum-subject.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .curriculum-subject.completed::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--success);
        }

        .subject-header-curr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .subject-name-curr {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .subject-actions-curr {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .subject-info-curr {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .exam-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .subject-grade {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
        }

        /* Utility classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }
        .p-4 { padding: 2rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .gap-4 { gap: 2rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-90 { opacity: 0.9; }
        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }
        .select-none { user-select: none; }
        .transition { transition: all var(--transition); }

        /* Piano dettagliato */
        .plan-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .plan-subject-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: all var(--transition);
        }

        .plan-subject-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .plan-subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .plan-subject-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-light);
        }

        .plan-subject-priority {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .plan-subject-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .plan-stat {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .plan-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .plan-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .plan-schedule {
            margin-top: 1rem;
        }

        .plan-schedule-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .plan-schedule-slots {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .plan-schedule-slot {
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            background: var(--bg-card);
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 2rem 1rem; }
            .timer-display { font-size: 4rem; }
            .focus-timer { font-size: 6rem; }
            .form-row { grid-template-columns: 1fr; }
            .subject-info { grid-template-columns: 1fr; }
            .nav-tabs { padding: 6px; gap: 2px; }
            .nav-tab { padding: 12px 16px; min-width: 100px; font-size: 0.9rem; }
            .card { padding: 1.5rem; }
            .timer-controls { flex-direction: column; align-items: center; }
            .modal-buttons { flex-direction: column; }
            .streak-number { font-size: 3rem; }
            .weekly-slots { grid-template-columns: 1fr; }
            .task-header { flex-direction: column; align-items: flex-start; }
            .heatmap-grid { grid-template-columns: repeat(6, 1fr); }
            .rating-buttons { grid-template-columns: 1fr; }
            .rating-btn { padding: 1.5rem 1rem; }
            .rating-emoji { font-size: 2.5rem; }
            .calendar-day { min-height: 80px; padding: 0.25rem; }
            .calendar-day-number { font-size: 0.9rem; }
            .calendar-day-header { padding: 0.5rem 0.25rem; font-size: 0.8rem; }
            .calendar-session-count { font-size: 0.6rem; }
            .session-info { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .grade-input-group { flex-direction: column; align-items: flex-start; }
            .semesters-container { grid-template-columns: 1fr; }
            .year-stats { justify-content: center; }
            .curriculum-navigation { justify-content: center; }
            .year-selector { flex-wrap: wrap; }
            .subject-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .subject-actions { width: 100%; justify-content: flex-start; }
            .plan-detail-grid { grid-template-columns: 1fr; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        /* Additional improvements */
        .curriculum-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .plan-overview {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
        }

        .plan-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .plan-metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .plan-metric-number {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .plan-metric-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Animation presets */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            animation: shimmerLoading 1.5s infinite;
        }

        @keyframes shimmerLoading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1> Piano Studio Smart AI Pro</h1>
            <p>Il tuo assistente intelligente anti-procrastinazione con gestione esami completa</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('oggi', this)"> Oggi</button>
            <button class="nav-tab" onclick="showSection('materie', this)"> Materie</button>
            <button class="nav-tab" onclick="showSection('curriculum', this)"> Curriculum</button>
            <button class="nav-tab" onclick="showSection('esami', this)"> Esami</button>
            <button class="nav-tab" onclick="showSection('piano', this)"> Piano</button>
            <button class="nav-tab" onclick="showSection('pomodoro', this)"> Pomodoro</button>
            <button class="nav-tab" onclick="showSection('calendario', this)"> Calendario</button>
            <button class="nav-tab" onclick="showSection('statistiche', this)"> Statistiche</button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sezione OGGI -->
            <section id="oggi" class="section active">
                <!-- Recovery Dashboard -->
                <div class="recovery-dashboard hidden" id="recoveryDashboard">
                    <h4> Stato Recupero</h4>
                    <div class="missed-time">Tempo da recuperare: <span class="highlight" id="missedTime">0h 0min</span></div>
                    <div class="recovery-plan" id="recoveryPlan">Piano: Distribuzione automatica attiva</div>
                    <button class="btn btn-warning" onclick="showRecoveryOptions()"> Modifica Piano</button>
                </div>

                <div class="card oggi-card">
                    <h3> Il Tuo Piano di Oggi</h3>
                    
                    <div class="prossimo-task">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> PROSSIMO TASK:</h4>
                        <div class="task-corrente" id="taskCorrente">
                            <div class="task-header">
                                <span class="materia-nome" id="currentTaskMateria">Nessun task programmato</span>
                                <span class="tempo-stimato" id="currentTaskTime"> -- min</span>
                            </div>
                            <div class="task-descrizione" id="currentTaskDesc">
                                Aggiungi delle materie per iniziare a studiare in modo intelligente!
                            </div>
                            <div class="task-motivazione" id="currentTaskMotivation">
                                 Il sistema pianificher automaticamente le tue sessioni di studio
                            </div>

                            <div class="task-options hidden" id="taskOptions">
                                <h5> Cosa vuoi fare specificamente?</h5>
                                <div id="taskOptionsList"></div>
                            </div>

                            <button class="btn btn-primary" onclick="iniziaTask()" id="startTaskBtn" disabled> Inizia Subito</button>
                        </div>
                    </div>

                    <!-- Micro Tasks -->
                    <div class="micro-tasks hidden" id="microTasks">
                        <h4 style="color: var(--secondary); margin-bottom: 1rem;"> Task Micro (Anti-Procrastinazione)</h4>
                        <p style="opacity: 0.8; margin-bottom: 1rem;">Inizia con qualcosa di facile per creare momentum:</p>
                        <div id="microTasksList"></div>
                    </div>

                    <div class="programma-giornata">
                        <h4 style="color: var(--primary-light);"> Programma Completo di Oggi:</h4>
                        <div class="timeline-oggi" id="timelineOggi">
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Materie -->
            <section id="materie" class="section">
                <!-- Study Streak Card -->
                <div class="streak-card">
                    <h3 style="margin-bottom: 1rem; color: white;"> Studio Streak</h3>
                    <div class="streak-number" id="streakNumber">0</div>
                    <p style="font-size: 1.1rem; opacity: 0.9;">giorni consecutivi</p>
                </div>

                <div class="card">
                    <h3> Aggiungi Nuova Materia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeMateria">Nome Materia <span class="required">*</span></label>
                            <input type="text" id="nomeMateria" required placeholder="Es. Analisi Matematica I">
                        </div>
                        <div class="form-group">
                            <label for="cfu">CFU <span class="required">*</span></label>
                            <input type="number" id="cfu" min="1" max="30" required placeholder="Es. 9">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anno">Anno <span class="required">*</span></label>
                            <select id="anno" required>
                                <option value="">Seleziona Anno</option>
                                <option value="1">1 Anno</option>
                                <option value="2">2 Anno</option>
                                <option value="3">3 Anno</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="semestre">Semestre <span class="required">*</span></label>
                            <select id="semestre" required>
                                <option value="">Seleziona Semestre</option>
                                <option value="1">I Semestre</option>
                                <option value="2">II Semestre</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagine">Pagine Totali <span class="required">*</span></label>
                            <input type="number" id="pagine" min="1" required placeholder="Es. 450">
                        </div>
                        <div class="form-group">
                            <label for="pagineStudiate">Pagine gi Studiate</label>
                            <input type="number" id="pagineStudiate" min="0" value="0" placeholder="Es. 120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pagineOra">Pagine per Ora</label>
                            <input type="number" id="pagineOra" min="1" max="50" value="8" placeholder="Es. 8">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Quante pagine riesci a studiare in 1 ora per questa materia</small>
                        </div>
                        <div class="form-group">
                            <label for="eserciziTotali">Esercizi Totali</label>
                            <input type="number" id="eserciziTotali" min="0" value="0" placeholder="Es. 150">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Numero totale di esercizi da completare (opzionale)</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eserciziCompletati">Esercizi Completati</label>
                            <input type="number" id="eserciziCompletati" min="0" value="0" placeholder="Es. 45">
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">Esercizi gi completati</small>
                        </div>
                        <div class="form-group">
                            <label for="dataEsame">Data Esame</label>
                            <input type="date" id="dataEsame">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="priorita">Priorit</label>
                            <select id="priorita">
                                <option value="alta">Alta</option>
                                <option value="media" selected>Media</option>
                                <option value="bassa">Bassa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Difficolt Percepita</label>
                            <div class="star-rating" id="difficolta">
                                <span class="star" data-rating="1"></span>
                                <span class="star" data-rating="2"></span>
                                <span class="star" data-rating="3"></span>
                                <span class="star" data-rating="4"></span>
                                <span class="star" data-rating="5"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Slot Temporali -->
                    <div class="form-group">
                        <label> Slot Temporali Settimanali</label>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Definisci gli slot orari specifici in cui puoi studiare questa materia durante la settimana
                        </p>
                        <div class="weekly-slots" id="weeklySlots">
                            <!-- Slot per ogni giorno generati dinamicamente -->
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addMateria()"> Aggiungi Materia</button>
                </div>

                <div class="card">
                    <h3> Le Tue Materie</h3>
                    <div id="materieList">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna materia aggiunta ancora.</p>
                            <p>Inizia aggiungendo la tua prima materia!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione CURRICULUM -->
            <section id="curriculum" class="section">
                <!-- Navigation per anni -->
                <div class="curriculum-navigation">
                    <div class="year-selector">
                        <button class="year-tab active" onclick="showCurriculumYear(1, this)">1 Anno</button>
                        <button class="year-tab" onclick="showCurriculumYear(2, this)">2 Anno</button>
                        <button class="year-tab" onclick="showCurriculumYear(3, this)">3 Anno</button>
                    </div>
                    <div class="curriculum-actions">
                        <button class="btn btn-primary btn-small" onclick="showAddSubjectModal()"> Aggiungi Materia</button>
                        <button class="btn btn-secondary btn-small" onclick="importCurriculumData()"> Importa Dati</button>
                        <button class="btn btn-warning btn-small" onclick="exportCurriculumData()"> Esporta Dati</button>
                    </div>
                </div>

                <!-- Container per gli anni -->
                <div id="curriculumContainer">
                    <!-- Anno 1 -->
                    <div id="year-1" class="year-content active">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span></span>
                                    <span>Primo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary);" id="year1-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning);" id="year1-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success);" id="year1-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary);" id="year1-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> I Semestre</div>
                                        <div class="semester-progress" id="year1-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year1-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> II Semestre</div>
                                        <div class="semester-progress" id="year1-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year1-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anno 2 -->
                    <div id="year-2" class="year-content hidden">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span></span>
                                    <span>Secondo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary);" id="year2-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning);" id="year2-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success);" id="year2-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary);" id="year2-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> I Semestre</div>
                                        <div class="semester-progress" id="year2-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year2-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> II Semestre</div>
                                        <div class="semester-progress" id="year2-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year2-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anno 3 -->
                    <div id="year-3" class="year-content hidden">
                        <div class="year-section">
                            <div class="year-header">
                                <div class="year-title">
                                    <span></span>
                                    <span>Terzo Anno</span>
                                </div>
                                <div class="year-stats">
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--secondary);" id="year3-subjects">0</div>
                                        <div class="year-stat-label">Materie</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--warning);" id="year3-cfu">0</div>
                                        <div class="year-stat-label">CFU</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--success);" id="year3-completed">0</div>
                                        <div class="year-stat-label">Completati</div>
                                    </div>
                                    <div class="year-stat">
                                        <div class="year-stat-number" style="color: var(--primary);" id="year3-average">0.0</div>
                                        <div class="year-stat-label">Media</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="semesters-container">
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> I Semestre</div>
                                        <div class="semester-progress" id="year3-sem1-progress">0/0 esami</div>
                                    </div>
                                    <div id="year3-semester1-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="semester-section">
                                    <div class="semester-header">
                                        <div class="semester-title"> II Semestre</div>
                                        <div class="semester-progress" id="year3-sem2-progress">0/0 esami</div>
                                    </div>
                                    <div id="year3-semester2-subjects">
                                        <div class="empty-state">
                                            <div class="empty-state-icon"></div>
                                            <p>Nessuna materia aggiunta ancora</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Esami -->
            <section id="esami" class="section">
                <!-- Statistiche Esami -->
                <div class="card">
                    <h3> Statistiche Esami</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="totalExams">0</div>
                            <div class="stat-label">Esami Sostenuti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="totalCFU">0</div>
                            <div class="stat-label">CFU Acquisiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);" id="weightedAverage">0.00</div>
                            <div class="stat-label">Media Ponderata</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);" id="projectedGrade">0</div>
                            <div class="stat-label">Voto Laurea Est.</div>
                        </div>
                    </div>
                </div>

                <!-- Distribuzione Voti -->
                <div class="card">
                    <h3> Distribuzione Voti</h3>
                    <div id="gradeDistribution">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Completa alcuni esami per vedere la distribuzione!</p>
                        </div>
                    </div>
                </div>

                <!-- Lista Esami Sostenuti -->
                <div class="card">
                    <h3> Esami Sostenuti</h3>
                    <div id="examsList">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Marca una materia come "Esame Sostenuto" per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Piano Studio -->
            <section id="piano" class="section">
                <!-- Piano Overview -->
                <div class="plan-overview">
                    <h4> Piano di Studio Intelligente</h4>
                    <p id="planSummary">Caricamento piano personalizzato...</p>
                    <div class="plan-metrics">
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="totalWeeklyHours">0h</div>
                            <div class="plan-metric-label">Ore Settimanali</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="avgDailyHours">0h</div>
                            <div class="plan-metric-label">Media Giornaliera</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="totalPages">0</div>
                            <div class="plan-metric-label">Pagine Totali</div>
                        </div>
                        <div class="plan-metric">
                            <div class="plan-metric-number" id="completionWeeks">0</div>
                            <div class="plan-metric-label">Settimane Stimate</div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div class="card" style="background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), rgba(6, 214, 160, 0.05)); border: 1px solid rgba(6, 214, 160, 0.3); border-left: 4px solid var(--secondary);" id="aiSuggestions">
                    <h3 style="color: var(--secondary); display: flex; align-items: center; gap: 0.5rem;"> Suggerimenti AI</h3>
                    <div id="suggestionsList">
                        <div style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;"> Analizzando i tuoi dati...</div>
                            <div style="color: var(--text-primary); line-height: 1.5;">Il sistema sta elaborando raccomandazioni personalizzate basate sui tuoi orari di studio e produttivit.</div>
                        </div>
                    </div>
                </div>

                <!-- Piano Dettagliato -->
                <div class="card">
                    <h3> Dettagli Piano</h3>
                    <div id="pianDetails">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Pomodoro -->
            <section id="pomodoro" class="section">
                <!-- Impostazioni Obiettivo Giornaliero -->
                <div class="daily-goal-settings">
                    <h4> Obiettivo Giornaliero Personalizzato</h4>
                    <div class="goal-input-group">
                        <label for="dailyGoal" style="margin: 0; color: var(--text-primary);">Pomodori da completare oggi:</label>
                        <input type="number" id="dailyGoal" class="goal-input" min="1" max="20" value="8" onchange="updateDailyGoal()">
                        <span style="color: var(--text-secondary);">sessioni</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Personalizza il tuo obiettivo giornaliero in base al tempo che hai disponibile
                    </p>
                </div>

                <div class="card">
                    <div class="timer-container">
                        <h3> Timer Pomodoro</h3>
                        
                        <div class="timer-presets">
                            <button class="preset-btn active" onclick="setPreset(25, 5, this)">25/5 min</button>
                            <button class="preset-btn" onclick="setPreset(50, 10, this)">50/10 min</button>
                            <button class="preset-btn" onclick="setPreset(90, 20, this)">90/20 min</button>
                            <button class="preset-btn" onclick="showCustomTimerDialog()">Personalizza</button>
                        </div>

                        <div class="timer-display" id="timerDisplay">25:00</div>

                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startBtn" onclick="startTimer()"> Inizia</button>
                            <button class="btn btn-warning hidden" id="pauseBtn" onclick="pauseTimer()"> Pausa</button>
                            <button class="btn btn-danger" onclick="resetTimer()"> Reset</button>
                            <button class="btn btn-secondary" onclick="toggleFocusMode()"> Focus</button>
                        </div>

                        <div class="form-group">
                            <p><strong>Sessioni completate oggi:</strong> <span id="sessionCount">0</span> / <span id="sessionGoal">8</span></p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                            </div>
                            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;" id="progressText">Inizia la tua prima sessione!</small>
                        </div>
                    </div>
                </div>

                <!-- Lista Sessioni di Oggi -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;"> Sessioni di Oggi</h3>
                        <button class="btn btn-danger btn-small" onclick="showDeleteAllTodaySessionsModal()"> Elimina tutte</button>
                    </div>
                    
                    <div id="todaySessionsList" class="session-list">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna sessione completata oggi.</p>
                            <p>Avvia una sessione per iniziare!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Calendario -->
            <section id="calendario" class="section">
                <!-- Controlli Calendario -->
                <div class="card">
                    <h3> Navigazione Calendario</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="changeMonth(-1)" style="padding: 0.75rem 1rem;"> Precedente</button>
                            <h4 id="currentMonthYear" style="margin: 0; color: var(--primary-light); min-width: 200px; text-align: center;">Gennaio 2024</h4>
                            <button class="btn btn-secondary" onclick="changeMonth(1)" style="padding: 0.75rem 1rem;">Successivo </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="goToToday()" style="padding: 0.75rem 1rem;"> Oggi</button>
                            <button class="btn btn-warning" onclick="addManualSession()" style="padding: 0.75rem 1rem;"> Aggiungi Sessione</button>
                        </div>
                    </div>
                </div>

                <!-- Calendario Principale -->
                <div class="card">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">Lun</div>
                            <div class="calendar-day-header">Mar</div>
                            <div class="calendar-day-header">Mer</div>
                            <div class="calendar-day-header">Gio</div>
                            <div class="calendar-day-header">Ven</div>
                            <div class="calendar-day-header">Sab</div>
                            <div class="calendar-day-header">Dom</div>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Giorni generati dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Statistiche Mensili -->
                <div class="card">
                    <h3> Statistiche del Mese</h3>
                    <div class="form-row">
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-light);" id="monthSessions">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Sessioni Totali</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary);" id="monthHours">0h</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ore di Studio</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="monthDays">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Giorni Attivi</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="monthAverage">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Media Sessioni/Giorno</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sezione Statistiche -->
            <section id="statistiche" class="section">
                <div class="card">
                    <h3> Statistiche e Progressi</h3>
                    <div id="statisticheContent">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna statistica disponibile.</p>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    </div>
                </div>

                <!-- Sezione Produttivit -->
                <div class="card">
                    <h3> La Tua Produttivit</h3>
                    
                    <!-- Heatmap 24 ore -->
                    <div class="hourly-heatmap">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> Heatmap Oraria della Produttivit</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Visualizza i tuoi momenti pi produttivi durante la giornata
                        </p>
                        <div class="heatmap-grid" id="heatmapGrid">
                            <!-- Celle generate dinamicamente per ogni ora (0-23) -->
                        </div>
                        <div class="heatmap-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-empty);"></div>
                                <span>Nessun dato</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-low);"></div>
                                <span>Bassa</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-medium);"></div>
                                <span>Media</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-high);"></div>
                                <span>Alta</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--heatmap-very-high);"></div>
                                <span>Eccellente</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Ore Migliori -->
                    <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-light); margin-bottom: 1rem;"> Le Tue Top 3 Ore Migliori</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;" id="topHoursGrid">
                            <!-- Top ore generate dinamicamente -->
                        </div>
                        
                        <!-- Suggerimento AI -->
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; border-left: 4px solid var(--primary);" id="productivitySuggestion">
                            <h4 style="color: var(--primary-light); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;"> Suggerimento Smart</h4>
                            <p style="color: var(--text-primary); line-height: 1.6;">Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi produttivi!</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Focus Mode Overlay -->
    <div class="focus-mode" id="focusMode">
        <button class="close-focus" onclick="toggleFocusMode()"></button>
        <div class="focus-content">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;"> Modalit Focus</h2>
            <div class="focus-timer" id="focusTimer">25:00</div>
            <p style="font-size: 1.2rem; opacity: 0.8;">Resta concentrato! Stai facendo un ottimo lavoro.</p>
        </div>
    </div>

    <!-- Modal per Aggiungere Materia al Curriculum -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <h3> Aggiungi Materia al Curriculum</h3>
            <div class="form-group">
                <label for="currSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="currSubjectName" required placeholder="Es. Analisi Matematica I">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectYear">Anno <span class="required">*</span></label>
                    <select id="currSubjectYear" required>
                        <option value="1">1 Anno</option>
                        <option value="2">2 Anno</option>
                        <option value="3">3 Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="currSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currSubjectCFU">CFU <span class="required">*</span></label>
                    <input type="number" id="currSubjectCFU" min="1" max="30" required placeholder="Es. 9">
                </div>
                <div class="form-group">
                    <label for="currSubjectProfessor">Professore</label>
                    <input type="text" id="currSubjectProfessor" placeholder="Es. Prof. Mario Rossi">
                </div>
            </div>
            <div class="form-group">
                <label for="currSubjectNotes">Note (opzionale)</label>
                <textarea id="currSubjectNotes" rows="2" placeholder="Note aggiuntive sulla materia..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveCurriculumSubject()"> Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSubjectModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Rating Post-Sessione con Note -->
    <div class="modal-overlay" id="ratingModal">
        <div class="rating-modal">
            <h3> Sessione Completata!</h3>
            <p>Come ti senti dopo questa sessione di studio?<br>La tua valutazione ci aiuta a ottimizzare i tuoi orari migliori.</p>
            
            <div class="form-group">
                <label for="sessionNote"> Note sulla sessione (opzionale):</label>
                <input type="text" id="sessionNote" placeholder="Es. Ho studiato il capitolo 3..." style="margin-bottom: 1rem;">
            </div>
            
            <div class="rating-buttons">
                <div class="rating-btn sleepy" onclick="submitRating(1)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Stanco</div>
                </div>
                <div class="rating-btn neutral" onclick="submitRating(2)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Normale</div>
                </div>
                <div class="rating-btn good" onclick="submitRating(3)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Bene</div>
                </div>
                <div class="rating-btn excellent" onclick="submitRating(4)">
                    <div class="rating-emoji"></div>
                    <div class="rating-label">Eccellente</div>
                </div>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 1rem;">
                Clicca per salvare automaticamente
            </p>
        </div>
    </div>

    <!-- Modal per Timer Personalizzato -->
    <div class="modal-overlay" id="customTimerModal">
        <div class="modal">
            <h3> Personalizza Timer</h3>
            <div class="form-group">
                <label for="customWorkTime">Minuti di Lavoro (1-180):</label>
                <input type="number" id="customWorkTime" min="1" max="180" value="25">
            </div>
            <div class="form-group">
                <label for="customBreakTime">Minuti di Pausa (1-60):</label>
                <input type="number" id="customBreakTime" min="1" max="60" value="5">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyCustomTimer()"> Applica</button>
                <button class="btn btn-secondary" onclick="closeCustomTimerModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Sessione Manuale -->
    <div class="modal-overlay" id="addSessionModal">
        <div class="modal">
            <h3> Aggiungi Sessione Studio</h3>
            <div class="form-group">
                <label for="sessionDate">Data:</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label for="sessionMateria">Materia (opzionale):</label>
                <select id="sessionMateria">
                    <option value="">Sessione generica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sessionDuration">Durata (minuti):</label>
                <input type="number" id="sessionDuration" min="5" max="300" value="25">
            </div>
            <div class="form-group">
                <label for="manualSessionNote">Note (opzionale):</label>
                <input type="text" id="manualSessionNote" placeholder="Es. Ripasso capitolo 3">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveManualSession()"> Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeAddSessionModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Visualizzare Giorno Specifico -->
    <div class="modal-overlay" id="dayDetailModal">
        <div class="modal" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto;">
            <h3 id="dayDetailTitle"> Dettagli Giorno</h3>
            <div id="dayDetailContent">
                <!-- Contenuto generato dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDayDetailModal()"> Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere Voto Esame -->
    <div class="modal-overlay" id="examModal">
        <div class="modal">
            <h3> Registra Esame Sostenuto</h3>
            <div class="form-group">
                <label for="examSubject">Materia:</label>
                <input type="text" id="examSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="examGrade">Voto (18-30):</label>
                    <div class="grade-input-group">
                        <input type="number" id="examGrade" class="grade-input" min="18" max="30" placeholder="30">
                        <label>
                            <input type="checkbox" id="examLode"> Lode
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="examDate">Data Esame:</label>
                    <input type="date" id="examDate">
                </div>
            </div>
            <div class="form-group">
                <label for="examNotes">Note (opzionale):</label>
                <textarea id="examNotes" rows="3" placeholder="Es. Esame andato molto bene, argomenti principali..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="saveExamGrade()"> Salva Esame</button>
                <button class="btn btn-secondary" onclick="closeExamModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Modificare Esame -->
    <div class="modal-overlay" id="editExamModal">
        <div class="modal">
            <h3> Modifica Esame</h3>
            <div class="form-group">
                <label for="editExamSubject">Materia:</label>
                <input type="text" id="editExamSubject" readonly style="background: var(--bg-secondary);">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editExamGrade">Voto (18-30):</label>
                    <div class="grade-input-group">
                        <input type="number" id="editExamGrade" class="grade-input" min="18" max="30">
                        <label>
                            <input type="checkbox" id="editExamLode"> Lode
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editExamDate">Data Esame:</label>
                    <input type="date" id="editExamDate">
                </div>
            </div>
            <div class="form-group">
                <label for="editExamNotes">Note (opzionale):</label>
                <textarea id="editExamNotes" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="updateExamGrade()"> Aggiorna</button>
                <button class="btn btn-secondary" onclick="closeEditExamModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per Modificare Materia Curriculum -->
    <div class="modal-overlay" id="editCurriculumModal">
        <div class="modal">
            <h3> Modifica Materia Curriculum</h3>
            <div class="form-group">
                <label for="editCurrSubjectName">Nome Materia <span class="required">*</span></label>
                <input type="text" id="editCurrSubjectName" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editCurrSubjectYear">Anno <span class="required">*</span></label>
                    <select id="editCurrSubjectYear" required>
                        <option value="1">1 Anno</option>
                        <option value="2">2 Anno</option>
                        <option value="3">3 Anno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCurrSubjectSemester">Semestre <span class="required">*</span></label>
                    <select id="editCurrSubjectSemester" required>
                        <option value="1">I Semestre</option>
                        <option value="2">II Semestre</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editCurrSubjectCFU">CFU <span class="required">*</span></label>
                    <input type="number" id="editCurrSubjectCFU" min="1" max="30" required>
                </div>
                <div class="form-group">
                    <label for="editCurrSubjectProfessor">Professore</label>
                    <input type="text" id="editCurrSubjectProfessor">
                </div>
            </div>
            <div class="form-group">
                <label for="editCurrSubjectNotes">Note (opzionale)</label>
                <textarea id="editCurrSubjectNotes" rows="2"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="updateCurriculumSubject()"> Aggiorna</button>
                <button class="btn btn-secondary" onclick="closeEditCurriculumModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal Opzioni Recupero -->
    <div class="modal-overlay" id="recoveryModal">
        <div class="modal">
            <h3> Opzioni Recupero</h3>
            <div class="form-group">
                <label>Strategia di Recupero:</label>
                <select id="recoveryStrategy">
                    <option value="graduale">Graduale (distribuisci su 7 giorni)</option>
                    <option value="intensivo">Intensivo (recupera in 2-3 giorni)</option>
                    <option value="weekend">Weekend (solo sabato e domenica)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="applyRecoveryStrategy()"> Applica</button>
                <button class="btn btn-secondary" onclick="closeRecoveryModal()"> Annulla</button>
            </div>
        </div>
    </div>

    <!-- Tooltip per heatmap -->
    <div class="tooltip" id="heatmapTooltip"></div>

    <script>
        // === STATO GLOBALE APPLICAZIONE ===
        const APP = {
            materie: JSON.parse(localStorage.getItem('materie')) || [],
            esami: JSON.parse(localStorage.getItem('esami')) || [],
            curriculum: JSON.parse(localStorage.getItem('curriculum')) || [],
            currentCalendarDate: new Date(),
            calendarSessions: JSON.parse(localStorage.getItem('calendarSessions')) || {},
            sessionRatings: JSON.parse(localStorage.getItem('sessionRatings')) || {},
            difficoltaSelezionata: 3,
            timerInterval: null,
            selectedTaskOption: null,
            currentSessionStartTime: null,
            currentSessionData: null,
            currentEditingExamId: null,
            currentEditingCurriculumId: null,
            currentCurriculumYear: 1,
            
            // Task micro universali anti-procrastinazione
            universalMicroTasks: [
                { text: " Leggi il sommario del primo capitolo", durata: 5 },
                { text: " Scrivi 3 concetti che gi conosci dell'argomento", durata: 3 },
                { text: " Prepara il materiale di studio sulla scrivania", durata: 2 },
                { text: " Definisci 1 obiettivo specifico per oggi", durata: 2 },
                { text: " Controlla il tuo progresso attuale", durata: 3 },
                { text: " Cerca 1 video introduttivo sull'argomento", durata: 5 },
                { text: " Crea una lista di 3 domande da fare", durata: 4 },
                { text: " Fai 10 respiri profondi per concentrarti", durata: 1 }
            ],

            timerState: {
                minutes: 25,
                seconds: 0,
                isRunning: false,
                isBreak: false,
                workTime: 25,
                breakTime: 5,
                sessionsToday: parseInt(localStorage.getItem('sessionsToday')) || 0,
                lastSessionDate: localStorage.getItem('lastSessionDate') || '',
                dailyGoal: parseInt(localStorage.getItem('dailyGoal')) || 8
            },

            studyData: {
                streak: parseInt(localStorage.getItem('studyStreak')) || 0,
                lastStudyDate: localStorage.getItem('lastStudyDate') || '',
                totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
                missedTime: parseInt(localStorage.getItem('missedTime')) || 0
            },

            todayDetailedSessions: JSON.parse(localStorage.getItem('todayDetailedSessions')) || []
        };

        // === UTILITIES ===
        const Utils = {
            showSuccessMessage(message) {
                const existingToast = document.querySelector('.app-toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = 'app-toast';
                toast.style.cssText = `
                    position: fixed; top: 80px; right: 20px;
                    background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
                    color: white; padding: 1rem 1.5rem; border-radius: 12px;
                    box-shadow: var(--shadow-xl); z-index: 10000; font-weight: 600;
                    max-width: 400px; animation: slideInToast 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                    backdrop-filter: blur(10px);
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideInToast {
                        from { transform: translateX(100%) scale(0.8); opacity: 0; }
                        to { transform: translateX(0) scale(1); opacity: 1; }
                    }
                    @keyframes slideOutToast {
                        from { transform: translateX(0) scale(1); opacity: 1; }
                        to { transform: translateX(100%) scale(0.8); opacity: 0; }
                    }
                `;

                document.head.appendChild(style);
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOutToast 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    setTimeout(() => {
                        if (document.body.contains(toast)) document.body.removeChild(toast);
                        if (document.head.contains(style)) document.head.removeChild(style);
                    }, 400);
                }, 4000);
            },

            calculateTaskDuration(inizio, fine) {
                const start = new Date(`1970-01-01T${inizio}:00`);
                const end = new Date(`1970-01-01T${fine}:00`);
                return Math.round((end - start) / (1000 * 60));
            },

            getDaysToExam(dataEsame) {
                if (!dataEsame) return null;
                const today = new Date();
                const examDate = new Date(dataEsame);
                const diffTime = examDate - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            formatTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}h ${mins}min` : `${mins}min`;
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // === NAVIGAZIONE ===
        function showSection(sectionName, targetElement) {
            try {
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

                const targetSection = document.getElementById(sectionName);
                if (targetSection) targetSection.classList.add('active');
                if (targetElement) targetElement.classList.add('active');

                const updateContent = Utils.debounce(() => {
                    switch(sectionName) {
                        case 'oggi': TodayScheduler.generateTodaySchedule(); break;
                        case 'piano': PianoStudio.generatePianoStudio(); break;
                        case 'statistiche': 
                            Statistics.updateStatistiche();
                            Heatmap.updateHeatmap();
                            ProductivityAnalyzer.updateProductivitySection();
                            break;
                        case 'calendario': Calendar.renderCalendar(); break;
                        case 'materie':
                            setTimeout(() => {
                                WeeklySlots.initializeWeeklySlots();
                                StarRating.setupStarRating();
                            }, 100);
                            break;
                        case 'pomodoro': Sessions.updateTodaySessionsList(); break;
                        case 'esami': ExamManager.updateExamsSection(); break;
                        case 'curriculum': CurriculumManager.loadCurriculumData(); break;
                    }
                }, 150);

                updateContent();
            } catch (error) {
                console.error('Errore nel cambio sezione:', error);
            }
        }

        // === MATERIE MANAGEMENT ===
        const MaterieManager = {
            saveMaterie() {
                try {
                    localStorage.setItem('materie', JSON.stringify(APP.materie));
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                }
            },

            loadMaterie() {
                const container = document.getElementById('materieList');
                
                if (APP.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna materia aggiunta ancora.</p>
                            <p>Inizia aggiungendo la tua prima materia!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = APP.materie.map(materia => {
                    const percentualeCompletamento = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                    const percentualeEsercizi = materia.eserciziTotali > 0 ? 
                        Math.round(((materia.eserciziCompletati || 0) / materia.eserciziTotali) * 100) : 0;
                    
                    const isExamCompleted = materia.status === 'completato';
                    const examData = APP.esami.find(e => e.materiaId === materia.id);
                    
                    let oreTotaliSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreTotaliSettimanali += durata;
                            });
                        });
                        oreTotaliSettimanali = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                    }
                    
                    return `
                    <div class="subject-item ${isExamCompleted ? 'exam-completed' : ''}">
                        <div class="subject-header">
                            <div class="subject-name">${materia.nome}</div>
                            <div class="subject-actions">
                                <span class="status-badge ${isExamCompleted ? 'status-completato' : 'status-studio'}">
                                    ${isExamCompleted ? ' Completato' : ' In Studio'}
                                </span>
                                <span class="priority-badge priority-${materia.priorita}">${materia.priorita}</span>
                                ${!isExamCompleted ? `
                                    <button class="btn btn-success btn-small" onclick="MaterieManager.markAsExamCompleted(${materia.id})" title="Marca come esame sostenuto"></button>
                                    <button class="btn btn-warning btn-small" onclick="MaterieManager.editMateria(${materia.id})" title="Modifica materia"></button>
                                ` : `
                                    <button class="btn btn-warning btn-small" onclick="ExamManager.editExam(${materia.id})" title="Modifica esame"></button>
                                `}
                                <button class="btn btn-danger btn-small" onclick="MaterieManager.deleteMateria(${materia.id})" title="Elimina"></button>
                            </div>
                        </div>
                        
                        ${!isExamCompleted ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong style="color: var(--primary-light);">Progresso Studio:</strong>
                                <span style="color: var(--secondary); font-weight: 600;">${percentualeCompletamento}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentualeCompletamento}%"></div>
                            </div>
                            <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine completate</small>
                        </div>
                        ` : examData ? `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${examData.voto}${examData.lode ? 'L' : ''}</div>
                            <div>
                                <div style="color: var(--success); font-weight: 600;">Esame sostenuto</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                    ${examData.dataEsame ? new Date(examData.dataEsame).toLocaleDateString('it-IT') : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${materia.eserciziTotali > 0 && !isExamCompleted ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong style="color: var(--accent);">Progresso Esercizi:</strong>
                                <span style="color: var(--warning); font-weight: 600;">${percentualeEsercizi}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentualeEsercizi}%; background: linear-gradient(90deg, var(--warning), var(--accent));"></div>
                            </div>
                            <small style="color: var(--text-secondary);">${materia.eserciziCompletati || 0}/${materia.eserciziTotali} esercizi completati</small>
                        </div>
                        ` : ''}
                        
                        <div class="subject-info">
                            <div><strong>Anno:</strong> ${materia.anno} Anno</div>
                            <div><strong>Semestre:</strong> ${materia.semestre} Semestre</div>
                            <div><strong>CFU:</strong> ${materia.cfu}</div>
                            <div><strong>Pagine:</strong> ${materia.pagine}</div>
                            <div><strong>Pagine/ora:</strong> ${materia.pagineOra || 8}</div>
                            <div><strong>Ore settimanali:</strong> ${oreTotaliSettimanali}h</div>
                            ${materia.eserciziTotali > 0 ? `<div><strong>Esercizi:</strong> ${materia.eserciziCompletati || 0}/${materia.eserciziTotali}</div>` : ''}
                            <div><strong>Esame:</strong> ${materia.dataEsame ? new Date(materia.dataEsame).toLocaleDateString('it-IT') : 'Non impostato'}</div>
                            <div><strong>Difficolt:</strong> ${''.repeat(materia.difficolta || 3)}${''.repeat(5-(materia.difficolta || 3))}</div>
                            ${examData && examData.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${examData.note}</div>` : ''}
                        </div>
                    </div>
                    `;
                }).join('');
            },

            markAsExamCompleted(materiaId) {
                const materia = APP.materie.find(m => m.id === materiaId);
                if (!materia) {
                    Utils.showSuccessMessage(' Materia non trovata');
                    return;
                }

                document.getElementById('examSubject').value = materia.nome;
                document.getElementById('examModal').style.display = 'flex';
                document.getElementById('examModal').dataset.materiaId = materiaId;
            },

            editMateria(id) {
                try {
                    const materia = APP.materie.find(m => m.id === id);
                    if (!materia) {
                        Utils.showSuccessMessage(' Materia non trovata');
                        return;
                    }

                    // Popola form
                    const fields = {
                        nomeMateria: materia.nome || '',
                        cfu: materia.cfu || '',
                        anno: materia.anno || '',
                        semestre: materia.semestre || '',
                        pagine: materia.pagine || '',
                        pagineStudiate: materia.pagineStudiate || 0,
                        pagineOra: materia.pagineOra || 8,
                        eserciziTotali: materia.eserciziTotali || 0,
                        eserciziCompletati: materia.eserciziCompletati || 0,
                        dataEsame: materia.dataEsame || '',
                        priorita: materia.priorita || 'media'
                    };

                    Object.entries(fields).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.value = value;
                    });
                    
                    APP.difficoltaSelezionata = materia.difficolta || 3;
                    StarRating.updateStarDisplay();

                    setTimeout(() => {
                        WeeklySlots.initializeWeeklySlots();
                        
                        if (materia.slotSettimanali) {
                            setTimeout(() => {
                                Object.keys(materia.slotSettimanali).forEach(giorno => {
                                    const slots = materia.slotSettimanali[giorno];
                                    slots.forEach(slot => {
                                        WeeklySlots.addTimeSlot(giorno);
                                        const container = document.getElementById(`slots-${giorno}`);
                                        if (container) {
                                            const lastSlot = container.querySelector('.slot-item:last-of-type');
                                            if (lastSlot) {
                                                const inputs = lastSlot.querySelectorAll('input[type="time"]');
                                                if (inputs.length >= 2) {
                                                    inputs[0].value = slot.inizio;
                                                    inputs[1].value = slot.fine;
                                                }
                                            }
                                        }
                                    });
                                });
                            }, 200);
                        }
                    }, 100);

                    // Rimuovi materia per modifica
                    APP.materie = APP.materie.filter(m => m.id !== id);
                    this.saveMaterie();
                    this.loadMaterie();

                    showSection('materie', document.querySelector('.nav-tab[onclick*="materie"]'));
                    Utils.showSuccessMessage(' Materia caricata per modifica');
                    
                } catch (error) {
                    console.error(' Errore nella modifica:', error);
                    Utils.showSuccessMessage(' Errore nel caricamento della materia');
                }
            },

            deleteMateria(id) {
                try {
                    const materia = APP.materie.find(m => m.id === id);
                    if (!materia) {
                        Utils.showSuccessMessage(' Materia non trovata');
                        return;
                    }

                    const conferma = confirm(`Sei sicuro di voler eliminare "${materia.nome}"?\n\nQuesta azione eliminer anche l'eventuale esame associato e non pu essere annullata.`);
                    
                    if (conferma) {
                        APP.esami = APP.esami.filter(e => e.materiaId !== id);
                        ExamManager.saveEsami();
                        
                        APP.materie = APP.materie.filter(m => m.id !== id);
                        this.saveMaterie();
                        this.loadMaterie();
                        
                        // Rimuovi anche dal curriculum se presente
                        const currSubjectIndex = APP.curriculum.findIndex(c => c.nome === materia.nome && c.anno === materia.anno && c.semestre === materia.semestre);
                        if (currSubjectIndex !== -1) {
                            APP.curriculum.splice(currSubjectIndex, 1);
                            CurriculumManager.saveCurriculum();
                        }
                        
                        TodayScheduler.generateTodaySchedule();
                        PianoStudio.generatePianoStudio();
                        Statistics.updateStatistiche();
                        ExamManager.updateExamsSection();
                        CurriculumManager.loadCurriculumData();
                        
                        Utils.showSuccessMessage(' Materia ed esame eliminati con successo');
                    }
                } catch (error) {
                    console.error(' Errore nell\'eliminazione:', error);
                    Utils.showSuccessMessage(' Errore nell\'eliminazione della materia');
                }
            }
        };

        // === EXAM MANAGER ===
        const ExamManager = {
            saveEsami() {
                try {
                    localStorage.setItem('esami', JSON.stringify(APP.esami));
                } catch (error) {
                    console.error('Errore nel salvataggio esami:', error);
                }
            },

            updateExamsSection() {
                this.updateExamStats();
                this.updateGradeDistribution();
                this.updateExamsList();
            },

            updateExamStats() {
                const elements = {
                    totalExams: document.getElementById('totalExams'),
                    totalCFU: document.getElementById('totalCFU'),
                    weightedAverage: document.getElementById('weightedAverage'),
                    projectedGrade: document.getElementById('projectedGrade')
                };

                if (APP.esami.length === 0) {
                    Object.values(elements).forEach(el => el && (el.textContent = '0'));
                    return;
                }

                let totalCFU = 0;
                let weightedSum = 0;

                APP.esami.forEach(esame => {
                    const materia = APP.materie.find(m => m.id === esame.materiaId);
                    if (materia) {
                        const cfu = materia.cfu;
                        totalCFU += cfu;
                        weightedSum += esame.voto * cfu;
                    }
                });

                const weightedAverage = totalCFU > 0 ? (weightedSum / totalCFU).toFixed(2) : 0;
                const projectedGrade = totalCFU > 0 ? Math.round((weightedSum / totalCFU) * 110 / 30) : 0;

                if (elements.totalExams) elements.totalExams.textContent = APP.esami.length;
                if (elements.totalCFU) elements.totalCFU.textContent = totalCFU;
                if (elements.weightedAverage) elements.weightedAverage.textContent = weightedAverage;
                if (elements.projectedGrade) elements.projectedGrade.textContent = projectedGrade;
            },

            updateGradeDistribution() {
                const container = document.getElementById('gradeDistribution');
                if (!container) return;

                if (APP.esami.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Completa alcuni esami per vedere la distribuzione!</p>
                        </div>
                    `;
                    return;
                }

                const distribution = {};
                APP.esami.forEach(esame => {
                    const grade = esame.lode ? '30L' : esame.voto.toString();
                    distribution[grade] = (distribution[grade] || 0) + 1;
                });

                const sortedGrades = Object.keys(distribution).sort((a, b) => {
                    if (a === '30L') return 1;
                    if (b === '30L') return -1;
                    return parseInt(a) - parseInt(b);
                });

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem;">
                        ${sortedGrades.map(grade => `
                            <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-light);">${grade}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${distribution[grade]} esami</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            updateExamsList() {
                const container = document.getElementById('examsList');
                if (!container) return;

                if (APP.esami.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun esame sostenuto ancora.</p>
                            <p>Marca una materia come "Esame Sostenuto" per iniziare!</p>
                        </div>
                    `;
                    return;
                }

                const sortedExams = APP.esami.sort((a, b) => {
                    const dateA = new Date(a.dataEsame || '1970-01-01');
                    const dateB = new Date(b.dataEsame || '1970-01-01');
                    return dateB - dateA;
                });

                container.innerHTML = sortedExams.map(esame => {
                    const materia = APP.materie.find(m => m.id === esame.materiaId);
                    if (!materia) return '';

                    return `
                        <div class="subject-item exam-completed">
                            <div class="subject-header">
                                <div class="subject-name">${materia.nome}</div>
                                <div class="subject-actions">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--success);">${esame.voto}${esame.lode ? 'L' : ''}</div>
                                    <button class="btn btn-warning btn-small" onclick="ExamManager.editExam(${materia.id})" title="Modifica esame"></button>
                                    <button class="btn btn-danger btn-small" onclick="ExamManager.deleteExam(${esame.id})" title="Elimina esame"></button>
                                </div>
                            </div>
                            <div class="subject-info">
                                <div><strong>CFU:</strong> ${materia.cfu}</div>
                                <div><strong>Data:</strong> ${esame.dataEsame ? new Date(esame.dataEsame).toLocaleDateString('it-IT') : 'Non specificata'}</div>
                                ${esame.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${esame.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            editExam(materiaId) {
                const materia = APP.materie.find(m => m.id === materiaId);
                const esame = APP.esami.find(e => e.materiaId === materiaId);
                
                if (!materia || !esame) {
                    Utils.showSuccessMessage(' Esame non trovato');
                    return;
                }

                APP.currentEditingExamId = esame.id;
                
                document.getElementById('editExamSubject').value = materia.nome;
                document.getElementById('editExamGrade').value = esame.voto;
                document.getElementById('editExamLode').checked = esame.lode || false;
                document.getElementById('editExamDate').value = esame.dataEsame || '';
                document.getElementById('editExamNotes').value = esame.note || '';
                
                document.getElementById('editExamModal').style.display = 'flex';
            },

            deleteExam(esameId) {
                const esame = APP.esami.find(e => e.id === esameId);
                if (!esame) return;

                const materia = APP.materie.find(m => m.id === esame.materiaId);
                if (!materia) return;

                const conferma = confirm(`Sei sicuro di voler eliminare l'esame di "${materia.nome}"?\n\nLa materia torner allo stato "In Studio".`);
                
                if (conferma) {
                    APP.esami = APP.esami.filter(e => e.id !== esameId);
                    materia.status = 'studio';
                    
                    this.saveEsami();
                    MaterieManager.saveMaterie();
                    MaterieManager.loadMaterie();
                    this.updateExamsSection();
                    
                    Utils.showSuccessMessage(' Esame eliminato con successo');
                }
            }
        };

        // === CURRICULUM MANAGER ===
        const CurriculumManager = {
            saveCurriculum() {
                try {
                    localStorage.setItem('curriculum', JSON.stringify(APP.curriculum));
                } catch (error) {
                    console.error('Errore nel salvataggio curriculum:', error);
                }
            },

            loadCurriculumData() {
                this.updateYearStats();
                this.loadYearSubjects();
            },

            updateYearStats() {
                for (let year = 1; year <= 3; year++) {
                    const yearSubjects = APP.curriculum.filter(s => s.anno === year);
                    const completedSubjects = yearSubjects.filter(s => s.completato);
                    
                    const totalCFU = yearSubjects.reduce((sum, s) => sum + (s.cfu || 0), 0);
                    const avgGrade = completedSubjects.length > 0 ? 
                        (completedSubjects.reduce((sum, s) => sum + (s.voto || 0), 0) / completedSubjects.length).toFixed(1) : 0;

                    const elements = {
                        subjects: document.getElementById(`year${year}-subjects`),
                        cfu: document.getElementById(`year${year}-cfu`),
                        completed: document.getElementById(`year${year}-completed`),
                        average: document.getElementById(`year${year}-average`)
                    };

                    if (elements.subjects) elements.subjects.textContent = yearSubjects.length;
                    if (elements.cfu) elements.cfu.textContent = totalCFU;
                    if (elements.completed) elements.completed.textContent = completedSubjects.length;
                    if (elements.average) elements.average.textContent = avgGrade;

                    // Aggiorna progresso semestri
                    for (let sem = 1; sem <= 2; sem++) {
                        const semSubjects = yearSubjects.filter(s => s.semestre === sem);
                        const semCompleted = semSubjects.filter(s => s.completato).length;
                        const progressEl = document.getElementById(`year${year}-sem${sem}-progress`);
                        if (progressEl) {
                            progressEl.textContent = `${semCompleted}/${semSubjects.length} esami`;
                        }
                    }
                }
            },

            loadYearSubjects() {
                for (let year = 1; year <= 3; year++) {
                    for (let sem = 1; sem <= 2; sem++) {
                        const container = document.getElementById(`year${year}-semester${sem}-subjects`);
                        if (!container) continue;

                        const subjects = APP.curriculum.filter(s => s.anno === year && s.semestre === sem);
                        
                        if (subjects.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <p>Nessuna materia aggiunta ancora</p>
                                </div>
                            `;
                            continue;
                        }

                        container.innerHTML = subjects.map(subject => `
                            <div class="curriculum-subject ${subject.completato ? 'completed' : ''}">
                                <div class="subject-header-curr">
                                    <div class="subject-name-curr">${subject.nome}</div>
                                    <div class="subject-actions-curr">
                                        ${subject.completato && subject.voto ? 
                                            `<span class="subject-grade">${subject.voto}${subject.lode ? 'L' : ''}</span>` : ''
                                        }
                                        <input type="checkbox" class="exam-checkbox" ${subject.completato ? 'checked' : ''} 
                                               onchange="CurriculumManager.toggleSubjectCompletion(${subject.id})" title="Esame sostenuto">
                                        <button class="btn btn-warning btn-small" onclick="CurriculumManager.editCurriculumSubject(${subject.id})" title="Modifica"></button>
                                        <button class="btn btn-danger btn-small" onclick="CurriculumManager.deleteCurriculumSubject(${subject.id})" title="Elimina"></button>
                                    </div>
                                </div>
                                <div class="subject-info-curr">
                                    <div><strong>CFU:</strong> ${subject.cfu}</div>
                                    ${subject.professore ? `<div><strong>Prof:</strong> ${subject.professore}</div>` : ''}
                                    ${subject.note ? `<div style="grid-column: 1 / -1;"><strong>Note:</strong> ${subject.note}</div>` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            },

            toggleSubjectCompletion(subjectId) {
                const subject = APP.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                if (!subject.completato) {
                    const voto = prompt(`Inserisci il voto per "${subject.nome}" (18-30):`);
                    if (voto === null) return;
                    
                    const votoNum = parseInt(voto);
                    if (isNaN(votoNum) || votoNum < 18 || votoNum > 30) {
                        alert('Voto non valido. Inserisci un numero tra 18 e 30.');
                        return;
                    }

                    const lode = votoNum === 30 ? confirm('Lode?') : false;
                    
                    subject.completato = true;
                    subject.voto = votoNum;
                    subject.lode = lode;
                    subject.dataCompletamento = new Date().toISOString().split('T')[0];
                } else {
                    subject.completato = false;
                    delete subject.voto;
                    delete subject.lode;
                    delete subject.dataCompletamento;
                }

                this.saveCurriculum();
                this.loadCurriculumData();
            },

            editCurriculumSubject(subjectId) {
                const subject = APP.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                APP.currentEditingCurriculumId = subjectId;
                
                document.getElementById('editCurrSubjectName').value = subject.nome;
                document.getElementById('editCurrSubjectYear').value = subject.anno;
                document.getElementById('editCurrSubjectSemester').value = subject.semestre;
                document.getElementById('editCurrSubjectCFU').value = subject.cfu;
                document.getElementById('editCurrSubjectProfessor').value = subject.professore || '';
                document.getElementById('editCurrSubjectNotes').value = subject.note || '';
                
                document.getElementById('editCurriculumModal').style.display = 'flex';
            },

            deleteCurriculumSubject(subjectId) {
                const subject = APP.curriculum.find(s => s.id === subjectId);
                if (!subject) return;

                const conferma = confirm(`Sei sicuro di voler eliminare "${subject.nome}" dal curriculum?`);
                
                if (conferma) {
                    APP.curriculum = APP.curriculum.filter(s => s.id !== subjectId);
                    this.saveCurriculum();
                    this.loadCurriculumData();
                    Utils.showSuccessMessage(' Materia eliminata dal curriculum');
                }
            }
        };

        // === TIMER POMODORO ===
        const Timer = {
            setPreset(work, breakTime, targetElement) {
                try {
                    if (APP.timerState.isRunning) return;
                    
                    APP.timerState.workTime = work;
                    APP.timerState.breakTime = breakTime;
                    APP.timerState.minutes = work;
                    APP.timerState.seconds = 0;
                    APP.timerState.isBreak = false;
                    
                    this.updateTimerDisplay();
                    
                    document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                    if (targetElement) {
                        targetElement.classList.add('active');
                    }
                } catch (error) {
                    console.error('Errore nel preset timer:', error);
                }
            },

            updateTimerDisplay() {
                const display = `${APP.timerState.minutes.toString().padStart(2, '0')}:${APP.timerState.seconds.toString().padStart(2, '0')}`;
                const timerDisplayEl = document.getElementById('timerDisplay');
                const focusTimerEl = document.getElementById('focusTimer');
                
                if (timerDisplayEl) timerDisplayEl.textContent = display;
                if (focusTimerEl) focusTimerEl.textContent = display;
                
                if (timerDisplayEl) {
                    timerDisplayEl.classList.toggle('break-mode', APP.timerState.isBreak);
                }
            },

            updateSessionDisplay() {
                const elements = {
                    sessionCount: document.getElementById('sessionCount'),
                    sessionGoal: document.getElementById('sessionGoal'),
                    sessionProgress: document.getElementById('sessionProgress'),
                    progressText: document.getElementById('progressText')
                };

                this.updateDailyGoalDisplay();
                
                if (elements.sessionCount) elements.sessionCount.textContent = APP.timerState.sessionsToday;
                if (elements.sessionGoal) elements.sessionGoal.textContent = APP.timerState.dailyGoal;
                
                if (elements.sessionProgress) {
                    const progress = Math.min(100, (APP.timerState.sessionsToday / APP.timerState.dailyGoal) * 100);
                    elements.sessionProgress.style.width = progress + '%';
                }
                
                if (elements.progressText) {
                    if (APP.timerState.sessionsToday === 0) {
                        elements.progressText.textContent = 'Inizia la tua prima sessione!';
                    } else if (APP.timerState.sessionsToday >= APP.timerState.dailyGoal) {
                        elements.progressText.textContent = ' Obiettivo raggiunto! Ottimo lavoro!';
                    } else {
                        const remaining = APP.timerState.dailyGoal - APP.timerState.sessionsToday;
                        elements.progressText.textContent = `Ancora ${remaining} sessioni per raggiungere l'obiettivo`;
                    }
                }
            },

            updateDailyGoalDisplay() {
                const goalInput = document.getElementById('dailyGoal');
                const sessionGoalEl = document.getElementById('sessionGoal');
                
                if (goalInput) goalInput.value = APP.timerState.dailyGoal;
                if (sessionGoalEl) sessionGoalEl.textContent = APP.timerState.dailyGoal;
            }
        };

        // === STAR RATING ===
        const StarRating = {
            setupStarRating() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.replaceWith(star.cloneNode(true));
                });
                
                const freshStars = document.querySelectorAll('.star');
                freshStars.forEach((star, index) => {
                    star.addEventListener('click', (e) => {
                        e.preventDefault();
                        APP.difficoltaSelezionata = parseInt(star.dataset.rating);
                        this.updateStarDisplay();
                    });

                    star.addEventListener('mouseover', () => {
                        const rating = parseInt(star.dataset.rating);
                        this.highlightStars(rating);
                    });
                    
                    star.addEventListener('mouseout', () => {
                        this.updateStarDisplay();
                    });
                });

                this.updateStarDisplay();
            },

            highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            },

            updateStarDisplay() {
                this.highlightStars(APP.difficoltaSelezionata);
            }
        };

        // === WEEKLY SLOTS ===
        const WeeklySlots = {
            initializeWeeklySlots() {
                const container = document.getElementById('weeklySlots');
                if (!container) return;
                
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const giorniLabel = ['Luned', 'Marted', 'Mercoled', 'Gioved', 'Venerd', 'Sabato', 'Domenica'];

                container.innerHTML = giorni.map((giorno, index) => `
                    <div class="day-slots">
                        <h4>${giorniLabel[index]}</h4>
                        <div class="time-slots" id="slots-${giorno}">
                            <button type="button" class="add-slot" onclick="WeeklySlots.addTimeSlot('${giorno}')">+ Aggiungi Slot</button>
                        </div>
                    </div>
                `).join('');
            },

            addTimeSlot(giorno) {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) return;
                
                const slotId = `${giorno}-${Date.now()}`;
                
                const slotHTML = `
                    <div class="slot-item" id="${slotId}">
                        <input type="time" value="09:00" onchange="WeeklySlots.validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                        <span style="color: var(--text-secondary); margin: 0 0.5rem;">-</span>
                        <input type="time" value="11:00" onchange="WeeklySlots.validateSlots('${giorno}')" style="margin-right: 0.5rem;">
                        <button type="button" class="remove-slot" onclick="WeeklySlots.removeTimeSlot('${slotId}', '${giorno}')" title="Rimuovi slot"></button>
                    </div>
                `;
                
                const addButton = container.querySelector('.add-slot');
                if (addButton) {
                    addButton.insertAdjacentHTML('beforebegin', slotHTML);
                }
            },

            removeTimeSlot(slotId, giorno) {
                const slot = document.getElementById(slotId);
                if (slot) {
                    slot.remove();
                    this.validateSlots(giorno);
                }
            },

            validateSlots(giorno) {
                const container = document.getElementById(`slots-${giorno}`);
                if (!container) return true;
                
                const slots = container.querySelectorAll('.slot-item');
                const timeRanges = [];
                let hasOverlap = false;

                slots.forEach(slot => {
                    const inputs = slot.querySelectorAll('input[type="time"]');
                    const start = inputs[0].value;
                    const end = inputs[1].value;
                    
                    inputs.forEach(input => {
                        input.style.borderColor = 'var(--border)';
                    });

                    if (start && end) {
                        if (start >= end) {
                            inputs.forEach(input => {
                                input.style.borderColor = 'var(--danger)';
                            });
                            hasOverlap = true;
                        } else {
                            timeRanges.push({ start, end, element: slot });
                        }
                    }
                });

                // Check overlaps
                for (let i = 0; i < timeRanges.length; i++) {
                    for (let j = i + 1; j < timeRanges.length; j++) {
                        const range1 = timeRanges[i];
                        const range2 = timeRanges[j];
                        
                        if (this.timeOverlap(range1.start, range1.end, range2.start, range2.end)) {
                            [range1, range2].forEach(range => {
                                range.element.querySelectorAll('input').forEach(input => {
                                    input.style.borderColor = 'var(--danger)';
                                });
                            });
                            hasOverlap = true;
                        }
                    }
                }

                return !hasOverlap;
            },

            timeOverlap(start1, end1, start2, end2) {
                return (start1 < end2) && (end1 > start2);
            },

            getWeeklySlots() {
                const giorni = ['lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato', 'domenica'];
                const slotSettimanali = {};

                giorni.forEach(giorno => {
                    const container = document.getElementById(`slots-${giorno}`);
                    if (!container) {
                        slotSettimanali[giorno] = [];
                        return;
                    }
                    
                    const slots = container.querySelectorAll('.slot-item');
                    slotSettimanali[giorno] = [];

                    slots.forEach(slot => {
                        const inputs = slot.querySelectorAll('input[type="time"]');
                        const start = inputs[0].value;
                        const end = inputs[1].value;
                        
                        if (start && end && start < end) {
                            slotSettimanali[giorno].push({
                                inizio: start,
                                fine: end,
                                disponibile: true
                            });
                        }
                    });
                });

                return slotSettimanali;
            }
        };

        // === TODAY SCHEDULER ===
        const TodayScheduler = {
            generateTodaySchedule() {
                if (APP.materie.length === 0) {
                    this.updateTodayDisplay(null, []);
                    return;
                }

                const oggi = new Date();
                const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
                
                const scheduleOggi = this.generateSmartSchedule(giornoSettimana);
                
                this.updateTodayDisplay(scheduleOggi.nextTask, scheduleOggi.timeline);
                this.updateMicroTasks(scheduleOggi.nextTask);
            },

            generateSmartSchedule(giornoSettimana) {
                const materieFiltrate = APP.materie.filter(materia => {
                    if (materia.status === 'completato') return false;
                    const slots = materia.slotSettimanali && materia.slotSettimanali[giornoSettimana];
                    return slots && slots.length > 0;
                });

                if (materieFiltrate.length === 0) {
                    return { nextTask: null, timeline: [] };
                }

                const timeline = [];
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                const materiePrioritarie = materieFiltrate.sort((a, b) => {
                    const priorityOrder = { 'alta': 3, 'media': 2, 'bassa': 1 };
                    return (priorityOrder[b.priorita] || 0) - (priorityOrder[a.priorita] || 0);
                });

                let nextTask = null;

                materiePrioritarie.forEach(materia => {
                    const slots = materia.slotSettimanali[giornoSettimana] || [];
                    
                    slots.forEach(slot => {
                        if (slot.disponibile) {
                            const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                            
                            const task = {
                                materia: materia.nome,
                                durata: durata,
                                orarioInizio: slot.inizio,
                                orarioFine: slot.fine,
                                difficolta: materia.difficolta,
                                pagineRimanenti: Math.max(0, materia.pagine - (materia.pagineStudiate || 0)),
                                percentualeCompletamento: ((materia.pagineStudiate || 0) / materia.pagine) * 100,
                                opzioni: this.generateTaskOptions(materia)
                            };

                            timeline.push(task);

                            if (!nextTask && slot.inizio > currentTime) {
                                nextTask = task;
                            }
                        }
                    });
                });

                if (!nextTask && timeline.length > 0) {
                    nextTask = timeline[0];
                }

                return { nextTask, timeline: timeline.sort((a, b) => a.orarioInizio.localeCompare(b.orarioInizio)) };
            },

            generateTaskOptions(materia) {
                const percentualeCompletamento = ((materia.pagineStudiate || 0) / materia.pagine) * 100;
                const options = [];

                if (percentualeCompletamento < 30) {
                    options.push({
                        id: 'concetti-base',
                        titulo: ' Concetti Base',
                        descrizione: 'Inizia con i fondamenti e le definizioni principali',
                        motivazione: 'Costruire basi solide  essenziale per il successo'
                    });
                    options.push({
                        id: 'primi-capitoli',
                        titulo: ' Primi Capitoli',
                        descrizione: 'Studio sequenziale dall\'inizio del programma',
                        motivazione: 'Approccio sistematico per una comprensione completa'
                    });
                }

                if (percentualeCompletamento >= 20) {
                    options.push({
                        id: 'approfondimento',
                        titulo: ' Approfondimento',
                        descrizione: 'Continua con gli argomenti pi complessi',
                        motivazione: 'Sviluppa una comprensione pi profonda della materia'
                    });
                    options.push({
                        id: 'esercizi',
                        titulo: ' Esercizi Pratici',
                        descrizione: 'Risolvi problemi ed esercizi applicativi',
                        motivazione: 'La pratica consolida la teoria appresa'
                    });
                }

                if (percentualeCompletamento >= 50) {
                    options.push({
                        id: 'ripasso',
                        titulo: ' Ripasso Generale',
                        descrizione: 'Rivedi e consolida gli argomenti gi studiati',
                        motivazione: 'Il ripasso rafforza la memoria a lungo termine'
                    });
                }

                options.push({
                    id: 'personalizzato',
                    titulo: ' Studio Personalizzato',
                    descrizione: 'Scegli tu cosa studiare in questa sessione',
                    motivazione: 'Tu conosci meglio le tue necessit del momento'
                });

                return options;
            },

            updateTodayDisplay(nextTask, timeline) {
                const elements = {
                    currentTaskMateria: document.getElementById('currentTaskMateria'),
                    currentTaskTime: document.getElementById('currentTaskTime'),
                    currentTaskDesc: document.getElementById('currentTaskDesc'),
                    currentTaskMotivation: document.getElementById('currentTaskMotivation'),
                    taskOptions: document.getElementById('taskOptions'),
                    taskOptionsList: document.getElementById('taskOptionsList'),
                    startTaskBtn: document.getElementById('startTaskBtn'),
                    timelineContainer: document.getElementById('timelineOggi')
                };

                if (!nextTask) {
                    elements.currentTaskMateria.textContent = 'Nessun task programmato';
                    elements.currentTaskTime.textContent = ' -- min';
                    elements.currentTaskDesc.textContent = 'Aggiungi slot temporali alle tue materie per vedere il piano giornaliero!';
                    elements.currentTaskMotivation.textContent = ' Definisci quando puoi studiare per ottimizzare la tua giornata';
                    elements.taskOptions.classList.add('hidden');
                    elements.startTaskBtn.disabled = true;
                    
                    elements.timelineContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi materie con slot temporali per vedere il piano giornaliero</p>
                        </div>
                    `;
                    return;
                }

                elements.currentTaskMateria.textContent = nextTask.materia;
                elements.currentTaskTime.textContent = ` ${nextTask.durata} min`;
                
                if (nextTask.opzioni && nextTask.opzioni.length > 0) {
                    elements.taskOptions.classList.remove('hidden');
                    elements.taskOptionsList.innerHTML = nextTask.opzioni.map(opzione => `
                        <button class="task-option-btn" onclick="TodayScheduler.selectTaskOption('${opzione.id}', '${nextTask.materia}', this)">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">${opzione.titulo}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${opzione.descrizione}</div>
                            <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 0.5rem;"> ${opzione.motivazione}</div>
                        </button>
                    `).join('');
                    
                    if (!APP.selectedTaskOption) {
                        this.selectTaskOption(nextTask.opzioni[0].id, nextTask.materia);
                    }
                } else {
                    elements.taskOptions.classList.add('hidden');
                }

                elements.startTaskBtn.disabled = false;

                if (timeline.length === 0) {
                    elements.timelineContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessun task programmato per oggi</p>
                        </div>
                    `;
                } else {
                    elements.timelineContainer.innerHTML = timeline.map(task => `
                        <div class="timeline-item">
                            <div class="timeline-time">${task.orarioInizio}</div>
                            <div class="timeline-content">
                                <strong>${task.materia}</strong><br>
                                <span style="opacity: 0.8;">Slot di studio programmato</span><br>
                                <small style="color: var(--secondary);">${task.durata} min  ${Math.round(task.percentualeCompletamento)}% completato</small>
                            </div>
                        </div>
                    `).join('');
                }
            },

            selectTaskOption(optionId, materia, clickedElement) {
                APP.selectedTaskOption = optionId;
                APP.currentSessionData = { materia: materia, option: optionId };
                
                document.querySelectorAll('.task-option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                if (clickedElement) {
                    clickedElement.classList.add('selected');
                } else {
                    const buttons = document.querySelectorAll('.task-option-btn');
                    buttons.forEach(btn => {
                        if (btn.onclick && btn.onclick.toString().includes(optionId)) {
                            btn.classList.add('selected');
                        }
                    });
                }
                
                const currentTask = this.getCurrentNextTask();
                if (currentTask && currentTask.opzioni) {
                    const selectedOption = currentTask.opzioni.find(opt => opt.id === optionId);
                    if (selectedOption) {
                        document.getElementById('currentTaskDesc').textContent = selectedOption.descrizione;
                        document.getElementById('currentTaskMotivation').textContent = ` ${selectedOption.motivazione}`;
                    }
                }
            },

            updateMicroTasks(nextTask) {
                const microTasksContainer = document.getElementById('microTasks');
                const microTasksList = document.getElementById('microTasksList');

                if (!nextTask) {
                    microTasksContainer.classList.add('hidden');
                    return;
                }

                const tasks = APP.universalMicroTasks.slice(0, 4);
                microTasksContainer.classList.remove('hidden');
                
                microTasksList.innerHTML = tasks.map(task => `
                    <div class="micro-task-item" onclick="TodayScheduler.startMicroTask('${task.text}', ${task.durata}, this)">
                        <div>${task.text}</div>
                        <div class="micro-task-duration">${task.durata} min</div>
                    </div>
                `).join('');
            },

            startMicroTask(taskText, durata, clickedElement) {
                APP.currentSessionData = { materia: 'Micro-task', option: taskText };
                setPreset(durata, Math.max(2, Math.floor(durata / 5)), null);
                Utils.showSuccessMessage(` Micro-task avviato: ${taskText}`);
                
                if (clickedElement) {
                    document.querySelectorAll('.micro-task-item').forEach(item => {
                        item.style.transform = 'translateX(0)';
                        item.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                    });
                    clickedElement.style.transform = 'translateX(8px)';
                    clickedElement.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
                }
                
                startTimer();
            },

            getCurrentNextTask() {
                const oggi = new Date();
                const giornoSettimana = ['domenica', 'lunedi', 'martedi', 'mercoledi', 'giovedi', 'venerdi', 'sabato'][oggi.getDay()];
                const schedule = this.generateSmartSchedule(giornoSettimana);
                return schedule.nextTask;
            }
        };

        // === AGGIUNGE MATERIA CON COLLEGAMENTO CURRICULUM ===
        function addMateria() {
            try {
                const nome = document.getElementById('nomeMateria').value.trim();
                const cfu = parseInt(document.getElementById('cfu').value);
                const anno = parseInt(document.getElementById('anno').value);
                const semestre = parseInt(document.getElementById('semestre').value);
                const pagine = parseInt(document.getElementById('pagine').value);
                const pagineStudiate = parseInt(document.getElementById('pagineStudiate').value) || 0;
                const pagineOra = parseInt(document.getElementById('pagineOra').value) || 8;
                const eserciziTotali = parseInt(document.getElementById('eserciziTotali').value) || 0;
                const eserciziCompletati = parseInt(document.getElementById('eserciziCompletati').value) || 0;
                const dataEsame = document.getElementById('dataEsame').value;
                const priorita = document.getElementById('priorita').value;

                if (!nome || !cfu || !anno || !semestre || !pagine) {
                    Utils.showSuccessMessage(' Compila tutti i campi obbligatori');
                    return;
                }

                if (pagineStudiate > pagine) {
                    Utils.showSuccessMessage(' Le pagine studiate non possono essere superiori al totale');
                    return;
                }

                if (eserciziCompletati > eserciziTotali) {
                    Utils.showSuccessMessage(' Gli esercizi completati non possono essere superiori al totale');
                    return;
                }

                const slotSettimanali = WeeklySlots.getWeeklySlots();
                let hasSlots = false;
                Object.values(slotSettimanali).forEach(slots => {
                    if (slots.length > 0) hasSlots = true;
                });

                if (!hasSlots) {
                    const conferma = confirm('Non hai definito slot temporali per questa materia. Vuoi continuare comunque?');
                    if (!conferma) return;
                }

                const nuovaMateria = {
                    id: Date.now(),
                    nome,
                    cfu,
                    anno,
                    semestre,
                    pagine,
                    pagineStudiate,
                    pagineOra,
                    eserciziTotali,
                    eserciziCompletati,
                    dataEsame,
                    priorita,
                    difficolta: APP.difficoltaSelezionata,
                    slotSettimanali,
                    status: 'studio',
                    dataCreazione: new Date().toISOString()
                };

                APP.materie.push(nuovaMateria);
                MaterieManager.saveMaterie();
                
                // *** CORREZIONE PROBLEMA 1: Collegamento automatico con Curriculum ***
                // Aggiungi automaticamente al curriculum se non esiste gi
                const existingCurrSubject = APP.curriculum.find(c => 
                    c.nome === nome && c.anno === anno && c.semestre === semestre
                );
                
                if (!existingCurrSubject) {
                    const curriculumSubject = {
                        id: Date.now() + 1,
                        nome: nome,
                        anno: anno,
                        semestre: semestre,
                        cfu: cfu,
                        professore: '',
                        note: 'Aggiunta automaticamente dalla sezione Materie',
                        completato: false,
                        dataCreazione: new Date().toISOString()
                    };
                    
                    APP.curriculum.push(curriculumSubject);
                    CurriculumManager.saveCurriculum();
                }
                
                MaterieManager.loadMaterie();
                
                // Reset form
                document.getElementById('nomeMateria').value = '';
                document.getElementById('cfu').value = '';
                document.getElementById('anno').value = '';
                document.getElementById('semestre').value = '';
                document.getElementById('pagine').value = '';
                document.getElementById('pagineStudiate').value = '0';
                document.getElementById('pagineOra').value = '8';
                document.getElementById('eserciziTotali').value = '0';
                document.getElementById('eserciziCompletati').value = '0';
                document.getElementById('dataEsame').value = '';
                document.getElementById('priorita').value = 'media';
                APP.difficoltaSelezionata = 3;
                
                WeeklySlots.initializeWeeklySlots();
                StarRating.setupStarRating();
                
                // Aggiorna tutte le sezioni collegate
                TodayScheduler.generateTodaySchedule();
                PianoStudio.generatePianoStudio(); // *** CORREZIONE PROBLEMA 2 ***
                CurriculumManager.loadCurriculumData();
                
                Utils.showSuccessMessage(' Materia aggiunta con successo e collegata al curriculum!');
                
            } catch (error) {
                console.error('Errore nell\'aggiunta materia:', error);
                Utils.showSuccessMessage(' Errore nell\'aggiunta della materia');
            }
        }

        function setPreset(work, breakTime, targetElement) {
            Timer.setPreset(work, breakTime, targetElement);
        }

        function startTimer() {
            if (APP.timerState.isRunning) return;
            
            APP.timerState.isRunning = true;
            APP.currentSessionStartTime = new Date();
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.add('hidden');
            if (pauseBtn) pauseBtn.classList.remove('hidden');
            
            APP.timerInterval = setInterval(() => {
                if (APP.timerState.seconds === 0) {
                    if (APP.timerState.minutes === 0) {
                        clearInterval(APP.timerInterval);
                        completeSession();
                        return;
                    } else {
                        APP.timerState.minutes--;
                        APP.timerState.seconds = 59;
                    }
                } else {
                    APP.timerState.seconds--;
                }
                
                Timer.updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            if (!APP.timerState.isRunning) return;
            
            APP.timerState.isRunning = false;
            clearInterval(APP.timerInterval);
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
        }

        function resetTimer() {
            APP.timerState.isRunning = false;
            clearInterval(APP.timerInterval);
            
            APP.timerState.minutes = APP.timerState.workTime;
            APP.timerState.seconds = 0;
            APP.timerState.isBreak = false;
            
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            Timer.updateTimerDisplay();
        }

        function completeSession() {
            APP.timerState.isRunning = false;
            
            if (!APP.timerState.isBreak) {
                // *** CORREZIONE PROBLEMA 3: Conteggio sessioni corretto ***
                APP.timerState.sessionsToday++;
                APP.studyData.totalSessions++;
                
                // Aggiorna streak
                const today = new Date().toDateString();
                if (APP.studyData.lastStudyDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (APP.studyData.lastStudyDate === yesterday.toDateString()) {
                        APP.studyData.streak++;
                    } else {
                        APP.studyData.streak = 1;
                    }
                    APP.studyData.lastStudyDate = today;
                }
                
                // Salva dati
                localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
                localStorage.setItem('lastSessionDate', today);
                localStorage.setItem('studyStreak', APP.studyData.streak);
                localStorage.setItem('lastStudyDate', APP.studyData.lastStudyDate);
                localStorage.setItem('totalSessions', APP.studyData.totalSessions);
                
                // Aggiorna display
                Timer.updateSessionDisplay();
                updateStreakDisplay();
                
                // Mostra modal rating
                showRatingModal();
                
                // Avvia pausa se configurata
                if (APP.timerState.breakTime > 0) {
                    setTimeout(() => {
                        APP.timerState.isBreak = true;
                        APP.timerState.minutes = APP.timerState.breakTime;
                        APP.timerState.seconds = 0;
                        Timer.updateTimerDisplay();
                        Utils.showSuccessMessage(' Inizia la tua pausa!');
                    }, 2000);
                }
            } else {
                // Pausa completata
                APP.timerState.isBreak = false;
                APP.timerState.minutes = APP.timerState.workTime;
                APP.timerState.seconds = 0;
                Timer.updateTimerDisplay();
                Utils.showSuccessMessage(' Pausa finita! Torna al lavoro!');
            }
            
            resetTimer();
        }

        function showRatingModal() {
            document.getElementById('ratingModal').style.display = 'flex';
        }

        function submitRating(rating) {
            const sessionNote = document.getElementById('sessionNote').value || '';
            const today = new Date().toDateString();
            const hour = new Date().getHours();
            
            // Salva rating
            if (!APP.sessionRatings[today]) {
                APP.sessionRatings[today] = {};
            }
            if (!APP.sessionRatings[today][hour]) {
                APP.sessionRatings[today][hour] = [];
            }
            
            const sessionData = {
                rating: rating,
                note: sessionNote,
                materia: APP.currentSessionData?.materia || 'Sessione generica',
                option: APP.currentSessionData?.option || '',
                timestamp: new Date().toISOString(),
                duration: APP.timerState.workTime
            };
            
            APP.sessionRatings[today][hour].push(sessionData);
            localStorage.setItem('sessionRatings', JSON.stringify(APP.sessionRatings));
            
            // *** CORREZIONE PROBLEMA 3: Aggiungi alla lista sessioni dettagliate ***
            APP.todayDetailedSessions.push(sessionData);
            localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
            
            // Chiudi modal
            document.getElementById('ratingModal').style.display = 'none';
            document.getElementById('sessionNote').value = '';
            
            // Aggiorna liste
            Sessions.updateTodaySessionsList();
            
            // Messaggio in base al rating
            const messages = [
                ' Riposa un po\' e riprova pi tardi!',
                ' Buon lavoro! La prossima andr meglio!',
                ' Ottimo lavoro! Continua cos!',
                ' Fantastico! Sei in zona di massima produttivit!'
            ];
            
            Utils.showSuccessMessage(messages[rating - 1]);
        }

        function updateStreakDisplay() {
            const streakEl = document.getElementById('streakNumber');
            if (streakEl) {
                streakEl.textContent = APP.studyData.streak;
            }
        }

        function updateDailyGoal() {
            const goalValue = parseInt(document.getElementById('dailyGoal').value);
            if (goalValue && goalValue > 0 && goalValue <= 20) {
                APP.timerState.dailyGoal = goalValue;
                localStorage.setItem('dailyGoal', goalValue);
                Timer.updateSessionDisplay();
            }
        }

        function toggleFocusMode() {
            const focusMode = document.getElementById('focusMode');
            if (focusMode.style.display === 'flex') {
                focusMode.style.display = 'none';
            } else {
                focusMode.style.display = 'flex';
            }
        }

        function iniziaTask() {
            if (!APP.selectedTaskOption) {
                Utils.showSuccessMessage(' Seleziona prima cosa vuoi studiare');
                return;
            }
            
            startTimer();
            Utils.showSuccessMessage(' Sessione di studio iniziata!');
        }

        function showCustomTimerDialog() {
            document.getElementById('customTimerModal').style.display = 'flex';
        }

        function closeCustomTimerModal() {
            document.getElementById('customTimerModal').style.display = 'none';
        }

        function applyCustomTimer() {
            const workTime = parseInt(document.getElementById('customWorkTime').value);
            const breakTime = parseInt(document.getElementById('customBreakTime').value);
            
            if (workTime && breakTime && workTime > 0 && breakTime > 0) {
                Timer.setPreset(workTime, breakTime, null);
                closeCustomTimerModal();
                Utils.showSuccessMessage(' Timer personalizzato applicato!');
            } else {
                Utils.showSuccessMessage(' Inserisci valori validi');
            }
        }

        // === SESSIONS MANAGER ===
        const Sessions = {
            updateTodaySessionsList() {
                const container = document.getElementById('todaySessionsList');
                if (!container) return;
                
                // Reset sessioni giornaliere se  un nuovo giorno
                const today = new Date().toDateString();
                if (APP.timerState.lastSessionDate !== today) {
                    APP.timerState.sessionsToday = 0;
                    APP.todayDetailedSessions = [];
                    localStorage.setItem('sessionsToday', 0);
                    localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                }
                
                if (APP.todayDetailedSessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna sessione completata oggi.</p>
                            <p>Avvia una sessione per iniziare!</p>
                        </div>
                    `;
                    return;
                }
                
                const sortedSessions = APP.todayDetailedSessions.sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                container.innerHTML = sortedSessions.map((session, index) => {
                    const time = new Date(session.timestamp).toLocaleTimeString('it-IT', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const ratingEmojis = ['', '', '', ''];
                    const ratingStars = ''.repeat(session.rating) + ''.repeat(4 - session.rating);
                    
                    return `
                        <div class="session-item">
                            <div class="session-info">
                                <div class="session-time">${time}</div>
                                <div class="session-materia">${session.materia}</div>
                                <div class="session-note">${session.note || session.option || ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="session-rating">
                                    <span style="font-size: 1.2rem;">${ratingEmojis[session.rating - 1]}</span>
                                    <small style="color: var(--text-secondary);">${ratingStars}</small>
                                </div>
                                <div class="session-actions">
                                    <button class="btn btn-danger btn-small" onclick="Sessions.deleteSession(${index})" title="Elimina sessione"></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            deleteSession(index) {
                if (confirm('Sei sicuro di voler eliminare questa sessione?')) {
                    APP.todayDetailedSessions.splice(index, 1);
                    APP.timerState.sessionsToday = Math.max(0, APP.timerState.sessionsToday - 1);
                    
                    localStorage.setItem('todayDetailedSessions', JSON.stringify(APP.todayDetailedSessions));
                    localStorage.setItem('sessionsToday', APP.timerState.sessionsToday);
                    
                    this.updateTodaySessionsList();
                    Timer.updateSessionDisplay();
                    Utils.showSuccessMessage(' Sessione eliminata');
                }
            }
        };

        function showDeleteAllTodaySessionsModal() {
            if (APP.todayDetailedSessions.length === 0) {
                Utils.showSuccessMessage(' Non ci sono sessioni da eliminare');
                return;
            }
            
            const conferma = confirm(`Sei sicuro di voler eliminare tutte le ${APP.todayDetailedSessions.length} sessioni di oggi?\n\nQuesta azione non pu essere annullata.`);
            
            if (conferma) {
                APP.todayDetailedSessions = [];
                APP.timerState.sessionsToday = 0;
                
                localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                localStorage.setItem('sessionsToday', 0);
                
                Sessions.updateTodaySessionsList();
                Timer.updateSessionDisplay();
                Utils.showSuccessMessage(' Tutte le sessioni di oggi sono state eliminate');
            }
        }

        // === CALENDAR MANAGER ===
        const Calendar = {
            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                
                if (!grid || !monthYearEl) return;
                
                const year = APP.currentCalendarDate.getFullYear();
                const month = APP.currentCalendarDate.getMonth();
                
                monthYearEl.textContent = new Date(year, month).toLocaleDateString('it-IT', {
                    month: 'long',
                    year: 'numeric'
                });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);
                
                grid.innerHTML = '';
                
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayEl = this.createDayElement(date, month);
                    grid.appendChild(dayEl);
                }
                
                this.updateMonthStats();
            },
            
            createDayElement(date, currentMonth) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                const dateStr = date.toDateString();
                const today = new Date().toDateString();
                
                if (date.getMonth() !== currentMonth) {
                    dayEl.classList.add('other-month');
                }
                
                if (dateStr === today) {
                    dayEl.classList.add('today');
                }
                
                const sessions = this.getSessionsForDate(dateStr);
                if (sessions.length > 0) {
                    dayEl.classList.add('has-sessions');
                }
                
                dayEl.innerHTML = `
                    <div class="calendar-day-number">${date.getDate()}</div>
                    <div class="calendar-sessions">
                        ${sessions.slice(0, 3).map(session => 
                            `<div class="calendar-session-dot session-${session.type}"></div>`
                        ).join('')}
                    </div>
                    ${sessions.length > 0 ? 
                        `<div class="calendar-session-count">${sessions.length} sessioni</div>` : ''
                    }
                `;
                
                dayEl.addEventListener('click', () => this.showDayDetail(dateStr, sessions));
                
                return dayEl;
            },
            
            getSessionsForDate(dateStr) {
                const sessions = [];
                
                // Sessioni dal rating system
                if (APP.sessionRatings[dateStr]) {
                    Object.keys(APP.sessionRatings[dateStr]).forEach(hour => {
                        APP.sessionRatings[dateStr][hour].forEach(session => {
                            sessions.push({
                                ...session,
                                type: 'completed',
                                hour: parseInt(hour)
                            });
                        });
                    });
                }
                
                // Sessioni manuali dal calendar
                if (APP.calendarSessions[dateStr]) {
                    APP.calendarSessions[dateStr].forEach(session => {
                        sessions.push({
                            ...session,
                            type: 'manual'
                        });
                    });
                }
                
                return sessions.sort((a, b) => (a.hour || 0) - (b.hour || 0));
            },
            
            showDayDetail(dateStr, sessions) {
                const modal = document.getElementById('dayDetailModal');
                const title = document.getElementById('dayDetailTitle');
                const content = document.getElementById('dayDetailContent');
                
                const date = new Date(dateStr);
                title.textContent = ` ${date.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                })}`;
                
                if (sessions.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna sessione in questo giorno</p>
                        </div>
                    `;
                } else {
                    const totalMinutes = sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                    const avgRating = sessions.filter(s => s.rating).length > 0 ? 
                        sessions.filter(s => s.rating).reduce((sum, s) => sum + s.rating, 0) / sessions.filter(s => s.rating).length : 0;
                    
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-light);">${sessions.length}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">Sessioni</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary);">${Math.round(totalMinutes / 60 * 10) / 10}h</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">Tempo Totale</div>
                            </div>
                            ${avgRating > 0 ? `
                            <div style="text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${avgRating.toFixed(1)}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">Rating Medio</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <h4 style="margin-bottom: 1rem;"> Dettaglio Sessioni:</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${sessions.map(session => {
                                const time = session.hour !== undefined ? 
                                    `${session.hour.toString().padStart(2, '0')}:00` : 
                                    (session.timestamp ? new Date(session.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'N/A');
                                
                                const ratingEmojis = ['', '', '', ''];
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.5rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                                        <div>
                                            <div style="font-weight: 600; color: var(--primary-light);">${time} - ${session.materia || 'Sessione generica'}</div>
                                            ${session.note ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">${session.note}</div>` : ''}
                                            ${session.option ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${session.option}</div>` : ''}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.2rem;">${session.rating ? ratingEmojis[session.rating - 1] : ''}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${session.duration || 25}min</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                modal.style.display = 'flex';
            },
            
            updateMonthStats() {
                const year = APP.currentCalendarDate.getFullYear();
                const month = APP.currentCalendarDate.getMonth();
                
                let totalSessions = 0;
                let totalMinutes = 0;
                let activeDays = new Set();
                
                // Analizza tutto il mese
                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toDateString();
                    const sessions = this.getSessionsForDate(dateStr);
                    
                    if (sessions.length > 0) {
                        totalSessions += sessions.length;
                        totalMinutes += sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                        activeDays.add(day);
                    }
                }
                
                const avgSessionsPerDay = activeDays.size > 0 ? Math.round(totalSessions / activeDays.size * 10) / 10 : 0;
                
                const elements = {
                    monthSessions: document.getElementById('monthSessions'),
                    monthHours: document.getElementById('monthHours'),
                    monthDays: document.getElementById('monthDays'),
                    monthAverage: document.getElementById('monthAverage')
                };
                
                if (elements.monthSessions) elements.monthSessions.textContent = totalSessions;
                if (elements.monthHours) elements.monthHours.textContent = `${Math.round(totalMinutes / 60 * 10) / 10}h`;
                if (elements.monthDays) elements.monthDays.textContent = activeDays.size;
                if (elements.monthAverage) elements.monthAverage.textContent = avgSessionsPerDay;
            }
        };

        function changeMonth(direction) {
            APP.currentCalendarDate.setMonth(APP.currentCalendarDate.getMonth() + direction);
            Calendar.renderCalendar();
        }

        function goToToday() {
            APP.currentCalendarDate = new Date();
            Calendar.renderCalendar();
        }

        function addManualSession() {
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            
            // Popola select materie
            const select = document.getElementById('sessionMateria');
            select.innerHTML = '<option value="">Sessione generica</option>';
            APP.materie.forEach(materia => {
                if (materia.status !== 'completato') {
                    select.innerHTML += `<option value="${materia.nome}">${materia.nome}</option>`;
                }
            });
            
            document.getElementById('addSessionModal').style.display = 'flex';
        }

        function closeAddSessionModal() {
            document.getElementById('addSessionModal').style.display = 'none';
        }

        function saveManualSession() {
            const date = document.getElementById('sessionDate').value;
            const materia = document.getElementById('sessionMateria').value || 'Sessione generica';
            const duration = parseInt(document.getElementById('sessionDuration').value) || 25;
            const note = document.getElementById('manualSessionNote').value || '';
            
            if (!date) {
                Utils.showSuccessMessage(' Seleziona una data');
                return;
            }
            
            const dateStr = new Date(date).toDateString();
            
            if (!APP.calendarSessions[dateStr]) {
                APP.calendarSessions[dateStr] = [];
            }
            
            APP.calendarSessions[dateStr].push({
                id: Date.now(),
                materia,
                duration,
                note,
                timestamp: new Date(date).toISOString(),
                type: 'manual'
            });
            
            localStorage.setItem('calendarSessions', JSON.stringify(APP.calendarSessions));
            
            closeAddSessionModal();
            Calendar.renderCalendar();
            Utils.showSuccessMessage(' Sessione aggiunta al calendario!');
        }

        function closeDayDetailModal() {
            document.getElementById('dayDetailModal').style.display = 'none';
        }

        // === STATISTICS ===
        const Statistics = {
            updateStatistiche() {
                const container = document.getElementById('statisticheContent');
                if (!container) return;
                
                if (APP.materie.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Nessuna statistica disponibile.</p>
                            <p>Aggiungi delle materie per vedere i tuoi progressi!</p>
                        </div>
                    `;
                    return;
                }
                
                const stats = this.calculateStats();
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);">${stats.totalSubjects}</div>
                            <div class="stat-label">Materie Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);">${stats.completedSubjects}</div>
                            <div class="stat-label">Materie Completate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);">${stats.totalPages}</div>
                            <div class="stat-label">Pagine Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--secondary);">${stats.studiedPages}</div>
                            <div class="stat-label">Pagine Studiate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent);">${stats.weeklyHours}h</div>
                            <div class="stat-label">Ore Settimanali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary-light);">${stats.avgProgress}%</div>
                            <div class="stat-label">Progresso Medio</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Progresso per Materia</h4>
                        ${APP.materie.filter(m => m.status !== 'completato').map(materia => {
                            const progress = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                            return `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 600;">${materia.nome}</span>
                                        <span style="color: var(--secondary); font-weight: 600;">${progress}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                    <small style="color: var(--text-secondary);">${materia.pagineStudiate || 0}/${materia.pagine} pagine</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            calculateStats() {
                const totalSubjects = APP.materie.length;
                const completedSubjects = APP.materie.filter(m => m.status === 'completato').length;
                const totalPages = APP.materie.reduce((sum, m) => sum + m.pagine, 0);
                const studiedPages = APP.materie.reduce((sum, m) => sum + (m.pagineStudiate || 0), 0);
                
                let weeklyHours = 0;
                APP.materie.forEach(materia => {
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                weeklyHours += Utils.calculateTaskDuration(slot.inizio, slot.fine);
                            });
                        });
                    }
                });
                weeklyHours = Math.round(weeklyHours / 60 * 10) / 10;
                
                const avgProgress = totalPages > 0 ? Math.round((studiedPages / totalPages) * 100) : 0;
                
                return {
                    totalSubjects,
                    completedSubjects,
                    totalPages,
                    studiedPages,
                    weeklyHours,
                    avgProgress
                };
            }
        };

        // === HEATMAP ===
        const Heatmap = {
            initializeHeatmap() {
                const heatmapGrid = document.getElementById('heatmapGrid');
                if (!heatmapGrid) return;
                
                heatmapGrid.innerHTML = '';
                
                for (let hour = 0; hour < 24; hour++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell empty';
                    cell.textContent = hour.toString().padStart(2, '0');
                    cell.dataset.hour = hour;
                    
                    cell.addEventListener('mouseenter', (e) => this.showHeatmapTooltip(e, hour));
                    cell.addEventListener('mouseleave', this.hideHeatmapTooltip);
                    
                    heatmapGrid.appendChild(cell);
                }
                
                this.updateHeatmap();
            },

            updateHeatmap() {
                const cells = document.querySelectorAll('.heatmap-cell');
                
                cells.forEach((cell, hour) => {
                    const avgRating = this.calculateHourlyAverageRating(hour);
                    
                    cell.className = 'heatmap-cell';
                    
                    if (avgRating === 0) {
                        cell.classList.add('empty');
                    } else if (avgRating <= 1.5) {
                        cell.classList.add('low');
                    } else if (avgRating <= 2.5) {
                        cell.classList.add('medium');
                    } else if (avgRating <= 3.5) {
                        cell.classList.add('high');
                    } else {
                        cell.classList.add('very-high');
                    }
                });
            },

            calculateHourlyAverageRating(hour) {
                let totalRating = 0;
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                Object.keys(APP.sessionRatings).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date >= thirtyDaysAgo && APP.sessionRatings[dateKey][hour]) {
                        APP.sessionRatings[dateKey][hour].forEach(session => {
                            totalRating += session.rating;
                            sessionCount++;
                        });
                    }
                });
                
                return sessionCount > 0 ? totalRating / sessionCount : 0;
            },

            getHourlySessionCount(hour) {
                let sessionCount = 0;
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                Object.keys(APP.sessionRatings).forEach(dateKey => {
                    const date = new Date(dateKey);
                    if (date >= thirtyDaysAgo && APP.sessionRatings[dateKey][hour]) {
                        sessionCount += APP.sessionRatings[dateKey][hour].length;
                    }
                });
                
                return sessionCount;
            },

            showHeatmapTooltip(event, hour) {
                const tooltip = document.getElementById('heatmapTooltip');
                if (!tooltip) return;
                
                const avgRating = this.calculateHourlyAverageRating(hour);
                const sessionCount = this.getHourlySessionCount(hour);
                
                let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
                
                if (sessionCount === 0) {
                    content += 'Nessuna sessione registrata';
                } else {
                    const ratingText = avgRating <= 1.5 ? 'Bassa' : 
                                     avgRating <= 2.5 ? 'Media' : 
                                     avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    content += `Produttivit: ${ratingText}<br>`;
                    content += `${sessionCount} sessioni<br>`;
                    content += `Rating medio: ${avgRating.toFixed(1)}/4`;
                }
                
                tooltip.innerHTML = content;
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY - 10 + 'px';
                tooltip.classList.add('show');
            },

            hideHeatmapTooltip() {
                const tooltip = document.getElementById('heatmapTooltip');
                if (tooltip) {
                    tooltip.classList.remove('show');
                }
            }
        };

        // === PRODUCTIVITY ANALYZER ===
        const ProductivityAnalyzer = {
            updateProductivitySection() {
                this.updateTopHours();
                this.updateProductivitySuggestion();
            },

            updateTopHours() {
                const topHoursGrid = document.getElementById('topHoursGrid');
                if (!topHoursGrid) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = Heatmap.calculateHourlyAverageRating(hour);
                    const sessionCount = Heatmap.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const top3 = hourlyRatings.slice(0, 3);
                
                if (top3.length === 0) {
                    topHoursGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                            <p>Completa alcune sessioni per scoprire i tuoi orari migliori!</p>
                        </div>
                    `;
                    return;
                }
                
                topHoursGrid.innerHTML = top3.map((hour, index) => {
                    const ratingText = hour.avgRating <= 1.5 ? 'Bassa' : 
                                      hour.avgRating <= 2.5 ? 'Media' : 
                                      hour.avgRating <= 3.5 ? 'Alta' : 'Eccellente';
                    
                    const rankEmojis = ['', '', ''];
                    
                    return `
                        <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; text-align: center; border: 2px solid var(--border); transition: all 0.3s ease; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--success), var(--secondary));"></div>
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success); margin-bottom: 0.5rem;">${rankEmojis[index]}</div>
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-light); margin-bottom: 0.5rem;">${hour.hour}:00 - ${hour.hour + 1}:00</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                ${ratingText} (${hour.avgRating.toFixed(1)}/4)<br>
                                <small style="color: var(--text-muted);">${hour.sessionCount} sessioni</small>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateProductivitySuggestion() {
                const suggestionEl = document.getElementById('productivitySuggestion');
                if (!suggestionEl) return;
                
                const hourlyRatings = [];
                for (let hour = 0; hour < 24; hour++) {
                    const avgRating = Heatmap.calculateHourlyAverageRating(hour);
                    const sessionCount = Heatmap.getHourlySessionCount(hour);
                    
                    if (sessionCount > 0) {
                        hourlyRatings.push({
                            hour: hour,
                            avgRating: avgRating,
                            sessionCount: sessionCount
                        });
                    }
                }
                
                if (hourlyRatings.length === 0) {
                    suggestionEl.innerHTML = `
                        <h4 style="color: var(--primary-light); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;"> Suggerimento Smart</h4>
                        <p style="color: var(--text-primary); line-height: 1.6;">Aggiungi delle sessioni di studio per scoprire i tuoi momenti pi produttivi!</p>
                    `;
                    return;
                }
                
                hourlyRatings.sort((a, b) => b.avgRating - a.avgRating);
                const bestHour = hourlyRatings[0];
                const worstHour = hourlyRatings[hourlyRatings.length - 1];
                
                let suggestion = '';
                
                if (bestHour.avgRating >= 3.5) {
                    suggestion = ` Ottimo! Il tuo momento migliore  alle ${bestHour.hour}:00 con un rating di ${bestHour.avgRating.toFixed(1)}/4. Cerca di programmare le materie pi difficili in questo orario.`;
                } else if (bestHour.avgRating >= 2.5) {
                    suggestion = ` Il tuo orario pi produttivo  alle ${bestHour.hour}:00. Prova a ottimizzare questo slot con pause regolari e un ambiente di studio ideale.`;
                } else {
                    suggestion = ` Serve pi pratica! Il tuo orario migliore  alle ${bestHour.hour}:00, ma puoi migliorare. Sperimenta con diverse tecniche di studio.`;
                }
                
                if (worstHour.avgRating < 2 && hourlyRatings.length > 3) {
                    suggestion += ` Evita di studiare alle ${worstHour.hour}:00 quando possibile.`;
                }
                
                suggestionEl.innerHTML = `
                    <h4 style="color: var(--primary-light); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;"> Suggerimento Smart</h4>
                    <p style="color: var(--text-primary); line-height: 1.6;">${suggestion}</p>
                `;
            }
        };

        // === PIANO DI STUDIO INTELLIGENTE ===
        const PianoStudio = {
            generatePianoStudio() {
                try {
                    const materieInStudio = APP.materie.filter(m => m.status !== 'completato');
                    
                    if (materieInStudio.length === 0) {
                        this.showEmptyPlanState();
                        return;
                    }

                    const planMetrics = this.calculatePlanMetrics(materieInStudio);
                    this.updatePlanOverview(planMetrics);
                    this.generateAISuggestions(materieInStudio, planMetrics);
                    this.generatePlanDetails(materieInStudio); // *** CORREZIONE PROBLEMA 2 ***
                    
                } catch (error) {
                    console.error('Errore nella generazione del piano:', error);
                    this.showErrorPlanState();
                }
            },

            calculatePlanMetrics(materieInStudio) {
                let totalWeeklyHours = 0;
                let totalPages = 0;
                let totalRemainingPages = 0;
                let estimatedCompletionWeeks = 0;

                materieInStudio.forEach(materia => {
                    let oreSettimanali = 0;
                    if (materia.slotSettimanali) {
                        Object.values(materia.slotSettimanali).forEach(slots => {
                            slots.forEach(slot => {
                                const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                oreSettimanali += durata;
                            });
                        });
                    }
                    totalWeeklyHours += oreSettimanali / 60;
                    
                    totalPages += materia.pagine;
                    const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                    totalRemainingPages += pagineRimanenti;
                    
                    if (oreSettimanali > 0 && pagineRimanenti > 0) {
                        const paginePerSettimana = (oreSettimanali / 60) * (materia.pagineOra || 8);
                        const settimaneRimanenti = Math.ceil(pagineRimanenti / paginePerSettimana);
                        estimatedCompletionWeeks = Math.max(estimatedCompletionWeeks, settimaneRimanenti);
                    }
                });

                return {
                    totalWeeklyHours: Math.round(totalWeeklyHours * 10) / 10,
                    avgDailyHours: Math.round((totalWeeklyHours / 7) * 10) / 10,
                    totalPages,
                    totalRemainingPages,
                    estimatedCompletionWeeks,
                    subjectsCount: materieInStudio.length
                };
            },

            updatePlanOverview(metrics) {
                const elements = {
                    planSummary: document.getElementById('planSummary'),
                    totalWeeklyHours: document.getElementById('totalWeeklyHours'),
                    avgDailyHours: document.getElementById('avgDailyHours'),
                    totalPages: document.getElementById('totalPages'),
                    completionWeeks: document.getElementById('completionWeeks')
                };

                if (elements.planSummary) {
                    const summaryText = `Piano ottimizzato per ${metrics.subjectsCount} materie con un carico di studio di ${metrics.totalWeeklyHours}h settimanali. Completamento stimato in ${metrics.estimatedCompletionWeeks || 'N/A'} settimane.`;
                    elements.planSummary.textContent = summaryText;
                }

                if (elements.totalWeeklyHours) elements.totalWeeklyHours.textContent = `${metrics.totalWeeklyHours}h`;
                if (elements.avgDailyHours) elements.avgDailyHours.textContent = `${metrics.avgDailyHours}h`;
                if (elements.totalPages) elements.totalPages.textContent = metrics.totalRemainingPages;
                if (elements.completionWeeks) elements.completionWeeks.textContent = metrics.estimatedCompletionWeeks || 'N/A';
            },

            generateAISuggestions(materieInStudio, metrics) {
                const suggestionsList = document.getElementById('suggestionsList');
                if (!suggestionsList) return;

                const suggestions = [];
                
                if (metrics.avgDailyHours > 6) {
                    suggestions.push({
                        title: " Carico di Studio Intenso",
                        description: `Con ${metrics.avgDailyHours}h al giorno, considera di distribuire meglio il carico o estendere le tempistiche per evitare burnout.`
                    });
                } else if (metrics.avgDailyHours < 2) {
                    suggestions.push({
                        title: " Opportunit di Ottimizzazione",
                        description: `Con solo ${metrics.avgDailyHours}h al giorno, potresti aumentare le ore di studio per completare prima o aggiungere materie.`
                    });
                }

                const materieConScadenza = materieInStudio.filter(m => m.dataEsame);
                if (materieConScadenza.length > 0) {
                    const prossimeScadenze = materieConScadenza
                        .map(m => ({ ...m, daysToExam: Utils.getDaysToExam(m.dataEsame) }))
                        .filter(m => m.daysToExam <= 30 && m.daysToExam > 0)
                        .sort((a, b) => a.daysToExam - b.daysToExam);

                    if (prossimeScadenze.length > 0) {
                        suggestions.push({
                            title: " Focus su Priorit",
                            description: `${prossimeScadenze[0].nome} ha l'esame tra ${prossimeScadenze[0].daysToExam} giorni. Considera di aumentare le ore dedicate a questa materia.`
                        });
                    }
                }

                if (suggestions.length === 0) {
                    suggestions.push({
                        title: " Piano Ottimale",
                        description: "Il tuo piano di studio  ben bilanciato! Continua cos e monitora i progressi regolarmente."
                    });
                }

                suggestionsList.innerHTML = suggestions.map(s => `
                    <div style="background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; transition: all 0.3s ease;">
                        <div style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem;">${s.title}</div>
                        <div style="color: var(--text-primary); line-height: 1.5;">${s.description}</div>
                    </div>
                `).join('');
            },

            // *** CORREZIONE PROBLEMA 2: Generazione dettagli piano ***
            generatePlanDetails(materieInStudio) {
                const detailsContainer = document.getElementById('pianDetails');
                if (!detailsContainer) return;

                if (materieInStudio.length === 0) {
                    detailsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                        </div>
                    `;
                    return;
                }

                detailsContainer.innerHTML = `
                    <div class="plan-detail-grid">
                        ${materieInStudio.map(materia => {
                            const progress = Math.round(((materia.pagineStudiate || 0) / materia.pagine) * 100);
                            const pagineRimanenti = materia.pagine - (materia.pagineStudiate || 0);
                            
                            let oreTotaliSettimanali = 0;
                            let slotsInfo = 'Nessun slot definito';
                            
                            if (materia.slotSettimanali) {
                                const slots = [];
                                Object.entries(materia.slotSettimanali).forEach(([giorno, slotArray]) => {
                                    slotArray.forEach(slot => {
                                        const durata = Utils.calculateTaskDuration(slot.inizio, slot.fine);
                                        oreTotaliSettimanali += durata;
                                        slots.push(`${giorno.charAt(0).toUpperCase() + giorno.slice(1)}: ${slot.inizio}-${slot.fine}`);
                                    });
                                });
                                
                                if (slots.length > 0) {
                                    slotsInfo = slots.join('<br>');
                                }
                            }
                            
                            const oreSettimanaliFormatted = Math.round(oreTotaliSettimanali / 60 * 10) / 10;
                            const settimaneRimanenti = oreSettimanaliFormatted > 0 ? 
                                Math.ceil(pagineRimanenti / ((oreSettimanaliFormatted) * (materia.pagineOra || 8))) : 'N/A';
                            
                            return `
                                <div class="plan-subject-card">
                                    <div class="plan-subject-header">
                                        <div class="plan-subject-name">${materia.nome}</div>
                                        <div class="plan-subject-priority priority-${materia.priorita}">${materia.priorita}</div>
                                    </div>
                                    
                                    <div class="plan-subject-stats">
                                        <div class="plan-stat">
                                            <div class="plan-stat-number" style="color: var(--primary);">${progress}%</div>
                                            <div class="plan-stat-label">Completato</div>
                                        </div>
                                        <div class="plan-stat">
                                            <div class="plan-stat-number" style="color: var(--warning);">${pagineRimanenti}</div>
                                            <div class="plan-stat-label">Pagine Rimanenti</div>
                                        </div>
                                        <div class="plan-stat">
                                            <div class="plan-stat-number" style="color: var(--secondary);">${oreSettimanaliFormatted}h</div>
                                            <div class="plan-stat-label">Ore/Settimana</div>
                                        </div>
                                        <div class="plan-stat">
                                            <div class="plan-stat-number" style="color: var(--accent);">${settimaneRimanenti}</div>
                                            <div class="plan-stat-label">Settimane Stimate</div>
                                        </div>
                                    </div>
                                    
                                    <div class="plan-schedule">
                                        <div class="plan-schedule-title"> Programma Settimanale:</div>
                                        <div class="plan-schedule-slots">
                                            ${slotsInfo.split('<br>').map(slot => 
                                                `<div class="plan-schedule-slot">${slot}</div>`
                                            ).join('')}
                                        </div>
                                    </div>
                                    
                                    ${materia.dataEsame ? `
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                            <strong> Esame:</strong> ${new Date(materia.dataEsame).toLocaleDateString('it-IT')}<br>
                                            <small style="color: var(--text-secondary);">Giorni rimanenti: ${Utils.getDaysToExam(materia.dataEsame) || 'N/A'}</small>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            showEmptyPlanState() {
                const detailsContainer = document.getElementById('pianDetails');
                const suggestionsList = document.getElementById('suggestionsList');
                
                if (detailsContainer) {
                    detailsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi delle materie per generare il tuo piano di studio personalizzato!</p>
                            <p style="margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="showSection('materie', document.querySelector('.nav-tab[onclick*=materie]'))">
                                     Aggiungi Prima Materia
                                </button>
                            </p>
                        </div>
                    `;
                }
                
                if (suggestionsList) {
                    suggestionsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Aggiungi delle materie per ricevere suggerimenti personalizzati!</p>
                        </div>
                    `;
                }
            },

            showErrorPlanState() {
                const suggestionsList = document.getElementById('suggestionsList');
                if (suggestionsList) {
                    suggestionsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>Errore nella generazione del piano di studio.</p>
                            <p style="margin-top: 1rem;">
                                <button class="btn btn-warning" onclick="PianoStudio.generatePianoStudio()">
                                     Riprova
                                </button>
                            </p>
                        </div>
                    `;
                }
            }
        };

        // === EXAM MODAL FUNCTIONS ===
        function saveExamGrade() {
            const materiaId = parseInt(document.getElementById('examModal').dataset.materiaId);
            const voto = parseInt(document.getElementById('examGrade').value);
            const lode = document.getElementById('examLode').checked;
            const dataEsame = document.getElementById('examDate').value;
            const note = document.getElementById('examNotes').value;
            
            if (!voto || voto < 18 || voto > 30) {
                Utils.showSuccessMessage(' Inserisci un voto valido (18-30)');
                return;
            }
            
            const materia = APP.materie.find(m => m.id === materiaId);
            if (!materia) return;
            
            // Marca materia come completata
            materia.status = 'completato';
            
            // Crea record esame
            const nuovoEsame = {
                id: Date.now(),
                materiaId: materiaId,
                voto: voto,
                lode: lode && voto === 30,
                dataEsame: dataEsame || new Date().toISOString().split('T')[0],
                note: note,
                dataCreazione: new Date().toISOString()
            };
            
            APP.esami.push(nuovoEsame);
            
            // Aggiorna curriculum se presente
            const currSubject = APP.curriculum.find(c => c.nome === materia.nome && c.anno === materia.anno && c.semestre === materia.semestre);
            if (currSubject) {
                currSubject.completato = true;
                currSubject.voto = voto;
                currSubject.lode = lode && voto === 30;
                currSubject.dataCompletamento = dataEsame || new Date().toISOString().split('T')[0];
                CurriculumManager.saveCurriculum();
            }
            
            // Salva tutto
            MaterieManager.saveMaterie();
            ExamManager.saveEsami();
            
            // Aggiorna UI
            MaterieManager.loadMaterie();
            ExamManager.updateExamsSection();
            CurriculumManager.loadCurriculumData();
            TodayScheduler.generateTodaySchedule();
            PianoStudio.generatePianoStudio();
            
            // Chiudi modal
            closeExamModal();
            
            Utils.showSuccessMessage(` Esame di ${materia.nome} registrato con voto ${voto}${lode ? 'L' : ''}!`);
        }

        function closeExamModal() {
            document.getElementById('examModal').style.display = 'none';
            document.getElementById('examGrade').value = '';
            document.getElementById('examLode').checked = false;
            document.getElementById('examDate').value = '';
            document.getElementById('examNotes').value = '';
        }

        function updateExamGrade() {
            const esameId = APP.currentEditingExamId;
            const esame = APP.esami.find(e => e.id === esameId);
            
            if (!esame) {
                Utils.showSuccessMessage(' Esame non trovato');
                return;
            }
            
            const voto = parseInt(document.getElementById('editExamGrade').value);
            const lode = document.getElementById('editExamLode').checked;
            const dataEsame = document.getElementById('editExamDate').value;
            const note = document.getElementById('editExamNotes').value;
            
            if (!voto || voto < 18 || voto > 30) {
                Utils.showSuccessMessage(' Inserisci un voto valido (18-30)');
                return;
            }
            
            esame.voto = voto;
            esame.lode = lode && voto === 30;
            esame.dataEsame = dataEsame;
            esame.note = note;
            
            ExamManager.saveEsami();
            MaterieManager.loadMaterie();
            ExamManager.updateExamsSection();
            closeEditExamModal();
            
            Utils.showSuccessMessage(' Esame aggiornato con successo!');
        }

        function closeEditExamModal() {
            document.getElementById('editExamModal').style.display = 'none';
            APP.currentEditingExamId = null;
        }

        // === CURRICULUM MODAL FUNCTIONS ===
        function showAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'flex';
        }

        function closeAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'none';
        }

        function saveCurriculumSubject() {
            const nome = document.getElementById('currSubjectName').value.trim();
            const anno = parseInt(document.getElementById('currSubjectYear').value);
            const semestre = parseInt(document.getElementById('currSubjectSemester').value);
            const cfu = parseInt(document.getElementById('currSubjectCFU').value);
            const professore = document.getElementById('currSubjectProfessor').value.trim();
            const note = document.getElementById('currSubjectNotes').value.trim();
            
            if (!nome || !anno || !semestre || !cfu) {
                Utils.showSuccessMessage(' Compila tutti i campi obbligatori');
                return;
            }
            
            const nuovaMateria = {
                id: Date.now(),
                nome,
                anno,
                semestre,
                cfu,
                professore,
                note,
                completato: false,
                dataCreazione: new Date().toISOString()
            };
            
            APP.curriculum.push(nuovaMateria);
            CurriculumManager.saveCurriculum();
            CurriculumManager.loadCurriculumData();
            
            closeAddSubjectModal();
            
            // Reset form
            document.getElementById('currSubjectName').value = '';
            document.getElementById('currSubjectYear').value = '1';
            document.getElementById('currSubjectSemester').value = '1';
            document.getElementById('currSubjectCFU').value = '';
            document.getElementById('currSubjectProfessor').value = '';
            document.getElementById('currSubjectNotes').value = '';
            
            Utils.showSuccessMessage(' Materia aggiunta al curriculum!');
        }

        function updateCurriculumSubject() {
            const subjectId = APP.currentEditingCurriculumId;
            const subject = APP.curriculum.find(s => s.id === subjectId);
            
            if (!subject) {
                Utils.showSuccessMessage(' Materia non trovata');
                return;
            }
            
            const nome = document.getElementById('editCurrSubjectName').value.trim();
            const anno = parseInt(document.getElementById('editCurrSubjectYear').value);
            const semestre = parseInt(document.getElementById('editCurrSubjectSemester').value);
            const cfu = parseInt(document.getElementById('editCurrSubjectCFU').value);
            const professore = document.getElementById('editCurrSubjectProfessor').value.trim();
            const note = document.getElementById('editCurrSubjectNotes').value.trim();
            
            if (!nome || !anno || !semestre || !cfu) {
                Utils.showSuccessMessage(' Compila tutti i campi obbligatori');
                return;
            }
            
            subject.nome = nome;
            subject.anno = anno;
            subject.semestre = semestre;
            subject.cfu = cfu;
            subject.professore = professore;
            subject.note = note;
            
            CurriculumManager.saveCurriculum();
            CurriculumManager.loadCurriculumData();
            closeEditCurriculumModal();
            
            Utils.showSuccessMessage(' Materia aggiornata nel curriculum!');
        }

        function closeEditCurriculumModal() {
            document.getElementById('editCurriculumModal').style.display = 'none';
            APP.currentEditingCurriculumId = null;
        }

        function showCurriculumYear(year, tabElement) {
            APP.currentCurriculumYear = year;
            
            // Aggiorna tabs
            document.querySelectorAll('.year-tab').forEach(tab => tab.classList.remove('active'));
            if (tabElement) tabElement.classList.add('active');
            
            // Aggiorna contenuto
            document.querySelectorAll('.year-content').forEach(content => content.classList.add('hidden'));
            const targetContent = document.getElementById(`year-${year}`);
            if (targetContent) targetContent.classList.remove('hidden');
        }

        function importCurriculumData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                APP.curriculum = data;
                                CurriculumManager.saveCurriculum();
                                CurriculumManager.loadCurriculumData();
                                Utils.showSuccessMessage(' Curriculum importato con successo!');
                            } else {
                                Utils.showSuccessMessage(' File non valido');
                            }
                        } catch (error) {
                            Utils.showSuccessMessage(' Errore nella lettura del file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportCurriculumData() {
            const data = JSON.stringify(APP.curriculum, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `curriculum_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            Utils.showSuccessMessage(' Curriculum esportato!');
        }

        // === RECOVERY FUNCTIONS ===
        function showRecoveryOptions() {
            document.getElementById('recoveryModal').style.display = 'flex';
        }

        function closeRecoveryModal() {
            document.getElementById('recoveryModal').style.display = 'none';
        }

        function applyRecoveryStrategy() {
            const strategy = document.getElementById('recoveryStrategy').value;
            
            let message = '';
            switch(strategy) {
                case 'graduale':
                    message = ' Strategia graduale attivata: tempo distribuito su 7 giorni';
                    break;
                case 'intensivo':
                    message = ' Strategia intensiva attivata: recupero in 2-3 giorni';
                    break;
                case 'weekend':
                    message = ' Strategia weekend attivata: solo sabato e domenica';
                    break;
            }
            
            closeRecoveryModal();
            Utils.showSuccessMessage(message);
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Inizializza componenti base
                MaterieManager.loadMaterie();
                Timer.updateSessionDisplay();
                Timer.updateDailyGoalDisplay();
                updateStreakDisplay();
                
                // Reset sessioni giornaliere se nuovo giorno
                const today = new Date().toDateString();
                if (APP.timerState.lastSessionDate !== today) {
                    APP.timerState.sessionsToday = 0;
                    APP.todayDetailedSessions = [];
                    localStorage.setItem('sessionsToday', 0);
                    localStorage.setItem('todayDetailedSessions', JSON.stringify([]));
                }
                
                // Inizializza sezioni specifiche
                TodayScheduler.generateTodaySchedule();
                WeeklySlots.initializeWeeklySlots();
                StarRating.setupStarRating();
                Sessions.updateTodaySessionsList();
                Calendar.renderCalendar();
                Heatmap.initializeHeatmap();
                Statistics.updateStatistiche();
                ExamManager.updateExamsSection();
                CurriculumManager.loadCurriculumData();
                PianoStudio.generatePianoStudio();
                ProductivityAnalyzer.updateProductivitySection();
                
                console.log(' Piano Studio Smart inizializzato con successo!');
                
            } catch (error) {
                console.error(' Errore nell\'inizializzazione:', error);
            }
        });

        // Chiudi modali cliccando fuori
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        });

        // Previeni chiusura modal su click interno
        document.querySelectorAll('.modal, .rating-modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    </script>
</body>
</html>
